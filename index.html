<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Math Pet Adventure RPG (Pro Edition)</title>
  
  <!-- 1. LOAD FIREBASE LIBRARIES (DUAL CORE) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, runTransaction, arrayUnion, deleteDoc, writeBatch, increment, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. MAIN GAME DB (Pet Adventure) - Saves Student Data
    const gameConfig = {
     apiKey: "AIzaSyAw7gJ8lN5BNE2a74jdAoSu9vrpAsBgcpc",
      authDomain: "petadventure-b73c8.firebaseapp.com",
      projectId: "petadventure-b73c8",
      storageBucket: "petadventure-b73c8.firebase.storage.app",
      messagingSenderId: "590511399628",
      appId: "1:590511399628:web:400e68086ccfaba2e65869"
    };



    // 2. TOOLS DB (Visualization Practice) - Stores Tool HTML Code
    const toolsConfig = {
        apiKey: "AIzaSyCYVPsTnfNnyYfmgyKqeTtIAg5qf-ganS4",
        authDomain: "visualizationpractice.firebaseapp.com",
        projectId: "visualizationpractice",
        storageBucket: "visualizationpractice.firebasestorage.app",
        messagingSenderId: "814840211812",
        appId: "1:814840211812:web:01543de18dc9cb3ce23271"
    };

    // Initialize Both Apps
    const app = initializeApp(gameConfig);
    const toolsApp = initializeApp(toolsConfig, "toolsApp"); 

    const db = getFirestore(app);         // Main DB
    const toolsDb = getFirestore(toolsApp); // Content DB

    // Expose to window for the game logic
    window.db = db;
    window.toolsDb = toolsDb; 
    window.fbase = { doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, runTransaction, arrayUnion, deleteDoc, writeBatch, increment, query, where };
    console.log("üî• Dual-Core Firebase Initialized");
  </script>

  <!-- Load Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  
  <style>@view-transition { navigation: auto; }</style>
  
  <!-- Custom Game Styles -->
  <style>
  .tower-math-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none; /* JS will change this to 'flex' */
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    z-index: 15000; /* Force it above all other layers */
}
    :root {
        --bg-login: url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/Untitled%20design.png'); 
        --bg-game:  url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/Untitled%20design%20(1).png'); 
    }

    body { 
        box-sizing: border-box; margin: 0; padding: 0; 
        font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', cursive, sans-serif; 
        background: var(--bg-game) no-repeat center center fixed; 
        background-size: cover;
        height: 100vh; width: 100vw; overflow: hidden; 
        overscroll-behavior: none;
        user-select: none; -webkit-user-select: none; caret-color: transparent;   
    }

    input, textarea { user-select: text; -webkit-user-select: text; caret-color: auto; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* Login & Setup Screen */
    /* Update or Check this CSS block */
.login-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; /* Force full viewport width */
    height: 100vh; /* Force full viewport height */
    background: var(--bg-login) no-repeat center center fixed; 
    background-size: cover; 
    z-index: 5000; /* Increased Z-Index to be sure */
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow-y: auto; 
    padding: 20px; 
}
    .login-overlay.hidden { display: none; }
    .login-box { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; padding: 30px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); text-align: center; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
    .login-title { font-size: clamp(24px, 5vw, 32px); color: #5a67d8; margin-bottom: 10px; font-weight: bold; }
    .setup-section { margin-bottom: 20px; text-align: left; border-bottom: 2px solid #edf2f7; padding-bottom: 15px; }
    .setup-label { display: block; font-size: 16px; font-weight: bold; color: #2d3748; margin-bottom: 8px; }
    .login-input { width: 100%; padding: 12px; font-size: 16px; border: 3px solid #e5e7eb; border-radius: 10px; font-family: inherit; margin-bottom: 10px; }
    
    /* Buttons */
    .login-btn, .submit-btn, .explore-btn, .btn-green { width: 100%; padding: 15px; background: #48bb78; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #2f855a; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; touch-action: manipulation; }
    .login-btn:active, .submit-btn:active, .explore-btn:active, .btn-green:active { transform: translateY(5px); box-shadow: none; }
    .login-btn:disabled, .submit-btn:disabled, .explore-btn:disabled { background: #cbd5e0; box-shadow: none; cursor: not-allowed; transform: none; }
    
    /* Layout */
    .game-container { max-width: 1000px; margin: 0 auto; padding: 10px; height: 100vh; display: flex; flex-direction: column; }
    .header { background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; z-index: 100; position: relative; }
    .tabs { display: flex; gap: 8px; margin-bottom: 5px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; z-index: 100; position: relative;}
    .tab { flex: 1; padding: 10px; background: rgba(255,255,255,0.6); border: none; border-radius: 12px; color: #2d3748; font-weight: bold; cursor: pointer; white-space: nowrap; text-align: center; font-size: 15px; transition: all 0.2s; min-width: 80px; backdrop-filter: blur(5px); }
    .tab.active { background: white; color: #5a67d8; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-2px); }
    .tab.adventure-tab { background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); color: white; display: none; } 
    .content { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); flex: 1; overflow-y: auto; min-height: 0; position: relative; }
    .screen { display: none; height: 100%; } .screen.active { display: block; }

    /* Study & Quiz */
    .quiz-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 800px; margin: 0 auto; padding-top: 10px; transition: box-shadow 0.3s; border-radius: 20px; padding: 20px;}
    .question-text { font-size: clamp(24px, 5vw, 36px); text-align: center; font-weight: bold; color: #2d3748; margin: 20px 0; line-height: 1.3; }
    .mcq-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
    .mcq-btn { background: white; border: 3px solid #e2e8f0; border-radius: 15px; padding: 20px 10px; font-size: 22px; font-weight: bold; color: #4a5568; cursor: pointer; transition: all 0.1s; box-shadow: 0 6px 0 #cbd5e0; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 80px; user-select: none; }
    .mcq-btn:active { transform: translateY(6px); box-shadow: none; background-color: #f7fafc; }
    
    /* Hub & Grids */
    .hub-grid { display: flex; flex-direction: column; gap: 20px; }
    @media(min-width: 768px) { .hub-grid { flex-direction: row; align-items: flex-start; } .hub-left { flex: 1; max-width: 350px; position: sticky; top: 0; } .hub-right { flex: 1.5; } }
    .pet-display { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
    
    /* Battle Screen */
   /* Battle Screen: Game Boy Container */
    .battle-screen { 
        display: none; 
        flex-direction: column; /* Vertical Stack */
        height: 100%; 
        width: 100%; 
        background-color: #1a202c; /* Dark frame */
     background-image: none !important; /* üõë FORCE NO IMAGE ON CONTAINER */
        overflow: hidden; 
        position: relative;
    }
    .battle-screen.active { display: flex; }

    /* The Stage: 16:9 Locked Aspect Ratio */
    .battle-arena { 
        position: relative; 
        width: 100%; 
        aspect-ratio: 16 / 9; /* THE MAGIC NUMBER */
        background-size: 100% 100%; /* Stretch image to fit box exactly */
        background-position: center; 
        background-repeat: no-repeat; 
        flex-shrink: 0; /* Never shrink the stage */
        z-index: 10;
        margin: 0 auto; /* Center on wide screens */
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* The Controls: Fills remaining bottom space */
    .battle-ui-panel { 
        position: relative; 
        flex-grow: 1; /* Grow to fill bottom */
        width: 100%; 
        background: #f7fafc; 
        border-top: 4px solid #5a67d8; 
        padding: 10px; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2); 
        z-index: 20; 
        display: flex; 
        flex-direction: column; 
        justify-content: center;
        bottom: 0; left: 0; /* Reset positioning */
    }
    /* üé® MANUAL POSITIONING: "Painted on Background" */
    
    .battler { 
        position: absolute; 
        text-align: center; 
        width: 35%; /* üìè SIZE: Change this to make pets bigger/smaller */
        max-width: 300px; 
        z-index: 20;
        filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); /* Shadow on floor */
        transition: all 0.3s ease-out; 
    }

    /* üü¢ PLAYER (You) */
    #player-container { 
        bottom: 5%;  /* ‚¨ÜÔ∏è Height: Higher number = Higher on screen */
        left: 15%;    /* ‚¨ÖÔ∏è Horizontal: Higher number = More to the right */
        z-index: 30; /* Keep in front */
    }

    /* üî¥ ENEMY (Opponent) */
    #enemy-container { 
        bottom: 7%; /* ‚¨ÜÔ∏è Height: Higher looks "Further away" in distance */
        right: 15%;   /* ‚û°Ô∏è Horizontal: Higher number = More to the left */
        z-index: 20;
    }
    .battler-visual { font-size: clamp(60px, 15vw, 140px); margin-bottom: 10px; position: relative; transition: transform 0.1s; }
    
    /* DAMAGE TEXT SYSTEM */
    .floating-text { position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: 'Arial Black', sans-serif; font-size: 40px; font-weight: 900; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 100; animation: floatUp 1s ease-out forwards; }
    .floating-text.heal { color: #48bb78; text-shadow: 2px 2px 0 #047857; }
    .floating-text.super { color: #48bb78; font-size: 60px; text-shadow: 3px 3px 0 #064e3b; z-index: 200; }
    .floating-text.weak { color: #a0aec0; font-size: 30px; text-shadow: 1px 1px 0 #2d3748; }
    .floating-text.crit { color: #ffeb3b; font-size: 50px; text-shadow: 3px 3px 0 #b91c1c; animation: critShake 0.3s; }

    @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 20% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -100px) scale(1); opacity: 0; } }
    @keyframes critShake { 0% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-55%, -55%) rotate(-10deg); } 75% { transform: translate(-45%, -45%) rotate(10deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }

    .hp-bar-container { background: rgba(0,0,0,0.7); border-radius: 15px; height: 15px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); max-width: 100%; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 5px; }
    .hp-bar { 
    height: 100%; 
    background: linear-gradient(180deg, #48bb78 0%, #2f855a 100%); 
    transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); 
    position: relative; 
    z-index: 2; 
    max-width: 100%; /* üõë STOP at the edge! */
}
    .hp-bar-trail { position: absolute; top:0; left:0; height:100%; width:100%; background: white; z-index: 1; transition: width 0.8s ease-out 0.3s; }
    @keyframes attackLunge { 0% { transform: translateX(0) scale(1); } 50% { transform: translateX(60px) scale(1.1); } 100% { transform: translateX(0) scale(1); } }
    @keyframes damageShake { 0%, 100% { transform: translate(0, 0); filter: brightness(1); } 10%, 90% { transform: translate(-8px, -2px); filter: brightness(2) saturate(0); } 20%, 80% { transform: translate(6px, 4px); } 30%, 50%, 70% { transform: translate(-8px, -8px); } 40%, 60% { transform: translate(8px, 8px); } }
    .battler-visual.flipped-opponent { transform: none; }
    .battler-visual.flipped-opponent img, .battler-visual.flipped-opponent .emoji-wrapper { transform: scaleX(-1); display: inline-block; }
    /* The Command Deck: Stacks immediately below the image */
    .battle-ui-panel { 
        position: relative; /* Sit naturally in the flow */
        flex: 1; /* Fill all remaining space downwards */
        width: 100%; 
        background: #f7fafc; /* White/Gray panel color */
        border-top: 4px solid #5a67d8; 
        padding: 20px 10px; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2); 
        z-index: 20; 
        display: flex; 
        flex-direction: column; 
        justify-content: flex-start; /* Push buttons to the top of this panel */
        overflow-y: auto; /* Allow scrolling if too many buttons */
    }
    .battle-actions { display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 8px; width: 100%; }
    .battle-actions .action-btn { margin: 0; padding: 12px 2px; font-size: 13px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; flex: 1; min-width: 0; border-radius: 8px; }
    
    /* Battle Name Plates with Elements */
    .battle-name-plate { font-size: 14px; margin-top: 5px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .element-icon { font-size: 16px; filter: drop-shadow(0 0 2px white); }

    /* Common */
    .player-info {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0; /* Allows text to shrink if needed */
}
.header-action-btns {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto; /* This is the "Magic" that pushes buttons to the right-middle */
}
    .stats-container {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0; /* Ensures BP/Stamina never get squashed */
}
    .logout-btn { padding: 6px 12px; background: #e53e3e; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: auto; }
    .currency-display { background: #fef3c7; padding: 6px 12px; border-radius: 20px; font-weight: bold; color: #92400e; border: 2px solid #fcd34d; font-size: 14px; white-space: nowrap; }
    .stamina-display { background: #e0f2fe; padding: 6px 12px; border-radius: 20px; font-weight: bold; color: #0369a1; border: 2px solid #7dd3fc; font-size: 14px; white-space: nowrap; }
    .pet-visual { font-size: 150px; margin: 10px 0; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); position: relative; display: inline-block; min-width: 200px; min-height: 200px; }
    .pet-image { width: 350px; height: 350px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
    .blend-multiply { mix-blend-mode: multiply; }
    .battler-image { width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
    .pet-name { font-size: 20px; color: #2c5282; margin: 10px 0; font-weight: bold; }
    .rarity-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .rarity-common { background: #9ca3af; color: white; }
    .rarity-uncommon { background: #10b981; color: white; }
    .rarity-rare { background: #3b82f6; color: white; }
    .rarity-epic { background: #a855f7; color: white; }
    .rarity-legendary { background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }
    .projectile { position: fixed; width: 150px; height: 150px; font-size: 60px; pointer-events: none; z-index: 3000; display: flex; justify-content: center; align-items: center; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); text-shadow: -15px 0 10px rgba(255, 255, 255, 0.8), -30px 0 15px rgba(255, 255, 255, 0.4); color: white; }
    .projectile img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px #fff); }
    .pet-stats { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
    .stat-box { background: white; padding: 8px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 70px; }
    .stat-label { font-size: 11px; color: #718096; margin-bottom: 3px; }
    .stat-value { font-size: 16px; color: #5a67d8; font-weight: bold; }
    .inventory-section, .evolution-info { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .inventory-item { display: inline-block; background: white; padding: 8px; margin: 4px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .action-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); font-size: 14px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .action-btn:active { transform: translateY(4px); box-shadow: none; }
    .action-btn.green { background: #48bb78; color: white; }
    .action-btn.red { background: #f56565; color: white; }
    .action-btn.blue { background: #4299e1; color: white; }
    .evolution-btn { margin-top: 10px; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 0 #d97706; }
    .evolution-btn:active { transform: translateY(4px); box-shadow: none; }
    .evolution-btn:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; transform: none; }
    .pet-collection { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
    .pet-card { background: #fff; padding: 8px; border-radius: 10px; text-align: center; cursor: pointer; border: 3px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .pet-card.active { border-color: #5a67d8; background: #ebf8ff; }
    .pet-card-visual { font-size: 30px; }
    .shop-section { margin-bottom: 25px; }
    .shop-section h2 { color: #5a67d8; border-bottom: 2px solid #5a67d8; margin-bottom: 12px; font-size: 20px; }
    .shop-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .shop-item { background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .shop-item-price { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 15px; font-weight: bold; display: inline-block; margin: 8px 0; font-size: 14px; }
    .buy-btn { width: 100%; padding: 8px; background: #5a67d8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 0 #434190; }
    .buy-btn:active { transform: translateY(3px); box-shadow: none; }
    .gacha-btn { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; padding: 15px; border-radius: 15px; border: none; font-size: 20px; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 5px 0 #5b21b6; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .gacha-btn:active { transform: translateY(5px); box-shadow: none; }
    .gacha-results { display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    .gacha-card { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.5s ease-out; min-width: 120px; }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
    .wilds-container { text-align: center; padding: 20px 10px; }
    .rpg-container { width: 100%; max-width: 500px; margin: 0 auto; position: relative; border: 4px solid #2d3748; border-radius: 10px; overflow: hidden; background: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    canvas#rpg-canvas { display: block; width: 100%; height: auto; background: #81c784; image-rendering: pixelated; touch-action: none; }
    .d-pad { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px; gap: 10px; justify-content: center; margin-top: 20px; touch-action: manipulation; }
    .d-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.7); border: 2px solid #2d3748; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; color: #2d3748; -webkit-tap-highlight-color: transparent; }
    .d-btn:active { background: white; transform: scale(0.9); }
    .d-up { grid-column: 2; grid-row: 1; }
    .d-left { grid-column: 1; grid-row: 2; }
    .d-down { grid-column: 2; grid-row: 2; }
    .d-right { grid-column: 3; grid-row: 2; }
    .controls-hint { text-align: center; color: #4a5568; margin-top: 10px; font-size: 13px; font-style: italic; }
    .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-size: 16px; font-weight: bold; z-index: 3000; animation: slideIn 0.3s ease-out; max-width: 90%; }
    .toast.success { border-left: 5px solid #48bb78; color: #276749; }
    .toast.error { border-left: 5px solid #f56565; color: #742a2a; }
    .toast.info { border-left: 5px solid #4299e1; color: #2c5282; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2500; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .confirm-modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
    .confirm-modal h2 { color: #f56565; margin-bottom: 15px; font-size: 24px; }
    .confirm-modal p { color: #374151; font-size: 16px; margin-bottom: 15px; line-height: 1.6; }
    .confirm-modal .pet-preview { font-size: 60px; margin: 15px 0; }
    .confirm-reward { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 10px; font-weight: bold; margin: 15px 0; }
    .confirm-warning { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: bold; margin: 15px 0; }
    .confirm-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .confirm-btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-family: inherit; }
    .confirm-btn.yes { background: #f56565; color: white; }
    .confirm-btn.yes:hover { background: #e53e3e; transform: scale(1.05); }
    .confirm-btn.no { background: #5a67d8; color: white; }
    .confirm-btn.no:hover { background: #4c51bf; transform: scale(1.05); }
    .move-replace-list { display: grid; gap: 10px; margin: 20px 0; }
    .move-replace-btn { background: white; border: 2px solid #cbd5e0; padding: 15px; border-radius: 10px; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-weight: bold; transition: all 0.2s; }
    .move-replace-btn:hover { border-color: #f56565; background: #fff5f5; color: #c53030; }
    .move-replace-btn span { pointer-events: none; }
    .student-list-item { background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .student-list-item:last-child { border-bottom: none; }
    .student-info { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
    .student-info strong { color: #2d3748; font-size: 16px; }
    .student-info span { color: #718096; font-size: 12px; margin-left: 5px; }
    .delete-confirm-modal .confirm-buttons { display: flex; justify-content: space-between; gap: 10px; }
    .delete-confirm-modal .confirm-buttons .confirm-btn.yes { background: #e53e3e; }
    .grade-group { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; background: #f7fafc; overflow: hidden; }
    .grade-summary { display: flex; justify-content: space-between; padding: 12px 15px; font-weight: bold; font-size: 16px; background: #e9eef2; cursor: pointer; }
    .grade-student-list { background: white; }
    /* New Monitoring Badge Style */
    .assigned-topic-badge { display: inline-block; background: #e0f2fe; color: #0284c7; font-size: 11px; padding: 3px 8px; border-radius: 12px; margin: 2px; border: 1px solid #7dd3fc; }

    #evolution-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; transition: opacity 0.5s; }
    .evo-message { font-size: clamp(20px, 5vw, 40px); font-weight: bold; margin-bottom: 40px; opacity: 0; }
    .evo-pet-visual { font-size: 180px; min-width: 200px; min-height: 200px; position: relative; display: inline-block; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
    .evo-pet-image { width: 200px; height: 200px; object-fit: contain; }
    @keyframes evolutionFlash { 0% { opacity: 1; transform: scale(1); filter: brightness(1); } 3% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 7% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 11% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 15% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 18% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 20% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 30% { opacity: 0; transform: scale(0.5); filter: brightness(5) drop-shadow(0 0 50px #ffea00); } 40% { opacity: 0; transform: scale(0); } 60% { opacity: 1; transform: scale(1.3); filter: brightness(3) drop-shadow(0 0 30px #ffffff); } 100% { opacity: 1; transform: scale(1); filter: brightness(1); } }
    .flash-and-scale { animation: evolutionFlash 1.5s ease-in-out forwards; }
    @keyframes subtleFloat { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3px) scale(1.01); } 100% { transform: translateY(0) scale(1); } }
    .pet-visual, .battler-visual { animation: subtleFloat 4s ease-in-out infinite; }
    
    #gacha-cinematic-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e003a 0%, #0d011a 100%); z-index: 5500; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; overflow: hidden; }
    .summoning-circle { width: clamp(200px, 60vw, 400px); height: clamp(200px, 60vw, 400px); border-radius: 50%; border: 5px solid #8e24aa; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 40px #a855f7, inset 0 0 30px #673ab7; animation: gachaCharge 1.5s linear infinite; transform-origin: center; transition: opacity 0.5s; will-change: transform; }
    .summoning-core { width: 100px; height: 100px; background: radial-gradient(circle, #ffdb00 0%, #e65100 80%); border-radius: 50%; box-shadow: 0 0 60px #ffdb00; opacity: 0; transition: all 0.2s; }
    @keyframes gachaCharge { 0% { transform: rotate(0deg); opacity: 0.8; } 50% { opacity: 1; } 100% { transform: rotate(360deg); opacity: 0.8; } }
    @keyframes gachaFlash { 0% { background: rgba(255, 255, 255, 0); } 50% { background: rgba(255, 255, 255, 1); transform: scale(5); } 100% { background: rgba(255, 255, 255, 0); } }
    .flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 6000; pointer-events: none; }
    .gacha-pet-reveal { position: absolute; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(200, 220, 255, 0) 70%); border-radius: 50%; opacity: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .gacha-pet-reveal.rare { box-shadow: 0 0 30px 10px rgba(59, 130, 246, 0.6); }
    .gacha-pet-reveal.epic { box-shadow: 0 0 30px 10px rgba(168, 85, 247, 0.8); }
    .gacha-pet-reveal.legendary { box-shadow: 0 0 40px 15px rgba(245, 158, 11, 0.9); }
    .gacha-reveal-visual { width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 4px 15px rgba(0,0,0,0.5)); }
    @keyframes petPopIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    
    @keyframes eggShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
    .egg-shaking { animation: eggShake 0.5s infinite; }
    .hatch-light { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
    @keyframes flashWhite { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    
    /* Streak Calendar */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
    .calendar-day { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center; opacity: 0.5; }
    .calendar-day.active { background: #ebf8ff; border-color: #4299e1; opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .calendar-day.claimed { background: #f0fff4; border-color: #48bb78; opacity: 1; }
    
    /* Quest/Dialog */
    .dialog-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: rgba(255,255,255,0.95); border-radius: 15px; border: 3px solid #2d3748; padding: 20px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 16px; color: #2d3748; display: none; }
    .dialog-name { font-weight: bold; color: #5a67d8; margin-bottom: 5px; text-transform: uppercase; font-size: 14px; }
    .burst-glow { box-shadow: 0 0 15px #f6e05e, inset 0 0 10px #d69e2e; border-color: #ecc94b !important; }

    /* Adventure Card Grid */
    .adventure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 10px; }
    .adventure-card { background: white; border: 2px solid #ed8936; border-radius: 15px; overflow: hidden; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .adventure-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(237, 137, 54, 0.3); }
    .adventure-header { background: #f6ad55; padding: 10px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
    .adventure-body { padding: 15px; }
    .adventure-desc { font-size: 13px; color: #4a5568; margin-bottom: 10px; }
    .adventure-status { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    .status-active { background: #c6f6d5; color: #276749; }
    .status-coming { background: #e2e8f0; color: #718096; }

    /* Feature 2: Swap Card */
    .swap-card { 
        background: white; 
        border: 2px solid #e2e8f0; 
        border-radius: 12px; 
        padding: 10px; 
        cursor: pointer; 
        transition: all 0.2s; 
        opacity: 1; 
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
    }
    .swap-card:hover { border-color: #4299e1; transform: translateX(5px); }
    .swap-card.active-pet { border-color: #48bb78; background: #f0fff4; pointer-events: none; border-width: 3px; }
    .swap-card.fainted { opacity: 0.6; filter: grayscale(1); background: #f7fafc; cursor: not-allowed; }
    .swap-card.fainted::after { content: "FAINTED"; position: absolute; top: 50%; right: 10px; transform: translateY(-50%) rotate(-10deg); font-weight: 900; color: #e53e3e; border: 2px solid #e53e3e; padding: 2px 5px; font-size: 10px; border-radius: 4px; }

    /* MINI HP BAR FOR MENU */
    .mini-hp-bg { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .mini-hp-fill { height: 100%; background: #48bb78; transition: width 0.3s; }
    .mini-hp-fill.low { background: #f56565; }
    .mini-hp-fill.mid { background: #ecc94b; }

    /* VISUAL POLISH: Animated Bars */
    .xp-bar-container, .hatch-bar-container {
        width: 100%; height: 12px; background: #2d3748; border-radius: 6px; overflow: hidden; margin-top: 5px; border: 1px solid rgba(255,255,255,0.2);
    }

    .xp-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 0 10px #667eea;
        transition: width 0.5s ease;
    }

    .hatch-bar {
        height: 100%;
        background: repeating-linear-gradient(
          45deg,
          #f6ad55,
          #f6ad55 10px,
          #ed8936 10px,
          #ed8936 20px
        );
        background-size: 200% 200%;
        animation: barStripes 2s linear infinite;
        transition: width 0.5s ease;
    }
    @keyframes barStripes { 100% { background-position: 100% 100%; } }

    /* RAID BOSS UI */
    .raid-container { display:flex; flex-direction: column; height: 100%; }
    .raid-split { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; flex-grow: 1; height: 0; min-height: 0; }
    .leaderboard-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; overflow-y: auto; color: white; font-size: 12px; }
    .lb-row { display: flex; justify-content: space-between; padding: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .lb-row.me { color: #f6e05e; font-weight: bold; background: rgba(255,255,255,0.1); }

    /* TYPE EFFECTIVENESS INDICATORS */
    .type-indicator { font-size: 16px; margin-left: 5px; font-weight: bold; }
    .eff-up { color: #48bb78; } 
    .eff-down { color: #f56565; }

    /* --- NEW PRO RPG STYLES --- */
    /* Burst Mode: Makes buttons glow when you have a Math Streak */
    .burst-ready {
        box-shadow: 0 0 15px #f6ad55, inset 0 0 10px #f6e05e;
        border: 2px solid #ecc94b !important;
        animation: pulseGold 1s infinite alternate;
    }

    @keyframes pulseGold {
        from { box-shadow: 0 0 10px #f6ad55; }
        to { box-shadow: 0 0 25px #ed8936, 0 0 10px white; }
    }

    /* Combat Log: Professional scrolling text */
    .battle-log-container {
        display: none;
        width: 100%;
        height: 60px; /* Compact height */
        background: rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 5px 10px;
        overflow-y: auto;
        font-size: 12px;
        color: white;
        font-family: monospace;
        display: flex;
        flex-direction: column-reverse; /* Newest logs at bottom */
        border: 1px solid rgba(255,255,255,0.3);
    }

    .log-entry { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .log-entry.player { color: #68d391; } /* Green for player */
    .log-entry.enemy { color: #fc8181; }  /* Red for enemy */
    .log-entry.crit { color: #f6e05e; font-weight: bold; } /* Gold for crit */
    
    /* --- NEW REWARD ANIMATIONS --- */
.confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; overflow: hidden; }
.confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; }

@keyframes fall {
  to { transform: translateY(100vh) rotate(720deg); }
}

.reward-card-glow {
  background: radial-gradient(circle, #fff 0%, #f6e05e 40%, #d69e2e 100%);
  padding: 30px; border-radius: 20px;
  box-shadow: 0 0 50px #f6e05e, 0 0 100px rgba(255,215,0,0.5);
  animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  text-align: center;
  position: relative;
  border: 4px solid #fff;
}

.reward-shine {
  position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
  transform: rotate(45deg);
  animation: shineMove 3s infinite linear;
  pointer-events: none;
}

@keyframes shineMove { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }

/* --- UPDATED TOOL FOCUS MODE STYLES --- */
#tool-player-view {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: #1a202c;
    z-index: 9999;
    display: none;
    flex-direction: column;
}

.focus-header {
    background: rgba(0,0,0,0.9);
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid #5a67d8;
    height: 100px; /* Slightly taller to accommodate the pet */
}

/* The cheering pet is now part of the header flex */
.cheer-zone {
    display: flex;
    align-items: center;
    gap: 15px;
    pointer-events: none;
    z-index: 10001;
}

.cheer-pet-img {
    width: 150px; /* Increased size from 120px */
    height: 150px;
    object-fit: contain;
    filter: drop-shadow(0 0 15px rgba(255,255,255,0.6));
    animation: bounce 2s infinite ease-in-out;
    margin-top: 40px; /* Overhangs slightly out of the header */
}

.speech-bubble {
    background: white;
    border: 3px solid #5a67d8;
    border-radius: 15px;
    padding: 10px 15px;
    font-size: 14px;
    font-weight: bold;
    color: #2d3748;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    max-width: 180px;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s;
}

/* Updated speech bubble arrow to point right toward the pet */
.speech-bubble::after {
    content: '';
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-left: 12px solid #5a67d8;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}


/* =========================================
       üè∞ VOXEL BUILDER ENGINE (CSS)
       ========================================= */
    
    .builder-container {
        width: 100%; height: 100%;
        position: relative;
        background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); /* Sky */
        overflow: hidden;
        border-radius: 15px;
        touch-action: none; /* Prevents scrolling while rotating */
    }

    .perspective-container {
        perspective: 1200px;
        width: 100%; height: 100%;
        position: absolute;
        display: flex; align-items: center; justify-content: center;
    }

    .scene-3d {
        position: relative;
        width: 400px; height: 400px;
        transform-style: preserve-3d;
        transition: transform 0.1s ease-out;
    }

    /* The Floor Grid */
    .grid-base {
        position: absolute;
        display: grid;
        background-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        border: 4px solid rgba(255,255,255,0.8);
        transform-origin: center;
        /* Width/Grid Template set via JS */
    }

    .grid-cell {
        border: 0.5px solid rgba(0,0,0,0.1);
        transition: background 0.1s;
    }
    .grid-cell:hover { background-color: rgba(66, 153, 225, 0.5); cursor: pointer; }

    /* The Block (Cube) */
    .voxel-cube {
        position: absolute; width: 40px; height: 40px;
        transform-style: preserve-3d;
        pointer-events: none; /* Let clicks pass through container */
    }

    .face {
        position: absolute; width: 40px; height: 40px;
        backface-visibility: hidden;
        pointer-events: auto; /* Re-enable clicks on faces */
        cursor: pointer;
    }
    .face:hover { filter: brightness(1.2); }

    /* Cube Faces Math - Overlap Fix */
    .face-top   { transform: rotateX(0deg) translateZ(20px) scale(1.01); }
    .face-front { transform: rotateX(-90deg) translateZ(20px) scale(1.01); filter: brightness(0.9); }
    .face-back  { transform: rotateX(90deg) translateZ(20px) scale(1.01); filter: brightness(0.9); }
    .face-right { transform: rotateY(90deg) translateZ(20px) scale(1.01); filter: brightness(0.7); }
    .face-left  { transform: rotateY(-90deg) translateZ(20px) scale(1.01); filter: brightness(0.7); }

    /* Builder UI Overlay */
    .build-ui {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.9);
        padding: 10px; border-top: 2px solid #cbd5e0;
        display: flex; flex-direction: column; gap: 10px;
        z-index: 100;
    }
    .palette-scroll {
        display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;
    }
    .block-btn {
        min-width: 60px; height: 60px;
        border: 2px solid #e2e8f0; border-radius: 10px;
        background: white; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 20px; position: relative;
    }
    .block-btn.active { border-color: #5a67d8; background: #ebf8ff; transform: translateY(-3px); }
    .block-qty { font-size: 10px; font-weight: bold; color: #5a67d8; }
 
 /* --- EXAM SYSTEM STYLES --- */
    
    /* 1. Student Exam Card (In Study Tab) */
    .exam-card {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 2px solid #e53e3e;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        animation: pulseRed 2s infinite;
        display: none; /* Hidden by default */
    }
    @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); } }

    /* 2. Lockdown Interface */
    .exam-lockdown {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #f7fafc; z-index: 9000; flex-direction: column;
    }
    .exam-header { background: #2d3748; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    
    /* 3. Navigator Grid (1, 2, 3...) */
    .nav-grid { display: flex; gap: 8px; padding: 10px; overflow-x: auto; background: white; border-top: 1px solid #e2e8f0; justify-content: center; }
    .nav-box {
        width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
        border: 2px solid #cbd5e0; border-radius: 8px; font-weight: bold; cursor: pointer; color: #718096;
    }
    .nav-box.answered { background: #4299e1; color: white; border-color: #3182ce; }
    .nav-box.current { border-color: #2b6cb0; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* 4. Teacher Gradebook Table */
    .gradebook-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .gradebook-table th { background: #2d3748; color: white; padding: 10px; text-align: left; }
    .gradebook-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; color: #2d3748; }
    .gradebook-table tr:nth-child(even) { background: #f7fafc; }
    .score-pass { color: #38a169; font-weight: bold; }
    .score-fail { color: #e53e3e; font-weight: bold; }  
    
    /* EQUIPMENT SLOTS */
    .equipment-grid {
        display: flex; gap: 10px; justify-content: center; margin: 15px 0;
    }
    .equip-slot {
        width: 50px; height: 50px; 
        background: #edf2f7; border: 2px dashed #cbd5e0; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; cursor: pointer; position: relative;
        transition: all 0.2s;
    }
    .equip-slot:hover { border-color: #5a67d8; background: white; }
    .equip-slot.filled { border: 2px solid #5a67d8; background: #ebf8ff; }
    .equip-badge {
        position: absolute; bottom: -20px; font-size: 10px; font-weight: bold;
        color: #718096; width: 100%; text-align: center;
    }
    .equip-img { width: 35px; height: 35px; object-fit: contain; }
    /* FUSION SYSTEM */
    .star-display { color: #ecc94b; font-size: 18px; text-shadow: 1px 1px 0 #975a16; margin-top: -5px; margin-bottom: 5px; }
    .fuse-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; }
    .fuse-card { background: white; border: 2px solid #e2e8f0; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; position: relative; }
    .fuse-card:hover { border-color: #5a67d8; background: #ebf8ff; }
    .fuse-card.high-level { border-color: #fc8181; background: #fff5f5; }
    .fuse-card.high-level::after { content: "‚ö†Ô∏è"; position: absolute; top: 5px; right: 5px; font-size: 12px; }
    /* Add to your CSS */
.grid-base {
    /* ensure pointer events work for placing the first block */
    pointer-events: auto; 
    z-index: 1; /* Below the blocks */
}
.voxel-cube {
    z-index: 10; /* Above the grid */
}
/* =========================================
   üì± MOBILE & APP EXPERIENCE PATCH
   ========================================= */

/* 1. NOTCH PROTECTION (iPhone Safe Areas) */
body {
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
}
.header {
    background: rgba(255,255,255,0.95);
    padding: 10px 15px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between; /* Pushes Name to Left, Stats to Right */
    align-items: center;
    gap: 15px;
    z-index: 100;
    position: relative;
    flex-wrap: nowrap; /* Prevents squashing into multiple rows */
}
/* =========================================
   üì± MOBILE "GAMEBOY" SPLIT-SCREEN PATCH
   ========================================= */

@media (max-width: 768px) {
    
    /* 1. GLOBAL FIXES */
    .game-container { padding: 0; height: 100vh; max-width: 100%; overflow: hidden; }
    
    /* 2. BUILDER: Square Window in Middle */
    .builder-container { 
        height: 50vh; /* Don't fill screen, make it a window */
        width: 100%;
        margin-top: 10%; 
        /* CRITICAL: This fixes the "Rotation not pushing" issue */
        touch-action: none; 
    }
    .build-ui { padding-bottom: 40px; }

    /* ENEMY: Top-Right of the Top Zone */
    #enemy-container {
        bottom: auto !important;
        top: 15% !important;
        right: 5% !important;
        /* Reduce width for normal mobs. Bosses have their own size logic in JS */
        width: 25% !important; 
        transform: scale(1.0); /* Remove scaling, let the width handle it */
        z-index: 10; 
    }
    
    /* Make text readable on mobile */
    .battle-name-plate {
        font-size: 11px; 
        text-shadow: 0 0 4px #000;
        background: rgba(0,0,0,0.5);
        padding: 4px 8px;
        border-radius: 4px;
    }

    /* Big, Tappable Buttons Grid */
    .battle-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        width: 100%;
    }
    .battle-actions .action-btn {
        min-height: 60px; /* Thumb size */
        font-size: 16px;
        border-radius: 12px;
        margin: 0;
        box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    }
}

/* --- PRO UI: HUD & JOURNAL STYLES --- */
/* SMART HUD: Top-Left Positioning */
.adventure-hud {
    position: fixed; /* Sticks to the screen */
    top: 140px;      /* Sits below Header & Tabs */
    left: 10px;      /* Left alignment */
    z-index: 1500; 
    pointer-events: none; /* Lets you click THROUGH it (Crucial!) */
    display: none; 
    flex-direction: column; 
    gap: 5px;
    transform-origin: top left; /* Scale from the corner */
    transition: all 0.3s ease;
}

/* MOBILE OPTIMIZATION */
@media (max-width: 768px) {
    .adventure-hud {
        top: 125px; /* Move slightly higher on phones */
        transform: scale(0.75); /* Shrink to 75% size so it doesn't cover the map */
    }
}
.hud-pill {
    background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
    border-radius: 20px; padding: 5px 12px;
    border: 1px solid rgba(255,255,255,0.2);
    color: white; font-size: 12px; display: flex; align-items: center; gap: 8px;
}
.journal-btn {
    position: absolute; top: 70px; right: 15px;
    z-index: 1500; width: 50px; height: 50px;
    background: #f6ad55; border-radius: 50%;
    display: none; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: 3px solid white;
}
.journal-panel {
    position: fixed; top: 0; right: -300px; width: 280px; height: 100vh;
    background: white; z-index: 2000; transition: right 0.3s ease-out;
    box-shadow: -5px 0 20px rgba(0,0,0,0.2); padding: 20px;
}
.journal-panel.open { right: 0; }
.mission-card {
    background: #f7fafc; border-left: 4px solid #5a67d8;
    padding: 10px; margin-bottom: 10px; border-radius: 4px;
}
.mission-done { color: #a0aec0; text-decoration: line-through; }

/* --- PRO LOOT: RARITY VISUALS --- */
.item-slot {
    position: relative;
    transition: all 0.2s;
}
.rarity-basic { border: 2px solid #cbd5e0 !important; }
.rarity-rare { 
    border: 2px solid #4299e1 !important; 
    box-shadow: 0 0 10px rgba(66, 153, 225, 0.5);
    background: linear-gradient(135deg, #fff 0%, #ebf8ff 100%) !important;
}
.rarity-legendary { 
    border: 3px solid #d69e2e !important; 
    box-shadow: 0 0 15px #f6e05e;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
    animation: lootGlow 2s infinite alternate;
}
@keyframes lootGlow {
    from { box-shadow: 0 0 5px #f6e05e; }
    to { box-shadow: 0 0 20px #f6ad55; }
}
/* --- PRO LOOT: REVEAL ANIMATIONS --- */
.reveal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 9999;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.reveal-card {
    background: white; border-radius: 25px; padding: 40px;
    text-align: center; max-width: 400px; width: 90%;
    transform: scale(0); animation: lootPop 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.28) forwards;
    position: relative; overflow: hidden;
}
@keyframes lootPop {
    to { transform: scale(1); }
}
.reveal-shine {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 60%);
    animation: rotateShine 4s linear infinite;
    pointer-events: none;
}
@keyframes rotateShine {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.reveal-image {
    width: 150px; height: 150px; object-fit: contain;
    filter: drop-shadow(0 0 15px rgba(0,0,0,0.2));
    margin-bottom: 20px; position: relative; z-index: 2;
}
/* --- PRO RAID: PHASE VISUALS --- */
.enrage-filter { filter: sepia(100%) saturate(300%) hue-rotate(-50deg) drop-shadow(0 0 20px red) !important; }
.frenzy-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 500;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    color: white; text-align: center; padding: 20px;
}
.frenzy-timer { font-size: 48px; font-weight: 900; color: #f56565; animation: pulse 1s infinite; }
.shield-bar-bg { width: 80%; height: 15px; background: #2d3748; border-radius: 10px; margin: 15px 0; border: 2px solid white; overflow: hidden; }
.shield-bar-fill { height: 100%; background: #4299e1; transition: width 0.3s; box-shadow: 0 0 10px #4299e1; }
/* Recommendation 3: Screen Shake & Frenzy Juice */
.shake-ui { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
  10%, 90% { transform: translate3d(-2px, 0, 0); }
  20%, 80% { transform: translate3d(4px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
  40%, 60% { transform: translate3d(8px, 0, 0); }
}
.frenzy-bg-active { animation: frenzyPulse 1.5s infinite; }
@keyframes frenzyPulse {
    0% { background-color: rgba(255, 0, 0, 0.1); }
    50% { background-color: rgba(255, 0, 0, 0.4); }
    100% { background-color: rgba(255, 0, 0, 0.1); }
}
/* =========================================
   üóº INFINITY TOWER: MASTER PRO STYLES
   ========================================= */

/* 1. LOBBY & SQUAD MANAGEMENT */
.tower-lobby-card {
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
}
.weather-tag {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
}
.tower-btn-group {
    display: flex; gap: 10px;
    justify-content: center; margin-top: 10px;
}
.tower-modal {
    position: fixed; top: 10%; left: 5%; width: 90%; height: 80%;
    background: white; border: 4px solid #5a67d8; border-radius: 20px;
    z-index: 5000; padding: 20px; display: none; flex-direction: column;
    color: #2d3748;
}

/* 2. THE BATTLE STAGE (The "Hero Wars" Formation) */
.tower-stage {
    position: relative;
    /* This forces the stage to stay the same SHAPE as your background image */
    aspect-ratio: 16 / 9; 
    width: 100%;
    margin: 0 auto;
    
    background-image: url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/123.png');
    /* '100% 100%' ensures the image stretches to fit our invisible 16:9 box exactly */
    background-size: 100% 100%; 
    background-position: center;
    background-repeat: no-repeat;
    overflow: hidden;
}
.hero-slot {
    position: absolute;
    /* ADJUST THIS NUMBER to match the size of the stone in your art */
    width: 16%; 
    height: auto; /* Give it enough height to show the pet and the HP number */
    
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    transition: all 0.4s ease-out;
}

/* Row Layering: Makes the front row pets look like they are in front of the back row */
.row-top { z-index: 100; }
.row-bottom { z-index: 200; }

.hero-img-unit {
    width: 100%; /* The pet will now fill exactly the 14% width you set above */
    height: auto;
    object-fit: contain;
}

/* 3. DASHBOARD & COMMAND BAR (The Bottom Menu) */
#tower-command-bar {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 130px;
    background: rgba(26, 32, 44, 0.98);
    border-top: 4px solid #5a67d8;
    display: none; /* Shown via JS only when it is the student's turn */
    padding: 15px;
    z-index: 1000;
    flex-direction: column;
    justify-content: center;
}
.tower-action-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    width: 100%;
}

/* 4. TURN INDICATORS & EFFECTS */
/* Glow for the pet currently attacking */
.tower-active-glow {
    filter: drop-shadow(0 0 15px #5a67d8) brightness(1.2) !important;
    transform: scale(1.1) translateY(-10px);
}
/* Glow if the student got the Math Focus correct */
.burst-glow-pet {
    filter: drop-shadow(0 0 20px #f6e05e) brightness(1.3) !important;
}
/* Gray out pets that have already used their turn */
.pet-acted { 
    filter: grayscale(1) opacity(0.5) !important; 
}

/* 5. UI OVERLAYS & TEXT */
.tower-command-box {
    background: white; padding: 20px; 
    border-radius: 15px; border: 4px solid #5a67d8;
}
.hero-hp-number {
    font-size: 13px; font-weight: 900;
    color: #48bb78; text-shadow: 2px 2px 0px #000;
    z-index: 10; margin-bottom: -5px;
}
.enemy-hp-number { color: #f56565; }

/* Cinematic Intro Banner */
#tower-floor-banner {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9); color: #f6e05e;
    padding: 20px 60px; font-size: 32px; font-weight: 900;
    border-radius: 50px; border: 3px solid #f6e05e;
    z-index: 2000; opacity: 0; pointer-events: none;
    transition: all 0.5s;
}
.banner-show { opacity: 1 !important; transform: translate(-50%, -50%) scale(1.2) !important; }

/* 6. LOOT MODAL */
.loot-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 10000;
    display: none; align-items: center; justify-content: center;
    flex-direction: column; color: white; text-align: center;
}

/* --- ARCHAEOLOGY & BEACON PRO STYLES --- */
.study-dashboard {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}
.excavation-card {
    background: linear-gradient(135deg, #5d4037 0%, #3e2723 100%);
    border: 3px solid #2d1b10;
    border-radius: 15px;
    padding: 12px;
    color: white;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
    position: relative;
    display: flex;
    align-items: center;
    gap: 15px;
}
.beacon-card {
    background: white;
    border: 3px solid #5a67d8;
    border-radius: 15px;
    padding: 12px;
}
.fossil-well {
    width: 60px;
    height: 60px;
    background: rgba(0,0,0,0.4);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255,255,255,0.1);
}
.fossil-img {
    width: 45px;
    height: 45px;
    object-fit: contain;
    transition: all 0.5s;
}
/* This creates the mystery silhouette */
.is-fossil {
    filter: brightness(0) drop-shadow(0 0 2px rgba(255,255,255,0.2));
}
.is-revealing {
    filter: brightness(0.4) sepia(1) hue-rotate(-50deg) saturate(5); /* Dark glowing amber */
}
.progress-container {
    width: 100%; height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; margin-top: 5px;
}
.dig-fill { height: 100%; background: #f6ad55; width: 0%; transition: width 0.3s; }
.beacon-fill { height: 100%; background: #667eea; width: 0%; transition: width 1s; }

/* --- CLASSROOM BEACON STYLES --- */
.beacon-boost-glow {
    box-shadow: inset 0 0 50px rgba(246, 224, 94, 0.4) !important;
    border: 5px solid #f6ad55 !important;
}
.boost-active-text {
    animation: pulseGold 1s infinite alternate;
    color: #d97706;
    font-weight: 900;
}
/* --- ANALYTICS & MONITORING STYLES --- */
.monitor-bar-bg {
    width: 100%; height: 8px; background: #edf2f7; border-radius: 4px; overflow: hidden; margin-top: 4px;
}
.monitor-bar-fill {
    height: 100%; transition: width 0.5s ease;
}
.score-tag {
    font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-left: 5px;
}
.cycle-badge {
    background: #e9d8fd; color: #553c9a; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;
}

/* --- üèÜ HALL OF FAME (LEADERBOARD) MODAL STYLES --- */
#leaderboard-modal .confirm-modal {
    max-width: 450px;
    border: 4px solid #4299e1;
    padding: 0; 
    overflow: hidden;
    background: white;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.lb-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #edf2f7;
    font-size: 14px;
    transition: background 0.2s;
}

.lb-row:last-child { border-bottom: none; }

.lb-rank { 
    font-weight: bold; 
    width: 30px; 
    color: #718096; 
    font-size: 16px;
}

.lb-name { 
    flex: 1; 
    font-weight: bold; 
    color: #2d3748; 
    display: flex;
    align-items: center;
}

.lb-score { 
    background: #ebf8ff; 
    color: #2b6cb0; 
    padding: 4px 12px; 
    border-radius: 15px; 
    font-weight: 900; 
    font-size: 12px; 
    border: 1px solid #bee3f8;
}

/* Highlight style for the current student */
.lb-me { 
    background: #fffaf0 !important; 
    border-left: 5px solid #f6ad55 !important;
    border-right: 5px solid #f6ad55 !important;
}

.medal { 
    font-size: 20px; 
    margin-right: 10px; 
}

/* Header button in the top bar */
.lb-rank-btn {
    background: #ebf8ff;
    border: 2px solid #4299e1;
    border-radius: 8px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 18px;
    margin-right: 10px;
    box-shadow: 0 2px 0 #4299e1;
}

.lb-rank-btn:active {
    transform: translateY(2px);
    box-shadow: none;
}

.quest-board { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; width: 100%; }
    .quest-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; transition: all 0.3s; position: relative; }
    .quest-card.complete { border-color: #48bb78; background: #f0fff4; }
    .quest-card.claimed { opacity: 0.6; filter: grayscale(0.5); pointer-events: none; }
    .quest-icon { font-size: 24px; width: 40px; height: 40px; background: #edf2f7; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .quest-info { flex: 1; }
    .quest-title { font-weight: bold; font-size: 14px; color: #2d3748; }
    .quest-progress-bg { width: 100%; height: 6px; background: #edf2f7; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .quest-progress-fill { height: 100%; background: #5a67d8; transition: width 0.4s ease; }
    .quest-card.complete .quest-progress-fill { background: #48bb78; }
    .btn-claim { background: #48bb78; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 10px rgba(72,187,120,0.5); } 100% { transform: scale(1); } }
    
    .quest-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; margin-bottom:10px; text-align:left; }
.quest-card.complete { border-color: #48bb78; background: #f0fff4; }
.quest-card.claimed { opacity: 0.5; filter: grayscale(1); }
.quest-icon { font-size: 24px; }
.quest-info { flex: 1; }
.quest-title { font-weight: bold; font-size: 14px; color: #2d3748; }
.quest-progress-bg { width: 100%; height: 6px; background: #edf2f7; border-radius: 3px; margin-top: 4px; overflow: hidden; }
.quest-progress-fill { height: 100%; background: #f56565; transition: width 0.4s ease; }
.quest-card.complete .quest-progress-fill { background: #48bb78; }

  </style>
  </head>
 <body><!-- Login Screen -->
  <div class="login-overlay" id="login-overlay">
   <div class="login-box">
    <div class="login-icon" style="font-size: 40px; margin-bottom: 10px;">üè´</div>
    <h1 class="login-title">Math Pet Adventure</h1>
    <p style="color: #4a5568; margin-bottom: 20px; font-size: 14px; font-weight:bold;">Customize your learning journey!</p>
    
    <!-- STUDENT LOGIN FORM -->
    <form id="setup-form">
     <div class="setup-section"><label class="setup-label">1. Username</label><input type="text" id="student-name" class="login-input" placeholder="Enter Username" required></div>
     <div class="setup-section"><label class="setup-label">2. Password</label><input type="password" id="student-pass" class="login-input" placeholder="Enter Password" required></div>
     <button type="submit" id="login-submit-btn" class="login-btn" disabled style="background:#a0aec0; cursor:wait; box-shadow:none;">‚è≥ Loading Game Data...</button>
    </form>

    <!-- SECRET TRIGGER -->
    <div style="margin-top: 30px; font-size: 10px; color: #4a5568; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;" onclick="toggleTeacherLogin()">raymondanacaya</div>
    
    <!-- TEACHER/ADMIN LOGIN PANEL (Clean Version) -->
    <div id="teacher-login-panel" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
        <h3 style="color:#d69e2e; font-weight:bold; margin-bottom:10px;">Staff Access</h3>
        <input type="text" id="teacher-username" class="login-input" placeholder="Username (e.g. admin)">
        <input type="password" id="teacher-pass" class="login-input" placeholder="Password">
        <button class="action-btn blue" onclick="loginTeacher()">Log In</button>
    </div>
   </div>
  </div>
 <!-- ADMIN DASHBOARD (Hidden, High Security) -->
 <!-- DANGEROUS SYSTEM PATCHER (Add this inside admin-dashboard-screen) -->
<div id="admin-dashboard-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#2d3748; z-index:2200; padding:40px; overflow-y:auto; color:white;">
    <div style="max-width:1000px; margin:0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #4a5568; padding-bottom:20px;">
            <h1 style="font-size:32px; font-weight:bold; color:#f6ad55;">üõ°Ô∏è HEADMASTER ADMIN</h1>
            <button class="action-btn red" style="width:auto;" onclick="location.reload()">Log Out</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
            
            <!-- COLUMN 1: MANAGE TEACHERS -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #4a5568;">
                <h2 style="color:#63b3ed; border-bottom:1px solid #4a5568; padding-bottom:10px; margin-bottom:15px;">üë®‚Äçüè´ Create Teacher Account</h2>
                <input type="text" id="admin-new-teacher-user" class="login-input" placeholder="Teacher Username" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="password" id="admin-new-teacher-pass" class="login-input" placeholder="Password" style="background:#4a5568; color:white; border-color:#718096;">
                <button class="action-btn blue" onclick="adminCreateTeacher()">Create Account</button>
                
                <h3 style="margin-top:20px; color:#cbd5e0;">Existing Teachers</h3>
                <div id="admin-teacher-list" style="max-height:200px; overflow-y:auto; font-size:14px; color:#a0aec0;">Loading...</div>
            </div>

            <!-- COLUMN 2: SUMMON BOSS (Fixed: Added Image Input) -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #4a5568;">
                <h2 style="color:#f56565; border-bottom:1px solid #4a5568; padding-bottom:10px; margin-bottom:15px;">‚ò†Ô∏è Summon World Boss</h2>
                
                <input type="text" id="admin-boss-name" class="login-input" placeholder="Boss Name (e.g. Titan)" value="Titan" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="number" id="admin-boss-hp" class="login-input" placeholder="HP" value="50000" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="number" id="admin-boss-atk" class="login-input" placeholder="Attack" value="20" style="background:#4a5568; color:white; border-color:#718096;">
                
                <!-- MISSING INPUTS ADDED HERE -->
                <input type="text" id="admin-boss-img" class="login-input" placeholder="Image URL (e.g. https://...)" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="text" id="admin-boss-reward" class="login-input" placeholder="Reward JSON URL" value="events/boss_reward.json" style="background:#4a5568; color:white; border-color:#718096;">
                
                <div style="margin:15px 0; background:#1a202c; padding:10px; border-radius:10px;">
                    <label style="font-weight:bold; color:#f6ad55; display:block; margin-bottom:5px;">Target:</label>
                    <label style="display:block; margin-bottom:5px;">
                        <input type="radio" name="boss-target" value="global" checked onchange="toggleTeacherCheckboxes(false)"> 
                        üåç Global (All Students)
                    </label>
                    <label style="display:block;">
                        <input type="radio" name="boss-target" value="specific" onchange="toggleTeacherCheckboxes(true)"> 
                        üéØ Specific Classes
                    </label>
                </div>

                <div id="admin-boss-teacher-select" style="display:none; margin-bottom:15px; max-height:100px; overflow-y:auto; background:#1a202c; padding:5px;">
                    <!-- Teacher checkboxes injected here -->
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="action-btn red" onclick="adminSummonBoss()">SUMMON BOSS</button>
                    <button class="action-btn" style="background:#718096;" onclick="adminEndRaid()">üõë END RAID</button>
                </div>
            </div>
            <!-- COLUMN 3: DATABASE PATCHER -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:2px solid #f56565; margin-top:20px; grid-column: span 2;">
                <h2 style="color:#f56565; border-bottom:1px solid #718096; padding-bottom:10px; margin-bottom:15px;">
                    ‚ò£Ô∏è DATABASE PATCHER (Advanced)
                </h2>
                <p style="color:#cbd5e0; font-size:12px; margin-bottom:10px;">
                    WARNING: Scripts run here affect the LIVE database. Use with caution.
                </p>
                <textarea id="admin-patch-code" 
                    style="width:100%; height:150px; background:#1a202c; color:#68d391; font-family:monospace; padding:10px; border:1px solid #4a5568; border-radius:5px;" 
                    placeholder="// Paste Javascript repair code here..."></textarea>
                
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="action-btn red" onclick="executeAdminPatch()">üöÄ RUN PATCH</button>
                    <button class="action-btn blue" onclick="loadRudolfPatch()">üìã Load Rudolf Fix</button>
                </div>
                <div id="patch-logs" style="margin-top:10px; color:#a0aec0; font-size:12px; font-family:monospace;">Waiting...</div>
            </div>
            </div>
            <!-- COLUMN 4: TOOL CREATOR -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #ecc94b; margin-top:20px; grid-column: span 2;">
                <h2 style="color:#ecc94b; border-bottom:1px solid #718096; padding-bottom:10px; margin-bottom:15px;">
                    üõ†Ô∏è TOOL FACTORY (Math Tools)
                </h2>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <input type="text" id="admin-tool-title" class="login-input" placeholder="Tool Title" style="background:#1a202c; color:white;">
                    <input type="text" id="admin-tool-topic" class="login-input" placeholder="Topic (e.g. Geometry)" style="background:#1a202c; color:white;">
                    
                    <select id="admin-tool-grade" class="login-input" style="background:#1a202c; color:white;">
                        <option value="All">All Grades</option>
                        <option value="K">Kindergarten</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                    </select>
                </div>

                <textarea id="admin-tool-html" 
                    style="width:100%; height:150px; background:#1a202c; color:#68d391; font-family:monospace; padding:10px; border:1px solid #4a5568; border-radius:5px;" 
                    placeholder="Paste HTML Code here..."></textarea>
                
                <button class="action-btn green" style="margin-top:10px;" onclick="adminPublishTool()">üöÄ PUBLISH TO CLOUD</button>
            </div>
    </div>
</div>
   
  <!-- TEACHER DASHBOARD (Clean & Verified) -->
   <div id="teacher-dashboard-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2100; padding:40px; overflow-y:auto;">
       <div style="max-width:1000px; margin:0 auto;">
           
           <!-- 1. HEADER ROW (Top) -->
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 2px solid #edf2f7; padding-bottom: 20px;">
               <h1 style="font-size:32px; font-weight:bold; color:#5a67d8; margin:0;">üë©‚Äçüè´ Teacher Dashboard</h1>
               
               <!-- Button Group (Right Side) -->
               <div style="display:flex; align-items:center;">
                   <button class="action-btn blue" onclick="loadStudentList(); document.getElementById('gradebook-modal').style.display='flex'">üìä Gradebook</button>
                   <button class="action-btn red" style="width:auto; padding:10px 20px; margin:0;" onclick="location.reload()">Log Out</button>
               </div>
           </div>
           
           <!-- 2. MAIN CONTENT GRID (Bottom) -->
           
           <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:40px;">
               <!-- LEFT COLUMN: Controls -->
               <div>
                   <!-- 1. Create Student -->
                   <div style="background:#f7fafc; padding:25px; border-radius:15px; border:2px solid #e2e8f0; margin-bottom: 20px;">
                       <!-- Recommendation: Quest Master Control Panel -->
<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px; border-radius:15px; margin-bottom: 20px; color: white; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);">
    <h2 style="font-size:20px; font-weight:bold; margin-bottom:15px; display:flex; align-items:center; gap:10px;">üõ°Ô∏è Quest Master Controls</h2>
    
    <!-- Endurance Mode Toggle -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">
        <div>
            <div style="font-weight:bold;">Endurance Mode</div>
            <div style="font-size:11px; opacity:0.8;">Double all enemy HP (Great for fast classes!)</div>
        </div>
        <input type="checkbox" id="qm-endurance-toggle" style="width:25px; height:25px; cursor:pointer;">
    </div>

    <!-- Reward Multiplier Slider -->
    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;">
            <span>XP/BP Multiplier</span>
            <span id="qm-mult-display" style="background:#f6ad55; padding:2px 8px; border-radius:5px;">1.0x</span>
        </div>
        <input type="range" id="qm-reward-slider" min="1" max="3" step="0.5" value="1" style="width:100%; cursor:pointer;" oninput="document.getElementById('qm-mult-display').innerText = this.value + 'x'">
    </div>

    <button class="action-btn green" style="margin:0; border:2px solid white;" onclick="saveQuestMasterSettings()">Apply Settings to Class</button>
</div>
<!-- üåü BEACON COMMAND CENTER (FOR TEACHERS) -->
<div style="background:linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%); padding:20px; border-radius:15px; margin-bottom: 20px; color: white; border: 3px solid #f6e05e;">
    <h2 style="font-size:18px; font-weight:bold; margin-bottom:10px;">üåü Class Beacon</h2>
    <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
            <span>Current Class Charge:</span>
            <span id="t-beacon-val">0 / 1000</span>
        </div>
        <div class="progress-container" style="background:rgba(255,255,255,0.2); height:15px; border-radius:10px; overflow:hidden;">
            <div id="t-beacon-fill" style="width:0%; height:100%; background:#f6e05e; transition:width 0.5s;"></div>
        </div>
    </div>
    <button id="activate-boost-btn" class="gacha-btn" style="padding:10px; font-size:14px; background:#48bb78; border:none; display:none; width:100%;" onclick="triggerClassBoost()">
        üöÄ ACTIVATE BRAIN BOOST (20 MIN)
    </button>
    <div id="boost-active-msg" style="text-align:center; font-weight:bold; color:#f6ad55; display:none;">
        üî• BOOST IS CURRENTLY ACTIVE!
    </div>
</div>
<!-- üîÑ MATH CYCLE MANAGEMENT (FOR TEACHERS) -->
<div style="background: white; border: 3px solid #ed8936; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
    <h3 style="color:#c05621; margin:0 0 10px 0; display:flex; align-items:center; gap:8px;">üîÑ Cycle Manager</h3>
    <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
        Reset progress when starting a new lesson. Current Topic: <span id="t-active-topic" class="cycle-badge">General Review</span>
    </p>
    <div style="display:flex; gap:10px;">
        <input type="text" id="new-cycle-name" class="login-input" placeholder="e.g. Fractions Week" style="margin:0; flex:1; font-size:14px;">
        <button class="action-btn red" style="width:auto; margin:0; padding:0 20px;" onclick="resetMathCycle()">RESET BOARD</button>
    </div>
</div>
                       <h2 style="font-size:20px; font-weight:bold; margin-bottom:15px;">Create Student Account</h2>
                       <input type="text" id="new-student-user" class="login-input" placeholder="Username">
                       <input type="password" id="new-student-pass" class="login-input" placeholder="Password">
                       <label style="display:block; font-weight:bold; margin-top:10px;">Assign Grade:</label>
                       <select id="new-student-grade" class="login-input">
                           <option value="K">Kindergarten</option>
                           <option value="1">Grade 1</option>
                           <option value="2">Grade 2</option>
                           <option value="3">Grade 3</option>
                           <option value="4">Grade 4</option>
                           <option value="5">Grade 5</option>
                           <option value="6">Grade 6</option>
                       </select>
                       <button class="action-btn green" onclick="createStudentAccount()">Create Account</button>
                       <!-- START OF BULK IMPORT UI -->
<div style="border-top: 2px dashed #cbd5e0; margin-top: 25px; padding-top: 20px;">
    <h2 style="font-size:18px; font-weight:bold; margin-bottom:5px; color:#4a5568;">üìÇ Bulk Import Roster</h2>
    <p style="font-size:11px; color:#718096; margin-bottom:15px;">
        Upload a .csv file with 3 columns: <br>
        <strong>Username, Password, Grade</strong>
    </p>
    <input type="file" id="csv-file-input" accept=".csv" class="login-input" style="font-size: 13px; padding: 8px; background: white; border: 2px solid #cbd5e0;">
    <button class="action-btn blue" id="csv-import-btn" onclick="importStudentsCSV()">üöÄ Upload & Enroll</button>
    <div id="csv-status" style="font-size:12px; margin-top:10px; font-weight:bold; text-align:center;"></div>
</div>
<!-- END OF BULK IMPORT UI -->
                   </div>

                   <!-- 2. CLASS RAID CONTROLS -->
                   <div style="background:#2d3748; padding:20px; border-radius:15px; border:2px solid #4a5568; margin-bottom: 20px; color: white;">
                        <h2 style="color:#f6ad55; font-weight:bold; margin-bottom:10px;">‚ò†Ô∏è Class Raid Boss</h2>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            
                            <!-- Updated Inputs with Dark Background and White Text -->
                            <input type="text" id="t-boss-name" class="login-input" placeholder="Boss Name" value="Titan" 
                                   style="background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="number" id="t-boss-hp" class="login-input" placeholder="HP" value="10000" 
                                   style="background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="number" id="t-boss-atk" class="login-input" placeholder="Atk" value="15" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="text" id="t-boss-img" class="login-input" placeholder="Image URL" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="text" id="t-boss-reward-url" class="login-input" placeholder="Reward JSON" value="events/boss_reward.json" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="action-btn red" onclick="teacherSummonRaid()">SUMMON</button>
                            <button class="action-btn" style="background:#718096;" onclick="teacherEndRaid()">üõë STOP</button>
                        </div>
                   </div>
               </div>

               <!-- RIGHT COLUMN: Student List -->
               <div style="background:#fff; border:2px solid #e2e8f0; border-radius:15px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
                   <div style="background:#f7fafc; padding:15px; border-bottom:2px solid #e2e8f0; font-weight:bold; color:#4a5568; display:flex; justify-content:space-between; align-items:center;">
                       <label style="display:flex; align-items:center; cursor:pointer;">
                           <input type="checkbox" id="select-all-students" onchange="toggleAllStudents(this.checked)" style="margin-right:8px; transform:scale(1.2);">
                           <span>My Students</span>
                       </label>
                       <div>
                           <button class="action-btn blue" style="width:auto; padding:5px 10px; font-size:12px; margin-top:-2px;" onclick="loadStudentList()">Refresh</button>
                           <button class="action-btn" style="width:auto; padding:5px 10px; font-size:12px; margin-top:-2px; background:#d69e2e; margin-left:5px;" onclick="claimLegacyStudents()">‚ö†Ô∏è Claim Old</button>
                       </div>
                   </div>
                   <div id="bulk-action-bar" style="background:#ebf8ff; padding:10px 15px; border-bottom:1px solid #cceeff; display:none; justify-content:space-between; align-items:center;">
                       <span id="bulk-selected-count" style="font-weight:bold; color:#5a67d8;">0 Selected</span>
                       <button class="action-btn green" style="width:auto; padding:5px 10px; font-size:12px;" onclick="openBulkTopicManager()">Assign Topics</button>
                       <button class="action-btn" style="width:auto; padding:5px 10px; font-size:12px; background:#d69e2e; margin-left:5px;" onclick="bulkRewardBP()">üéÅ Reward BP</button>
                   </div>
                   <div id="student-list-container" style="flex:1; overflow-y: auto;">
                       <div style="padding:20px; text-align:center; color:gray;">Loading list...</div>
                   </div>
               </div>
           </div>
       </div>

       <!-- Modals included inside dashboard -->
       <div id="topic-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#5a67d8; margin-bottom:10px;">Manage Student</h2>
               <p id="tm-student-name" style="font-weight:bold; color:#2d3748; margin-bottom:10px;">Student: -</p>
               <div style="margin-bottom:15px; background:#e0f2fe; padding:10px; border-radius:8px; border:1px solid #7dd3fc;">
                   <label style="font-weight:bold; color:#0369a1; font-size:12px; display:block; margin-bottom:5px;">Currently Assigned Lessons:</label>
                   <div id="tm-current-assignments" style="display:flex; flex-wrap:wrap; max-height:80px; overflow-y:auto;"><span style="color:#64748b; font-size:12px;">Loading...</span></div>
               </div>
               <div style="margin-bottom:15px; background:#f7fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                   <label style="font-weight:bold; color:#4a5568; font-size:14px;">Select Grade Source:</label>
                   <select id="tm-grade-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="refreshTopicManagerUI()">
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
               </div>
               <div id="tm-topic-list" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:20px;">Loading...</div>
               <div style="display:flex; gap:10px;">
                   <button class="action-btn blue" onclick="saveStudentTopics()">Save Changes</button>
                   <button class="action-btn red" onclick="document.getElementById('topic-manager-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <div class="modal-overlay" id="teacher-delete-modal" style="z-index:2300;">
           <div class="confirm-modal delete-confirm-modal">
               <div style="font-size: 60px;">üóëÔ∏è</div>
               <h2 style="color: #e53e3e;">Delete Account?</h2>
               <p>Delete <strong id="delete-student-name-display">STUDENT</strong>?</p>
               <div class="confirm-buttons">
                   <button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> 
                   <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Delete</button>
               </div>
           </div>
       </div>
   </div>
       <!-- Modals included inside dashboard -->
       
       <!-- 1. NEW GRADEBOOK MODAL -->
       <div id="gradebook-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2300;">
           <div style="background:white; padding:30px; border-radius:15px; width:800px; max-width:95%; max-height:90vh; display:flex; flex-direction:column;">
               <h2 style="color:#2b6cb0; margin-bottom:20px;">üìä Classroom Gradebook</h2>
               
               <div style="display:flex; gap:10px; margin-bottom:20px;">
                   <select id="gb-grade-select" class="login-input" style="margin:0;" onchange="loadGradebookTests()">
                       <option value="">1. Select Grade</option>
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
                   <select id="gb-test-select" class="login-input" style="margin:0;" onchange="renderGradebook()">
                       <option value="">2. Select Test</option>
                   </select>
               </div>

               <div style="flex:1; overflow-y:auto; border:1px solid #e2e8f0; border-radius:10px;">
                   <table class="gradebook-table">
                       <thead><tr><th>Student</th><th>Score</th><th>Status</th><th>Date</th></tr></thead>
                       <tbody id="gradebook-body"><tr><td colspan="4" style="text-align:center;">Select a Test to view scores.</td></tr></tbody>
                   </table>
               </div>

               <button class="action-btn red" style="margin-top:20px;" onclick="document.getElementById('gradebook-modal').style.display='none'">Close</button>
           </div>
       </div>

       <!-- 2. UPDATED TOPIC MANAGER (With Exam Dropdown) -->
       <div id="topic-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#5a67d8; margin-bottom:10px;">Manage Student</h2>
               <p id="tm-student-name" style="font-weight:bold; color:#2d3748; margin-bottom:10px;">Student: -</p>
               
               <!-- Grade Selector -->
               <div style="margin-bottom:15px; background:#f7fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                   <label style="font-weight:bold; color:#4a5568; font-size:14px;">1. Grade Level:</label>
                   <select id="tm-grade-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="refreshTopicManagerUI()">
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
               </div>

               <!-- Exam Selector (NEW) -->
               <div style="margin-bottom:15px; background:#fff5f5; padding:10px; border-radius:8px; border:1px solid #feb2b2;">
                   <label style="font-weight:bold; color:#c53030; font-size:14px;">2. Assign Active Exam:</label>
                   <select id="tm-exam-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="updateExamStatusDisplay()">
                       <option value="">-- No Exam Assigned --</option>
                   </select>
                   <div id="tm-exam-status" style="margin-top:10px; font-weight:bold; font-size:14px; color:#718096;">Status: ...</div>
               </div>

               <!-- Topic List -->
               <label style="font-weight:bold; color:#4a5568; font-size:14px;">3. Review Topics:</label>
               <div id="tm-topic-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:20px;">Loading...</div>
               
               <div style="display:flex; gap:10px;">
                   <button class="action-btn blue" onclick="saveStudentTopics()">Save Changes</button>
                   <button class="action-btn red" onclick="document.getElementById('topic-manager-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <!-- 3. UPDATED BULK ASSIGN (Now with Exams!) -->
       <div id="bulk-assign-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#48bb78; margin-bottom:10px;">Bulk Assign</h2>
               <p id="bulk-student-count-display" style="margin-bottom:15px; font-weight:bold; color:#2d3748;">...</p>
               
               <!-- 1. Grade Selector -->
               <div style="margin-bottom:15px; background:#f7fafc; padding:10px; border-radius:8px;">
                   <label style="font-weight:bold; color:#4a5568;">1. Target Grade Level:</label>
                   <select id="bulk-grade-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="refreshBulkTopicUI()">
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
               </div>

               <!-- 2. Exam Selector (NEW) -->
               <div style="margin-bottom:15px; background:#fff5f5; padding:10px; border-radius:8px; border:1px solid #feb2b2;">
                   <label style="font-weight:bold; color:#c53030;">2. Assign Exam to All (Optional):</label>
                   <select id="bulk-exam-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;">
                       <option value="">-- Keep Existing / No Change --</option>
                       <!-- Options loaded via JS -->
                   </select>
               </div>
<!-- Choice: Add or Reset -->
<div style="margin-bottom:15px; padding:10px; background:#fff5f5; border-radius:8px; border:1px solid #feb2b2;">
    <label style="display:flex; align-items:center; cursor:pointer; gap:10px;">
        <input type="checkbox" id="bulk-clear-checkbox" style="width:20px; height:20px;">
        <div>
            <span style="font-weight:bold; color:#c53030;">üóëÔ∏è Clear Existing Topics?</span>
            <div style="font-size:10px; color:#718096;">If checked, students will ONLY have the new topics selected below.</div>
        </div>
    </label>
</div>
               <!-- 3. Topic List -->
               <label style="font-weight:bold; color:#4a5568;">3. Add Review Topics:</label>
               <div id="bulk-topic-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:20px;">Loading...</div>
               
               <div style="display:flex; gap:10px;">
                   <button class="action-btn green" onclick="saveBulkStudentTopics()">Apply to Selected</button>
                   <button class="action-btn red" onclick="document.getElementById('bulk-assign-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <!-- 4. EXISTING DELETE MODAL (Unchanged) -->
       <div class="modal-overlay" id="teacher-delete-modal" style="z-index:2300;">
           <div class="confirm-modal delete-confirm-modal">
               <div style="font-size: 60px;">üóëÔ∏è</div>
               <h2 style="color: #e53e3e;">Delete Account?</h2>
               <p>Delete <strong id="delete-student-name-display">STUDENT</strong>?</p>
               <div class="confirm-buttons">
                   <button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> 
                   <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Delete</button>
               </div>
           </div>
       </div>
  </div><!-- Main Game -->
  
  <!-- We add an ID and force it to be hidden initially -->
<div class="game-container" id="main-game-ui" style="display: none;">
   <header class="header">
    <div class="player-info"><span style="font-size: 24px; margin-right: 5px;">üë§</span><div><div style="font-weight: bold; font-size: 16px;" id="display-name">Player</div><div style="font-size: 12px; color: #718096;" id="display-grade">Grade: -</div><button class="lb-rank-btn" onclick="toggleLeaderboard(true)" title="Math Leaderboard">
    <span>üèÜ</span>
    <span class="lb-text-label">Math Leaderboard</span>
</button>
<button class="lb-rank-btn" onclick="toggleQuestBoard(true)" style="background:#fff5f5; border-color:#f56565; color:#c53030; position:relative;">
    <span>üéØ</span>
    <span class="lb-text-label">Daily Quests</span>
    <div id="quest-notif-dot" style="display:none; position:absolute; top:-5px; right:-5px; width:12px; height:12px; background:red; border-radius:50%; border:2px solid white;"></div>
</button>
<button class="logout-btn" onclick="logout()">Logout</button></div>
    <div class="stats-container"><button id="mute-btn" onclick="toggleAudio()" style="background:none; border:none; font-size:24px; cursor:pointer;" title="Mute/Unmute">üîä</button>
    <button onclick="toggleFullscreen()" style="background:none; border:none; font-size:24px; cursor:pointer; margin-right:10px;" title="Fullscreen">‚õ∂</button>
    <div class="stamina-display">‚ö° <span id="stamina-display">100</span>/100</div><div class="currency-display">üß† <span id="bp-display">0</span> BP</div></div>
   </header>
   <nav class="tabs">
       <button class="tab active" data-tab="study" onclick="switchTab('study')">üìö Study</button> 
       <button class="tab" data-tab="hub" onclick="switchTab('hub')">üè† Pet Hub</button> 
       <button class="tab" data-tab="shop" onclick="switchTab('shop')">üõí Shop</button> 
       <button class="tab" data-tab="wilds" onclick="switchTab('wilds')">üå≤ Wilds</button>
       <button class="tab adventure-tab" data-tab="adventure" onclick="switchTab('adventure')">üåü Adventure</button>
       <button class="tab" data-tab="build" onclick="switchTab('build')">üè∞ Build</button>
       <button class="tab" data-tab="tools" onclick="switchTab('tools')">üõ†Ô∏è Tools</button>
       <button class="tab" data-tab="tower" onclick="switchTab('tower')">üóº Tower</button>
   </nav>
   <!-- PRO UI: ADVENTURE HUD & JOURNAL -->
   <div class="adventure-hud" id="adv-hud">
       <div class="hud-pill">
           <span id="hud-pet-icon">üêæ</span>
           <div style="width:100px; height:6px; background:#4a5568; border-radius:3px;">
               <div id="hud-hp-fill" style="width:100%; height:100%; background:#48bb78; border-radius:3px; transition:width 0.3s;"></div>
           </div>
           <span id="hud-hp-text">100/100</span>
       </div>
       <div class="hud-pill" id="hud-combo-pill" style="display:none; border-color:#f6ad55;">
           üî• Math Streak: <span id="hud-combo-val">0</span>
       </div>
   </div>

   <div class="journal-btn" id="journal-trigger" onclick="toggleJournal()">üìú</div>

   <div class="journal-panel" id="journal-panel">
       <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
           <h2 style="margin:0; font-size:20px;">üìú Quest Journal</h2>
           <button class="action-btn red" style="width:40px; margin:0;" onclick="toggleJournal()">X</button>
       </div>
       <div id="journal-content">
           <p style="color:gray;">No active quests. Go explore!</p>
       </div>
   </div>
   <main class="content">
   <section id="screen-study" class="screen active">
       
       <!-- üéì ACTIVE EXAM ALERT CARD (Architect Fix) -->
    <div id="active-exam-card" class="exam-card" style="display: none; margin-bottom: 20px;">
        <div style="font-size: 40px; margin-bottom: 10px;">üìù</div>
        <h2 id="exam-card-title" style="color: #e53e3e; font-weight: bold; font-size: 20px;">Exam Assigned!</h2>
        <p id="exam-card-status" style="color: #718096; font-size: 13px; margin-bottom: 15px;">Your teacher has assigned a test.</p>
        <button id="start-exam-btn" class="login-btn" style="background: #e53e3e; box-shadow: 0 5px 0 #9b2c2c;" onclick="initExamMode()">
            START EXAM NOW
        </button>
    </div>
    
    <!-- NEW: MASTER ENGAGEMENT DASHBOARD -->
    <div class="study-dashboard">
        <!-- ‚õèÔ∏è ARCHAEOLOGY SITE -->
        <div class="excavation-card">
            <div class="fossil-well" id="fossil-well">
                <img id="fossil-icon" src="" class="fossil-img is-fossil">
            </div>
            <div style="flex:1">
                <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold;">
                    <span>MYSTERY DIG</span>
                    <span id="dig-count">0/20</span>
                </div>
                <div class="progress-container">
                    <div id="dig-fill" class="dig-fill"></div>
                </div>
                <div id="dig-hint" style="font-size:9px; color:#a0aec0; margin-top:4px;">Keep solving to uncover the relic!</div>
            </div>
        </div>
        

        <!-- üåü CLASS BEACON -->
        <div class="beacon-card">
            <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold; color:#5a67d8;">
                <span>CLASS GOAL</span>
                <span id="beacon-text">0/1000</span>
            </div>
            <div class="progress-container" style="background:#edf2f7;">
                <div id="beacon-fill" class="beacon-fill"></div>
            </div>
            <div style="font-size:9px; color:#718096; margin-top:4px;">Group Brain Boost: <b>Double XP</b></div>
        </div>
    </div>

    <!-- 1. THE EXAM INTERFACE (Lockdown) -->
    <div id="exam-interface" class="exam-lockdown">
        <div class="exam-header">
            <span>üìù EXAM MODE</span>
            <span id="exam-progress-text">Q 1 / 10</span>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; align-items:center;">
            <div id="exam-visual" style="margin-bottom:20px; max-width:100%;"></div>
            <!-- Question Text + Speaker Button -->
          <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 30px;">
              <div id="exam-q-text" style="font-size:24px; font-weight:bold; text-align:center; color:#2d3748; margin: 0;">...</div>
              <button onclick="readExamQuestion()" class="bg-indigo-500 text-white p-2 rounded-full shadow-md hover:bg-indigo-600 transition duration-150" style="width: 40px; height: 40px; line-height: 1; border:none; cursor:pointer;">üîä</button>
          </div>
            <div id="exam-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; width:100%; max-width:600px;"></div>
        </div>

        <div style="background:#f7fafc;">
            <div id="exam-nav-container" class="nav-grid"></div>
            <div style="padding:15px; display:flex; justify-content:space-between; max-width:800px; margin:0 auto;">
                <button class="action-btn blue" style="width:120px;" onclick="prevExamQ()">‚¨Ö Back</button>
                <button id="exam-next-btn" class="action-btn blue" style="width:120px;" onclick="nextExamQ()">Next ‚û°</button>
            </div>
        </div>
    </div>

    <!-- 2. NEW RESULTS MODAL (Step-by-Step Review) -->
    <div class="modal-overlay" id="exam-results-modal">
        <div class="confirm-modal" style="max-width:700px; width:95%; height:90vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
            
            <!-- Header: Score & Reward -->
            <div style="background:#2d3748; color:white; padding:15px; text-align:center;">
                <h2 id="review-score-header" style="color:white; margin:0; font-size:20px;">Score: ...</h2>
                <div id="review-reward-text" style="font-size:14px; color:#68d391; margin-top:5px;"></div>
            </div>

            <!-- Scrollable Question Area -->
            <div style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; align-items:center;">
                
                <!-- Status Badge (Correct/Wrong) -->
                <div id="review-status-badge" style="margin-bottom:15px; padding:5px 15px; border-radius:15px; font-weight:bold; text-transform:uppercase;">...</div>

                <!-- Visual -->
                <div id="review-visual" style="margin-bottom:20px; max-width:100%;"></div>
                
                <!-- Question Text -->
                <div id="review-q-text" style="font-size:22px; font-weight:bold; text-align:center; margin-bottom:20px; color:#2d3748;">...</div>
                
                <!-- Options Grid (Disabled) -->
                <div id="review-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; width:100%; max-width:600px;"></div>
            </div>

            <!-- Footer: Navigation -->
            <div style="background:#f7fafc; padding:15px; border-top:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <button class="action-btn blue" style="width:100px;" onclick="changeReviewQ(-1)">‚¨Ö Prev</button>
                <div id="review-counter" style="font-weight:bold; color:#4a5568;">Q 1 / 10</div>
                <button class="action-btn blue" style="width:100px;" onclick="changeReviewQ(1)">Next ‚û°</button>
            </div>
            
            <!-- Close Button -->
            <div style="padding:10px; background:white; border-top:1px solid #eee;">
                <button class="confirm-btn yes" style="width:100%;" onclick="closeExamResults()">Finish Review</button>
            </div>
        </div>
    </div>
     <div class="quiz-container">
      <div style="color: #718096; margin-bottom: 10px; font-size: 14px;">Solve to earn Brain Points!</div>
      <div id="question-visual-container" class="my-4 mx-auto" style="max-width: 90%; height: auto; display: flex; justify-content: center;"></div>
      <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;"><div class="question-text" id="question-text" style="margin: 0;">Loading question...</div><button id="tts-speaker-btn" onclick="readQuestionAloud()" class="bg-indigo-500 text-white p-2 rounded-full shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150" style="width: 40px; height: 40px; line-height: 1;">üîä</button></div>
      <div id="input-mode-container"><input type="number" id="answer-input" class="answer-input" placeholder="?"> <br> <button class="submit-btn" id="check-btn" style="margin-top: 20px;">Check Answer</button></div>
      <div id="mcq-mode-container" class="mcq-options" style="display:none"></div>
      <div id="feedback" class="feedback"></div>
     </div>
    </section>
    <section id="screen-build" class="screen" style="padding: 0; height: 100%;">
        <div class="builder-container" id="builder-container">
            
            <!-- 3D Scene -->
            <div class="perspective-container">
                <div id="world" class="scene-3d">
                    <!-- Blocks injected here by JS -->
                </div>
            </div>

            <!-- Hint Overlay -->
            <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; pointer-events: none;">
                üñ±Ô∏è Drag to Rotate ‚Ä¢ Click to Build
            </div>

            <!-- UI Controls -->
            <div class="build-ui">
                <!-- Visitor Entry -->
                <div id="build-main-controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="visit-username" class="login-input" placeholder="Friend's Name" style="margin:0; flex:1; padding:5px; height: 35px;">
                    <button class="action-btn blue" style="width:auto; margin:0; padding:5px 15px; font-size:12px;" onclick="visitFriendLand()">Visit ‚úàÔ∏è</button>
                </div>

                <!-- Visitor Tools (Hidden by default) -->
                <div id="visitor-controls" style="display: none; background: #ebf8ff; padding: 10px; border-radius: 10px; border: 2px solid #4299e1; margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span id="visiting-name" style="font-weight:bold; color:#2b6cb0; font-size: 14px;">Visiting: -</span>
                        <button class="action-btn red" style="width:auto; margin:0; padding:2px 10px; font-size:12px;" onclick="exitVisit()">Exit Land</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="action-btn green" style="font-size:12px; padding:10px;" onclick="giveStar()">‚≠ê Give Star</button>
                        <button class="action-btn blue" style="font-size:12px; padding:10px;" onclick="openComplimentMenu()">üéÅ Compliment</button>
                    </div>
                    <div id="kindness-meter" style="font-size:10px; color:#718096; margin-top:5px; text-align:center;">Kindness Purse: 100/100 BP</div>
                </div>
                <!-- Top Row: Tools -->
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="action-btn red" style="width:auto; padding: 5px 10px; font-size: 12px;" onclick="resetBuilderView()">Reset View</button>
                    <div style="font-weight:bold; font-size:14px; color:#2d3748;">
                        Land: <span id="land-size-display">6x6</span>
                    </div>
                    <button class="action-btn blue" style="width:auto; padding: 5px 10px; font-size: 12px;" onclick="expandLand()">Expand (500 BP)</button>
                </div>

                <!-- Bottom Row: Block Palette -->
                <div class="palette-scroll" id="block-palette">
                    <!-- Javascript will fill this -->
                    <div class="block-btn active">
                        <div>üß±</div>
                        <div class="block-qty">x99</div>
                    </div>
                </div>
            </div>

        </div>
    </section>
    <section id="screen-tools" class="screen">
    <!-- 1. LIBRARY VIEW -->
    <div id="tools-library-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background: #fffbeb; padding: 15px; border-radius: 15px; border: 2px solid #f6ad55;">
            <div>
                <h2 style="color: #d97706; font-size: 24px; margin:0; font-weight: 900;">üßÆ Math Lab</h2>
                <p style="font-size: 12px; color: #b45309; margin:0;">Complete activities to master skills!</p>
            </div>
            
            <!-- Enhanced Grade Filter -->
            <div style="text-align: right;">
                <label style="display:block; font-size: 10px; font-weight: bold; color: #d97706; text-transform: uppercase;">Change Grade:</label>
                <select id="tools-grade-filter" class="login-input" style="width:160px; margin:0; padding:8px; border: 2px solid #f6ad55; cursor:pointer; background: white;" onchange="renderToolsTab()">
                    <option value="All">Show All Grades</option>
                    <option value="K">Kindergarten</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                </select>
            </div>
        </div>

        <div id="tools-grid" class="adventure-grid">
            <!-- Content injected by JS -->
        </div>
    </div>

<div id="tool-player-view">
    <div class="focus-header">
        <!-- Left Side: Title and Score -->
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="active-tool-title" style="color:white; font-weight:bold; font-size:18px;">Tool Name</span>
            <div style="background:#2d3748; padding:8px 20px; border-radius:20px; border:2px solid #48bb78; box-shadow: 0 0 10px rgba(72, 187, 120, 0.3);">
                <span style="color:#a0aec0; font-size:12px; font-weight: bold;">SMART SCORE:</span>
                <span id="focus-score-display" style="color:#48bb78; font-size: 24px; font-weight:bold; font-family:monospace;">0</span>
            </div>
        </div>

        <!-- Middle/Right: The Cheering Pet (Now integrated) -->
        <div class="cheer-zone">
            <div id="pet-speech" class="speech-bubble">Amazing work!</div>
            <div id="cheer-pet-visual"></div>
        </div>

        <!-- Right Side: Exit -->
        <button class="action-btn red" style="width:auto; padding:8px 20px; margin:0;" onclick="exitTool()">üíæ SAVE & EXIT</button>
    </div>

    <div style="flex:1; background:white; position:relative;">
        <iframe id="tool-frame" style="width:100%; height:100%; border:none;" sandbox="allow-scripts allow-modals allow-same-origin allow-popups"></iframe>
    </div>
</div>
    </section>
    <section id="screen-hub" class="screen"><div id="hub-content"></div></section>
    <section id="screen-shop" class="screen"><div id="shop-content"></div></section>
    <section id="screen-wilds" class="screen">
     <div class="wilds-container" id="wilds-menu">
       <div style="font-size: 60px; margin-bottom: 20px;">üå≤üåæüå≤</div>
       <h2 class="section-title">The Wild Grass</h2>
       <p style="margin-bottom: 20px;">Explore to find wild monsters and items!</p>
       <button class="explore-btn" onclick="startExploration()">Explore (Requires Pet)</button>
       <div style="margin-top:20px; border-top: 1px solid #eee; padding-top:20px;">
           <h3 style="color:#d69e2e;">‚öîÔ∏è Multiplayer Arena</h3>
           <p style="font-size:13px; margin-bottom:10px;">Challenge a classmate! (Cost: 100 BP)</p>
           <button class="action-btn blue" onclick="showMultiplayerMenu()">Create / Join Room</button>
           <div style="margin-top: 15px;">
               <button class="action-btn red" onclick="joinRaid()">‚ò†Ô∏è World Boss Raid (Live)</button>
           </div>
       </div>
     </div>
     <div id="multiplayer-menu" style="display:none; text-align:center; padding-top:10px;">
         <h2 style="margin-bottom:20px;">‚öîÔ∏è PVP Arena Lobby</h2>
         <div style="background:#f0f9ff; padding:20px; border-radius:15px; margin-bottom:20px;"><h3>Create Room</h3><p style="font-size:12px; color:#666;">Generate a code for your friend.</p><button class="action-btn green" onclick="createPvPRoom()">Create Room (100 BP)</button></div>
         <div style="background:#fff5f5; padding:20px; border-radius:15px;"><h3>Join Room</h3><p style="font-size:12px; color:#666;">Enter your friend's code.</p><input type="text" id="room-code-input" placeholder="1234" style="padding:10px; border-radius:5px; border:1px solid #ccc; width:100px; text-align:center; font-size:20px; margin:10px 0;"><button class="action-btn blue" onclick="joinPvPRoom()">Join Room</button></div>
         <button class="action-btn red" style="margin-top:20px;" onclick="document.getElementById('multiplayer-menu').style.display='none'; document.getElementById('wilds-menu').style.display='block';">Back</button>
     </div>
     <div id="pvp-lobby-screen" style="display:none; text-align:center; padding-top:40px;">
         <h2 id="pvp-status-msg" style="font-size:24px; margin-bottom:10px; color:#2d3748;">Waiting...</h2>
         <div style="font-size:60px; margin:20px 0; letter-spacing:10px; font-family:monospace; color:#5a67d8;" id="display-room-code">----</div>
         <p id="pvp-host-status"></p>
         <p id="pvp-guest-status"></p>
         <button id="pvp-start-btn" class="action-btn green" style="display:none; width:250px; margin:20px auto;" onclick="startPvPBattle()">START BATTLE! ‚öîÔ∏è</button>
         <button class="action-btn red" style="width:200px; margin:20px auto;" onclick="leavePvPRoom()">Cancel</button>
     </div>
     
     <!-- UPDATED RPG WRAPPER -->
     <div id="rpg-wrapper" style="display:none; text-align:center; padding-top:10px;">
        <div style="background: rgba(0,0,0,0.8); color: white; padding: 5px; border-radius: 8px; font-size: 12px; margin-bottom: 5px; display:flex; justify-content:space-between; align-items:center;">
            <span id="wild-hp-display">HP: --/--</span>
            <span>
                <button class="action-btn green" style="width:auto; padding: 4px 8px; font-size:10px; margin:0;" onclick="quickUseItem('health_potion')">üíä Heal</button>
                <button class="action-btn blue" style="width:auto; padding: 4px 8px; font-size:10px; margin:0;" onclick="quickUseItem('stamina_potion')">‚ö° Energy</button>
            </span>
        </div>
         <div class="rpg-container"><canvas id="rpg-canvas" width="480" height="400"></canvas></div>
         <div class="d-pad"><div class="d-btn d-up" onclick="handleDPad('ArrowUp')">‚¨ÜÔ∏è</div><div class="d-btn d-left" onclick="handleDPad('ArrowLeft')">‚¨ÖÔ∏è</div><div class="d-btn d-down" onclick="handleDPad('ArrowDown')">‚¨áÔ∏è</div><div class="d-btn d-right" onclick="handleDPad('ArrowRight')">‚û°Ô∏è</div></div>
         <div class="controls-hint">Swipe on the map or use the buttons!</div>
         <button class="action-btn red" style="width:100%; max-width: 200px; margin-top:20px;" onclick="stopExploration()">Stop Exploring</button>
     </div>
     
     <div id="battle-ui" class="battle-screen">
    <!-- PRO RAID: FRENZY UI -->
      <div id="raid-frenzy-overlay" class="frenzy-overlay">
          <h2 style="color:#f6ad55; font-size: 24px; margin-bottom:0;">‚ö° MATH FRENZY! ‚ö°</h2>
          <p style="font-size:12px;">Shatter the shield before time runs out!</p>
          <div class="frenzy-timer" id="frenzy-timer">30</div>
          
          <div id="frenzy-math-q" style="font-size: 32px; font-weight: bold; margin: 20px 0;">5 + 5 = ?</div>
          
          <div class="shield-bar-bg"><div id="frenzy-shield-fill" class="shield-bar-fill" style="width: 0%;"></div></div>
          <div id="frenzy-shield-text" style="font-weight:bold; font-size:14px;">SHIELD: 0 / 5</div>

          <div id="frenzy-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; width: 100%; max-width: 400px; margin-top:15px;">
              <!-- Speed Buttons go here -->
          </div>
      </div>
      <div class="battle-arena">
       <div class="battler" id="player-container">
        <div id="battle-player-visual" class="battler-visual">ü•ö</div>
        <div class="hp-bar-container">
            <div id="player-hp-trail" class="hp-bar-trail" style="width: 100%;"></div>
            <div id="player-hp-bar" class="hp-bar" style="width: 100%;"></div>
        </div>
        <div id="player-battle-name" class="battle-name-plate">Player</div>
        <div id="player-hp-text" style="font-size: 14px; margin-top: 2px; font-weight: bold; color:white; text-shadow:1px 1px 2px black;">100/100</div>
       </div>
       
       <div class="battler" id="enemy-container">
        <div id="battle-enemy-visual" class="battler-visual">üëæ</div>
        <div class="hp-bar-container">
            <div id="enemy-hp-trail" class="hp-bar-trail" style="width: 100%;"></div>
            <div id="enemy-hp-bar" class="hp-bar" style="width: 100%;"></div>
        </div>
        <div id="enemy-name" class="battle-name-plate">Enemy</div>
       </div>
      </div>
      
      <div class="battle-ui-panel">
          <div id="battle-actions" class="battle-actions"></div>
      </div>
     </div>
    </section>

    <!-- NEW RAID SCREEN -->
    <section id="screen-raid" class="screen">
        <div id="raid-lobby" style="text-align:center; padding-top: 50px;">
            <h1 style="font-size: 40px; color:#e53e3e;">‚ò†Ô∏è WORLD RAID</h1>
            <p>Join the class to defeat the Titan!</p>
            <button class="action-btn red" style="width: 200px; font-size: 20px;" onclick="joinRaid()">Enter Raid (1 BP)</button>
        </div>

        <div id="raid-arena" style="display:none; height:100%; flex-direction:column;">
            <div class="raid-container">
                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:10px; border-bottom:1px solid #ccc;">
                    <div style="font-weight:bold; color:#e53e3e;">HP: <span id="raid-boss-hp-text">Loading...</span></div>
                    <button class="action-btn" style="width:auto; padding:5px 10px; font-size:12px;" onclick="exitRaid()">Exit</button>
                </div>
                
                <!-- Main Content Split -->
                <div class="raid-split">
                    <!-- Left: Battle Area -->
                    <div style="position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <div class="hp-bar-container" style="height:25px; margin-bottom:10px;">
                            <div id="raid-boss-bar" class="hp-bar" style="width:100%; background: linear-gradient(90deg, #c53030, #9b2c2c);"></div>
                        </div>
                        <div id="raid-boss-visual" style="font-size:120px; transition: transform 0.1s;">üëπ</div>
                        
                        <!-- Player Squad Preview -->
                        <div id="raid-squad-preview" style="display:flex; gap:5px; margin-top:20px; height: 40px;"></div>

                        <!-- Controls -->
                        <div style="margin-top: 20px; width: 100%;">
                            <button id="raid-atk-btn" class="gacha-btn" style="background:#c53030;" onclick="attackRaidBoss()">‚öîÔ∏è ATTACK!</button>
                        </div>
                    </div>

                    <!-- Right: Leaderboard -->
                    <div class="leaderboard-panel">
                        <h3 style="text-align:center; color:#f6ad55; margin-bottom:10px;">üèÜ Top Damage</h3>
                        <div id="raid-leaderboard-list">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- New Adventure Screen with Quest List -->
    <section id="screen-adventure" class="screen">
        <div style="text-align: center; padding: 20px;">
            <h2 style="color: #ed8936; font-size: 24px; margin-bottom: 20px;">üó∫Ô∏è Quest Board</h2>
            
            <!-- LIST OF EVENTS -->
            <div id="adventure-list-view" class="adventure-grid">
                <div style="color:#718096; width:100%;">Loading available quests...</div>
            </div>

            <!-- ACTIVE QUEST VIEW (Hidden by default) -->
            <div id="adventure-play-view" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button class="action-btn red" style="width:auto; padding: 5px 10px;" onclick="exitAdventure()">Quit Quest</button>
                    <span id="quest-title-display" style="font-weight:bold; color: #ed8936;">Quest Title</span>
                </div>
                <div class="rpg-container">
                    <canvas id="adventure-canvas" width="480" height="400" style="background:#2d3748; width:100%; display:block; image-rendering: pixelated;"></canvas>
                </div>
                <div class="dialog-box" id="quest-dialog">
                    <div class="dialog-name" id="quest-npc-name">NPC</div>
                    <div id="quest-text">Hello traveler!</div>
                    <button class="action-btn blue" id="quest-action-btn" style="margin-top: 10px;">Continue</button>
                </div>
                 <div class="d-pad" style="margin-top:10px;">
                    <div class="d-btn d-up" onclick="handleQuestDPad('ArrowUp')">‚¨ÜÔ∏è</div>
                    <div class="d-btn d-left" onclick="handleQuestDPad('ArrowLeft')">‚¨ÖÔ∏è</div>
                    <div class="d-btn d-down" onclick="handleQuestDPad('ArrowDown')">‚¨áÔ∏è</div>
                    <div class="d-btn d-right" onclick="handleQuestDPad('ArrowRight')">‚û°Ô∏è</div>
                </div>
            </div>
        </div>
    </section>
    <section id="screen-tower" class="screen" style="background:#1a202c; color:white;">
    <!-- Lobby View -->
    <div id="tower-lobby" style="text-align:center; padding:20px;">
        <h1 style="font-size:32px; color:#f6e05e; text-shadow: 0 0 10px #b7791f;">üóº INFINITY TOWER</h1>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin:20px 0;">
            <p style="font-size:18px;">Floor: <strong id="current-floor-tag" style="color:#f6ad55;">1</strong></p>
            <p style="font-size:12px; opacity:0.7;">Best: <span id="highest-floor-display">1</span></p>
        </div>
        <div id="tower-squad-preview" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;"></div>
        <button class="gacha-btn" style="background:linear-gradient(to bottom, #5a67d8, #4c51bf);" onclick="startTowerFloor()">‚ö° ASCEND TOWER</button>
<button onclick="resetTowerProgress()" style="background:none; border:none; color:#fc8181; font-size:11px; cursor:pointer; margin-top:15px; text-decoration:underline;">Reset Progress to Floor 1</button>
    </div>

    <!-- Battle Arena View -->
    <div id="tower-arena" style="display:none; height:100%; position:relative; background:#1a202c; overflow:hidden; border-radius:15px;">
        
        <!-- 1. The Visual Stage (Hero Wars Background) -->
        <div class="tower-stage" id="tower-stage-container" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;">
            <!-- Formation and Pets are injected here by JavaScript -->
        </div>

        <!-- 2. Top Controls (Run Button) -->
        <div style="position:absolute; top:10px; right:10px; z-index:500;">
            <button class="action-btn red" style="width:auto; padding:5px 15px; font-size:12px;" onclick="towerConfirmEscape()">RUN üèÉ</button>
        </div>

        <!-- 3. Bottom Command Dashboard (Replaces the old Manual Menu) -->
        <div id="tower-command-bar">
            <div id="tower-pet-name-display" style="color: #a0aec0; font-size: 11px; font-weight: bold; margin-bottom: 5px; text-align: center; text-transform: uppercase;">Commanding: Pet Name</div>
            <div id="tower-moves-list" class="tower-action-grid">
                <!-- Buttons like Attack and Focus are injected here by JS -->
            </div>
        </div>


    </div> <!-- END OF TOWER ARENA -->
</section>

<!-- 4. The Math Pop-up (Centered Overlay) -->
<div id="tower-math-popup" class="tower-math-overlay" style="z-index: 2000;">
     <div id="tower-math-content" style="width:90%; max-width:400px; position:relative;">
         <!-- Question Card injected here -->
     </div>
</div>
   </main>
  </div>
  
  <div class="modal-overlay" id="release-modal"><div class="confirm-modal"><h2>‚ö†Ô∏è Release Pet?</h2><div class="pet-preview" id="release-pet-preview">üê±</div><p id="release-pet-text" style="font-weight: bold; font-size: 18px;">Are you sure you want to release <strong>Cat</strong>?</p><p style="color: #6b7280; font-size: 14px;">This pet will leave your collection forever and return to the wild.</p><div class="confirm-reward">‚úÖ You will receive +10 Brain Points</div><div class="confirm-warning">üö® WARNING: This action cannot be undone!</div><div class="confirm-buttons"><button class="confirm-btn no" id="release-cancel">No, Keep</button> <button class="confirm-btn yes" id="release-confirm">Yes, Release</button></div></div></div>
  <div class="modal-overlay" id="gacha-reveal-modal"><div class="confirm-modal" style="max-width: 800px;"><h2 id="reveal-title">üåü Legendary Summon Results! üåü</h2><p id="reveal-message">You summoned 3 powerful companions!</p><div id="gacha-reveal-container" class="gacha-results"></div><div style="margin-top: 30px;"><button class="confirm-btn yes" onclick="closeGacha()">Awesome!</button></div></div></div>
  <div id="gacha-cinematic-modal"><div class="flash-overlay" id="gacha-flash-overlay"></div><div id="gacha-message" class="evo-message" style="margin-bottom: 50px; font-size: 28px; transition: opacity 1s;">Summoning Legendary Power...</div><div class="summoning-circle" id="summoning-circle"><div class="summoning-core" id="summoning-core"></div></div><div id="pet-reveal-container" style="position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none;"></div><div id="gacha-cinematic-controls" style="position: absolute; bottom: 10%; opacity: 0; transition: opacity 0.5s;"></div></div>
  <!-- EQUIPMENT SELECTION MODAL -->
  <div class="modal-overlay" id="equip-modal">
      <div class="confirm-modal">
          <h2 style="color: #5a67d8;">üéí Equip Item</h2>
          <p id="equip-slot-title">Select a Weapon:</p>
          <!-- List of items you own for this slot -->
          <div id="equip-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto;">
              <!-- Items injected here by JS -->
          </div>

          <div class="confirm-buttons">
              <button class="confirm-btn no" onclick="document.getElementById('equip-modal').classList.remove('active')">Cancel</button>
              <button id="unequip-btn" class="confirm-btn yes" style="background: #e53e3e; display: none;">Unequip Current</button>
          </div>
      </div>
  </div>
  <div class="modal-overlay" id="arena-modal"><div class="confirm-modal"><div style="font-size: 60px; margin-bottom: 10px;">üèüÔ∏è</div><h2 style="color: #d69e2e;">Championship Arena</h2><p style="font-weight: bold; font-size: 18px;">Challenge a Powerful Champion?</p><div style="background: #fffbeb; padding: 15px; border-radius: 10px; border: 2px solid #fbd38d; margin: 15px 0; text-align: left;"><div>üéüÔ∏è <strong>Ticket Cost:</strong> 1</div><div id="arena-ticket-display" style="color: #744210; font-size: 14px; margin-bottom: 10px;">(You have: 0)</div><hr style="border-color: #fbd38d; margin: 10px 0;"><div style="font-size: 14px;"><div>üèÜ <strong>Win:</strong> Rare, Epic, or Legendary Egg</div><div style="color: #e53e3e;">üíÄ <strong>Lose:</strong> -20 Stamina</div></div></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="closeArenaModal()">Leave</button> <button class="confirm-btn yes" id="enter-arena-btn" style="background: #d69e2e;">Fight! ‚öîÔ∏è</button></div></div></div>
  <div class="modal-overlay" id="replace-move-modal"><div class="confirm-modal"><h2 style="color: #4299e1;">üß† Move Relearner</h2><p>Your pet already knows 4 moves!</p><p style="font-size: 14px; color: #718096;">Select a move to <strong>forget</strong> to learn <strong id="new-move-name" style="color: #48bb78;">New Move</strong>:</p><div id="replace-move-list" class="move-replace-list"></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="closeReplaceModal()">Cancel</button></div></div></div>
  <div class="modal-overlay" id="teacher-delete-modal"><div class="confirm-modal delete-confirm-modal"><div style="font-size: 60px; margin-bottom: 10px;">üóëÔ∏è</div><h2 style="color: #e53e3e;">Delete Student Account?</h2><p style="font-weight: bold; font-size: 18px;">Are you sure you want to delete account: <strong id="delete-student-name-display">STUDENT_NAME</strong>?</p><div class="confirm-warning">üö® WARNING: All associated data will be permanently lost! This cannot be undone.</div><div class="confirm-buttons"><button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Yes, Delete Permanently</button></div></div></div>
  <div id="evolution-modal"><div id="evo-message-1" class="evo-message" style="transition: opacity 1s;">...The aura is changing...</div><div id="evo-pet-container" class="evo-pet-visual"></div><div id="evo-message-2" class="evo-message" style="transition: opacity 1s; margin-top: 40px;"></div><button id="evo-continue-btn" class="action-btn green" style="width:200px; padding:12px; margin-top: 40px; display:none;">Continue</button></div>
  <div class="modal-overlay" id="quantity-modal"><div class="confirm-modal"><h2 id="qty-item-name" style="color: #48bb78;">Buy Item</h2><div id="qty-item-visual" class="pet-preview" style="font-size: 50px;">üõí</div><p id="qty-cost-display" style="font-weight: bold; font-size: 16px; color:#92400e; margin-bottom: 20px;">Cost: 0 BP</p><label for="quantity-slider" id="quantity-label" style="display:block; font-weight:bold; margin-bottom:10px;">Quantity: 1</label><input type="range" id="quantity-slider" min="1" max="1" value="1" style="width: 100%; height: 25px; cursor: pointer;"><div style="display:flex; justify-content:space-between; font-size:12px; color:#718096; margin-bottom:20px;"><span>1</span><span id="max-affordable-qty">Max: 1</span></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="document.getElementById('quantity-modal').classList.remove('active');">Cancel</button> <button class="confirm-btn green" id="qty-buy-confirm-btn" style="background: #48bb78;">Buy 1 (0 BP)</button></div></div></div>
  
  <!-- üß¨ EVOLUTION MATH CHALLENGE MODAL -->
  <div class="modal-overlay" id="evo-challenge-modal" style="z-index: 9500;">
      <div class="confirm-modal" style="max-width: 500px; width: 90%; height: auto; padding: 0; overflow: hidden; display:flex; flex-direction:column;">
          
          <!-- Header -->
          <div style="background: #5a67d8; color: white; padding: 15px; font-weight: bold; font-size: 18px; display:flex; justify-content:space-between;">
              <span>üß¨ Evolution Trial</span>
              <span id="evo-chal-score">0 / 3</span>
          </div>

          <!-- Question Area -->
          <div id="evo-chal-content" style="padding: 30px 20px; text-align: center; flex: 1;">
              <!-- Question goes here -->
          </div>

          <!-- Footer (Cancel) -->
          <div style="background: #f7fafc; padding: 10px; border-top: 1px solid #e2e8f0; text-align: center;">
              <button class="confirm-btn no" style="font-size: 12px; padding: 8px 15px;" onclick="closeEvoChallenge()">Give Up</button>
          </div>
      </div>
  </div>

  <div id="hatch-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:6000; flex-direction:column; align-items:center; justify-content:center;">
      <div id="hatch-light" class="hatch-light"></div>
      <div id="hatch-egg-visual" style="font-size:150px;">ü•ö</div>
      <h2 id="hatch-text" style="color:white; margin-top:20px; font-size:32px;">It's hatching!</h2>
      <button id="hatch-finish-btn" class="action-btn green" style="width:200px; display:none; margin-top:20px;">Awesome!</button>
  </div>
  
  <!-- BULK USE MODAL -->
<div class="modal-overlay" id="use-quantity-modal" style="z-index: 4000;">
    <div class="confirm-modal">
        <h2 id="use-qty-title" style="color: #4299e1;">Use Item</h2>
        <div id="use-qty-visual" class="pet-preview" style="font-size: 50px;">üß™</div>
        
        <p id="use-qty-desc" style="font-weight: bold; color:#2d3748; margin-bottom: 20px;">
            You have: 0
        </p>

        <label id="use-qty-label" style="display:block; font-weight:bold; margin-bottom:10px;">
            Use: 1
        </label>
        
        <input type="range" id="use-qty-slider" min="1" max="1" value="1" 
               style="width: 100%; height: 25px; cursor: pointer; accent-color: #4299e1;">
        
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#718096; margin-bottom:20px;">
            <span>1</span>
            <span id="use-qty-max">Max: 1</span>
        </div>

        <div class="confirm-buttons">
            <button class="confirm-btn no" onclick="document.getElementById('use-quantity-modal').classList.remove('active')">
                Cancel
            </button> 
            <button class="confirm-btn yes" id="use-qty-confirm-btn" style="background: #4299e1;">
                Confirm
            </button>
        </div>
    </div>
</div>
  
  <!-- Daily Reward Modal -->
  <div class="modal-overlay" id="daily-modal"><div class="confirm-modal"><h2>üìÖ Daily Reward</h2><p>Welcome back! Keep your streak alive.</p><div class="calendar-grid" id="daily-calendar"></div><button class="confirm-btn green" style="margin-top:20px; width:100%;" onclick="document.getElementById('daily-modal').classList.remove('active')">Collect Reward</button></div></div>
  
  <!-- üèÜ HALL OF FAME MODAL -->
<div class="modal-overlay" id="leaderboard-modal">
    <div class="confirm-modal">
        <div class="leaderboard-header">
            <h2 style="margin:0; color:white; font-size:20px;">üèÜ Top Scholars</h2>
            <button onclick="toggleLeaderboard(false)" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <p style="font-size:12px; color:#718096; margin-top:-10px;">Current Topic: <span id="lb-topic-name" style="font-weight:bold; color:#4299e1;">General Review</span></p>
        
        <div id="scholar-leaderboard-list" style="max-height: 400px; overflow-y: auto;">
            <!-- Names injected here by JS -->
        </div>

        <div class="confirm-buttons" style="margin-top:20px;">
            <button class="confirm-btn no" style="width:100%;" onclick="toggleLeaderboard(false)">Back to Game</button>
        </div>
    </div>
</div>

  <!-- FEATURE 2: TEAM SWAP MODAL -->
  <div class="modal-overlay" id="swap-pet-modal">
    <div class="confirm-modal" style="width: 95%; max-width: 600px;">
        <h2 style="color: #4299e1;">üîÑ Switch Pet</h2>
        <p style="margin-bottom:15px;">Choose a companion to send into battle:</p>
        <div id="swap-list-container" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto; padding:5px;">
            <!-- Pet Cards injected here -->
        </div>
        <div class="confirm-buttons">
            <button class="confirm-btn no" id="swap-cancel-btn" onclick="document.getElementById('swap-pet-modal').classList.remove('active')">Cancel</button>
        </div>
    </div>
  </div>
  

  <script>
// --- PRO INFRASTRUCTURE: UNIVERSAL COMPRESSION DICTIONARY ---
const SAVE_KEYS = {
    // Top-Level State
    // --- 1. CORE PLAYER STATE ---
    brainPoints: 'bp', stamina: 'st', maxStamina: 'mst', inventory: 'inv', 
    team: 'tm', currentPetId: 'cpid', mapX: 'mx', mapY: 'my', 
    dailyStreak: 'ds', lastLoginDate: 'lld', questProgress: 'qp',
    toolHistory: 'th', grade: 'gr', examHistory: 'eh', builder: 'bld',
    playerName: 'pn', lastCycleId: 'lcid', highestTowerFloor: 'htf',
    pets: 'p', mathCorrect: 'mc', mathTotal: 'mt',

    // --- 2. PET DNA & STATS ---
    id: 'id', type: 'tp', name: 'nm', hp: 'hp', maxHP: 'mhp', 
    level: 'lv', xp: 'xp', maxXp: 'mxp', powers: 'pwr', stars: 'str', 
    isHatched: 'ih', hatchProgress: 'hpg', evolutionStage: 'evs', 
    equipment: 'eqp', rarity: 'rty', element: 'el', image: 'img', 
    imageStyle: 'ims', emoji: 'emj', savedEvolutions: 'sevo', badges: 'bdg',

    // --- 3. ITEMS, GEAR & FORGE ---
    instanceId: 'iid', baseId: 'bid', prefix: 'pfx', price: 'prc', 
    description: 'dsc', desc: 'dsc', icon: 'icn', baseStat: 'bst', 
    stat: 'stt', statBonus: 'stb', value: 'val', duration: 'dur', 
    chance: 'chc', effect: 'eff', color: 'clr', healing: 'hel', 
    xpReward: 'xpr', logic: 'lgc', target: 'trg', forgeScraps: 'fgs',

    // --- 4. SOCIAL & QUESTS ---
    givenToday: 'gt', notifications: 'nt', starsReceived: 'sr', 
    badgeInventory: 'bin', isVisiting: 'iv', inBattle: 'ib', 
    burstMode: 'bm', assignedExam: 'ax', selectedTopics: 'st',
    dailyQuests: 'dq', isFirstAttempt: 'ifa',

    // --- 5. BUILDER ENGINE ---
    voxels: 'vx', landSize: 'ls'
};

// --- PRO EQUIPMENT: PREFIX SYSTEM ---
const ITEM_PREFIXES = {
    basic: [
        { name: "Sharp", stat: 5, type: "dmg", rarity: "basic", color: "#4a5568" },
        { name: "Sturdy", stat: 15, type: "hp", rarity: "basic", color: "#4a5568" },
        { name: "Quick", stat: 5, type: "crit", rarity: "basic", color: "#4a5568" }
    ],
    rare: [
        { name: "Flaming", stat: 8, type: "dmg", rarity: "rare", color: "#2b6cb0" },
        { name: "Chilled", stat: 8, type: "dmg", rarity: "rare", color: "#2b6cb0" },
        { name: "Vampiric", stat: 0, type: "lifesteal", value: 0.15, rarity: "rare", color: "#2b6cb0" }
    ],
    legendary: [
        { name: "Scholar's", stat: 0, type: "bp_boost", value: 5, rarity: "legendary", color: "#b7791f" },
        { name: "Ancient", stat: 20, type: "all", rarity: "legendary", color: "#b7791f" }
    ]
};

// --- PRO BUILDER: VOXEL COMPRESSION MAP ---
let VOXEL_MAP = {
    'grass': 'g', 'dirt': 'd', 'stone': 's', 'wood': 'w', 
    'brick': 'b', 'glass': 'i', 'gold': 'o'
};
// This creates a reversed version for loading: { 'g': 'grass', ... }
let VOXEL_LOOKUP = Object.fromEntries(Object.entries(VOXEL_MAP).map(([k, v]) => [v, k]));
    
    // --- GLOBAL GAME STATE DEFINITION ---
    let raidSyncTimer = null;
let localPendingDamage = 0;
let currentEquipSlot = null;
let currentBuyingItem = null;
    let gameState = {
        mathCorrect: 0,
        mathTotal: 0,
        lastCycleId: "",
        playerName: "Student", grade: null, selectedTopics: [],toolHistory: {},isBrainBoosted: false, activeQuestionPool: [], currentQuestion: null, brainPoints: 0, 
        pets: [], currentPetId: null, inventory: {}, inBattle: false, battleState: null, mapX: 2, mapY: 2, stamina: 100, maxStamina: 100, tempMoveToLearn: null,
        combo: 0, burstMode: false, dailyStreak: 0, lastLoginDate: null, questProgress: { active: false, flags: [] },
        questBattleActive: false, questSuccessKey: null, pendingQuestRewardData: null,
    givenToday: 0, notifications: [], starsReceived: 0, isVisiting: false,
    badgeInventory: [], highestTowerFloor: 1, 
    currentTowerFloor: 1,
    towerBattleActive: false,
    team: [] // ADDED: Squad Array
};

    const AUDIO_ASSETS = {
        bgm: { 
            login: "audio/login.mp3", 
            hub: "audio/hub.mp3", 
            wilds: "audio/wild.mp3", 
            battle: "audio/battle.mp3", 
            boss: "audio/boss.mp3", 
            victory: "audio/win.mp3" 
        },
        sfx: { 
            click: "audio/click.mp3", 
            correct: "audio/correct.mp3", 
            wrong: "audio/wrong.mp3", 
            attack: "audio/attack.mp3", 
            hit: "audio/hit.mp3", 
            levelUp: "audio/levelup.mp3", 
            gacha: "audio/gacha.mp3",
            heal: "audio/heal.mp3"
        }
    };

    const soundManager = {
        currentBGM: null, currentBGMKey: null, isMuted: false,
        playBGM: function(key) { 
            if (this.isMuted || this.currentBGMKey === key) return; 
            this.stopBGM(); 
            const url = AUDIO_ASSETS.bgm[key]; 
            if (!url) return; 
            this.currentBGM = new Audio(url); 
            this.currentBGM.loop = true; 
            this.currentBGM.volume = 0.4; 
            this.currentBGM.play().catch(() => {}); 
            this.currentBGMKey = key; 
        },
        stopBGM: function() { 
            if (this.currentBGM) { this.currentBGM.pause(); this.currentBGM.currentTime = 0; this.currentBGM = null; this.currentBGMKey = null; } 
        },
        playSFX: function(key) { 
            if (this.isMuted) return; 
            const url = AUDIO_ASSETS.sfx[key]; 
            if (!url) return; 
            const sfx = new Audio(url); sfx.volume = 0.6; sfx.play().catch(() => {}); 
        },
        toggleMute: function() { 
            this.isMuted = !this.isMuted; 
            if (this.isMuted) { this.stopBGM(); return "üîá"; } 
            else { 
                const t = document.querySelector('.tab.active'); 
                const id = t ? t.dataset.tab : 'hub'; 
                if (gameState.inBattle) this.playBGM(gameState.battleState.isBoss ? 'boss' : 'battle'); 
                else if (id === 'wilds') this.playBGM('wilds'); 
                else this.playBGM('hub'); 
                return "üîä"; 
            } 
        }
    };
    function toggleAudio() { document.getElementById('mute-btn').innerText = soundManager.toggleMute(); }

    const MAP_ROWS = 10;
    const MAP_COLS = 12;

    const MAP_1 = [ [2,2,0,0,0,2,2,0,0,0,2,2], [2,0,0,1,1,1,1,0,0,0,0,2], [0,0,1,1,1,2,2,1,0,0,0,0], [0,0,1,2,2,8,2,2,1,0,0,0], [0,0,1,1,1,2,2,1,1,0,0,0], [0,0,0,0,0,0,0,0,0,0,1,0], [2,1,1,0,0,0,0,0,1,1,1,2], [2,1,0,0,7,0,0,0,0,1,1,2], [2,0,0,0,0,0,0,0,0,0,0,2], [2,2,0,0,0,2,2,0,0,0,2,2] ];
    const MAP_2 = [ [4,4,4,4,4,0,0,4,4,4,4,4], [4,4,9,9,4,4,4,4,9,9,4,4], [4,9,4,4,4,4,4,4,4,4,9,4], [4,9,4,3,3,3,3,3,3,4,9,4], [0,4,4,3,3,8,3,3,3,4,4,0], [0,4,4,3,3,3,3,3,3,4,4,0], [4,9,4,4,4,4,4,4,4,4,9,4], [4,9,9,4,4,4,4,4,4,9,9,4], [4,4,4,4,4,0,0,4,4,4,4,4], [4,4,4,4,4,0,0,4,4,4,4,4] ];
    const MAP_3 = [ [5,5,0,0,5,5,5,5,0,0,5,5], [5,5,0,0,5,5,5,5,0,0,5,5], [5,3,3,3,5,5,5,5,3,3,3,5], [5,3,8,3,5,5,5,5,3,3,3,5], [0,5,5,5,5,2,2,5,5,5,5,0], [0,5,5,5,5,2,2,5,5,5,5,0], [5,9,9,5,5,5,5,5,5,9,9,5], [5,5,5,5,5,7,5,5,5,5,5,5], [5,5,0,0,5,5,5,5,0,0,5,5], [5,5,0,0,5,5,5,5,0,0,5,5] ];
    const MAP_4 = [ [1,1,0,0,1,1,1,1,0,0,1,1], [1,6,6,6,1,1,1,1,6,6,6,1], [0,6,8,6,0,0,0,0,6,6,6,0], [0,6,6,6,0,3,3,0,6,6,6,0], [0,0,0,0,0,3,3,0,0,0,0,0], [0,0,0,0,0,3,3,0,0,0,0,0], [0,6,6,6,0,0,0,0,6,6,6,0], [1,6,6,6,1,1,1,1,6,6,6,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1] ];
    const MAP_5 = [ [0,0,0,0,0,9,9,0,0,0,0,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,9,8,0,0,0,0,0,0,0,9,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,0,0,0,0,9,9,0,0,0,0,0], [0,0,0,0,0,9,9,0,0,0,0,0], [0,9,9,0,0,0,0,0,0,9,9,0], [0,9,7,0,0,9,9,0,0,0,9,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,0,0,0,0,9,9,0,0,0,0,0] ];
    const MAP_6 = [ [3,3,0,0,3,3,3,3,0,0,3,3], [3,0,0,0,0,3,3,0,0,0,0,3], [3,0,4,4,0,3,3,0,4,4,0,3], [3,0,4,8,0,3,3,0,4,4,0,3], [3,3,3,3,3,3,3,3,3,3,3,3], [3,3,3,3,3,3,3,3,3,3,3,3], [3,0,4,4,0,3,3,0,4,4,0,3], [3,0,4,4,0,0,0,0,4,4,0,3], [3,3,0,0,3,3,3,3,0,0,3,3], [3,3,0,0,3,3,3,3,0,0,3,3] ];
    const MAP_7 = [ [2,2,0,0,2,2,2,2,0,0,2,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,1,8,1,2,1,1,2,1,7,1,2], [2,1,1,1,0,0,0,0,1,1,1,2], [0,0,0,0,0,2,2,0,0,0,0,0], [0,0,0,0,0,2,2,0,0,0,0,0], [2,1,1,1,0,0,0,0,1,1,1,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,2,0,0,2,2,2,2,0,0,2,2] ];
    const MAP_8 = [ [4,4,0,0,4,4,4,4,0,0,4,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,0,0,0,0,8,0,0,0,0,0,4], [0,0,9,9,0,0,0,0,9,9,0,0], [0,0,9,9,0,0,0,0,9,9,0,0], [4,0,0,0,0,0,0,0,0,0,0,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,4,0,0,4,4,4,4,0,0,4,4], [4,4,0,0,4,4,4,4,0,0,4,4] ];
    const MAP_9 = [ [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,3,3,3,3,3,3,0,1,1], [1,1,0,3,3,8,3,3,3,0,1,1], [0,0,0,3,3,3,3,3,3,0,0,0], [0,0,0,3,3,3,3,3,3,0,0,0], [1,1,0,3,3,3,3,3,3,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1] ];
    const MAP_10 = [ [9,9,0,0,9,9,9,9,0,0,9,9], [9,5,0,0,5,5,5,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [0,0,0,0,0,8,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,5,5,5,0,0,5,9], [9,9,0,0,9,9,9,9,0,0,9,9] ];

    const MAP_COLLECTION = [
        { data: MAP_1, name: "Mystic Forest" }, { data: MAP_2, name: "Desert Oasis" }, { data: MAP_3, name: "Frozen Tundra" },
        { data: MAP_4, name: "Flower Garden" }, { data: MAP_5, name: "Rocky Wasteland" }, { data: MAP_6, name: "Island Hop" },
        { data: MAP_7, name: "Deep Jungle" }, { data: MAP_8, name: "Ancient Ruins" }, { data: MAP_9, name: "Lakeside Path" },
        { data: MAP_10, name: "Mountain Pass" }
    ];

    let currentMapData = JSON.parse(JSON.stringify(MAP_1));
    let currentMapName = "Mystic Forest";

    const GITHUB_CONFIG = { enabled: true, username: "rye-ai", repo: "MathPetRPG", branch: "main" };
    function getGhUrl(path) { return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`; }
    async function fetchGithubFolder(folderPath) { try { const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${folderPath}?ref=${GITHUB_CONFIG.branch}`); if (res.status === 404 || !res.ok) return []; return await res.json(); } catch (e) { return []; } }
    let currentLoggedTeacher = null; // Stores "MrSmith" after login
    let EXTERNAL_PET_DATA = []; // Now loaded from GitHub
    let QUESTION_REPOSITORY = {}; const LEVEL_CAPS = { common: 50, uncommon: 50, rare: 60, epic: 75, legendary: 100 };
    const BATTLE_BACKGROUNDS = { 1: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur.png', 4: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(1).png', 5: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png', 6: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(2).png', 7: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/%E2%80%9CA%20high-quality%20monster-inspired%20battle%20arena%20in%20landscape%20orientation.%20A%20large%2C%20circular%20stadium%20floor%20made%20of%20smooth%20stone%20tiles%20with%20subtle%20glowing%20patterns.%20Surrounding%20the%20arena%20are%20tall%20stadium%20walls%2C%20bright%20.jpg' }; const ARENA_IMGS = [ 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur.png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(1).png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(2).png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png' ];
    
    const PET_TYPES = {
      common: [
        { id: 'monster_01', name: 'Kittire', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/1.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'normal' },
        { id: 'monster_02', name: 'CaidICE', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/28.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'ice' }, 
        { id: 'monster_03', name: 'KatieDro', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/7.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'water' },
        { id: 'monster_04', name: 'Royalion', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/19.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'electric'] }, 
        { id: 'monster_05', name: 'KingBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/25.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 45, rarity: 'common', element: ['earth', 'normal'] },
        { id: 'monster_06', name: 'Kaifire', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/13.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'shadow'] }, 
        { id: 'monster_07', name: 'Teviphant', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/37.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'shadow'] },
        { id: 'monster_08', name: 'Augustur', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/16.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'ice' },
        { id: 'monster_09', name: 'Luking', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/4.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'water'] },
        { id: 'monster_10', name: 'Kaylight', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/10.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'light' },
        { id: 'monster_11', name: 'Zyfir', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/22.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'fire' }
      ],
      uncommon: [ { id: 'monster_12', name: 'Malachice', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/40.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 50, rarity: 'uncommon', element: 'ice' } ],
      rare: [ { id: 'monster_13', name: 'CaraBrown', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/31.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 60, rarity: 'rare', element: 'earth' } ],
      epic: [ { id: 'monster_14', name: 'Ms.Mckenfish', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/1.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 70, rarity: 'epic', element: 'fire' } ],
      legendary: [ { id: 'monster_15', name: 'Pilandoc', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/34.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 90, rarity: 'legendary', element: ['light', 'fire'] } ],
      event: [] 
    };

    const EVOLUTION_CHAINS = {
      'monster_01': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/2.png', imageStyle: 'blend-multiply', emoji: 'üê±', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/3.png', imageStyle: 'blend-multiply', emoji: 'ü¶Å', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
     'monster_02': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/29.png', imageStyle: 'blend-multiply', emoji: '‚ùÑÔ∏è', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/30.png', imageStyle: 'blend-multiply', emoji: '‚ùÑÔ∏è', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_03': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/8.png', imageStyle: 'blend-multiply', emoji: 'üíß', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/9.png', imageStyle: 'blend-multiply', emoji: 'üíß', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_04': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/20.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/21.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_05': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/26.png', imageStyle: 'blend-multiply', emoji: 'üêª', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/27.png', imageStyle: 'blend-multiply', emoji: 'üêª', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_06': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/14.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/15.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_07': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/38.png', imageStyle: 'blend-multiply', emoji: 'üêò', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/39.png', imageStyle: 'blend-multiply', emoji: 'üêò', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_08': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/17.png', imageStyle: 'blend-multiply', emoji: 'ü¶â', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/18.png', imageStyle: 'blend-multiply', emoji: 'ü¶â', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_09': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/5.png', imageStyle: 'blend-multiply', emoji: 'ü§¥', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/6.png', imageStyle: 'blend-multiply', emoji: 'ü§¥', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_10': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/11.png', imageStyle: 'blend-multiply', emoji: '‚ú®', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/12.png', imageStyle: 'blend-multiply', emoji: '‚ú®', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_11': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/23.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/24.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_12': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/41.png', imageStyle: 'blend-multiply', emoji: 'üßä', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/42.png', imageStyle: 'blend-multiply', emoji: 'üßä', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_13': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/32.png', imageStyle: 'blend-multiply', emoji: 'üü§', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/33.png', imageStyle: 'blend-multiply', emoji: 'üü§', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_14': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/2.png', imageStyle: 'blend-multiply', emoji: 'üê†', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/3.png', imageStyle: 'blend-multiply', emoji: 'üê†', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_15': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/35.png', imageStyle: 'blend-multiply', emoji: 'ü¶å', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/36.png', imageStyle: 'blend-multiply', emoji: 'ü¶å', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'light_bearcat_baby': [
        { name: 'Teen OlaBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/44.png', imageStyle: 'blend-multiply', emoji: 'üêº', rarity: 'legendary', baseHP: 100, cost: 100, level: 10 },
        { name: 'Elder OlaBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/45.png', imageStyle: 'blend-multiply', emoji: 'üêº', rarity: 'legendary', baseHP: 150, cost: 200, level: 20 }
      ]
    };

    let MONSTER_TYPES = [
      { id: 'Bugja', emoji: 'üëæ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/5.png', imageStyle: 'blend-multiply', name: 'Bugja', hp: 30, damage: 8, xp: 15, element: 'grass' },
      { id: 'Plup', emoji: 'üëπ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/3.png', imageStyle: 'blend-multiply', name: 'Plup', hp: 35, damage: 10, xp: 20, element: 'fire' },
      { id: 'Jap', emoji: 'ü¶á', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/1.png', imageStyle: 'blend-multiply', name: 'Jap', hp: 25, damage: 7, xp: 15, element: 'wind' },
      { id: 'Sap', emoji: 'üêç', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/4.png', imageStyle: 'blend-multiply', name: 'Sap', hp: 28, damage: 9, xp: 18, element: 'earth' },
      { id: 'Slimax', emoji: 'üï∑Ô∏è', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/2.png', imageStyle: 'blend-multiply', name: 'Slimax', hp: 32, damage: 8, xp: 18, element: 'water' }
    ];

    let BOSS_TYPES = [
       { id: 'Shadow King', emoji: 'üíÄ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/9.png', imageStyle: 'blend-multiply', name: 'Shadow King', hp: 300, damage: 20, xp: 100, isBoss: true, element: 'shadow' }
    ];
    
    let ARENA_MONSTERS = [
       { emoji: 'üêâ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/7.png', imageStyle: 'blend-multiply', name: 'Krackince', hp: 120, damage: 18, xp: 80, element: 'ice' },
       { emoji: 'ü¶Ö', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/8.png', imageStyle: 'blend-multiply', name: 'Trum', hp: 110, damage: 22, xp: 80, element: 'grass' },
       { emoji: 'ü¶ï', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/6.png', imageStyle: 'blend-multiply', name: 'Draire', hp: 140, damage: 15, xp: 80, element: 'fire' }
    ];

   let SHOP_ITEMS = { 
        egg_items: [ 
            { id: 'premium_food', name: 'Premium Food', icon: 'ü•©', price: 50, desc: 'Adds 20% to hatch progress', effect: 20 }, 
            { id: 'warmer', name: 'Warmer', icon: 'üî•', price: 30, desc: 'Adds 10% to hatch progress', effect: 10 }, 
            { id: 'hatching_machine', name: 'Hatching Machine', icon: '‚öôÔ∏è', price: 100, desc: 'Adds 50% to hatch progress', effect: 50 } 
        ], 
        power_items: [ 
            // BASIC ATTACKS
            { id: 'claw_attack', name: 'Claw Attack', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/2.png', icon: 'ü¶Ö', price: 80, desc: 'Normal damage', damage: 10, element: 'normal' }, 
            
            // ELEMENTAL STATUS ATTACKS
            { 
                id: 'fire_spell', name: 'Fire Spell', 
                image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/1.png', icon: 'üî•', 
                price: 120, desc: 'Burn the target', damage: 15, element: 'fire',
                effect: { type: "burn", value: 5, duration: 3, chance: 0.5 } // <--- NEW!
            }, 
            { 
                id: 'ice_blast', name: 'Ice Blast', 
                image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/4.png', icon: '‚ùÑÔ∏è', 
                price: 110, desc: 'Freezing cold', damage: 12, element: 'ice',
                effect: { type: "freeze", duration: 1, chance: 0.3 } // <--- NEW!
            }, 
            { 
                id: 'thunder_strike', name: 'Thunder Strike', 
                image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/5.png', icon: '‚ö°', 
                price: 150, desc: 'Shocking hit', damage: 18, element: 'electric',
                effect: { type: "stun", duration: 1, chance: 0.25 } // <--- NEW!
            }, 
            { 
                id: 'poison_fang', name: 'Poison Fang', 
                image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/10.png', icon: 'üêç', 
                price: 105, desc: 'Toxic bite', damage: 14, element: 'grass',
                effect: { type: "poison", value: 5, duration: 5, chance: 0.8 } // <--- NEW!
            },
            { 
                id: 'shadow_strike', name: 'Shadow Strike', 
                image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/8.png', icon: 'üåë', 
                price: 130, desc: 'Lifesteal Attack', damage: 16, element: 'shadow',
                effect: { type: "drain", value: 0.05, chance: 0.75 } // <--- NEW! (Heals 50% of damage)
            },

            // STANDARD ATTACKS (No effects, just damage)
            { id: 'quick_dodge', name: 'Cloud Strike', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/3.png', icon: 'üí®', price: 100, desc: 'Normal damage', damage: 15, element: 'normal' }, 
            { id: 'water_wave', name: 'Water Wave', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/6.png', icon: 'üåä', price: 90, desc: 'Soaking wet', damage: 11, element: 'water' }, 
            { id: 'earth_slam', name: 'Earth Slam', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/7.png', icon: 'ü™®', price: 100, desc: 'Rock solid', damage: 13, element: 'earth' }, 
            { id: 'wind_slash', name: 'Wind Slash', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/12.png', icon: 'üå™Ô∏è', price: 95, desc: 'Fast cut', damage: 10, element: 'wind' }, 
            { id: 'light_beam', name: 'Light Beam', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/9.png', icon: '‚ú®', price: 140, desc: 'Holy light', damage: 17, element: 'light' }, 
            { id: 'mega_punch', name: 'Mega Punch', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/11.png', icon: 'üëä', price: 115, desc: 'Heavy hit', damage: 15, element: 'normal' } 
        ],
        consumable_items: [ 
            { id: 'health_potion', name: 'Health Potion', icon: 'üß™', price: 50, desc: 'Restores 30 HP', healing: 30 }, 
            { id: 'stamina_potion', name: 'Stamina Potion', icon: '‚ö°', price: 40, desc: 'Restores 50 Stamina', stamina: 50 }, 
            { id: 'xp_potion', name: 'XP Potion', icon: 'üåü', price: 50, desc: 'Gives 100 XP to active pet', xp: 100 }, 
            { id: 'arena_ticket', name: 'Arena Ticket', icon: 'üéüÔ∏è', price: 150, desc: 'Enter 1 Arena Fight', type: 'ticket' } 
        ] 
    };
    
    // --- THE ARITHMETIC SHIELD ---
// Forces any value to be a safe number. If it's NaN, it resets to fallback.
function safeNum(val, fallback = 0) {
    const n = Math.floor(Number(val));
    return Number.isFinite(n) ? n : fallback;
}

// Centralized BP Updater (Prevents NaN and String-concatenation)
function adjustBP(amount) {
    const current = safeNum(gameState.brainPoints);
    const change = safeNum(amount);
    gameState.brainPoints = Math.max(0, current + change);
    updateStatsDisplay();
    hasUnsavedChanges = true;
}

function adjustStamina(amount) {
    const current = safeNum(gameState.stamina);
    const change = safeNum(amount);
    // This forces stamina to stay between 0 and 100
    gameState.stamina = Math.min(100, Math.max(0, current + change));
    updateStatsDisplay();
    hasUnsavedChanges = true;
}

// --- ‚öñÔ∏è SQUAD LEVEL SYNC ENGINE (REPAIRED & EGG-SAFE) ---
function applySquadLevelSync() {
    if (!gameState.pets || gameState.pets.length < 6) return;

    // 1. Get ONLY hatched pets. Eggs do NOT count toward the floor.
    const hatchedPets = gameState.pets.filter(p => p.isHatched === true);
    
    // 2. If they don't have at least 6 hatched pets, we can't set a floor yet.
    if (hatchedPets.length < 6) return;

    // 3. Sort hatched pets by level (Highest to Lowest)
    const allLevels = hatchedPets
        .map(p => {
            // Find the level using any possible name (lv or level)
            const val = p.level || p.lv || p.lvl || 1;
            return safeNum(val, 1);
        })
        .sort((a, b) => b - a);

    // 4. The 6th pet in the list is our Floor
    const levelFloor = allLevels[5]; 

    // 5. Only sync if the floor is actually worth boosting (higher than 1)
    if (levelFloor <= 1) return;

    let updated = false;
    gameState.pets.forEach(p => {
        const currentLvl = safeNum(p.level || p.lv || p.lvl, 1);
        
        // 6. ONLY boost if the pet is lower than the floor.
        if (currentLvl < levelFloor) {
            console.log(`‚öñÔ∏è Squad Sync: Boosting ${p.name} to Level ${levelFloor}`);
            p.level = levelFloor;
            p.lv = levelFloor;
            
            // Re-calculate stats for the new higher level
            p.maxHP = 50 + (levelFloor * 10);
            p.hp = p.maxHP; 
            p.mhp = p.maxHP;
            p.maxXp = levelFloor * 300 + 200;
            p.xp = 0; 
            updated = true;
        }
    });

    if (updated) {
        hasUnsavedChanges = true;
        // Optional: saveGame(true); // Uncomment if you want it to save to cloud instantly
    }
}

// Centralized Pet HP Updater
function adjustPetHP(pet, amount) {
    if (!pet) return;
    const gear = getPetEquipmentStats(pet);
    const max = safeNum(pet.maxHP) + safeNum(gear.hp);
    const current = safeNum(pet.hp);
    const change = safeNum(amount);
    
    pet.hp = Math.min(max, Math.max(0, current + change));
    hasUnsavedChanges = true;
}

    const MathEngine = {
        generate: (gradeInput) => {
            let grade = gradeInput === 'K' ? 0 : parseInt(gradeInput);
            if (isNaN(grade)) grade = 1;
            let types = ['add'];
            if (grade >= 1) types.push('sub');
            if (grade >= 3) types.push('mul');

            const type = types[Math.floor(Math.random() * types.length)];
            let n1, n2, a, q, htmlQ;
            const baseMax = grade === 0 ? 5 : grade * 10; 

            if (type === 'add') {
                n1 = Math.floor(Math.random() * baseMax);
                n2 = Math.floor(Math.random() * baseMax);
                a = n1 + n2;
                q = `${n1} + ${n2} = ?`;
            } else if (type === 'sub') {
                n1 = Math.floor(Math.random() * baseMax);
                n2 = Math.floor(Math.random() * n1); 
                a = n1 - n2;
                q = `${n1} - ${n2} = ?`;
            } else if (type === 'mul') {
                const limit = grade === 3 ? 5 : 12; 
                n1 = Math.floor(Math.random() * limit);
                n2 = Math.floor(Math.random() * 10);
                a = n1 * n2;
                q = `${n1} √ó ${n2} = ?`;
            }

            if (grade === 0) {
                 const icon = ['üçé','üçå','‚≠ê','üê±'][Math.floor(Math.random()*4)];
                 htmlQ = `<div style="font-size:30px">${icon.repeat(n1)} ${type==='add' ? '+' : '-'} ${icon.repeat(n2)}</div>`;
            } else {
                 htmlQ = `<div style="font-size: 40px; font-weight:bold; color:#2d3748;">${q}</div>`;
            }

            return { q: htmlQ, qVisualHTML: htmlQ, text: q, a: a, options: MathEngine.generateDistractors(a, type) };
        },
        generateDistractors: (answer, type) => {
            let opts = new Set([answer]);
            let range = Math.max(5, Math.ceil(answer * 0.5)); 
            while(opts.size < 4) {
                let offset = Math.floor(Math.random() * (range * 2)) - range;
                let val = answer + offset;
                if(val >= 0 && val !== answer) opts.add(val);
            }
            return Array.from(opts).sort(() => Math.random() - 0.5);
        }
    };

   // --- PRO REGISTRY ENGINE (0% API Usage) ---
let GITHUB_REGISTRY = null;

// --- üè≠ THE MASTER PET FACTORY (The Sanity Filter) ---
function createPetInstance(baseId, customName = null, isHatched = true) {
    let baseData = null;
    // Look in the PET_TYPES object already defined at the top
    for (const rarity in PET_TYPES) {
        const found = PET_TYPES[rarity].find(b => b.id === baseId);
        if (found) { baseData = found; break; }
    }
    if (!baseData) return null;

    const maxHP = Number(baseData.baseHP || baseData.hp || 50);
    return {
        id: 'pet_' + Date.now() + Math.floor(Math.random() * 1000),
        type: baseId,
        name: customName || baseData.name,
        image: baseData.image || "",
        imageStyle: baseData.imageStyle || 'blend-multiply',
        emoji: baseData.emoji || 'üêæ',
        rarity: baseData.rarity || 'common',
        element: baseData.element || 'normal',
        level: 1, xp: 0, maxXp: 100,
        hp: maxHP, maxHP: maxHP,   
        isHatched: isHatched,
        hatchProgress: isHatched ? 100 : 0,
        evolutionStage: 0,
        powers: baseData.powers || ['claw_attack'],
        stars: 0, equipment: {}, badges: [],
        savedEvolutions: EVOLUTION_CHAINS[baseId] || []
    };
}

// --- PHASE 1: THE GATEKEEPER ENGINE ---
// --- üõ°Ô∏è PHASE 1: THE GATEKEEPER (LOADER) ---
async function loadGitHubData() {
    const loginBtn = document.getElementById('login-submit-btn');
    
    if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.innerText = "‚è≥ Syncing Registry...";
        loginBtn.style.background = "#a0aec0";
    }

    if (!GITHUB_CONFIG.enabled) return;

    try {
        console.log("üì° Connecting to GitHub Registry...");
        const registryRes = await fetch(getGhUrl('registry.json'));
        if (!registryRes.ok) throw new Error("Registry not found");
        const registryData = await registryRes.json();

        const directFetch = async (folder, file) => {
            try {
                const safePath = file.split('/').map(part => encodeURIComponent(part)).join('/');
                const res = await fetch(getGhUrl(`${folder}/${safePath}`));
                return res.ok ? await res.json() : null;
            } catch (e) { return null; }
        };

        // A. Load Pets
        if (registryData.pets) {
            for (const file of registryData.pets) {
                const data = await directFetch('pets', file);
                if (data) {
                    const processEntry = (entry) => {
                        const petBlueprint = entry.base ? entry.base : entry;
                        const evolutions = entry.evolutions || null;
                        const r = petBlueprint.rarity || 'common';
                        if (!PET_TYPES[r]) PET_TYPES[r] = [];

                        if (!PET_TYPES[r].find(x => x.id === petBlueprint.id)) {
                            PET_TYPES[r].push(petBlueprint);
                            if (evolutions) EVOLUTION_CHAINS[petBlueprint.id] = evolutions;
                        }
                    };
                    if (Array.isArray(data)) data.forEach(item => processEntry(item));
                    else processEntry(data);
                }
            }
        }

        // B. Load Enemies/Items/Powers
        const enemies = await Promise.all((registryData.enemies || []).map(f => directFetch('enemies', f)));
        enemies.forEach((d, idx) => {
            if (d && Array.isArray(d)) {
                if (registryData.enemies[idx].includes('boss')) BOSS_TYPES = [...BOSS_TYPES, ...d];
                else MONSTER_TYPES = [...MONSTER_TYPES, ...d];
            }
        });

        const items = await Promise.all((registryData.items || []).map(f => directFetch('items', f)));
        items.forEach(d => { if(d) SHOP_ITEMS.equipment = [...(SHOP_ITEMS.equipment||[]), ...d]; });

        const powers = await Promise.all((registryData.powers || []).map(f => directFetch('powers', f)));
        // D. Sync Custom Voxel Blocks (The "Unroller")
        const blockFiles = await Promise.all((registryData.blocks || []).map(f => directFetch('blocks', f)));
        blockFiles.forEach(fileData => { 
            if (fileData && Array.isArray(fileData)) {
                fileData.forEach(block => {
                    // Only add if the ID doesn't exist yet
                    if (!BUILDER_BLOCKS.find(b => b.id === block.id)) {
                        BUILDER_BLOCKS.push(block); 
                        // Add to the save-system compression map
                        const shortId = block.id.substring(0,2);
                        VOXEL_MAP[block.id] = shortId; 
                        VOXEL_LOOKUP[shortId] = block.id;
                    }
                });
            }
        });
        powers.forEach(d => { if(d) SHOP_ITEMS.power_items = [...SHOP_ITEMS.power_items, ...d]; });

        // --- ‚úÖ FINAL SUCCESS HANDSHAKE ---
        console.log("‚úÖ Registry Synchronized Successfully.");
        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.innerText = "Start Adventure! üöÄ";
            loginBtn.style.background = "#48bb78";
            loginBtn.style.cursor = "pointer";
            loginBtn.style.boxShadow = "0 5px 0 #2f855a";
        }

    } catch (e) {
        console.error("‚ùå Registry Sync Failed!", e);
        if (loginBtn) {
            loginBtn.innerText = "‚ö†Ô∏è Offline Mode (Retry)";
            loginBtn.disabled = false;
            loginBtn.style.background = "#f56565";
        }
    }
}

// Immediately trigger the load
loadGitHubData();
// ==========================================
// üöÄ PRO BACKEND ENGINE: COMPRESSION & SYNC
// ==========================================

// --- PRO BACKEND: COMPRESSOR (FIXED FOR INVENTORY) ---
function compressState(state) {
    let compressed = {};
    for (let key in state) {
        // ARCHITECT FIX: Exclude Teacher-controlled fields from the student's personal bundle
        if (['activeQuestionPool', 'battleState', 'currentQuestion', 'questBattleActive', 'pendingQuestRewardData', 'selectedTopics', 'assignedExam'].includes(key)) continue;
        
        const shortKey = SAVE_KEYS[key] || key;
        let value = state[key];

        // 1. Pets Compression
        if (key === 'pets' && Array.isArray(value)) {
            value = value.map(pet => {
                let cp = {};
                const essentials = ['id', 'type', 'name', 'hp', 'maxHP', 'level', 'xp', 'maxXp', 'powers', 'stars', 'isHatched', 'hatchProgress', 'evolutionStage', 'equipment', 'savedEvolutions', 'badges'];
                for (let k in pet) {
                    if (essentials.includes(k)) cp[SAVE_KEYS[k] || k] = pet[k];
                }
                return cp;
            });
        }
        
        // 2. Inventory & Unique Items Compression (FIXED FOR BUILDER BLOCKS)
        if (key === 'inventory' && value) {
            let ci = {};
            for (let k in value) {
                if (k === 'equipment' && Array.isArray(value[k])) {
                    ci.eqp = value[k].map(item => {
                        let cItem = {};
                        for (let prop in item) {
                            if (prop === 'prefix') {
                                let cPfx = {};
                                for (let pk in item.prefix) cPfx[SAVE_KEYS[pk] || pk] = item.prefix[pk];
                                cItem.pfx = cPfx;
                            } else {
                                cItem[SAVE_KEYS[prop] || prop] = item[prop];
                            }
                        }
                        return cItem;
                    });
                } else {
                    // This ensures loose numbers stay inside the 'inv' object
                    ci[SAVE_KEYS[k] || k] = value[k];
                }
            }
            compressed[shortKey] = ci;
            continue;
        }

        // 3. Builder Compression
        if (key === 'builder' && value) {
            let cb = {};
            for (let k in value) {
                if (k === 'voxels') continue;
                cb[SAVE_KEYS[k] || k] = value[k];
            }
            cb.vx = {};
            for (let coord in value.voxels) {
                cb.vx[coord] = VOXEL_MAP[value.voxels[coord].id] || value.voxels[coord].id;
            }
            compressed[shortKey] = cb;
            continue;
        }

        compressed[shortKey] = value;
    }
    return compressed;
}

// --- PRO BACKEND: DECOMPRESSOR (FIXED FOR INVENTORY) ---
function decompressData(data) {
    let state = {};
    const invertedKeys = Object.fromEntries(Object.entries(SAVE_KEYS).map(([k, v]) => [v, k]));

for (let key in data) {
        const longKey = invertedKeys[key] || key;
        let value = data[key];

        // --- üõ°Ô∏è SHIELD 1: TOP-LEVEL NUMBERS (BP, Stamina, etc) ---
        // This forces them to be numbers immediately. No "NaN" can pass here.
        if (['bp', 'st', 'mst', 'mc', 'mt', 'ds', 'htf'].includes(key)) {
            state[longKey] = safeNum(value);
            continue;
        }

        // --- üõ°Ô∏è SHIELD 2: PET DECOMPRESSION ---
        if (longKey === 'pets' && Array.isArray(value)) {
            value = value.map(compressedPet => {
                let dp = {};
                for (let k in compressedPet) dp[invertedKeys[k] || k] = compressedPet[k];
                
                // Force numeric stats for Pet
                dp.hp = safeNum(dp.hp);
                dp.maxHP = safeNum(dp.maxHP, 50);
                dp.level = safeNum(dp.level, 1);
                dp.xp = safeNum(dp.xp);
                dp.maxXp = safeNum(dp.maxXp, 100);
                dp.evolutionStage = safeNum(dp.evolutionStage);

                // Re-sync Image from Registry
                let baseData = null;
                const speciesId = dp.type || dp.tp; // Supports both compressed and long
                for (const rarity in PET_TYPES) {
                    const found = PET_TYPES[rarity].find(b => b.id === speciesId);
                    if (found) { baseData = found; break; }
                }

                if (baseData) {
                    dp.image = baseData.image; 
                    dp.imageStyle = baseData.imageStyle || dp.imageStyle;
                    dp.element = baseData.element;
                    dp.rarity = baseData.rarity;
                    dp.emoji = baseData.emoji;
                    
                    // Keep Evolution visuals
                    const stage = Number(dp.evolutionStage || 0);
                    let chain = EVOLUTION_CHAINS[speciesId] || dp.savedEvolutions || dp.sevo;
                    if (stage > 0 && chain && chain[stage - 1]) {
                        if (chain[stage - 1].image) dp.image = chain[stage - 1].image;
                    }
                }

                // Protect against missing lists
                dp.powers = Array.isArray(dp.powers) ? dp.powers : ['claw_attack'];
                dp.badges = Array.isArray(dp.badges) ? dp.badges : [];
                dp.equipment = (dp.equipment && typeof dp.equipment === 'object') ? dp.equipment : {};

                return dp;
            });
        }
        
        // --- üõ°Ô∏è SHIELD 3: INVENTORY DECOMPRESSION ---
        if (longKey === 'inventory' && value) {
            let di = {};
            for (let k in value) {
                const lk = invertedKeys[k] || k;
                // Handle Equipment List
                if (lk === 'eqp' || lk === 'equipment') {
                    di.equipment = (value[k] || []).map(cItem => {
                        let dItem = {};
                        for (let p in cItem) dItem[invertedKeys[p] || p] = cItem[p];
                        // Cast Item Numbers
                        if (dItem.prefix) dItem.prefix.stat = safeNum(dItem.prefix.stat);
                        dItem.level = safeNum(dItem.level, 1);
                        return dItem;
                    });
                } else {
                    // Handle Consumables (Potions, etc)
                    di[lk] = safeNum(value[k]); 
                }
            }
            state[longKey] = di;
            continue;
        }

        // --- üõ°Ô∏è SHIELD 4: BUILDER ENGINE ---
        if (longKey === 'builder' && value) {
            let db = { landSize: 6, voxels: {}, inventory: {} };
            for (let k in value) {
                const lk = invertedKeys[k] || k;
                if (lk === 'voxels') {
                    for (let coord in value[k]) {
                        const val = value[k][coord];
                        if (typeof val === 'string') db.voxels[coord] = { id: VOXEL_LOOKUP[val] || val };
                        else db.voxels[coord] = val;
                    }
                } else { db[lk] = value[k]; }
            }
            state[longKey] = db;
            continue;
        }

        state[longKey] = value;
    }
    return state;
}

// 3. PRO LOAD: With Legacy Bridge Detect
async function loadProgressFromFirebase(username) {
    try {
        const docSnap = await window.fbase.getDoc(window.fbase.doc(window.db, "students", username));
        if (docSnap.exists()) {
            const cloudData = docSnap.data().saveData;
            // Safety: Sync keys so the game always finds the pet list
            if (cloudData.p && !cloudData.pets) cloudData.pets = cloudData.p;
            if (cloudData.pets && !cloudData.p) cloudData.p = cloudData.pets;
            if (!cloudData) return false;
            
            // Fetch Teacher World Settings
try {
    const studentData = docSnap.data();
    if (studentData.teacherId) {
        const tDoc = await window.fbase.getDoc(window.fbase.doc(window.db, "teachers", studentData.teacherId));
        if (tDoc.exists()) {
            gameState.teacherConfig = tDoc.data();
            console.log("üåç World Settings Loaded:", gameState.teacherConfig);
        }
    }
} catch(e) { console.log("Could not load teacher config"); }

            // --- LEGACY BRIDGE ---
            // Detect if data is already compressed (has tiny keys like 'bp')
            const isCompressed = cloudData.bp !== undefined || cloudData.p !== undefined;
            
            let finalData;
            if (isCompressed) {
                console.log("üì¶ Decompressing Pro Format...");
                finalData = decompressData(cloudData);
            } else {
                console.log("üåâ Legacy Bridge: Converting old save format...");
                finalData = cloudData; // Use as-is, repairSaveData will handle the rest
            }

           // --- ARCHITECT FIX: TEACHER PRIORITY LOAD ---
            // 1. Memoize (remember) what the Teacher assigned at the root
            const teacherTopics = gameState.selectedTopics;
            const teacherExam = gameState.assignedExam;
            const teacherGrade = gameState.grade;

            // 2. Load the student's personal data (Pets, BP, etc.)
            gameState = { ...gameState, ...finalData };
            

            // 3. Force-Restore Teacher's assignments so they aren't overwritten
            gameState.selectedTopics = teacherTopics || [];
            gameState.assignedExam = teacherExam || "";
            gameState.grade = teacherGrade;
            // --------------------------------------------
          // üõ°Ô∏è ARCHITECT FIX: Align local math score with saved math score
            gameState.mathCorrect = finalData.mathCorrect || 0;
            gameState.mathTotal = finalData.mathTotal || 0;
            gameState.teacherId = docSnap.data().teacherId; // Ensure teacher ID is loaded
            repairSaveData();
            updateStatsDisplay();

            // --- COMMUNITY MAILBOX CHECK ---
            if (gameState.notifications && gameState.notifications.length > 0) {
                setTimeout(showMailbox, 3000); 
            }
            // Reset Kindness Purse on New Day
            const today = new Date().toDateString();
            if (gameState.lastLoginDate !== today) {
                gameState.givenToday = 0;
            }

            repairSaveData(); 
            
            updateStatsDisplay();
            return true;
        }
    } catch (e) { console.error("Cloud Load Error:", e); }
    return false;
}

// 4. PRO SAVE: Compression + Dirty State
async function saveProgressToFirebase() {
    
    // --- üö® EMERGENCY BRAKE: DATA LOSS PROTECTION ---
    // If the game thinks the student has 0 pets, it is likely a loading error.
    // We stop the save so we don't accidentally delete their pets in the cloud.
    if (!gameState.pets || gameState.pets.length === 0) {
        console.error("üõë EMERGENCY BRAKE: 0 pets detected. Aborting save to prevent data loss.");
        return false;
    }
    
    // --- NAN CRITICAL STOP ---
    if (!Number.isFinite(gameState.brainPoints)) {
        console.error("‚õî CRITICAL: BP is NaN. Save Aborted to protect Cloud Data.");
        // Try to auto-repair locally before the next heartbeat
        gameState.brainPoints = safeNum(gameState.brainPoints, 0); 
        return false;
    }
    if (!gameState.playerName || !hasUnsavedChanges || gameState.playerName === "Student") return;

    console.log("üïí Heartbeat Sync: Pushing compressed bundle...");
    const compressed = compressState(gameState);

    try {
        const docRef = window.fbase.doc(window.db, "students", gameState.playerName);
        
        // üî• EXPERT FIX: We use setDoc WITHOUT {merge: true} for the saveData field specifically
        // OR we use updateDoc to ensure we don't accidentally create loose fields at the root.
        await window.fbase.updateDoc(docRef, { 
            saveData: compressed, 
            lastSaved: new Date().toISOString() 
        });
        
        hasUnsavedChanges = false; 
        return true;
    } catch (e) { 
        console.error("Firebase Sync Failed. If this is a new user, using setDoc instead...");
        // Fallback for brand new users who don't have a document yet
        const docRef = window.fbase.doc(window.db, "students", gameState.playerName);
        await window.fbase.setDoc(docRef, { 
            saveData: compressed, 
            username: gameState.playerName,
            teacherId: gameState.teacherId || ""
        });
        hasUnsavedChanges = false;
    }
}

// --- PRO BACKEND: IMPROVED SAVE LOGIC ---
function saveGame(forceFirebase = false) {
    if (!gameState.playerName) return;

    // 1. Instant Local Backup
    localStorage.setItem('math_rpg_' + gameState.playerName, JSON.stringify(gameState));
    
    // 2. Mark as Changed
    hasUnsavedChanges = true;

    // 3. Force Sync if requested (Buying/Upgrading)
    if (forceFirebase === true) {
        console.log("üíæ Forced Save: Syncing to Cloud now...");
        saveProgressToFirebase();
    }
}

function repairSaveData() {
    let fixed = false;

    // 1. Repair Basic State & Forge Currency
    if (gameState.combo === undefined) { gameState.combo = 0; fixed = true; }
    if (!gameState.toolHistory) { gameState.toolHistory = {}; fixed = true; }
    if (!gameState.inventory) { gameState.inventory = {}; fixed = true; }
    
    // üõ°Ô∏è SECURITY FIX: Force Scraps to 0 if missing or broken
    if (gameState.inventory.forgeScraps === undefined || isNaN(gameState.inventory.forgeScraps)) { 
        gameState.inventory.forgeScraps = 0; 
        fixed = true; 
    }
    
    // üéØ DAILY QUEST INITIALIZER
    if (!gameState.dailyQuests) {
        gameState.dailyQuests = { lastDate: "", math: 0, combat: 0, social: 0, claimed: [false, false, false] };
        fixed = true;
    }
    if (gameState.isFirstAttempt === undefined) { gameState.isFirstAttempt = true; fixed = true; }
    
    // üõ°Ô∏è TEAM/SQUAD INITIALIZER
    if (!gameState.team || gameState.team.length === 0) { 
        gameState.team = gameState.currentPetId ? [gameState.currentPetId] : []; 
        fixed = true; 
    }
    
    // 2. üè• THE PET DOCTOR (Identity & Schema Insurance)
    if (gameState.pets && Array.isArray(gameState.pets)) {
        // Remove "Ghost" pets (null entries in the list)
        const originalCount = gameState.pets.length;
        gameState.pets = gameState.pets.filter(p => p !== null && p !== undefined && typeof p === 'object');
        if (gameState.pets.length !== originalCount) fixed = true;

        gameState.pets.forEach(p => {
            // A. Identity Insurance: If 'type' is lost, recover it by Name
            if (!p.type || p.type === "undefined") {
                const recoveryMap = { 
                    'Liark': 'liark_01', 'Raygon': 'ray', 'Tyrannosaurus': 'trex_01', 
                    'Groochy': 'tree_01', 'Noahsaur': 'noahsaur_01', 'Ms.Frolch': 'msfrolch_01' 
                };
                if (recoveryMap[p.name]) { p.type = recoveryMap[p.name]; fixed = true; }
            }
            
            // --- üõ°Ô∏è B. THE ICON FIXER (Crucial) ---
            // This forces the icon to match the evolution stage immediately
            const stage = p.evolutionStage || 0;
            if (p.isHatched && stage > 0) {
                let chain = EVOLUTION_CHAINS[p.type];
                if (!chain && p.savedEvolutions) chain = p.savedEvolutions;

                if (chain && chain[stage - 1]) {
                    const correctImg = chain[stage - 1].image;
                    // If the saved image is still the old one, update it!
                    if (p.image !== correctImg) {
                        p.image = correctImg;
                        p.imageStyle = chain[stage - 1].imageStyle || 'blend-multiply';
                        fixed = true; // This triggers a save to the cloud with the right info
                        console.log(`üé® Icon Sync: Updated ${p.name} to evolved form.`);
                    }
                }
            }

            // B. Folder Insurance: Prevents Hub crashing on ".length" errors
            if (!p.powers) { p.powers = []; fixed = true; }
            if (!p.badges) { p.badges = []; fixed = true; }
            if (!p.equipment) { p.equipment = {}; fixed = true; }
            if (p.stars === undefined) { p.stars = 0; fixed = true; }

            // C. Health Aligner: Fixes NaN and immortal pets
           // Look for the level in any key (level, lv, or lvl). If none found, use 1.
        const foundLevel = p.level || p.lv || p.lvl || 1;
        p.level = safeNum(foundLevel, 1);
        p.lv = p.level; // Force both to be the same so the game stays synced
            // Re-calculate the "Fair Max HP" based on level
            const correctMaxHP = 50 + (p.level * 10);
            
            if (isNaN(p.maxHP) || p.maxHP === null || p.maxHP < 50) {
                p.maxHP = correctMaxHP;
                p.hp = p.maxHP;
                fixed = true;
            }
            
            p.hp = Number(p.hp);
            if (isNaN(p.hp) || p.hp > p.maxHP || p.hp === null) { 
                p.hp = p.maxHP; 
                fixed = true; 
            }
        });
    }

    // 3. ‚öñÔ∏è THE FAIRNESS RESET (Global Equipment Level Wipe)
    if (gameState.inventory.equipment && Array.isArray(gameState.inventory.equipment)) {
        gameState.inventory.equipment.forEach(item => {
            if (item.level > 1) { item.level = 1; fixed = true; }
            if (item.prefix) {
                const rarity = item.rarity || 'basic';
                let fairStat = 10; 
                if (rarity === 'rare') fairStat = 15;
                if (rarity === 'legendary') fairStat = 25;
                if (item.prefix.stat > fairStat) { item.prefix.stat = fairStat; fixed = true; }
            }
        });
    }

    // 4. Final Save: Commit the cleanup to the Cloud
    if (fixed) {
        console.log("‚úÖ Auto-Doctor: Database fully repaired and protected.");
        saveGame(true); 
    }
}

    // RPG Variables
    const TILE_SIZE = 40; 
    let canvas, ctx, playerImage = new Image(), arenaIcon = new Image(); const HUMAN_SPRITE_URL = "https://i.imgur.com/J6eL2tY.png"; arenaIcon.src = 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/Copy%20of%20Zyfire%20(1).png';

    function isWalkable(tile) { return tile === 0 || tile === 1 || tile === 4 || tile === 5 || tile === 6; }

    function initRPG() {
      canvas = document.getElementById('rpg-canvas'); ctx = canvas.getContext('2d');
      const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
      if (pet && pet.image && pet.image.length > 5) playerImage.src = pet.image; else playerImage.src = HUMAN_SPRITE_URL; 
      
      injectRandomArena(); 
      playerImage.onload = () => drawMap(); 
      drawMap();
      
      document.removeEventListener('keydown', handleKeyDown); document.addEventListener('keydown', handleKeyDown);
      initSwipe(); 
      
      canvas.addEventListener('click', (e) => {
          if (gameState.inBattle) return; const rect = canvas.getBoundingClientRect(); const clickX = (e.clientX - rect.left) * (canvas.width / rect.width); const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
          const tileX = Math.floor(clickX / TILE_SIZE); const tileY = Math.floor(clickY / TILE_SIZE);
          if (tileX < 0 || tileX >= MAP_COLS || tileY < 0 || tileY >= MAP_ROWS) return;
          if (Math.abs(tileX - gameState.mapX) + Math.abs(tileY - gameState.mapY) <= 2) { const t = currentMapData[tileY][tileX]; if (t === 8) checkArenaEntry(); else if (t === 7) confirmBossBattle(7); }
      });
      
      // Update Wilds HUD
      document.getElementById('wild-hp-display').innerText = `HP: ${pet.hp}/${pet.maxHP}`;
    }

    function drawMap() {
      if (!ctx) return; ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let r = 0; r < MAP_ROWS; r++) {
        for (let c = 0; c < MAP_COLS; c++) {
          const tile = currentMapData[r][c]; const x = c * TILE_SIZE; const y = r * TILE_SIZE;
          if (tile === 2) { ctx.fillStyle = '#2e7d32'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '24px Arial'; ctx.fillStyle = '#1b5e20'; ctx.fillText('üå≤', x+5, y+30); } 
          else if (tile === 3) { ctx.fillStyle = '#4fc3f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#0288d1'; ctx.fillText('~', x+10, y+25); } 
          else if (tile === 1) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#388e3c'; ctx.fillText('w', x+5, y+15); ctx.fillText('w', x+20, y+30); } 
          else if (tile === 4) { ctx.fillStyle = '#f6e05e'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('.', x+10, y+15); ctx.fillText('.', x+25, y+30); }
          else if (tile === 5) { ctx.fillStyle = '#e2e8f0'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#cbd5e0'; ctx.fillText('‚ùÑÔ∏è', x+8, y+26); }
          else if (tile === 6) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#ed64a6'; ctx.fillText('üå∏', x+5, y+28); }
          else if (tile === 9) { ctx.fillStyle = '#4a5568'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '20px Arial'; ctx.fillStyle = '#2d3748'; ctx.fillText('ü™®', x+8, y+28); }
          else if (tile === 7) { ctx.fillStyle = '#2d3748'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#e53e3e'; ctx.fillText('üíÄ', x+10, y+25); } 
          else if (tile === 8) { if (arenaIcon.complete && arenaIcon.naturalWidth > 0) { ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.drawImage(arenaIcon, x, y, TILE_SIZE, TILE_SIZE); } else { ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '18px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('üèüÔ∏è', x+5, y+28); } } 
          else { ctx.fillStyle = '#d7ccc8'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); }
        }
      }
      const px = gameState.mapX * TILE_SIZE; const py = gameState.mapY * TILE_SIZE;
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; ctx.lineWidth = 3; ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE);
      if (playerImage.complete && playerImage.naturalWidth !== 0) ctx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE);
      else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke(); }
      ctx.font = "bold 14px Arial"; ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(5, 5, 120, 25); ctx.fillStyle = "white"; ctx.fillText(currentMapName || "Wilds", 10, 22);
    }

    function handleKeyDown(e) {
        if (activeToolId !== null) return;
        if(gameState.inBattle) return; 
        
        // Prevent scrolling with arrows
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.key) > -1) {
            e.preventDefault(); 
        }

        // Check if we are in Adventure Mode or Wilds Mode
        const isAdventure = document.getElementById('screen-adventure').classList.contains('active');
        const isQuestPlaying = document.getElementById('adventure-play-view').style.display !== 'none';

        if (isAdventure && isQuestPlaying) {
            // Use Adventure Controls
            handleQuestDPad(e.key);
        } else {
            // Use Wilds Controls
            handleDPad(e.key);
        }
    }
    function handleDPad(key) { if (gameState.inBattle) return; let dx = 0; let dy = 0; if (key === 'ArrowUp') dy = -1; if (key === 'ArrowDown') dy = 1; if (key === 'ArrowLeft') dx = -1; if (key === 'ArrowRight') dx = 1; if (dx !== 0 || dy !== 0) tryMove(dx, dy); }
    
    function tryMove(dx, dy) {
      if (gameState.stamina <= 0) { showToast("No Stamina! Study to buy Energy!", "error"); return; }
      const newX = gameState.mapX + dx; const newY = gameState.mapY + dy;
      if (newX < 0) { switchMap('left'); return; } 
      if (newX >= MAP_COLS) { switchMap('right'); return; } 
      if (newY < 0) { switchMap('up'); return; } 
      if (newY >= MAP_ROWS) { switchMap('down'); return; }

      const targetTile = currentMapData[newY][newX];
      if (targetTile === 7) { confirmBossBattle(7); return; } 
      if (targetTile === 8) { checkArenaEntry(); return; }
      if (!isWalkable(targetTile)) return;
      
      gameState.mapX = newX; gameState.mapY = newY; 
      adjustStamina(-1); 
      updateStatsDisplay(); 
      drawMap();
      if ([1,4,5,6].includes(targetTile)) checkEncounter(targetTile);
    }
    
    function injectRandomArena() { let hasArena = false; for(let r=0; r<MAP_ROWS; r++) { for(let c=0; c<MAP_COLS; c++) { if (currentMapData[r][c] === 8) hasArena = true; } } if (!hasArena) { let possibleSpots = []; for(let r=1; r<MAP_ROWS-1; r++) { for(let c=1; c<MAP_COLS-1; c++) { const t = currentMapData[r][c]; if (t === 0 || t === 1 || t === 4 || t === 5) possibleSpots.push({r, c}); } } if (possibleSpots.length > 0) { const spot = possibleSpots[Math.floor(Math.random() * possibleSpots.length)]; currentMapData[spot.r][spot.c] = 8; } } }
    
    function switchMap(d) { 
        // 1. Pick a new random map
        const rand = Math.floor(Math.random() * MAP_COLLECTION.length);
        const selectedMap = MAP_COLLECTION[rand];
        currentMapData = JSON.parse(JSON.stringify(selectedMap.data)); 
        currentMapName = selectedMap.name;
        injectRandomArena(); 

        // 2. Set entry position based on direction
        if (d === 'left') gameState.mapX = MAP_COLS - 1;
        else if (d === 'right') gameState.mapX = 0;
        else if (d === 'up') gameState.mapY = MAP_ROWS - 1;
        else if (d === 'down') gameState.mapY = 0;

        // 3. --- NEW IMPROVED SAFETY CHECK ---
        // If the specific entry tile is a tree/rock, move to a random safe spot
        let safetyAttempts = 0;
        while (!isWalkable(currentMapData[gameState.mapY][gameState.mapX]) && safetyAttempts < 100) {
            // Teleport to a safe random spot inside the map boundaries
            gameState.mapX = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;
            gameState.mapY = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;
            safetyAttempts++;
        }

        drawMap(); 
        showToast(`Entered: ${currentMapName}`, "info"); 
        saveGame(); // Saves the new safe location immediately
    }
    
    function checkEncounter(t) { if (Math.random() < 0.4) startBattle(t, false, false); }
    function confirmBossBattle(t) { if(confirm("‚ö†Ô∏è DANGER! Boss Lair ahead. Fight?")) startBattle(t, true, false); }
    function checkArenaEntry() { if (document.getElementById('arena-modal').classList.contains('active')) return; const t = gameState.inventory['arena_ticket'] || 0; document.getElementById('arena-ticket-display').innerText = `(You have: ${t})`; document.getElementById('arena-modal').classList.add('active'); document.getElementById('enter-arena-btn').onclick = () => { if (t > 0) { gameState.inventory['arena_ticket']--; closeArenaModal(); startBattle(8, false, true); } else { showToast("No tickets!", "error"); closeArenaModal(); } }; }
    function closeArenaModal() { document.getElementById('arena-modal').classList.remove('active'); }

    async function loadAssignmentAndQuestions(a) { if (!a || !a.grade || !a.topics || a.topics.length === 0) { gameState.activeQuestionPool = []; return false; } gameState.activeQuestionPool = []; for (const val of a.topics) { if (val.startsWith('INTERNAL:')) { const k = val.replace('INTERNAL:', ''); const q = QUESTION_REPOSITORY[a.grade][k]; if (q) gameState.activeQuestionPool = gameState.activeQuestionPool.concat(q); } else { try { const res = await fetch(val); if (res.ok) { const q = await res.json(); if (Array.isArray(q)) gameState.activeQuestionPool = gameState.activeQuestionPool.concat(q); } } catch (err) {} } } if (gameState.activeQuestionPool.length === 0) return false; return true; }

    document.getElementById('check-btn').addEventListener('click', () => checkAnswer());
    document.getElementById('answer-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
    document.getElementById('setup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const n = document.getElementById('student-name').value.trim(); const p = document.getElementById('student-pass').value.trim();
      if (!n || !p) { showToast("Enter credentials!", "error"); return; }
      const auth = await authenticateStudent(n, p);
      if (!auth.success) { showToast(auth.message, "error"); return; }
      gameState.playerName = n; loadExternalPets();
      const cloudLoaded = await loadProgressFromFirebase(n);
      rehydrateAllPets(); // Try to find images immediately
      if (!cloudLoaded || gameState.pets.length === 0) if (gameState.pets.length === 0) initializeGame();
      if (auth.assignment) { 
          gameState.grade = auth.assignment.grade; 
          gameState.selectedTopics = auth.assignment.topics || []; 
          gameState.assignedExam = auth.assignment.exam; // <--- NEW: Save to Game State
      }
      await loadAssignmentAndQuestions(auth.assignment);
      checkDailyLogin();
      document.getElementById('display-name').innerText = gameState.playerName; 
      document.getElementById('display-grade').innerText = `Grade: ${gameState.grade}`;
      updateStatsDisplay();
      
      RelicEngine.updateUI(); 
      initClassBeacon();
      
      // --- START OF FIX ---
      
      // 1. Hide the Login Screen completely
      document.getElementById('login-overlay').style.display = 'none';
      
      // 2. Show the Game UI (We use 'flex' to maintain your layout)
      // Note: If this line causes an error, check that your HTML div has id="main-game-ui"
      document.getElementById('main-game-ui').style.display = 'flex'; 
      
      // --- END OF FIX ---
      
      soundManager.playBGM('hub'); 
          generateNextQuestion(); 
          renderHub();
          updateDailyQuests(); // <--- ADD THIS HERE
          initClassBeacon();
          setTimeout(() => { 
              syncToClassLeaderboard(); 
              checkActiveExam(); // Refreshes the Red Card UI
          }, 2000);
        });

    function loadExternalPets() {
        EXTERNAL_PET_DATA.forEach(line => {
            if (PET_TYPES[line.base.rarity]) {
                if (!PET_TYPES[line.base.rarity].find(p => p.id === line.base.id)) { PET_TYPES[line.base.rarity].push(line.base); }
            }
            if (line.evolutions && Array.isArray(line.evolutions)) { EVOLUTION_CHAINS[line.base.id] = line.evolutions; }
        });
    gameState.dailyQuests = {
            lastDate: new Date().toDateString(),
            math: 0, combat: 0, social: 0,
            claimed: [false, false, false]
        };
        gameState.isFirstAttempt = true;
        
    }

    function initializeGame() { 
        console.log("üê£ Initializing New Player Starter Pack...");
        
        // 1. Create Starter Cat using the Factory (The safe machine we just built)
        const starterCat = createPetInstance('monster_01', 'Cat', true);
        
        if (starterCat) {
            gameState.pets.push(starterCat);
            gameState.currentPetId = starterCat.id;
            gameState.team = [starterCat.id]; // Put Cat in the Squad
        }

        // 2. Create Starter Egg using the Factory
        const eggPool = PET_TYPES.common;
        if (eggPool && eggPool.length > 0) {
            const randomBase = eggPool[Math.floor(Math.random() * eggPool.length)];
            const starterEgg = createPetInstance(randomBase.id, "Mystery Egg", false);
            if (starterEgg) {
                gameState.pets.push(starterEgg);
            }
        }

        // 3. Set Starter Resources
        gameState.brainPoints = 100; 
        gameState.stamina = 100; 
        gameState.inventory['arena_ticket'] = 1;
        
        // 4. Set Starter Builder Land
        gameState.builder = {
            landSize: 6,
            voxels: {},
            inventory: { 'grass': 10, 'wood': 5, 'stone': 5 }
        };

        console.log("‚úÖ Starter Pack Created Successfully.");
        saveGame(true); // Force sync to Firebase
    }
    
// ==========================================
// üõ†Ô∏è PRO TOOLS ENGINE: LOCKDOWN & CHEER
// ==========================================

let activeToolId = null;
let activeToolTopic = ""; // New: Remembers the topic for the badge
let lastKnownScore = 0;

// 1. RENDER TOOLS GRID (Shows Badges)
// 1. RENDER TOOLS GRID (Updated with Debugging & Fresh State Logic)
async function renderToolsTab() {
    const grid = document.getElementById('tools-grid');
    const filter = document.getElementById('tools-grade-filter').value;
    grid.innerHTML = '<div style="color:gray; text-align:center; width:100%;">Syncing with Math Lab...</div>';

    try {
        const q = window.fbase.collection(window.toolsDb, "games");
        const snap = await window.fbase.getDocs(q);
        grid.innerHTML = "";
        
        // --- FRESH DATA CHECK ---
        // Ensure we are pulling FRESH data from the global gameState
        const history = gameState.toolHistory || {}; 
        console.log("üìä Badge System checking History:", history);

        snap.forEach(doc => {
            const t = doc.data();
            const matchesGrade = (filter === "All") || (t.grade === filter);
            const isTool = (t.subject === 'math' || t.subject === 'tools');

            if (matchesGrade && isTool) {
                // MATCHING TOOL ID TO HISTORY
                const record = history[doc.id] || { score: 0, claimed: false };
                
                let badge = "";
                let style = "border: 2px solid #ed8936;"; // Default Orange

                // Logic for Mastered (100% or Claimed)
                if (record.claimed === true || record.score >= 100) {
                    badge = `<span style="background:#48bb78; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">‚úÖ MASTERED</span>`;
                    style = "border: 3px solid #48bb78; background:#f0fff4;"; // Green Card
                } 
                // Logic for Progressing (Resume)
                else if (record.score > 0) {
                    badge = `<span style="background:#ecc94b; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">RESUME: ${record.score}%</span>`;
                    style = "border: 3px solid #ecc94b; background:#fffbeb;"; // Yellow Card
                }

                grid.innerHTML += `
                <div class="adventure-card" style="${style}" onclick="launchTool('${doc.id}')">
                    <div class="adventure-header" style="background:linear-gradient(135deg, #d97706, #b45309)">
                        <span>üõ†Ô∏è ${t.title}</span>
                    </div>
                    <div class="adventure-body">
                        <p class="adventure-desc">${t.topic || "Math Lab Activity"}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                            ${badge} 
                            <span style="font-size:10px; color:#718096;">Gr ${t.grade || "All"}</span>
                        </div>
                    </div>
                </div>`;
            }
        });

    } catch (e) { 
        console.error("‚ùå renderToolsTab Error:", e);
        grid.innerHTML = "Connection Error."; 
    }
}

// 2. LAUNCH FOCUS MODE (Lockdown)
async function launchTool(docId) {
    try {
        const docSnap = await window.fbase.getDoc(window.fbase.doc(window.toolsDb, "games", docId));
        if (!docSnap.exists()) return showToast("Tool not found", "error");

        const data = docSnap.data();
        activeToolTopic = data.topic || data.title || "Math Mastery"; // Capture the topic
        activeToolId = docId;

        // 1. Get saved progress
        if (!gameState.toolHistory) gameState.toolHistory = {};
        const record = gameState.toolHistory[docId] || { score: 0, claimed: false };
        
        let startScore = record.claimed ? 0 : (record.score || 0);
        lastKnownScore = startScore;

        // 2. Open the Window
        document.getElementById('tool-player-view').style.display = 'flex';
        document.getElementById('active-tool-title').innerText = data.title + (record.claimed ? " (Review Mode)" : "");
        document.getElementById('focus-score-display').innerText = startScore;
        
        // 3. Set up the Cheering Pet
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        const cheerVis = document.getElementById('cheer-pet-visual');
        cheerVis.innerHTML = pet.image 
            ? `<img src="${pet.image}" class="cheer-pet-img ${pet.imageStyle}">` 
            : `<div style="font-size:80px;">${pet.emoji}</div>`;
        
        updatePetSpeech(`Time for some math, ${gameState.playerName}!`);

        // --- üõ†Ô∏è THE AUTOMATIC BRIDGE ---
        const frame = document.getElementById('tool-frame');
        const bridgeScript = `
            <script>
                // A. Variables for the Tool to find
                window.INITIAL_SCORE = ${startScore};
                window.smartScore = ${startScore};

                // B. Function to talk to RPG
                function submitScore(s) { 
                    window.parent.postMessage({ type: 'TOOL_SCORE', score: s }, '*'); 
                }

                // C. AUTO-RESUME: This forces the tool to use the score even if it doesn't have initGame()
                window.addEventListener('load', () => {
                    // Try to inject into the tool's 'currentScore' variable if it exists
                    if (typeof currentScore !== 'undefined') {
                        currentScore = window.INITIAL_SCORE;
                        if (typeof updateScoreDisplay === 'function') updateScoreDisplay();
                    }
                    // Try to trigger a 'reset' or 'init' if they exist
                    if (typeof initGame === 'function') initGame();
                });
            <\/script>
        `;
        
        frame.srcdoc = bridgeScript + data.htmlCode;
        soundManager.stopBGM();

    } catch (e) { console.error(e); }
}

window.addEventListener('message', (e) => {
    if (!e.data || e.data.type !== 'TOOL_SCORE' || !activeToolId) return;

    const newScore = parseInt(e.data.score) || 0;
    document.getElementById('focus-score-display').innerText = newScore;
    
    if (!gameState.toolHistory) gameState.toolHistory = {};
    let record = gameState.toolHistory[activeToolId] || { score: 0, claimed: false };

    if (newScore > lastKnownScore) {
        const cheers = ["Great job!", "Keep going!", "You're a genius!", "Brain power increasing!"];
        updatePetSpeech(cheers[Math.floor(Math.random() * cheers.length)]);
    }
    lastKnownScore = newScore;

    if (!record.claimed) {
        record.score = newScore;
        gameState.toolHistory[activeToolId] = record;
        
        if (newScore >= 100) {
            record.claimed = true;
            record.score = 100;
            
            // 1. Award BP
            addBP(500);

            // 2. Award Mastery Badge using our saved topic
            const badgeName = activeToolTopic; 
            if (!gameState.badgeInventory.includes(badgeName)) {
                gameState.badgeInventory.push(badgeName);
            }

            // 3. Effects
            updatePetSpeech("üéâ MASTERY! YOU DID IT! üéâ");
            soundManager.playSFX('levelUp');
            
            // 4. Save
            saveGame(true); 

            // 5. Success Ceremony
            triggerRewardCeremony(
                "TOOL MASTERED!", 
                `Perfect Score! +500 BP & ${badgeName} Badge`, 
                "üõ†Ô∏è", 
                null
            );
        } else {
            saveGame(false); 
        }
    }
});

async function exitTool() {
    if (!activeToolId) return;

    const exitBtn = document.querySelector('#tool-player-view .action-btn.red');
    const originalText = exitBtn ? exitBtn.innerText : "EXIT";

    try {
        if (exitBtn) {
            exitBtn.innerText = "‚åõ SAVING...";
            exitBtn.disabled = true;
        }

        console.log("üì° Final Save before closing...");
        // This ensures we wait for Firebase before hiding the screen
        await saveGame(true); 

    } catch (e) {
        console.error("Exit Save Error:", e);
    } finally {
        activeToolId = null;
        const frame = document.getElementById('tool-frame');
        if (frame) frame.srcdoc = ""; 
        
        document.getElementById('tool-player-view').style.display = 'none';
        
        if (exitBtn) {
            exitBtn.innerText = originalText;
            exitBtn.disabled = false;
        }

        soundManager.playBGM('hub');
        renderToolsTab(); 
        showToast("Progress Saved to Cloud", "success");
    }
}

function updatePetSpeech(text) {
    const bubble = document.getElementById('pet-speech');
    if(!bubble) return;
    bubble.innerText = text;
    bubble.style.opacity = 1;
    setTimeout(() => { if(bubble) bubble.style.opacity = 0; }, 4000);
}

// 5. ADMIN: PUBLISH TOOL (Kept for Headmaster Dashboard)
async function adminPublishTool() {
    const title = document.getElementById('admin-tool-title').value;
    const topic = document.getElementById('admin-tool-topic').value;
    const grade = document.getElementById('admin-tool-grade').value;
    const html = document.getElementById('admin-tool-html').value;

    if(!title || !html) return alert("Missing Title or Code!");

    try {
        await window.fbase.addDoc(window.fbase.collection(window.toolsDb, "games"), {
            title: title,
            topic: topic,
            grade: grade,
            htmlCode: html,
            subject: "tools",
            createdAt: new Date().toISOString()
        });
        alert("‚úÖ Tool Published Successfully!");
    } catch(e) {
        alert("Error publishing: " + e.message);
    }
}
    
    
    // --- DAILY LOGIN LOGIC ---
    function checkDailyLogin() {
        const today = new Date().toDateString();
        if (gameState.lastLoginDate !== today) {
            if (isConsecutiveDay(gameState.lastLoginDate, today)) { gameState.dailyStreak++; } else { gameState.dailyStreak = 1; }
            gameState.lastLoginDate = today;
            saveGame();
            showDailyModal();
        }
    }
    function isConsecutiveDay(lastStr, todayStr) {
        if(!lastStr) return false;
        const last = new Date(lastStr); const now = new Date(todayStr);
        const diff = (now - last) / (1000 * 3600 * 24);
        return diff >= 0.9 && diff < 2.1;
    }
    function showDailyModal() {
        const c = document.getElementById('daily-calendar'); c.innerHTML='';
        const days = ['50 BP', 'Potion', '100 BP', 'Potion', '200 BP', 'Rare Egg', 'EPIC EGG!'];
        let streak = gameState.dailyStreak > 7 ? (gameState.dailyStreak % 7) || 7 : gameState.dailyStreak;
        days.forEach((reward, i) => {
            const dayNum = i+1;
            let cls = 'calendar-day';
            if (dayNum < streak) cls += ' claimed';
            if (dayNum === streak) cls += ' active';
            c.innerHTML += `<div class="${cls}"><div>Day ${dayNum}</div><div style="font-weight:bold; font-size:12px;">${reward}</div></div>`;
        });
        
        // Give Reward
        const r = days[streak-1];
        if(r.includes('BP')) addBP(parseInt(r));
        if(r.includes('Potion')) { gameState.inventory['health_potion']=(gameState.inventory['health_potion']||0)+1; showToast("Got Daily Potion!", "success"); }
        if(r.includes('Rare')) { showToast("Free Rare Egg next battle!", "info"); } // Placeholder logic
        document.getElementById('daily-modal').classList.add('active');
    }

    function updateDailyQuests() {
    const today = new Date().toDateString();
    // 1. Daily Reset
    if (gameState.dailyQuests.lastDate !== today) {
        gameState.dailyQuests = {
            lastDate: today,
            math: 0, combat: 0, social: 0,
            claimed: [false, false, false]
        };
        saveGame(true);
    }
    renderQuestBoard();
}

function renderQuestBoard() {
    const dq = gameState.dailyQuests;
    const board = document.getElementById('daily-quest-board');
    if (!board) return;

    const quests = [
        { id: 0, icon: 'üéì', title: 'Scholar', desc: 'Solve 20 Perfect Questions', val: dq.math, target: 20, reward: 500 },
        { id: 1, icon: '‚öîÔ∏è', title: 'Warrior', desc: 'Defeat 5 Wild Monsters', val: dq.combat, target: 5, reward: 100 },
        { id: 2, icon: 'ü§ù', title: 'Citizen', desc: 'Send a Compliment/Heart', val: dq.social, target: 1, reward: 50 }
    ];

    board.innerHTML = quests.map(q => {
        const isDone = q.val >= q.target;
        const isClaimed = dq.claimed[q.id];
        const pct = Math.min(100, (q.val / q.target) * 100);
        
        return `
        <div class="quest-card ${isDone ? 'complete' : ''} ${isClaimed ? 'claimed' : ''}">
            <div class="quest-icon">${q.icon}</div>
            <div class="quest-info">
                <div class="quest-title">${q.title}: ${q.val}/${q.target}</div>
                <div style="font-size:11px; color:#718096;">${q.desc}</div>
                <div class="quest-progress-bg"><div class="quest-progress-fill" style="width:${pct}%"></div></div>
            </div>
            ${isDone && !isClaimed ? `<button class="btn-claim" onclick="claimQuestReward(${q.id}, ${q.reward})">CLAIM ${q.reward}BP</button>` : ''}
            ${isClaimed ? '<div style="color:#48bb78; font-weight:bold;">‚úÖ</div>' : ''}
        </div>`;
    }).join('');
}

function claimQuestReward(id, amount) {
    if (gameState.dailyQuests.claimed[id]) return;
    gameState.dailyQuests.claimed[id] = true;
    addBP(amount);
    soundManager.playSFX('levelUp');
    triggerRewardCeremony("QUEST COMPLETE!", `You earned your daily ${amount} BP reward!`, "üí∞", null);
    renderQuestBoard();
    saveGame(true);
}
    
    function generateNextQuestion() { 
        gameState.isFirstAttempt = true; // Reset first attempt for the new question
        let q;
        if (!gameState.activeQuestionPool || gameState.activeQuestionPool.length === 0) { q = MathEngine.generate(gameState.grade); } 
        else { q = gameState.activeQuestionPool[Math.floor(Math.random() * gameState.activeQuestionPool.length)]; }
        gameState.currentQuestion = q; 
        document.getElementById('question-visual-container').innerHTML = q.qVisualHTML || ''; 
        document.getElementById('question-text').innerHTML = q.q; 
        document.getElementById('feedback').innerText = ''; 
        document.getElementById('input-mode-container').style.display = 'none'; 
        const c = document.getElementById('mcq-mode-container'); c.style.display = 'grid'; c.innerHTML = ''; 
        const options = q.options || MathEngine.generateDistractors(parseFloat(q.a));
        options.forEach(opt => { const b = document.createElement('div'); b.className = 'mcq-btn'; b.innerText = opt; b.onclick = () => checkAnswer(opt); c.appendChild(b); }); 
    }
    
   function openInBattleMath() {
    if (gameState.battleState.turnInProgress) return;

    let q = (gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) 
        ? gameState.activeQuestionPool[Math.floor(Math.random() * gameState.activeQuestionPool.length)] 
        : MathEngine.generate(gameState.grade || "1");

    // Use the Tower Overlay as a Universal Overlay
    const overlay = document.getElementById('tower-math-popup');
    const content = document.getElementById('tower-math-content');
    
    overlay.style.display = 'flex';
    content.innerHTML = `
        <div class="tower-command-box" style="border-color:#5a67d8; color:#2d3748; background:white; padding:20px; border-radius:15px; border:4px solid #5a67d8; text-align:center;">
            <div style="font-weight:bold; color:#5a67d8; margin-bottom:10px;">üß† FOCUSING...</div>
            <div style="font-size:32px; font-weight:bold; margin-bottom:20px;">${q.qVisualHTML || q.q}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${q.options.map(opt => `<button class="mcq-btn" style="min-height:60px; font-size:22px;" onclick="resolveInBattleMath('${opt}', '${q.a}')">${opt}</button>`).join('')}
            </div>
            <button class="action-btn red" style="margin-top:15px; padding:5px; font-size:12px;" onclick="document.getElementById('tower-math-popup').style.display='none'">Cancel</button>
        </div>
    `;
}
    
function resolveInBattleMath(selected, correct) {
    // 1. Hide the pop-up immediately
    document.getElementById('tower-math-popup').style.display = 'none';

    if (selected == correct) {
        soundManager.playSFX('correct');
        gameState.combo = (gameState.combo || 0) + 1;
        addBP(5);
        
        // Legendary Light Aura Heal
        const activePet = gameState.pets.find(p => p.id === gameState.currentPetId);
        if (activePet && activePet.rarity === 'legendary' && activePet.hp > 0) {
            if (activePet.element === 'light' || (Array.isArray(activePet.element) && activePet.element.includes('light'))) {
                const healAmt = Math.floor(activePet.maxHP * 0.05);
                // THE SHIELD: Use adjustPetHP instead of raw math
                adjustPetHP(activePet, healAmt);
                const pVis = document.getElementById('battle-player-visual');
                if(pVis) showFloatingText(pVis.parentElement, `+${healAmt}`, "heal");
            }
        }
        
        if (gameState.combo >= 3) {
            gameState.burstMode = true;
            showToast("üî• BURST READY!", "success");
        } else {
            showToast(`Correct! Combo: ${gameState.combo}/3`, "success");
        }
    } else {
        soundManager.playSFX('wrong');
        gameState.combo = 0;
        showToast("Focus Lost! Combo Reset.", "error");
    }
    
    // Refresh the battle UI to show the new combo/health
    renderBattle(); 
}

    // UPDATED MATH LOGIC: CONNECTS MATH TO BATTLE (BURST MODE)
    // --- SPAM FIX VARIABLE ---
    let isProcessingAnswer = false;

    // UPDATED MATH LOGIC: CONNECTS MATH TO BATTLE (BURST MODE)
    function checkAnswer(val) { 
        // 1. STOP SPAM: If already processing, ignore click
        if (isProcessingAnswer) return;

        let input = val; 
        if (input === undefined) { 
            input = document.getElementById('answer-input').value; 
            if(typeof gameState.currentQuestion.a === 'number') input = parseFloat(input); 
        } 
        
        const fb = document.getElementById('feedback'); 
        
        if (input == gameState.currentQuestion.a) { 
            isProcessingAnswer = true;
            recordMathParticipation(true); 
            soundManager.playSFX('correct'); 

            // --- DAILY QUEST LOGIC ---
            if (gameState.isFirstAttempt) {
                if (!gameState.dailyQuests) updateDailyQuests(); // Safety check
                gameState.dailyQuests.math = Math.min(20, (gameState.dailyQuests.math || 0) + 1);
                checkQuestNotifications(); // This turns on the Red Dot in the header!
            }
            // -------------------------

            let finalReward = gameState.isBrainBoosted ? 20 : 10;
            addBP(finalReward);

            // (Keep your Excavation/Beacon code that you pasted here earlier right below this) 
            
            // --- NEW: EXCAVATION & BEACON UPDATE ---
            gameState.digProgress = (gameState.digProgress || 0) + 1;
            if (gameState.digProgress >= 20) {
                gameState.digProgress = 0;
                RelicEngine.grantReward();
            } else {
                RelicEngine.updateUI();
            }
            if (gameState.teacherId) {
                const bRef = window.fbase.doc(window.db, "class_stats", `beacon_${gameState.teacherId}`);
                window.fbase.updateDoc(bRef, { totalEnergy: window.fbase.increment(1) }).catch(() => {
                    window.fbase.setDoc(bRef, { totalEnergy: 1, teacherId: gameState.teacherId });
                });
            }
            
            // COMBO LOGIC
            gameState.combo = (gameState.combo || 0) + 1;
            
            if (gameState.combo >= 3) {
                gameState.burstMode = true; 
                fb.innerText = "üî• BRAIN BURST ACTIVATED! Next Attack CRIT! üî•";
                fb.className = "feedback correct";
                // Visual feedback
                document.querySelector('.quiz-container').style.boxShadow = "0 0 30px #f6e05e";
            } else {
                fb.innerText = `Correct! Streak: ${gameState.combo}`; 
                fb.className = "feedback correct";
                document.querySelector('.quiz-container').style.boxShadow = "none";
            }
            
            // Dim buttons to show they are locked
            document.querySelectorAll('.mcq-btn').forEach(btn => btn.style.opacity = "0.5");

            setTimeout(() => {
                generateNextQuestion(); 
                // 3. UNLOCK: Allow clicks again
                isProcessingAnswer = false;
                
                // Reset visual glow
                if(gameState.combo < 3) document.querySelector('.quiz-container').style.boxShadow = "none";
            }, 1000); 

        } else {
            gameState.isFirstAttempt = false; // They missed it! No longer counts for the quest
            recordMathParticipation(false);
            // Wrong Answer (No lock needed here)
            const d = Math.min(safeNum(gameState.brainPoints), 5); 
            adjustBP(-d); 
            updateStatsDisplay(); 
            
            gameState.combo = 0; 
            gameState.burstMode = false; 
            document.querySelector('.quiz-container').style.boxShadow = "none";
            
            saveGame(); 
            fb.innerText = `Incorrect! -${d} BP`; 
            fb.className = "feedback incorrect"; 
            soundManager.playSFX('wrong'); 
        } 
    }
   function addBP(a) {
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    const gear = getPetEquipmentStats(pet);
    
    const bonus = Math.floor(Number(gear.bpBoost || 0));
    const amount = safeNum(a);
    const total = amount + bonus;
    
    // THE SHIELD: Use adjustBP instead of +=
    adjustBP(total);
    
    if (bonus > 0 && amount > 0) showToast(`+${total} BP (Scholar Bonus!)`, "success");
}

    // --- SQUAD SYSTEM ---

    // 1. Toggle Logic
    function toggleSquadMember(petId) {
        if (!gameState.team) gameState.team = [];
        
        const idx = gameState.team.indexOf(petId);
        if (idx > -1) {
            if (gameState.team.length <= 1) return showToast("Squad cannot be empty!", "error");
            gameState.team.splice(idx, 1);
            showToast("Removed from Squad", "info");
        } else {
            if (gameState.team.length >= 6) return showToast("Squad Full (Max 6)!", "error");
            gameState.team.push(petId);
            showToast("Added to Squad", "success");
        }
        saveGame();
        renderHub(); // Refresh UI
    }

    // 2. Helper: Get Squad Objects
    function getSquad() {
        if (!gameState.team || gameState.team.length === 0) return [gameState.pets.find(p => p.id === gameState.currentPetId)];
        return gameState.team.map(id => gameState.pets.find(p => p.id === id)).filter(p => p !== undefined);
    }

    function renderHub() {
      const c = document.getElementById('hub-content'); 
      if (!c) return; 

      // 1. ATTEMPT TO FIND THE PET
      let p = gameState.pets.find(pet => pet.id === gameState.currentPetId);

      // 2. THE SELF-HEALER: If currentPetId is wrong, pick the first pet in the list
      if (!p && gameState.pets.length > 0) {
          console.warn("ü©π Pet pointer was broken. Auto-fixing...");
          p = gameState.pets[0];
          gameState.currentPetId = p.id;
      }

      // 3. THE SAFETY NET: If they have NO pets, show a message instead of crashing
      if (!p) { 
          c.innerHTML = `
            <div style="text-align:center; padding:50px; color:#4a5568;">
                <div style="font-size:80px; margin-bottom:20px;">ü•ö</div>
                <h2 style="font-size:24px; font-weight:bold;">No Pets Found</h2>
                <p style="margin-bottom:20px;">Your collection is empty! Visit the shop or solve math to find an egg.</p>
                <button class="action-btn blue" onclick="switchTab('shop')" style="max-width:200px; margin:0 auto;">Visit Shop</button>
            </div>`; 
          return; 
      }

      // 4. DATA RE-HYDRATION: If image is missing, restore it from Registry
      if (p.isHatched && !p.image) {
          for (const rarity in PET_TYPES) {
              const baseData = PET_TYPES[rarity].find(b => b.id === p.type);
              if (baseData) {
                  p.image = baseData.image;
                  p.imageStyle = baseData.imageStyle;
                  p.element = p.element || baseData.element;
                  p.emoji = p.emoji || baseData.emoji;
                  p.maxHP = p.maxHP || baseData.baseHP;
                  break;
              }
          }
      }
      
      // 4.5 DATA HARDENING: Ensure arrays exist so the UI doesn't crash on .length
      if (!p.powers || !Array.isArray(p.powers)) {
          console.log("ü©π Fixing missing powers for: " + p.name);
          p.powers = ['claw_attack']; // Give them a basic move so they aren't stuck
      }
      if (!p.badges || !Array.isArray(p.badges)) {
          p.badges = [];
      }
      if (!p.equipment || typeof p.equipment !== 'object') {
          p.equipment = {};
      }

      // 5. AUTO-REPAIR: Evolution Image Logic (Safely Wrapped)
      if (p.isHatched) {
          let chain = EVOLUTION_CHAINS[p.type];
          if (!chain && p.savedEvolutions) { chain = p.savedEvolutions; EVOLUTION_CHAINS[p.type] = p.savedEvolutions; }

          if (chain && Array.isArray(chain)) {
              if (p.evolutionStage === 1 && chain[0]?.image && p.image !== chain[0].image) {
                  p.image = chain[0].image; p.imageStyle = chain[0].imageStyle || p.imageStyle;
                  if(chain[0].element) p.element = chain[0].element;
                  saveGame(); 
              } else if (p.evolutionStage >= 2 && chain[1]?.image && p.image !== chain[1].image) {
                  p.image = chain[1].image; p.imageStyle = chain[1].imageStyle || p.imageStyle;
                  if(chain[1].element) p.element = chain[1].element;
                  saveGame(); 
              }
          }
      }

      // --- END OF PROTECTION BLOCK ---
      // ----------------------------------------------------
      // Calculate gear bonuses for display
      const gear = getPetEquipmentStats(p);
      const displayMaxHP = p.maxHP + gear.hp;
      // Mastery Slot Logic
      // üõ°Ô∏è UI SHIELD: Prevents crash if badges are missing
      const currentBadges = p.badges || []; 
      const totalSlots = p.level >= 30 ? 3 : (p.level >= 15 ? 2 : 1);
      const emptySlots = Math.max(0, totalSlots - currentBadges.length);

      let masteryHTML = `<div style="display:flex; gap:5px; margin-top:5px; justify-content:center;">`;
      for(let i=0; i<3; i++) {
          const badge = currentBadges[i];
          const isLocked = i >= totalSlots;
          const style = isLocked ? "background:#cbd5e0; opacity:0.5;" : (badge ? "background:#ebf8ff; border:2px solid #5a67d8;" : "background:white; border:2px dashed #cbd5e0;");
          const icon = isLocked ? "üîí" : (badge ? "üèÖ" : "");
          const title = isLocked ? `Lvl ${i === 1 ? 15 : 30}` : (badge || "Empty");
          
          masteryHTML += `<div style="${style} width:40px; height:40px; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:14px;" title="${title}">${icon}<div style="font-size:8px; font-weight:bold;">${title}</div></div>`;
      }
      masteryHTML += `</div>`;
      
      if (!p) { c.innerHTML = "<div class='no-pet-message'>No pet selected.</div>"; return; }
      
      // Safety Checks
      if (!gameState.team) gameState.team = [p.id]; 
      if (!p.equipment) p.equipment = {}; 
      if (!p.stars) p.stars = 0; // Initialize Stars
      
      if(!p.level) p.level = 1; 
      if(!p.xp) p.xp = 0; 
      if(!p.maxXp) p.maxXp = 100; 
      const currentStage = typeof p.evolutionStage === 'number' ? p.evolutionStage : 0;
      
      let v = p.image ? `<img src="${p.image}" class="pet-image ${p.imageStyle||''}" alt="${p.name}">` : `<div style="font-size:80px">${p.emoji}</div>`;
      
      // 1. INCUBATOR VIEW (If egg)
      if (!p.isHatched) { 
          c.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <h2>ü•ö Incubator</h2>
                <div class="pet-visual" style="font-size:100px;">ü•ö</div>
                <h3>Mystery Egg</h3>
                
                <div style="margin:20px 0;">
                    ${p.hatchProgress}% 
                    <div class="hatch-bar-container"><div class="hatch-bar" style="width: ${p.hatchProgress}%;"></div></div>
                </div>

                <!-- Action Buttons Container -->
                <div style="display:flex; flex-direction:column; gap:10px; max-width:280px; margin: 0 auto;">
                    ${p.hatchProgress >= 100 
                        ? `<button class="action-btn green" onclick="hatchPet()">‚ú® HATCH NOW! ‚ú®</button>` 
                        : `<p style="color:#718096; font-size:12px;">Use Items in Shop to speed up!</p>`
                    }
                    <!-- THE NEW SELL BUTTON -->
                    <button class="action-btn" style="background:#ed8936; color:white; box-shadow: 0 4px 0 #c05621;" onclick="sellEgg()">
                        üí∞ Sell Egg (+50 BP)
                    </button>
                </div>

                <div style="margin-top:20px;">${renderInventory(true)}</div>
            </div>
            <div class="pet-collection">${renderCollection()}</div>`; 
          return; 
      }
      
      // --- STAR DISPLAY ---
      let starHTML = "";
      for(let i=0; i<5; i++) {
          starHTML += (i < p.stars) ? "‚òÖ" : "‚òÜ";
      }
      // --------------------

      // --- BUTTON LOGIC ---
      let actionButton = "";
      if (p.stars < 5) {
          actionButton = `<button class="action-btn blue" style="margin-top:5px;" onclick="openFuseMenu()">‚öóÔ∏è Fuse (+Star)</button>`;
      } else {
          // 5 Stars Reached! Check Level.
          if (p.level >= 25) {
              actionButton = `<button class="gacha-btn" style="margin-top:5px; font-size:16px;" onclick="startUltraEvolve()">üß¨ ULTRA EVOLVE</button>`;
          } else {
              actionButton = `<button class="action-btn" disabled style="background:#cbd5e0; margin-top:5px;">üîí Ultra (Need Lvl 25)</button>`;
          }
      }
      // --------------------

      // Evolution Check
      let ch = EVOLUTION_CHAINS[p.type]; 
      if (!ch && p.savedEvolutions) {
          ch = p.savedEvolutions;
          EVOLUTION_CHAINS[p.type] = p.savedEvolutions;
      }
      const nextEvo = (ch && ch[currentStage]) ? ch[currentStage] : null;
      const can = nextEvo && p.level >= nextEvo.level;
      let ev = nextEvo ? `<div class="evolution-info"><h3>üß¨ Evolution</h3><p>Next: <strong>${nextEvo.name || ('Teen ' + p.name)}</strong></p><button class="evolution-btn" ${can?'':'disabled'} onclick="evolvePet()">${can?`‚ú® Evolve (Lvl ${nextEvo.level})`:`üîí Need Level ${nextEvo.level}`}</button></div>` : `<div class="evolution-info" style="background:#fef3c7"><h3>üëë Max Level</h3></div>`;
      
      // Squad Logic
      const isInSquad = gameState.team ? gameState.team.includes(p.id) : false;
      const squadBtnColor = isInSquad ? 'red' : 'blue';
      const squadBtnText = isInSquad ? 'Remove from Squad' : 'Add to Squad';
      // --- üõ°Ô∏è IMPROVED SQUAD DISPLAY (Visual Avatars) ---
      const squadList = (gameState.team || []).map(tid => {
          const mp = gameState.pets.find(x => x.id === tid);
          if (!mp) return "";

          // Decide if we use an Image or Emoji
          const visual = mp.image 
              ? `<img src="${mp.image}" class="${mp.imageStyle}" style="width:100%; height:100%; object-fit:contain;">` 
              : `<div style="font-size:18px;">${mp.emoji || 'üêæ'}</div>`;

          return `
            <div style="width:35px; height:35px; background:white; border-radius:50%; border:2px solid #5a67d8; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" title="${mp.name}">
                ${visual}
            </div>`;
      }).join('');

      const squadDisplay = `
        <div style="margin-top:10px; padding:12px; background:#edf2f7; border-radius:12px; border:1px solid #cbd5e0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong style="color:#2d3748;">üõ°Ô∏è Squad (${(gameState.team||[]).length}/6)</strong>
                <button class="action-btn ${isInSquad ? 'red' : 'blue'}" style="width:auto; padding:4px 10px; font-size:10px; margin:0;" onclick="toggleSquadMember('${p.id}')">
                    ${isInSquad ? 'Remove Me' : 'Add Me'}
                </button>
            </div>
            <div style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                ${squadList || '<span style="color:gray; font-size:12px;">Squad is empty!</span>'}
            </div>
        </div>`;

      // Helper: Render Slot
      // --- FIXED: RENDER GITHUB IMAGES IN SLOTS ---
      const renderSlot = (type, icon) => {
          const instanceId = p.equipment[type];
          // Find the unique item in our bag
          const item = (gameState.inventory.equipment || []).find(i => i.instanceId === instanceId);
          
          let content = icon; // Default to the emoji (like üó°Ô∏è)
          let css = "equip-slot";
          let borderStyle = "";

          if (item) {
              css += " filled";
              // Apply Rarity Border
              if (item.rarity === 'rare') borderStyle = "border-color: #4299e1; box-shadow: 0 0 5px #4299e1;";
              if (item.rarity === 'legendary') borderStyle = "border-color: #f6ad55; box-shadow: 0 0 8px #f6ad55;";

              // If the item has a GitHub image, use it!
              if (item.image && item.image.startsWith('http')) {
                  content = `<img src="${item.image}" class="equip-img" style="width:100%; height:100%; object-fit:contain;">`;
              } else {
                  content = item.image || icon;
              }
          }
          return `<div class="${css}" style="${borderStyle}" onclick="openEquipMenu('${type}')">${content}<div class="equip-badge">${type}</div></div>`;
      };

      // 4. MAIN DISPLAY
      c.innerHTML = `
      <div class="hub-grid">
        <div class="hub-left">
            <div class="pet-display">
                <div class="pet-visual">${v}</div>
                <div class="pet-name">
                    Lvl ${p.level} ${p.name} <button onclick="renamePet()" style="background:none; border:none; cursor:pointer; font-size:16px;" title="Rename (100 BP)">‚úèÔ∏è</button> <span class="rarity-badge rarity-${p.rarity}">${p.rarity}</span>
                </div>
                <!-- STARS -->
                <div class="star-display">${starHTML}</div>
<!-- Show Mastery Slots -->
<div style="font-size:11px; color:#718096; margin-top:10px;">MASTERY SLOTS</div>
${masteryHTML}
${emptySlots > 0 && gameState.badgeInventory.length > 0 ? `<button class="action-btn blue" style="padding:5px; font-size:11px;" onclick="openInfusionMenu()">üß¨ Infuse Mastery</button>` : ''}
                <!-- STATS -->
                <div style="font-size:12px;">XP: ${p.xp} / ${p.maxXp}</div>
                <div class="xp-bar-container"><div class="xp-bar" style="width: ${(p.xp/p.maxXp)*100}%"></div></div>
                
                <!-- EQUIPMENT GRID -->
                <div class="equipment-grid">
                    ${renderSlot('weapon', 'üó°Ô∏è')} ${renderSlot('armor', 'üõ°Ô∏è')} ${renderSlot('accessory', 'üíç')} ${renderSlot('charm', 'üßø')}
                </div>
                
                <!-- ACTION BUTTONS -->
                ${actionButton}
                <button class="action-btn red" style="margin-top:10px;" onclick="releasePet()">Release</button>
            </div>
        </div>
        <div class="hub-right">
            <div class="inventory-section"><h3>Stats</h3><div class="pet-stats"><div class="stat-box"><div class="stat-label">HP</div><div class="stat-value">${p.hp}/${displayMaxHP}</div></div><div class="stat-box"><div class="stat-label">Power</div><div class="stat-value">${p.powers.length}/4</div></div></div>${squadDisplay}</div>
            ${ev}
            <div class="inventory-section"><h3>üéí Inventory</h3>${renderInventory(false)}</div>
            <div class="inventory-section"><h3>‚öîÔ∏è Powers</h3>${renderPowersList(p)}</div>
        </div>
      </div>
      <div class="pet-collection">${renderCollection()}</div>`;
    }
    
    function renderCollection() { 
        // üõ°Ô∏è ARCHITECT FIX: Calculate the correct evolution image on-the-fly
        return gameState.pets.filter(p => p && p.id).map(p => {
            const isActive = p.id === gameState.currentPetId;
            
            // 1. THE SMART LOOKUP: Don't just trust p.image
            let displayImg = p.image; 
            const stage = p.evolutionStage || 0;
            
            if (p.isHatched && stage > 0) {
                // Find the evolution data for this specific pet type
                let chain = EVOLUTION_CHAINS[p.type];
                if (!chain && p.savedEvolutions) chain = p.savedEvolutions;

                // If it's evolved, pick the image from the chain instead of the saved image
                if (chain && chain[stage - 1]) {
                    displayImg = chain[stage - 1].image;
                }
            }

            // 2. Determine Visual (Egg vs Calculated Image)
            let visual = p.emoji || 'üêæ';
            if (!p.isHatched) {
                visual = 'ü•ö';
            } else if (displayImg) {
                visual = `<img src="${displayImg}" class="${p.imageStyle || ''}" style="width:40px;height:40px; object-fit:contain;">`;
            }

            // 3. Return the HTML Card
            return `
            <div class="pet-card ${isActive ? 'active' : ''}" onclick="switchPet('${p.id}')">
                <div class="pet-card-visual">${visual}</div>
                <div style="font-size:10px; font-weight:bold; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${p.isHatched ? p.name : "Mystery Egg"}
                </div>
                ${p.isHatched ? `<div style="font-size:8px; color:#718096; font-weight:bold;">Lvl ${p.level}</div>` : ''}
            </div>`;
        }).join(''); 
    }
    // --- PRO EQUIPMENT: HUB INVENTORY VIEW ---
// --- PRO UI: CLEAN INVENTORY (Consumables Only) ---
function renderInventory(isEgg) { 
    let h = ""; 
    const i = gameState.inventory;

    // We only show "Stackable" consumables here to keep the UI clean.
    const btn = (key, name, icon) => {
        const count = i[key] || 0;
        if(count <= 0) return '';
        
        const action = (key === 'xp_potion' && count > 1) 
            ? `openUseQuantityModal('${key}')` 
            : `useItem('${key}')`;

        return `
        <div class="inventory-item">
            <div style="font-size:20px;">${icon}</div>
            <div style="font-weight:bold; font-size:10px;">x${count}</div>
            <button class="buy-btn" style="padding:2px; font-size:10px;" onclick="${action}">Use</button>
        </div>`;
    };

    if(!isEgg) { 
        // Only show usable items
        h += btn('health_potion', 'Health', 'üß™');
        h += btn('stamina_potion', 'Stamina', '‚ö°');
        h += btn('xp_potion', 'XP', 'üåü');
        h += btn('arena_ticket', 'Ticket', 'üéüÔ∏è');
    } else { 
        // Egg hatching items
        if(i['premium_food']) h += `<div class="inventory-item"><div>ü•©</div><button class="buy-btn" onclick="useItem('premium_food')">+20%</button></div>`; 
        if(i['warmer']) h += `<div class="inventory-item"><div>üî•</div><button class="buy-btn" onclick="useItem('warmer')">+10%</button></div>`; 
        if(i['hatching_machine']) h += `<div class="inventory-item"><div>‚öôÔ∏è</div><button class="buy-btn" onclick="useItem('hatching_machine')">+50%</button></div>`; 
    }
    
    return h || "<p style='color:#718096; font-size:11px;'>No items.</p>";
}
    function renderPowersList(p) { 
        // SAFETY GUARD: Check if p or powers exists
        if (!p || !p.powers) return "None.";
        
        if (p.powers.length === 0) return "None.";
        
        return p.powers.map(pid => {
            const i = findShopItem(pid);
            if (!i) return '';
            const iconHtml = i.image ? `<img src="${i.image}" style="width:20px;">` : i.icon;
            return `<div style="padding:5px; display:flex; align-items:center; gap:5px;">${iconHtml} ${i.name}</div>`;
        }).join(''); 
    }
    function switchPet(id) { gameState.currentPetId = id; saveGame(); renderHub(); }
    
    function hatchPet() { 
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
    if(!p || p.isHatched || p.hatchProgress < 100) return;

    // 1. Find the "Recipe" for what is inside the egg
    let baseData = null;
    for (const rarity in PET_TYPES) {
        const found = PET_TYPES[rarity].find(b => b.id === p.type);
        if (found) { baseData = found; break; }
    }

    if (baseData) {
        // 2. Transform the egg into the pet
        p.isHatched = true;
        p.name = baseData.name;
        p.image = baseData.image;
        p.imageStyle = baseData.imageStyle || 'blend-multiply';
        p.element = baseData.element;
        p.emoji = baseData.emoji;
        p.maxHP = Number(baseData.baseHP || baseData.hp || 50);
        p.hp = p.maxHP;
        p.powers = baseData.powers || ['claw_attack'];
        
        // Auto-add to squad if there is space
        if (!gameState.team) gameState.team = [];
        if (gameState.team.length < 6 && !gameState.team.includes(p.id)) {
            gameState.team.push(p.id);
        }

        // 3. Visual Ceremony
        const m = document.getElementById('hatch-modal');
        const v = document.getElementById('hatch-egg-visual');
        const t = document.getElementById('hatch-text');
        const l = document.getElementById('hatch-light');
        const b = document.getElementById('hatch-finish-btn');
        
        m.style.display = 'flex'; 
        v.innerHTML = 'ü•ö'; 
        v.className = 'egg-shaking'; 
        t.innerText = "It's hatching..."; 
        b.style.display = 'none';
        
        setTimeout(() => { if(l) l.style.animation = "flashWhite 1s forwards"; soundManager.playSFX('levelUp'); }, 2000);
        setTimeout(() => { 
            v.className = ''; 
            v.innerHTML = p.image ? `<img src="${p.image}" class="pet-image ${p.imageStyle}" style="width:300px; height:300px;">` : p.emoji; 
            v.style.animation = "petPopIn 0.8s"; 
            t.innerText = `Hatched ${p.name}!`; 
            b.style.display = 'block'; 
            saveGame(true); 
            renderHub(); 
        }, 2500);
        
        b.onclick = () => { m.style.display = 'none'; };
    } else {
        showToast("Error: Hatching data lost!", "error");
    }
}
    
    function sellEgg() {
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    
    // Safety check: only eggs can be sold here
    if (!p || p.isHatched) return;

    if (confirm("Sell this mystery egg for 50 BP? This cannot be undone!")) {
        const idToRemove = p.id;

        // 1. Give the reward
        addBP(50);

        // 2. Remove the egg from the list
        gameState.pets = gameState.pets.filter(pet => pet.id !== idToRemove);

        // 3. Auto-select the next available pet so the screen updates
        if (gameState.pets.length > 0) {
            gameState.currentPetId = gameState.pets[0].id;
        } else {
            gameState.currentPetId = null;
        }

        // 4. Save to Cloud and Refresh
        saveGame(true); 
        renderHub();
        showToast("Egg sold for 50 BP!", "success");
    }
}

    // WILDS QUICK ITEM USAGE
    function quickUseItem(id) {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        if (!gameState.inventory[id] || gameState.inventory[id] <= 0) { showToast("You don't have any!", "error"); return; }
        // --- PRO FIX: GEAR-AWARE QUICK HEAL ---
        if (id === 'health_potion') {
            const gear = getPetEquipmentStats(p);
            const currentTotalMax = p.maxHP + gear.hp; // Calculate the real limit

            if (p.hp >= currentTotalMax) return showToast("HP is full!", "info");
            
            gameState.inventory[id]--;
            // Heal +30, but cap it at the GEAR-BOOSTED max
            p.hp = Math.min(p.hp + 30, currentTotalMax); 
            
            showToast(`Used Potion! HP: ${p.hp}/${currentTotalMax}`, "success");
            soundManager.playSFX('heal'); 
        } else if (id === 'stamina_potion') {
            if (gameState.stamina >= 100) return showToast("Stamina full!", "info");
            gameState.inventory[id]--;
            adjustStamina(50);
            showToast("Used Energy! (+50)", "success");
        }
        updateStatsDisplay();
        document.getElementById('wild-hp-display').innerText = `HP: ${p.hp}/${p.maxHP}`;
        saveGame(true);
    }

    function useItem(id) {
        if(gameState.inventory[id]>0) {
            const p = gameState.pets.find(pet=>pet.id===gameState.currentPetId); const maxLvl = LEVEL_CAPS[p.rarity] || 100;
            // --- PRO FIX: GEAR-AWARE HUB HEAL ---
            if(id==='health_potion') { 
                const gear = getPetEquipmentStats(p);
                const currentTotalMax = p.maxHP + gear.hp;

                if(p.hp >= currentTotalMax) return showToast("Health is already full!", "error"); 
                
                p.hp = Math.min(p.hp + 30, currentTotalMax); 
                showToast("Healed!", "success"); 
            }
            else if(id==='stamina_potion') { if(gameState.stamina >= 100) return showToast("Stamina is full!", "error"); gameState.stamina=Math.min(gameState.stamina+50,100); updateStatsDisplay(); showToast("Stamina Up!", "success"); }
            else if(id==='xp_potion') { if(p.level>=maxLvl) return showToast("Max Level!", "error"); gameState.inventory[id]--; p.xp+=100; if(p.xp>=p.maxXp && p.level<maxLvl) { p.level++; p.xp=0; p.maxXp=p.level*300+200; p.maxHP+=10; p.hp=p.maxHP; showToast("Level Up!", "success"); soundManager.playSFX('levelUp'); } else showToast("+100 XP", "success"); saveGame(); renderHub(); return; }
            else if(id==='premium_food') p.hatchProgress=Math.min(100,p.hatchProgress+20); else if(id==='warmer') p.hatchProgress=Math.min(100,p.hatchProgress+10); else if(id==='hatching_machine') p.hatchProgress=Math.min(100,p.hatchProgress+50);
            if(id !== 'xp_potion') gameState.inventory[id]--; 
            saveGame(); renderHub();
        }
    }
    
    // ==========================================
    // üß¨ STANDARD EVOLUTION (With Dedicated Modal)
    // ==========================================

    let pendingEvoData = null; 
    let stdEvoCount = 0; 
    let stdEvoScore = 0; 

    async function evolvePet() {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        
        // 1. Get Evolution Data
        let ch = EVOLUTION_CHAINS[p.type]; 
        if (!ch && p.savedEvolutions) {
             ch = p.savedEvolutions;
             EVOLUTION_CHAINS[p.type] = p.savedEvolutions;
        }

        if (!ch) return showToast(`Error: Evolution data missing`, "error");
        
        const currentStage = typeof p.evolutionStage === 'number' ? p.evolutionStage : 0;
        if (!ch[currentStage]) return showToast("Max Evolution!", "info");
        
        const next = ch[currentStage];
        
        // 2. Check Requirements
        if (p.level < next.level) { showToast(`Need Lvl ${next.level} to evolve!`, "error"); return; }
        if (gameState.brainPoints < next.cost) { showToast(`Need ${next.cost} BP to evolve!`, "error"); return; }
        
        // 3. Confirm & Start
        pendingEvoData = next; 
        if(confirm(`üß¨ EVOLUTION READY!\n\nTo evolve into ${next.name || "Next Form"}, you must pass a quick test.\n\nAnswer 3 Questions correctly.\n\nCost: ${next.cost} BP (Paid on success).`)) {
            startStandardEvoQuiz();
        }
    }

    function startStandardEvoQuiz() {
        stdEvoCount = 0;
        stdEvoScore = 0;
        
        // OPEN NEW MODAL
        document.getElementById('evo-challenge-modal').classList.add('active');
        document.getElementById('evo-chal-score').innerText = "0 / 3";
        
        renderStandardEvoQuestion();
    }

    function renderStandardEvoQuestion() {
        if (stdEvoCount >= 3) {
            finishStandardEvoQuiz();
            return;
        }

        let q;
        
        // 1. TRY TO USE ASSIGNED TOPICS FIRST
        if (gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) {
            const randomIndex = Math.floor(Math.random() * gameState.activeQuestionPool.length);
            q = gameState.activeQuestionPool[randomIndex];
        } 
        // 2. FALLBACK TO GENERIC MATH (If no topics assigned)
        else {
            q = MathEngine.generate(gameState.grade || "1");
        }

        const container = document.getElementById('evo-chal-content');
        
        // Render
        container.innerHTML = `
            <div style="font-size:14px; color:#718096; margin-bottom:10px; font-weight:bold;">QUESTION ${stdEvoCount+1}</div>
            
            <div style="font-size:32px; margin-bottom:15px;">${q.qVisualHTML || ""}</div>
            
            <!-- Question Text -->
            <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:20px;">
                <div style="font-size:24px; font-weight:bold; color:#2d3748;">${q.text || q.q}</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%;">
                ${q.options.map(opt => `<button class="mcq-btn" style="min-height:50px; font-size:18px;" onclick="handleEvoAnswer('${opt}', '${q.a}')">${opt}</button>`).join('')}
            </div>
        `;
    }

    window.handleEvoAnswer = (ans, correct) => {
        if (ans == correct) {
            stdEvoScore++;
            soundManager.playSFX('correct');
        } else {
            soundManager.playSFX('wrong');
        }
        
        stdEvoCount++;
        document.getElementById('evo-chal-score').innerText = `${stdEvoScore} / 3`;
        
        // Short delay to feel like a game
        setTimeout(renderStandardEvoQuestion, 300);
    }

    function finishStandardEvoQuiz() {
        document.getElementById('evo-challenge-modal').classList.remove('active');

        // PASS CONDITION: 2 out of 3
        if (stdEvoScore >= 2) {
            performEvolutionAnimation();
        } else {
            alert(`Trial Failed (${stdEvoScore}/3). \n\nThe evolution energy fades... \nStudy and try again!`);
        }
    }

    function closeEvoChallenge() {
        if(confirm("Quit the evolution trial?")) {
            document.getElementById('evo-challenge-modal').classList.remove('active');
        }
    }

    function performEvolutionAnimation() {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        const next = pendingEvoData;
        let newName = next.name || ("Teen " + p.name);

        // Deduct Cost
        gameState.brainPoints -= next.cost;
        updateStatsDisplay();

        // Setup Animation Modal
        const m = document.getElementById('evolution-modal'); 
        const c = document.getElementById('evo-pet-container'); 
        m.style.display = 'flex'; 
        
        document.getElementById('evo-message-1').innerText = ""; 
        document.getElementById('evo-message-2').innerText = "";
        document.getElementById('evo-continue-btn').style.display='none';
        
        c.innerHTML = p.image ? `<img src="${p.image}" class="evo-pet-image ${p.imageStyle}">` : p.emoji; 
        c.classList.remove('flash-and-scale');
        
        setTimeout(() => { 
            document.getElementById('evo-message-1').innerText = "The aura is changing..."; 
            document.getElementById('evo-message-1').style.opacity = 1; 
        }, 500);
        
        setTimeout(() => { 
            // üõ°Ô∏è DATA PRESERVATION: Keep all old data, only update what changed
            const updatedPet = {
                ...p, // This keeps the ID, the XP, the Stars, etc.
                name: newName,
                image: next.image,
                imageStyle: next.imageStyle || 'blend-multiply',
                rarity: next.rarity,
                maxHP: next.baseHP || p.maxHP,
                evolutionStage: (p.evolutionStage || 0) + 1
            };

            // Apply the update to the pet in the list
            const petIdx = gameState.pets.findIndex(pet => pet.id === p.id);
            gameState.pets[petIdx] = updatedPet;
            
            // Re-heal to full Max HP
            gameState.pets[petIdx].hp = gameState.pets[petIdx].maxHP;

            c.innerHTML = next.image ? `<img src="${next.image}" class="evo-pet-image ${next.imageStyle}">` : next.emoji; 
            c.classList.add('flash-and-scale'); 
            soundManager.playSFX('levelUp'); 
        }, 3000);

        setTimeout(() => { 
            document.getElementById('evo-message-2').innerText = `Evolved into ${newName}!`; 
            document.getElementById('evo-message-2').style.opacity = 1; 
            document.getElementById('evo-continue-btn').style.display = 'block'; 
            pendingEvoData = null;
        }, 5000);

        document.getElementById('evo-continue-btn').onclick = () => { 
            m.style.display = 'none'; 
            saveGame(true); 
            renderHub(); 
        };
    }
    
    function renderShop() {
        const c = document.getElementById('shop-content'); 
        
        let h = `<div class="shop-section" style="text-align:center; background:#f3e8ff; padding:15px; border-radius:15px; border:2px solid #a855f7; margin-bottom:30px;">
            <h2 style="color:#6b21a8; border-bottom:none;">üîÆ Legendary Summon</h2>
            <button class="gacha-btn" onclick="buyGacha()">SUMMON (5000 BP)</button>
        </div>`;

        // Define Categories
        const categories = [
            { t: 'ü•ö Egg Care', i: SHOP_ITEMS.egg_items, k: 'egg' },
            { t: '‚öîÔ∏è Powers', i: SHOP_ITEMS.power_items, k: 'power' },
            { t: 'üß™ Consumables', i: SHOP_ITEMS.consumable_items, k: 'consumable' },
            { t: 'üéí Equipment', i: SHOP_ITEMS.equipment || [], k: 'equipment' } // New Category
        ];

        categories.forEach(cat => { 
            if (cat.i.length === 0) return; // Don't show empty categories
            
            h += `<div class="shop-section"><h2>${cat.t}</h2><div class="shop-items">`;
            
            cat.i.map(item => {
                // VISUAL LOGIC: Check for Image URL first, else Emoji
                let visual = item.icon || 'üì¶';
                if (item.image && item.image.startsWith('http')) {
                    visual = `<img src="${item.image}" style="width:50px; height:50px; object-fit:contain; filter:drop-shadow(0 2px 5px rgba(0,0,0,0.2));">`;
                } else {
                    visual = `<div style="font-size:30px;">${visual}</div>`;
                }

                // BUY BUTTON LOGIC
                // Powers use buyItem(id, 'power'). 
                // Equipment uses buyItem(id, 'equipment').
                // Consumables use openQuantityModal.
                let action = `openQuantityModal('${item.id}')`;
                if (cat.k === 'power') action = `buyItem('${item.id}','power')`;
                if (cat.k === 'equipment') action = `buyItem('${item.id}','equipment')`;

                h += `
                <div class="shop-item">
                    <div style="height:60px; display:flex; align-items:center; justify-content:center; margin-bottom:5px;">
                        ${visual}
                    </div>
                    <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${item.name}</div>
                    <div style="font-size:11px; color:#718096; margin-bottom:8px; height:30px; overflow:hidden;">${item.desc || item.description || ''}</div>
                    <div class="shop-item-price">üß† ${item.price}</div>
                    <button class="buy-btn" onclick="${action}">Buy</button>
                </div>`;
            }).join('');
            
            h += `</div></div>`;
        }); 
        
        c.innerHTML = h;
    }
    function buyGacha() {
    if(gameState.brainPoints < 5000) { showToast("Need 5000 BP!", "error"); return; }
    
    // Lock the gate during summoning
    adjustBP(-5000); 
    updateStatsDisplay(); 
    
    const pulls = []; 
    for(let i=0; i<3; i++) { 
        const r = Math.random(); 
        const pool = r < 0.50 ? PET_TYPES.rare : (r < 0.95 ? PET_TYPES.epic : PET_TYPES.legendary); 
        const base = pool[Math.floor(Math.random() * pool.length)]; 
        
        // USE THE FACTORY
        const newPet = createPetInstance(base.id, base.name, true);
        if (newPet) pulls.push(newPet);
    } 
    
    gameState.pets.push(...pulls); 
    saveGame(true);
    startGachaAnimation(pulls);
}

function startGachaAnimation(pulls) { 
    soundManager.playSFX('gacha'); 
    document.getElementById('gacha-cinematic-modal').style.display = 'flex'; 
    const flash = document.getElementById('gacha-flash-overlay');
    if(flash) flash.style.animation = 'gachaFlash 1s ease-out 1.5s'; 
    setTimeout(() => revealNextPet(pulls, 0), 2500); 
}
    function revealNextPet(pulls,i) { const p=pulls[i]; const c=document.getElementById('pet-reveal-container'); c.innerHTML=''; const vis = p.image?`<img src="${p.image}" class="gacha-reveal-visual ${p.imageStyle}">`:`<div style="font-size:100px">${p.emoji}</div>`; const el = document.createElement('div'); el.className=`gacha-pet-reveal ${p.rarity}`; el.style.animation='petPopIn 1s forwards'; el.innerHTML = `<div class="rarity-badge rarity-${p.rarity}">${p.rarity}</div>${vis}<div style="font-weight:bold;margin-top:15px;">${p.name}</div>`; c.appendChild(el); const ctrl = document.getElementById('gacha-cinematic-controls'); ctrl.innerHTML=''; ctrl.style.opacity=1; const btn = document.createElement('button'); btn.className='gacha-btn'; btn.innerText=i<2?'Continue':'Finish'; btn.onclick=()=>i<2?revealNextPet(pulls,i+1):closeGachaCinematic(pulls); ctrl.appendChild(btn); }
    function closeGachaCinematic(pulls) { document.getElementById('gacha-cinematic-modal').style.display='none'; const c=document.getElementById('gacha-reveal-container'); c.innerHTML=pulls.map(p=>`<div class="gacha-card"><div>${p.image?`<img src="${p.image}" class="${p.imageStyle}" style="width:60px;">`:p.emoji}</div><div>${p.name}</div><div class="rarity-badge rarity-${p.rarity}">${p.rarity}</div></div>`).join(''); document.getElementById('gacha-reveal-modal').classList.add('active'); }
    function closeGacha() { document.getElementById('gacha-reveal-modal').classList.remove('active'); switchTab('hub'); }
    function findShopItem(id) { for(const k in SHOP_ITEMS) { const f=SHOP_ITEMS[k].find(i=>i.id===id); if(f) return f; } return null; }
    function buyItem(id, type) {
    const baseItem = findShopItem(id);
    if (gameState.brainPoints < baseItem.price) return showToast("Not enough BP", "error");

    adjustBP(-baseItem.price);

    if (type === 'power') {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        if (p.powers.includes(id)) return showToast("Already known!", "info");
        if (p.powers.length >= 4) { openReplaceModal(baseItem); return; }
        p.powers.push(id);
    } 
    else if (type === 'equipment') {
        const roll = Math.random();
        let pool, rarityName;
        
        // 5% chance for Legendary, 20% for Rare, 75% for Basic
        if (roll > 0.95) { pool = ITEM_PREFIXES.legendary; rarityName = "legendary"; }
        else if (roll > 0.75) { pool = ITEM_PREFIXES.rare; rarityName = "rare"; }
        else { pool = ITEM_PREFIXES.basic; rarityName = "basic"; }

        const prefix = pool[Math.floor(Math.random() * pool.length)];
        
        // --- FIXED: CARRY OVER GITHUB IMAGES ---
        const instance = {
            instanceId: 'item_' + Date.now() + Math.floor(Math.random()*1000),
            baseId: id,
            name: `${prefix.name} ${baseItem.name}`,
            image: baseItem.image || baseItem.icon, // <--- SAVES THE GITHUB IMAGE!
            prefix: JSON.parse(JSON.stringify(prefix)), 
            rarity: rarityName,
            type: baseItem.type
        };

        if (!gameState.inventory.equipment) gameState.inventory.equipment = [];
        gameState.inventory.equipment.push(instance);
        
        showLootReveal(instance); 
    } 

    saveGame(false);
    updateStatsDisplay();
    renderShop();
}
    function openQuantityModal(id) { currentBuyingItem=findShopItem(id); const max=Math.floor(gameState.brainPoints/currentBuyingItem.price); if(max===0) return showToast("Too expensive!", "error"); document.getElementById('quantity-modal').classList.add('active'); const sl=document.getElementById('quantity-slider'); sl.max=max; sl.value=1; document.getElementById('qty-item-name').innerText=`Buy ${currentBuyingItem.name}`; document.getElementById('qty-buy-confirm-btn').onclick=()=>confirmBulkBuy(currentBuyingItem.price); updateQuantityModalDisplay(1,currentBuyingItem.price); sl.oninput=(e)=>updateQuantityModalDisplay(e.target.value,currentBuyingItem.price); }
    function updateQuantityModalDisplay(q,p) { document.getElementById('quantity-label').innerText=`Qty: ${q}`; document.getElementById('qty-cost-display').innerText=`Total: ${q*p} BP`; document.getElementById('qty-buy-confirm-btn').innerText=`Buy ${q}`; }
    function confirmBulkBuy(p) { const q=parseInt(document.getElementById('quantity-slider').value); if(gameState.brainPoints<q*p) return; gameState.brainPoints-=q*p; gameState.inventory[currentBuyingItem.id]=(gameState.inventory[currentBuyingItem.id]||0)+q; saveGame(); updateStatsDisplay(); renderShop(); document.getElementById('quantity-modal').classList.remove('active'); showToast(`Bought ${q}!`, "success"); }
    function openReplaceModal(item) { gameState.tempMoveToLearn=item; document.getElementById('new-move-name').innerText=item.name; const list=document.getElementById('replace-move-list'); list.innerHTML=''; const p=gameState.pets.find(pet=>pet.id===gameState.currentPetId); p.powers.forEach((pid,i)=>{const m=findShopItem(pid); const d=document.createElement('div'); d.className='move-replace-btn'; d.innerHTML=`${m.name} <span>üóëÔ∏è</span>`; d.onclick=()=>confirmReplaceMove(i); list.appendChild(d);}); document.getElementById('replace-move-modal').classList.add('active'); }
    function closeReplaceModal() { document.getElementById('replace-move-modal').classList.remove('active'); gameState.tempMoveToLearn=null; }
    function confirmReplaceMove(i) { const p=gameState.pets.find(pet=>pet.id===gameState.currentPetId); p.powers.splice(i,1); p.powers.push(gameState.tempMoveToLearn.id); gameState.brainPoints-=gameState.tempMoveToLearn.price; saveGame(); renderShop(); closeReplaceModal(); showToast("Move Learned!", "success"); }
    // ==========================================
    // FIXED EXPLORATION & MAP ENGINE
    // (Paste this ABOVE 'function getArenaEnemy')
    // ==========================================

    function startExploration() { 
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        
        // 1. Safety Checks
        if(!p) { showToast("No pet selected!", "error"); return; }
        if(p.hp <= 0) { showToast("Your pet has fainted! Heal first.", "error"); return; }
        if(!p.isHatched) { showToast("You need a hatched pet!", "error"); return; }
        if(!p.powers || p.powers.length === 0) { showToast("You need at least 1 power!", "error"); return; }
        if(gameState.stamina <= 0) { showToast("No Stamina! Study to get Energy.", "error"); return; }
        
        // 2. Prepare Game State
        gameState.inBattle = false; 
        gameState.battleState = null; 
        
        // 3. Switch Screens
        document.getElementById('wilds-menu').style.display = 'none'; 
        document.getElementById('rpg-wrapper').style.display = 'block'; 
        
        // 4. Start the Map Engine
        initRPG(); 
        soundManager.playBGM('wilds'); 
    }

    function stopExploration() { 
        document.getElementById('wilds-menu').style.display = 'block'; 
        document.getElementById('rpg-wrapper').style.display = 'none'; 
        soundManager.playBGM('hub'); 
    }

    function initRPG() {
      // Initialize Canvas
      canvas = document.getElementById('rpg-canvas'); 
      ctx = canvas.getContext('2d');
      
      // --- SAFE SPAWN CHECK (New Code) ---
      // This ensures they never load into a tree/water/rock
      let safetyAttempts = 0;
      
      // If the current spot is NOT walkable, or if it's out of bounds
      while (
          (gameState.mapY >= MAP_ROWS || gameState.mapX >= MAP_COLS || 
          !isWalkable(currentMapData[gameState.mapY][gameState.mapX])) 
          && safetyAttempts < 100
      ) {
          console.log("‚ö†Ô∏è Player stuck in wall/tree! Moving to safe spot...");
          // Randomize position until we hit grass/sand
          gameState.mapX = Math.floor(Math.random() * (MAP_COLS - 2)) + 1;
          gameState.mapY = Math.floor(Math.random() * (MAP_ROWS - 2)) + 1;
          safetyAttempts++;
      }
      // -----------------------------------------------------
      // END OF PASTED CODE
      
      const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
      
      // Load Player Sprite
      if (pet && pet.image && pet.image.length > 5) {
          playerImage.src = pet.image; 
      } else {
          playerImage.src = HUMAN_SPRITE_URL; 
      }
      
      injectRandomArena(); 
      
      // Draw Map
      if(playerImage.complete) {
          drawMap();
      } else {
          playerImage.onload = () => drawMap(); 
      }
      
      // Attach Controls
      document.removeEventListener('keydown', handleKeyDown); 
      document.addEventListener('keydown', handleKeyDown);
      initSwipe(); 
      
      // Click Interaction
      canvas.onclick = (e) => {
          if (gameState.inBattle) return; 
          const rect = canvas.getBoundingClientRect(); 
          const clickX = (e.clientX - rect.left) * (canvas.width / rect.width); 
          const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
          const tileX = Math.floor(clickX / TILE_SIZE); 
          const tileY = Math.floor(clickY / TILE_SIZE);
          
          if (tileX < 0 || tileX >= MAP_COLS || tileY < 0 || tileY >= MAP_ROWS) return;
          
          // Check distance
          if (Math.abs(tileX - gameState.mapX) + Math.abs(tileY - gameState.mapY) <= 2) { 
              const t = currentMapData[tileY][tileX]; 
              if (t === 8) checkArenaEntry(); 
              else if (t === 7) confirmBossBattle(7); 
          }
      };
      
      // Update UI
      document.getElementById('wild-hp-display').innerText = `HP: ${pet.hp}/${pet.maxHP}`;
    }

    function drawMap() {
      if (!ctx) return; 
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw Tiles
      for (let r = 0; r < MAP_ROWS; r++) {
        for (let c = 0; c < MAP_COLS; c++) {
          const tile = currentMapData[r][c]; 
          const x = c * TILE_SIZE; 
          const y = r * TILE_SIZE;
          
          if (tile === 2) { ctx.fillStyle = '#2e7d32'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '24px Arial'; ctx.fillStyle = '#1b5e20'; ctx.fillText('üå≤', x+5, y+30); } 
          else if (tile === 3) { ctx.fillStyle = '#4fc3f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#0288d1'; ctx.fillText('~', x+10, y+25); } 
          else if (tile === 1) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#388e3c'; ctx.fillText('w', x+5, y+15); ctx.fillText('w', x+20, y+30); } 
          else if (tile === 4) { ctx.fillStyle = '#f6e05e'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('.', x+10, y+15); ctx.fillText('.', x+25, y+30); }
          else if (tile === 5) { ctx.fillStyle = '#e2e8f0'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#cbd5e0'; ctx.fillText('‚ùÑÔ∏è', x+8, y+26); }
          else if (tile === 6) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#ed64a6'; ctx.fillText('üå∏', x+5, y+28); }
          else if (tile === 9) { ctx.fillStyle = '#4a5568'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '20px Arial'; ctx.fillStyle = '#2d3748'; ctx.fillText('ü™®', x+8, y+28); }
          else if (tile === 7) { ctx.fillStyle = '#2d3748'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#e53e3e'; ctx.fillText('üíÄ', x+10, y+25); } 
          else if (tile === 8) { 
              if (arenaIcon.complete && arenaIcon.naturalWidth > 0) { 
                  ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.drawImage(arenaIcon, x, y, TILE_SIZE, TILE_SIZE); 
              } else { 
                  ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '18px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('üèüÔ∏è', x+5, y+28); 
              } 
          } 
          else { ctx.fillStyle = '#d7ccc8'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); }
        }
      }
      
      // Draw Player
      const px = gameState.mapX * TILE_SIZE; 
      const py = gameState.mapY * TILE_SIZE;
      
      // Selection Box
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; 
      ctx.lineWidth = 3; 
      ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE);
      
      if (playerImage.complete && playerImage.naturalWidth !== 0) {
          ctx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE);
      } else { 
          // Fallback circle if image fails
          ctx.fillStyle = 'red'; 
          ctx.beginPath(); 
          ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2); 
          ctx.fill(); 
          ctx.strokeStyle = 'white'; 
          ctx.lineWidth = 2; 
          ctx.stroke(); 
      }
      
      // Map Name
      ctx.font = "bold 14px Arial"; 
      ctx.fillStyle = "rgba(0,0,0,0.5)"; 
      ctx.fillRect(5, 5, 120, 25); 
      ctx.fillStyle = "white"; 
      ctx.fillText(currentMapName || "Wilds", 10, 22);
    }
    function getArenaEnemy() { const pool = [...PET_TYPES.rare, ...PET_TYPES.epic, ...PET_TYPES.legendary]; const base = pool[Math.floor(Math.random() * pool.length)]; return { name: "Champion " + base.name, image: base.image, imageStyle: base.imageStyle, emoji: base.emoji, hp: Math.floor(base.baseHP * 2.5), damage: Math.floor(base.baseHP * 0.3), xp: 100 }; }
    
function getScaledEnemy(baseEnemyTemplate, playerLevel) {
    let enemy = JSON.parse(JSON.stringify(baseEnemyTemplate));
    const lvl = Number(playerLevel || 1);

    // 1. CALCULATE FAIR MATH (The "Wilds" standard)
    let fairHP = Math.floor(40 + (lvl * 13)); 
    let fairAtk = Math.floor(5 + (lvl * 1.6));

    // 2. CHECK FOR JSON OVERRIDES
    // We only use the JSON number if it's "Hardcoded" (like your 1500 HP Boss)
    // If it's a random bug (30 HP), we use the Fair Math instead.
    enemy.maxHP = (baseEnemyTemplate.hp && baseEnemyTemplate.hp > fairHP) ? baseEnemyTemplate.hp : fairHP;
    enemy.damage = (baseEnemyTemplate.damage && baseEnemyTemplate.damage > fairAtk) ? baseEnemyTemplate.damage : fairAtk;

    // Apply Endurance Mode (if teacher turned it on)
    if (gameState.teacherConfig && gameState.teacherConfig.enduranceMode === true) {
        enemy.maxHP = enemy.maxHP * 2;
    }

    enemy.hp = enemy.maxHP;

    // 3. IMAGE & NAME OVERRIDES
    if (baseEnemyTemplate.enemyImage) enemy.image = baseEnemyTemplate.enemyImage;
    enemy.name = baseEnemyTemplate.enemyName || `Lvl ${lvl} ${enemy.name}`;

    // Standard scaling for secondary stats (XP/Armor)
    enemy.armor = Math.min((lvl > 10 ? (lvl - 10) * 2 : 0), 50); 
    enemy.xp = Math.floor(15 + (lvl * 10));
    enemy.level = lvl; 

    return enemy;
}
    
    function getBattlerSize(entity, isBoss, isArena) {
        let size = 200; 
        const stage = entity.evolutionStage !== undefined ? entity.evolutionStage : (entity.level > 20 ? 2 : (entity.level > 10 ? 1 : 0));
        if (stage === 0) size = 180; else if (stage === 1) size = 240; else if (stage >= 2) size = 300; 
        if (isArena) size = 220; if (isBoss) size = 350; 
        return size;
    }

    const TYPE_CHART = { fire: { strong: ['grass', 'ice'], weak: ['water', 'earth', 'rock'] }, water: { strong: ['fire', 'earth', 'rock'], weak: ['grass', 'electric'] }, grass: { strong: ['water', 'earth', 'rock'], weak: ['fire', 'ice', 'wind'] }, electric: { strong: ['water', 'wind'], weak: ['earth'] }, earth: { strong: ['fire', 'electric'], weak: ['water', 'grass', 'ice'] }, ice: { strong: ['grass', 'wind'], weak: ['fire'] }, wind: { strong: ['grass'], weak: ['electric', 'ice'] }, shadow: { strong: ['light'], weak: ['light'] }, light: { strong: ['shadow'], weak: ['shadow'] }, normal: { strong: [], weak: [] } };
    const ELEMENT_ICONS = { fire: 'üî•', water: 'üåä', grass: 'üåø', electric: '‚ö°', earth: 'ü™®', ice: '‚ùÑÔ∏è', wind: 'üå™Ô∏è', shadow: 'üåë', light: '‚ú®', normal: '‚ö™' };
    function getElIcon(t) { if(Array.isArray(t)) return t.map(x=>ELEMENT_ICONS[x]).join(''); return ELEMENT_ICONS[t] || '‚ö™'; }
    function getElementMultiplier(moveType, targetInput) { if (!moveType || !targetInput) return 1.0; const atk = moveType.toLowerCase(); const targetTypes = Array.isArray(targetInput) ? targetInput : [targetInput]; let totalMultiplier = 1.0; targetTypes.forEach(defType => { const def = defType.toLowerCase(); const typeData = TYPE_CHART[atk]; if (typeData) { if (typeData.strong.includes(def)) totalMultiplier *= 2.0; else if (typeData.weak.includes(def)) totalMultiplier *= 0.5; } }); return totalMultiplier; }

    function startBattle(tileType, isBoss, isArena, specificEnemy = null) {
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        
        // Element failsafe
        if (!pet.element) { 
            for (const rarity in PET_TYPES) { 
                const def = PET_TYPES[rarity].find(d => d.id === pet.type); 
                if (def) { pet.element = def.element; break; } 
            } 
            if (!pet.element) pet.element = 'normal'; 
        }
        
        // 1. DETERMINE SCALING LEVEL
        // Wilds: Active Pet (Casual)
        // Boss/Arena: Strongest Pet in Squad (Hardcore)
        let scalingLevel = pet.level;

        if (isBoss || isArena) {
            const teamIds = gameState.team || [gameState.currentPetId];
            teamIds.forEach(id => {
                const member = gameState.pets.find(p => p.id === id);
                if (member && member.level > scalingLevel) {
                    scalingLevel = member.level;
                }
            });
        }

        // 2. GENERATE ENEMY
        let enemy;
        if (specificEnemy) {
            enemy = getScaledEnemy(specificEnemy, scalingLevel);
        } else if (isArena) { 
            const baseArena = getArenaEnemy(); 
            enemy = getScaledEnemy(baseArena, scalingLevel + 2); 
        } else if (isBoss) { 
            enemy = getScaledEnemy(BOSS_TYPES[0], scalingLevel + 5); 
        } else { 
            const randomBase = MONSTER_TYPES[Math.floor(Math.random() * MONSTER_TYPES.length)]; 
            enemy = getScaledEnemy(randomBase, scalingLevel); 
        }

       // 3. PRO GEAR INTEGRATION (Capacity Fix)
        const gear = getPetEquipmentStats(pet);
        const battleMaxHP = pet.maxHP + gear.hp;
        
        // Use the pet's existing health, but ensure it doesn't exceed the new max
        const currentBattleHP = Math.min(battleMaxHP, pet.hp); 

        // 4. SETUP BATTLE STATE
        gameState.inBattle = true;
        gameState.battleState = { 
            enemy: enemy, 
            playerHP: currentBattleHP,
            playerMaxHP: battleMaxHP,
            enemyHP: enemy.hp, 
            isBoss: isBoss, 
            isArena: isArena, 
            turnInProgress: false, 
            log: [`A wild ${enemy.name} appeared!`], 
            showBag: false,
            playerStatus: [],
            enemyStatus: []
        };
        
        soundManager.playBGM(isBoss || isArena ? 'boss' : 'battle');
        const bg = isArena ? ARENA_IMGS[0] : (BATTLE_BACKGROUNDS[tileType] || BATTLE_BACKGROUNDS[1]);
        
        // UI Switching
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-wilds').classList.add('active');
        document.getElementById('wilds-menu').style.display = 'none'; 
        document.getElementById('rpg-wrapper').style.display = 'none'; 
        document.getElementById('multiplayer-menu').style.display = 'none';
        document.getElementById('raid-arena').style.display = 'none';

        // Apply BG to the 16:9 Arena Stage only
        document.querySelector('#battle-ui .battle-arena').style.backgroundImage = `url('${bg}')`;
        document.getElementById('battle-ui').style.display = 'flex'; 
        
        renderBattle();
    }
    
    function showFloatingText(targetEl, text, type) { const ft = document.createElement('div'); ft.className = 'floating-text ' + (type||''); ft.innerText = text; targetEl.appendChild(ft); setTimeout(() => ft.remove(), 1000); }
    
    // --- EXPERT COMBAT ENGINE (UPDATED) ---

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function getTypeMult(moveType, defenderTypes) {
        if (!moveType || !defenderTypes) return 1.0;
        let mult = 1.0;
        const defArr = Array.isArray(defenderTypes) ? defenderTypes : [defenderTypes];
        const chart = {
            fire: { weak: ['water', 'rock'], strong: ['grass', 'ice'] },
            water: { weak: ['grass', 'electric'], strong: ['fire', 'rock'] },
            grass: { weak: ['fire', 'ice'], strong: ['water', 'rock'] },
            electric: { weak: ['rock'], strong: ['water'] },
            rock: { weak: ['water', 'grass'], strong: ['fire', 'electric'] },
            ice: { weak: ['fire'], strong: ['grass'] }
        };
        const atkData = chart[moveType];
        if (atkData) { defArr.forEach(def => { if (atkData.strong.includes(def)) mult *= 2.0; if (atkData.weak.includes(def)) mult *= 0.5; }); }
        return mult;
    }

    // NEW: SWAP SYSTEM LOGIC
    let isForcedSwap = false; 

    function openSwapMenu(forced = false) {
        isForcedSwap = forced;
        const modal = document.getElementById('swap-pet-modal');
        const container = document.getElementById('swap-list-container');
        const cancelBtn = document.getElementById('swap-cancel-btn');
        
        container.innerHTML = '';
        cancelBtn.style.display = forced ? 'none' : 'block';

        let availablePets = (gameState.team && gameState.team.length > 0) ? gameState.team.map(id => gameState.pets.find(p => p.id === id)) : gameState.pets;
        availablePets = availablePets.filter(p => p);

        availablePets.forEach(pet => {
            const isCurrent = pet.id === gameState.currentPetId;
            const isFainted = pet.hp <= 0;
            const card = document.createElement('div');
            card.className = `swap-card ${isCurrent ? 'active-pet' : ''} ${isFainted ? 'fainted' : ''}`;
            const visual = pet.image ? `<img src="${pet.image}" style="width:40px; height:40px; object-fit:contain;">` : `<div style="font-size:30px;">${pet.emoji}</div>`;
            const hpPercent = (pet.hp / pet.maxHP) * 100;
            const hpColor = hpPercent < 30 ? 'low' : (hpPercent < 60 ? 'mid' : '');
            card.innerHTML = `${visual}<div style="flex:1;"><div style="font-weight:bold; font-size:14px;">${pet.name} <span style="font-size:10px; color:#718096">Lvl ${pet.level}</span></div><div class="mini-hp-bg"><div class="mini-hp-fill ${hpColor}" style="width:${hpPercent}%"></div></div><div style="font-size:11px; text-align:right;">${pet.hp}/${pet.maxHP} HP</div></div>`;
            if (!isFainted && !isCurrent) card.onclick = () => confirmBattleSwap(pet.id);
            container.appendChild(card);
        });

        modal.classList.add('active');
    }

    async function confirmBattleSwap(newPetId) {
        // 1. Close Modal
        document.getElementById('swap-pet-modal').classList.remove('active');
        
        // 2. Update State
        gameState.currentPetId = newPetId;
        const newPet = gameState.pets.find(p => p.id === newPetId);
        
        // 3. Update HP tracking
        if (gameState.inBattle) {
            // If in a Raid, use the pet's real HP. 
            // If in normal battle, use battleState HP (which might need resetting if switching in fresh)
            if (window.currentRaidDocPath) {
                 // Raid Logic: No separate battleState HP, uses pet.hp directly
            } else {
                 // Normal Battle Logic: Update battleState to match the new pet
                 gameState.battleState.playerHP = newPet.hp;
                 gameState.battleState.playerMaxHP = newPet.maxHP;
            }
        }
        
        showToast(`Go ${newPet.name}!`, "info");

        // --- üõ°Ô∏è FIX: INSTANT VISUAL RESET ---
        // Immediately remove "Faint" effects (Gray/Transparent)
        const pVis = document.getElementById('battle-player-visual');
        if (pVis) {
            pVis.style.filter = "none";
            pVis.style.opacity = "1";
            pVis.style.transform = "scale(1)";
        }

        // --- üõ°Ô∏è FIX: RENDER THE CORRECT SCREEN ---
        if (window.currentRaidDocPath) {
            // We are in a Raid -> Use Raid Renderer
            renderRaidPlayerSide(); 
        } else {
            // We are in Wilds/Arena -> Use Standard Renderer
            renderBattle(); 
        }

        // 4. Handle Turn Penalty (Only for Wilds/Arena, NOT Raids)
        if (!isForcedSwap && gameState.inBattle && !window.currentRaidDocPath) {
            showToast("Swapping took your turn!", "warning");
            await wait(1000); 
            await processEnemyTurnAsync();
        } 
        
        if (gameState.inBattle && !window.currentRaidDocPath) { 
            gameState.battleState.turnInProgress = false; 
            renderBattle(); 
        }
    }

    // 1. Battle Logger Helper
    function addBattleLog(msg, type) {
        const container = document.getElementById('battle-log-feed');
        if (!container) return;
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerText = `> ${msg}`;
        container.prepend(entry);
    }

   function renderBattle() {
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId); 
        const bs = gameState.battleState;
        
        // --- 1. SETUP VISUALS (Top Screen) ---
        // (Visual logic remains the same)
        const pSize = getBattlerSize(pet, false, false);
        const eSize = getBattlerSize(bs.enemy, bs.isBoss, bs.isArena);
        
        const pVis = document.getElementById('battle-player-visual');
        const eVis = document.getElementById('battle-enemy-visual');
        
        pVis.style.filter = "none";    
        pVis.style.opacity = "1";      
        pVis.style.transform = "none"; 
        pVis.classList.remove('flipped-opponent');
        pVis.innerHTML = pet.image 
            ? `<img src="${pet.image}" class="battler-image ${pet.imageStyle}" style="width:${pSize}px; height:${pSize}px;">` 
            : `<div style="font-size:${pSize * 0.7}px;">${pet.emoji}</div>`;
      
        eVis.classList.add('flipped-opponent');
        eVis.innerHTML = bs.enemy.image 
            ? `<img src="${bs.enemy.image}" class="battler-image ${bs.enemy.imageStyle}" style="width:${eSize}px; height:${eSize}px;">` 
            : `<div class="emoji-wrapper" style="font-size:${eSize * 0.7}px;">${bs.enemy.emoji}</div>`;
      
        // Status Icons
        const pIcons = bs.playerStatus ? bs.playerStatus.map(s => s.icon).join(' ') : '';
        const eIcons = bs.enemyStatus ? bs.enemyStatus.map(s => s.icon).join(' ') : '';
      
        document.getElementById('player-battle-name').innerHTML = `${pet.name} ${pIcons} <span class="element-icon">${getElIcon(pet.element)}</span>`;
        document.getElementById('enemy-name').innerHTML = `${bs.enemy.name} ${eIcons} <span class="element-icon">${getElIcon(bs.enemy.element)}</span>`;
        
        // --- SIZE FIX: Toggle Boss Mode ---
        const eContainer = document.getElementById('enemy-container');
        if (bs.isBoss || bs.isArena) {
            eContainer.classList.add('boss-mode'); 
        } else {
            eContainer.classList.remove('boss-mode'); 
        }

        // Update Bars
        document.getElementById('enemy-hp-bar').style.width = (bs.enemyHP / bs.enemy.hp * 100) + "%";
        const pMax = bs.playerMaxHP || pet.maxHP; 
        document.getElementById('player-hp-bar').style.width = (bs.playerHP / pMax * 100) + "%";
        document.getElementById('player-hp-text').innerText = `${Math.ceil(bs.playerHP)}/${pMax}`;

        // --- 2. SETUP CONTROLS (Bottom Screen) ---
        const panel = document.querySelector('.battle-ui-panel');
        
        if(bs.turnInProgress) {
            panel.innerHTML = `<div style="width:100%; text-align:center; font-weight:bold; color:#718096; padding:20px;">Thinking...</div>`;
            return;
        }

        let buttons = pet.powers.map(pid => {
            const move = findShopItem(pid);
            const mult = getTypeMult(move.element, bs.enemy.element);
            
            let indicator = "";
            if (mult >= 2.0) indicator = "‚¨Ü";
            if (mult <= 0.5) indicator = "‚¨á";
            
            const burstStyle = gameState.burstMode ? 'box-shadow: 0 0 10px #f6e05e; border: 2px solid #ecc94b;' : '';

            return `<button class="action-btn green" style="${burstStyle}" onclick="usePowerAsync('${pid}')">
                <span>${move.name} ${indicator}</span>
            </button>`;
        }).join('');

        buttons += `<button class="action-btn blue" onclick="openSwapMenu()">üîÑ Squad</button>`;
        buttons += `<button class="action-btn blue" style="background:#667eea" onclick="openInBattleMath()">üß† FOCUS</button>`;
        buttons += `<button class="action-btn red" onclick="flee()">üèÉ Run</button>`;

        // ‚úÖ CLEANER UI: No Log Container
        panel.innerHTML = `
            <div id="action-buttons-grid" class="battle-actions">
                ${buttons}
            </div>
        `;
    }

 // --- PRO COMBAT: FIXED TURN FLOW & ATTACK ENGINE ---
    async function usePowerAsync(pid) {
        if (gameState.battleState.turnInProgress) return;
        if (gameState.battleState.playerHP <= 0) return showToast("Your pet has fainted!", "error");

        gameState.battleState.turnInProgress = true;
        
        // 1. Resolve Status Effects
        const playerStunned = resolveStatusTurn('player');
        updateStandardBattleUI(); 
        
        if (gameState.battleState.playerHP <= 0) { 
            await wait(1000); handlePlayerFaint(); return; 
        }

        if (playerStunned) {
            await wait(1000); 
        } 
        else {
            // 2. PERFORM ATTACK
            const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
            const enemy = gameState.battleState.enemy;
            const move = findShopItem(pid);
            const gear = getPetEquipmentStats(pet); 

            // A. Animation
            const pVis = document.getElementById('battle-player-visual');
            const eVis = document.getElementById('battle-enemy-visual');
            
            soundManager.playSFX('attack');
            pVis.style.animation = "attackLunge 0.3s";
            createProjectile(move.image || move.icon, pVis, eVis);
            await wait(500); 
            pVis.style.animation = "";

            // B. Damage Calculation
            let mult = getTypeMult(move.element, enemy.element);
            let isCrit = false;
            let critMult = 1.0;
            let effectiveArmor = enemy.armor || 0;

            if (gameState.burstMode) {
                critMult = 2.5; isCrit = true; effectiveArmor = 0; 
                gameState.burstMode = false;
                showToast("üõ°Ô∏è SHIELD SHATTERED!", "success");
                const qz = document.querySelector('.quiz-container');
                if (qz) qz.style.boxShadow = "none";
            } else if (Math.random() < (0.10 + (gear.crit / 100))) {
                critMult = 1.5; isCrit = true;
            }

            // --- MASTERY SYNERGY CHECK ---
            let synergyActive = false;
            const currentTopic = gameState.selectedTopics[0] || ""; // Get current lesson URL
            
            if (pet.badges && pet.badges.length > 0) {
                synergyActive = pet.badges.some(b => currentTopic.toLowerCase().includes(b.toLowerCase()));
            }

            // Calculate damage with potential 20% Boost
            let masteryMult = synergyActive ? 1.2 : 1.0;
            let rawDmg = (move.damage + (pet.level * 2) + gear.dmg) * masteryMult;
            
            if (synergyActive) {
                showFloatingText(pVis.parentElement, "‚ú® SYNERGY!", "heal");
            }
            let mitigation = 100 / (100 + effectiveArmor);
            let dmg = Math.floor((rawDmg * mult * critMult * mitigation) * (Math.random() * 0.2 + 0.9));
            
            gameState.battleState.enemyHP = Math.max(0, gameState.battleState.enemyHP - dmg);

            // C. UI Updates
            updateStandardBattleUI(); 
            soundManager.playSFX('hit');
            eVis.style.animation = "damageShake 0.5s";
            
            let color = isCrit ? "crit" : (mult > 1 ? "super" : (mult < 1 ? "weak" : ""));
            showFloatingText(eVis.parentElement, `-${dmg}`, color);
            addBattleLog(`${pet.name} used ${move.name}!`, isCrit ? 'crit' : 'player');

            if (mitigation < 0.8 && !isCrit) {
                showToast(`üõ°Ô∏è Enemy Armor reduced damage!`, "info");
            }

            // D. MATH-LOCKED GEAR (Lifesteal & Passives)
            // (Moved inside this bracket so 'dmg' variable is visible)
            if (gameState.combo > 0) {
                if (gear.lifesteal > 0 && dmg > 0) {
                    let heal = Math.floor(dmg * gear.lifesteal);
                    gameState.battleState.playerHP = Math.min(gameState.battleState.playerMaxHP, gameState.battleState.playerHP + heal);
                    showFloatingText(pVis.parentElement, `+${heal}`, "heal");
                }

                if (!move.effect && gameState.battleState.enemyHP > 0) {
                    const r = pet.rarity;
                    if ((r === 'rare' || r === 'epic') && Math.random() < (r === 'rare' ? 0.2 : 0.35)) {
                        let autoEffect = null;
                        if (pet.element === 'fire') autoEffect = { type: 'burn', value: 5, duration: 2, chance: 1 };
                        if (pet.element === 'ice') autoEffect = { type: 'freeze', duration: 1, chance: 1 };
                        if (pet.element === 'grass') autoEffect = { type: 'poison', value: 5, duration: 3, chance: 1 };
                        if (autoEffect) applyStatusEffect(autoEffect, 'player', 'enemy');
                    }
                }
            }
        }

        // 3. CHECK VICTORY
        if (gameState.battleState.enemyHP <= 0) { 
            await wait(1000); winBattle(); return; 
        }
        
        // 4. MATH-EARNED HEALING (Legendary Aura)
        const activePet = gameState.pets.find(p => p.id === gameState.currentPetId);
        if (activePet && activePet.rarity === 'legendary' && activePet.hp > 0) {
            if (activePet.element === 'light' || (Array.isArray(activePet.element) && activePet.element.includes('light'))) {
                const healAmt = Math.floor(activePet.maxHP * 0.05);
                activePet.hp = Math.min(activePet.maxHP, activePet.hp + healAmt);
                showToast(`‚ú® Light Aura: +${healAmt} HP Earned!`, "success");
                // Check which screen is active to update the HUD
const isWilds = document.getElementById('screen-wilds').classList.contains('active');
const isAdventure = document.getElementById('screen-adventure').classList.contains('active');
if (isWilds || isAdventure) updateAdventureHUD();
            }
        }
        
        // 5. ENEMY TURN
        await wait(800); 
        await processEnemyTurnAsync();
        
        // 6. RESET TURN
        if (gameState.inBattle) { 
            gameState.battleState.turnInProgress = false; 
            renderBattle(); 
        }
    }

    // Helper to update bars without re-rendering buttons
    function updateStandardBattleUI() {
        const bs = gameState.battleState;
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        
        // Update Enemy Bar
        const eBar = document.getElementById('enemy-hp-bar');
        if(eBar) eBar.style.width = (bs.enemyHP / bs.enemy.hp * 100) + "%";
        
        // Update Player Bar
        const pMax = bs.playerMaxHP || pet.maxHP; 
        const pBar = document.getElementById('player-hp-bar');
        const pText = document.getElementById('player-hp-text');
        
        if(pBar) pBar.style.width = (bs.playerHP / pMax * 100) + "%";
        if(pText) pText.innerText = `${Math.ceil(bs.playerHP)}/${pMax}`;
    }

    async function processEnemyTurnAsync() {
        if (!gameState.inBattle) return;
        
        // 1. RESOLVE ENEMY STATUS
        const enemyStunned = resolveStatusTurn('enemy');
        renderBattle(); 
        
        // Check if enemy died from burn/poison
        if (gameState.battleState.enemyHP <= 0) { 
            await wait(1000); 
            winBattle(); 
            return; 
        }

        // 2. IF FROZEN, SKIP ATTACK
        if (enemyStunned) {
            await wait(1000);
            return;
        }

        // 3. NORMAL ATTACK
        const eVis = document.getElementById('battle-enemy-visual');
        const pVis = document.getElementById('battle-player-visual');
        const enemy = gameState.battleState.enemy;

        eVis.style.animation = "attackLunge 0.3s";
        await wait(300); eVis.style.animation = "";

        // --- MASTERY DEFENSE CHECK ---
        let defenseSynergy = false;
        const currentTopicDef = gameState.selectedTopics[0] || "";
        const petDef = gameState.pets.find(p => p.id === gameState.currentPetId);

        if (petDef.badges && petDef.badges.length > 0) {
            defenseSynergy = petDef.badges.some(b => currentTopicDef.toLowerCase().includes(b.toLowerCase()));
        }

        let defenseMult = defenseSynergy ? 0.8 : 1.0; // Take 20% less damage
        let dmg = Math.floor(enemy.damage * (Math.random() * 0.2 + 0.9) * defenseMult);
        
        if (defenseSynergy) {
             showFloatingText(pVis.parentElement, "üõ°Ô∏è GUARDED!", "heal");
        }
        gameState.battleState.playerHP = Math.max(0, gameState.battleState.playerHP - dmg);
        soundManager.playSFX('hit');
        pVis.style.animation = "damageShake 0.5s";
        
        showFloatingText(pVis.parentElement, `-${dmg}`, "crit");
        addBattleLog(`${enemy.name} attacked for ${dmg} DMG!`, 'enemy');
        
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        
        // THE SHIELD: Apply damage via adjustPetHP and sync local state
        adjustPetHP(pet, -dmg);
        gameState.battleState.playerHP = pet.hp; 

        const gear = getPetEquipmentStats(pet);
        const currentMax = pet.maxHP + gear.hp;
        document.getElementById('player-hp-bar').style.width = (pet.hp / currentMax * 100) + "%";
        document.getElementById('player-hp-text').innerText = `${Math.ceil(gameState.battleState.playerHP)}/${pet.maxHP}`;

        if (gameState.battleState.playerHP <= 0) { await wait(1000); handlePlayerFaint(); }
    }
    
    async function handlePlayerFaint() {
        if (!gameState.team) gameState.team = [gameState.currentPetId]; 
        const playerEl = document.getElementById('battle-player-visual');
        playerEl.style.transition = "filter 1s, opacity 1s, transform 1s";
        playerEl.style.filter = "grayscale(100%) brightness(0.5)";
        playerEl.style.opacity = "0.5";
        playerEl.style.transform = "scale(0.8)";
        
        soundManager.playSFX('wrong'); 
        showToast(`${document.getElementById('display-name').innerText}'s pet fainted!`, "error");
        await wait(1500); 

        const alivePets = gameState.pets.filter(p => 
            ((gameState.team && gameState.team.includes(p.id)) || (!gameState.team)) && 
            p.hp > 0 && p.isHatched
        );
        
        if(alivePets.length > 0) { openSwapMenu(true); } else { loseBattle(); }
    }

    function winBattle() {
        gameState.dailyQuests.combat = Math.min(5, (gameState.dailyQuests.combat || 0) + 1);
        soundManager.stopBGM(); 
        soundManager.playSFX('victory'); 
        
        const activePet = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        const bs = gameState.battleState; 
        
        // 1. Update Active Pet HP
        activePet.hp = bs.playerHP; 
        
        // 2. Calculate Base Rewards
        const qmMult = (gameState.teacherConfig && gameState.teacherConfig.rewardMultiplier) ? gameState.teacherConfig.rewardMultiplier : 1;

let baseXP = Math.floor((bs.enemy.xp || 15) * qmMult);
let bpGained = Math.floor((bs.isBoss ? 100 : (bs.isArena ? 50 : 20)) * qmMult); 

if(qmMult > 1) showToast(`BONUS EVENT: ${qmMult}x Rewards!`, "success"); 
        
        // --- ANTI-CHEAT: OVERLEVELED PENALTY ---
        // If pet is > 5 levels higher than enemy (Wilds only), reduce rewards
        if (!bs.isBoss && !bs.isArena && activePet.level > (bs.enemy.level || 1) + 5) {
            baseXP = 1; 
            bpGained = 1; 
            showToast("Enemy too weak! Reduced Rewards.", "info");
        } else {
            showToast(`Victory! +${bpGained} BP`, "success"); 
        }
        // ---------------------------------------

        addBP(bpGained); 

        // 3. SQUAD XP SHARE LOOP
        const squadIds = gameState.team || [gameState.currentPetId];
        let leveledUpNames = [];

        squadIds.forEach(id => {
            const member = gameState.pets.find(p => p.id === id);
            if (!member) return;

            // Active gets 100%, Bench gets 50%
            const shareMult = (id === gameState.currentPetId) ? 1.0 : 0.5;
            const xpToAdd = Math.floor(baseXP * shareMult);

            if (xpToAdd > 0) {
                member.xp += xpToAdd;

                // Level Up Logic
                const maxLvl = LEVEL_CAPS[member.rarity] || 100;
                if (member.xp >= member.maxXp && member.level < maxLvl) { 
                    member.level++; 
                    member.xp = 0; 
                    member.maxXp = member.level * 300 + 200; 
                    member.maxHP = 50 + (member.level * 10); 
                    member.hp = member.maxHP; // Full heal on level up
                    leveledUpNames.push(member.name);
                } 
            }
        });

        if (leveledUpNames.length > 0) {
            soundManager.playSFX('levelUp');
            showToast(`Level Up: ${leveledUpNames.join(", ")}!`, "success");
        }
        
        applySquadLevelSync(); // Update the floor for everyone else
        
        // 4. Random Egg Drop (Wilds Only)
        if (!bs.isBoss && !bs.isArena && !gameState.questBattleActive && Math.random() < 0.1) {
            const eggPool = [...PET_TYPES.common, ...PET_TYPES.uncommon]; 
            const basePet = eggPool[Math.floor(Math.random() * eggPool.length)];
            const newEgg = JSON.parse(JSON.stringify(basePet)); 
            newEgg.type = basePet.id; 
            newEgg.id = 'egg_' + Date.now(); 
            newEgg.isHatched = false; 
            newEgg.hatchProgress = 0; 
            newEgg.level = 1; xp:0; maxXp:100;
            newEgg.powers = []; 
            newEgg.maxHP = basePet.baseHP; 
            newEgg.hp = basePet.baseHP;
            gameState.pets.push(newEgg); 
            setTimeout(() => { showToast("‚ú® Found a Mystery Egg! ‚ú®", "success"); }, 1500);
        }
// --- üéí BATTLE LOOT ENGINE ---
        // 1. Roll for 40% Drop Chance
        const lootRoll = Math.random();
        const isBossOrQuest = bs.isBoss || gameState.questBattleActive;
        const dropThreshold = isBossOrQuest ? 0.8 : 0.4; // Bosses/Quests drop more often (80%)

        if (lootRoll < dropThreshold && SHOP_ITEMS.equipment && SHOP_ITEMS.equipment.length > 0) {
            console.log("üéÅ Loot Drop Triggered!");
            
            // 2. Determine Rarity (Higher level pets find better stuff)
            const rarityRoll = Math.random();
            let rarityTier = "basic";
            
            if (rarityRoll < 0.05) rarityTier = "legendary"; // 5% Top Tier
            else if (rarityRoll < 0.25) rarityTier = "rare"; // 20% Rare Tier
            else rarityTier = "basic";                       // 75% Common Tier

            // 3. Pick Item & Prefix
            const pool = ITEM_PREFIXES[rarityTier] || ITEM_PREFIXES.basic;
            const prefix = pool[Math.floor(Math.random() * pool.length)];
            const baseItem = SHOP_ITEMS.equipment[Math.floor(Math.random() * SHOP_ITEMS.equipment.length)];

            // 4. Create Unique Instance
            const droppedItem = {
                instanceId: 'drop_' + Date.now() + Math.floor(Math.random()*1000),
                baseId: baseItem.id,
                name: `${prefix.name} ${baseItem.name}`,
                image: baseItem.image || baseItem.icon,
                prefix: JSON.parse(JSON.stringify(prefix)), 
                rarity: rarityTier,
                type: baseItem.type,
                level: 1
            };

            // 5. Add to Inventory
            if (!gameState.inventory.equipment) gameState.inventory.equipment = [];
            gameState.inventory.equipment.push(droppedItem);
            
            // 6. Delay the show slightly so it doesn't overlap victory text
            setTimeout(() => {
                showLootReveal(droppedItem);
            }, 1000);
        }
        gameState.inBattle = false; 
        document.getElementById('battle-ui').style.display = 'none'; 
        
        // 5. QUEST BATTLE RETURN LOGIC
        if (gameState.questBattleActive) {
            gameState.questBattleActive = false; 
            
            if (gameState.questSuccessKey) {
                gameState.questProgress.flags.push(gameState.questSuccessKey);
            }

            if (gameState.pendingQuestRewardData) {
                const r = gameState.pendingQuestRewardData;
                
                const newPet = { 
                    ...r, 
                    id: 'quest_reward_' + Date.now(), 
                    isHatched: false, 
                    hatchProgress: 0, 
                    powers: [], 
                    level: 1, xp: 0, maxXp: 100,
                    savedEvolutions: r.evolutions || [] 
                };
                
                gameState.pets.push(newPet);
                
                document.getElementById('adventure-list-view').style.display = 'none';
                document.getElementById('adventure-play-view').style.display = 'block';
                drawAdventureMap();

                const visual = r.image 
                    ? `<img src="${r.image}" style="width:150px; height:150px; object-fit:contain;">` 
                    : r.emoji;

                triggerRewardCeremony(
                    "QUEST COMPLETE!", 
                    `You found a ${r.name} Egg!`, 
                    visual, 
                    () => { switchTab('adventure'); }
                );
                
                gameState.pendingQuestRewardData = null; 
                saveGame(true); 
                return; 
            } 
            else {
                alert("‚öîÔ∏è Enemy Defeated! The path is open!");
                switchTab('adventure'); 
                document.getElementById('adventure-list-view').style.display = 'none';
                document.getElementById('adventure-play-view').style.display = 'block';
                drawAdventureMap(); 
            }
        } 
        else {
            // Standard Return
            document.getElementById('rpg-wrapper').style.display = 'block'; 
            initRPG(); 
            soundManager.playBGM('wilds');
        }
        
        saveGame(); 
    }

    function loseBattle() { soundManager.stopBGM(); const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); p.hp=0; showToast("Defeated...", "error"); gameState.inBattle=false; document.getElementById('battle-ui').style.display='none'; document.getElementById('wilds-menu').style.display='block'; saveGame(); setTimeout(() => soundManager.playBGM('hub'), 2000); }
    function flee() { 
    if(gameState.battleState.isArena) return showToast("No Running in Arena!", "error"); 
    
    gameState.inBattle = false; 
    document.getElementById('battle-ui').style.display = 'none'; 
    soundManager.stopBGM();

    // CHECK: Are we in an Adventure Quest?
    if (gameState.questBattleActive) {
        // Yes: Go back to Quest Map
        gameState.questBattleActive = false; 
        switchTab('adventure'); 
        document.getElementById('adventure-play-view').style.display = 'block'; 
        document.getElementById('adventure-list-view').style.display = 'none';
        drawAdventureMap(); 
        showToast("You ran away safely...", "info");
    } 
    else {
        // No: Go back to Wilds (Normal behavior)
        document.getElementById('rpg-wrapper').style.display = 'block'; 
        initRPG(); 
        soundManager.playBGM('wilds'); 
    }
}
    function switchTab(t) { 
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); 
    
    const activeTabBtn = document.querySelector(`.tab[data-tab="${t}"]`);
    if(activeTabBtn) activeTabBtn.classList.add('active'); 
    
    const targetScreen = document.getElementById('screen-' + t);
    if(targetScreen) targetScreen.classList.add('active'); 
    
    if(t === 'wilds') soundManager.playBGM('wilds'); else soundManager.playBGM('hub'); 
    if (t === 'hub') renderHub();
    
    // Toggle HUD & Journal Button
    const showAdvUI = (t === 'wilds' || t === 'adventure');
    document.getElementById('adv-hud').style.display = showAdvUI ? 'flex' : 'none';
    document.getElementById('journal-trigger').style.display = showAdvUI ? 'flex' : 'none';
    if (showAdvUI) updateAdventureHUD();
    if (t === 'shop') renderShop();
    
    // --- SMART TOOLS INITIALIZATION ---
    if (t === 'tools') {
        const filterDropdown = document.getElementById('tools-grade-filter');
        if (filterDropdown && gameState.grade) {
            filterDropdown.value = gameState.grade; 
        }
        renderToolsTab();
    }
    
    if (t === 'build') {
        initBuilder();
        if (typeof initBuilderPets === 'function') initBuilderPets(); 
    } else {
        if (typeof builderPetInterval !== 'undefined' && builderPetInterval) {
            clearInterval(builderPetInterval);
        }
    }

    // üî• NEW: INFINITY TOWER INITIALIZATION
    if (t === 'tower') {
        // 1. Update the basic numbers (FREE - No Firebase cost)
        document.getElementById('highest-floor-display').innerText = gameState.highestTowerFloor || 1;
        document.getElementById('current-floor-tag').innerText = gameState.currentTowerFloor || 1;

        // 2. Re-run the entire Lobby logic (FREE - No Firebase cost)
        // This ensures the "Heal All" price is calculated using the REAL HP from the Wilds.
        if (typeof renderTowerLobby === 'function') {
            renderTowerLobby(); 
        }
    }

    if (t !== 'wilds') { 
        document.getElementById('rpg-wrapper').style.display = 'none'; 
        document.getElementById('battle-ui').style.display = 'none'; 
        document.getElementById('wilds-menu').style.display = 'block'; 
    } 
}

// --- PRO UI: HUD & JOURNAL LOGIC ---

function updateAdventureHUD() {
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (!pet) return;

    // 1. Calculate Real Max HP (Base + Gear)
    const gear = getPetEquipmentStats(pet);
    let totalMax = (pet.maxHP || 50) + (gear.hp || 0);

    // üõ°Ô∏è LOGIC FIX: If you have 300 HP but Max says 50, 
    // simply pretend Max is 300 for the display.
    if (pet.hp > totalMax) {
        totalMax = pet.hp;
    }

    // 2. Update HP Bar width (Clamped to 100% max)
    let pct = (pet.hp / totalMax) * 100;
    pct = Math.min(100, Math.max(0, pct)); // Force between 0% and 100%

    const hpBar = document.getElementById('hud-hp-fill');
    if (hpBar) {
        hpBar.style.width = pct + "%";
        // Change color based on health
        hpBar.style.backgroundColor = pct < 30 ? "#f56565" : (pct < 60 ? "#ecc94b" : "#48bb78");
    }

    // 3. Update Text (Now it will say 300/300 instead of 300/50)
    const hpText = document.getElementById('hud-hp-text');
    if (hpText) hpText.innerText = `${Math.ceil(pet.hp)}/${Math.ceil(totalMax)}`;
    
    document.getElementById('hud-pet-icon').innerText = pet.emoji || "üêæ";

    // 4. Update Combo Pill
    const comboPill = document.getElementById('hud-combo-pill');
    if (gameState.combo > 0) {
        comboPill.style.display = 'flex';
        document.getElementById('hud-combo-val').innerText = gameState.combo;
    } else {
        comboPill.style.display = 'none';
    }
}

function toggleJournal() {
    const panel = document.getElementById('journal-panel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) renderJournalContent();
}

function renderJournalContent() {
    const content = document.getElementById('journal-content');
    
    // Check if we are in an Adventure
    if (!window.currentQuestData) {
        content.innerHTML = `<div class="mission-card">üìç Exploring the Wilds<br><small>Find random monsters and level up!</small></div>`;
        return;
    }

    const q = window.currentQuestData;
    let html = `<h3>${q.meta.title}</h3>`;
    
    // Professional Logic: Loop through "Logs" defined in your Quest JSON
    // If you don't have logs, we'll show a default "Next Step"
    if (q.meta.objectives) {
        q.meta.objectives.forEach(obj => {
            const isDone = gameState.questProgress.flags.includes(obj.flag);
            html += `
            <div class="mission-card ${isDone ? 'mission-done' : ''}">
                ${isDone ? '‚úÖ' : 'üéØ'} ${obj.text}
            </div>`;
        });
    } else {
        html += `<div class="mission-card">üéØ Current Objective: Explore ${q.startMap}</div>`;
    }

    content.innerHTML = html;
}
    function updateStatsDisplay() { document.getElementById('bp-display').innerText = gameState.brainPoints; document.getElementById('stamina-display').innerText = gameState.stamina; }
    function createProjectile(v, s, e) { const p = document.createElement('div'); p.className = 'projectile'; if (v && v.startsWith('http')) p.innerHTML = `<img src="${v}">`; else p.innerText = v; const sr = s.getBoundingClientRect(); const er = e.getBoundingClientRect(); p.style.left = (sr.left + sr.width/2 - 75) + 'px'; p.style.top = (sr.top + sr.height/2 - 75) + 'px'; document.body.appendChild(p); const a = p.animate([ { transform: 'translate(0,0) scale(0.5)', opacity: 1 }, { transform: `translate(${er.left+er.width/2 - (sr.left+sr.width/2)}px, ${er.top+er.height/2 - (sr.top+sr.height/2)}px) scale(1.2)`, opacity: 0 } ], { duration: 600 }); a.onfinish = () => p.remove(); }
    function showToast(m, t) { const d = document.createElement('div'); d.className = 'toast ' + t; d.innerText = m; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000); }
    // ==========================================
// OPTIMIZATION #1: BATCH SAVING (Fixes Write Limit)
// ==========================================

let hasUnsavedChanges = false;
let autoSaveInterval = null;


// Background Timer: Checks every 60 seconds
if (autoSaveInterval) clearInterval(autoSaveInterval);
autoSaveInterval = setInterval(() => {
    if (hasUnsavedChanges) {
        saveProgressToFirebase();
        hasUnsavedChanges = false;
        console.log("üïí Auto-Saved to Cloud");
        // Optional: showToast("Progress Saved", "info");
    }
}, 60000); // 60 seconds

    function logout() { location.reload(); }
    function toggleLeaderboard(show) {
        const modal = document.getElementById('leaderboard-modal');
        if (show) {
            modal.classList.add('active');
            // This checks the teacher's dashboard for the topic name, or defaults to "General Review"
            const topicLabel = document.getElementById('t-active-topic');
            const lbTopicDisplay = document.getElementById('lb-topic-name');
            if (lbTopicDisplay) {
                lbTopicDisplay.innerText = topicLabel ? topicLabel.innerText : "General Review";
            }
        } else {
            modal.classList.remove('active');
        }
    }
    
    function toggleQuestBoard(show) {
    const modal = document.getElementById('quest-modal');
    if (show) {
        modal.classList.add('active');
        renderQuestBoard();
    } else {
        modal.classList.remove('active');
    }
}

function updateDailyQuests() {
    if (!gameState.dailyQuests) {
        gameState.dailyQuests = { lastDate: "", math: 0, combat: 0, social: 0, claimed: [false, false, false] };
    }
    const today = new Date().toDateString();
    if (gameState.dailyQuests.lastDate !== today) {
        gameState.dailyQuests = { lastDate: today, math: 0, combat: 0, social: 0, claimed: [false, false, false] };
        saveGame(true);
    }
    checkQuestNotifications();
}

function checkQuestNotifications() {
    const dq = gameState.dailyQuests;
    const dot = document.getElementById('quest-notif-dot');
    const hasUnclaimed = (dq.math >= 20 && !dq.claimed[0]) || (dq.combat >= 5 && !dq.claimed[1]) || (dq.social >= 1 && !dq.claimed[2]);
    if (dot) dot.style.display = hasUnclaimed ? 'block' : 'none';
}

function renderQuestBoard() {
    const dq = gameState.dailyQuests;
    const list = document.getElementById('daily-quest-list');
    if (!list) return;

    const quests = [
        { id: 0, icon: 'üéì', title: 'Scholar', desc: '20 Perfect Math Answers', val: dq.math, target: 20, reward: 500 },
        { id: 1, icon: '‚öîÔ∏è', title: 'Warrior', desc: 'Defeat 5 Wild Monsters', val: dq.combat, target: 5, reward: 100 },
        { id: 2, icon: 'ü§ù', title: 'Citizen', desc: 'Send a Compliment/Heart', val: dq.social, target: 1, reward: 50 }
    ];

    list.innerHTML = quests.map(q => {
        const isDone = q.val >= q.target;
        const isClaimed = dq.claimed[q.id];
        const pct = Math.min(100, (q.val / q.target) * 100);
        return `
        <div class="quest-card ${isDone ? 'complete' : ''} ${isClaimed ? 'claimed' : ''}">
            <div class="quest-icon">${q.icon}</div>
            <div class="quest-info">
                <div class="quest-title">${q.title}: ${q.val}/${q.target}</div>
                <div style="font-size:11px; color:#718096;">${q.desc}</div>
                <div class="quest-progress-bg"><div class="quest-progress-fill" style="width:${pct}%"></div></div>
            </div>
            ${isDone && !isClaimed ? `<button class="btn-claim" onclick="claimQuestReward(${q.id}, ${q.reward})">CLAIM</button>` : ''}
            ${isClaimed ? '‚úÖ' : ''}
        </div>`;
    }).join('');
    checkQuestNotifications();
}

function claimQuestReward(id, amount) {
    gameState.dailyQuests.claimed[id] = true;
    addBP(amount);
    soundManager.playSFX('levelUp');
    triggerRewardCeremony("QUEST COMPLETE!", `+${amount} BP Bounty Claimed!`, "üí∞", null);
    renderQuestBoard();
    saveGame(true);
}
    function releasePet() { if(gameState.pets.length<=1) return; window.petToRelease = gameState.pets.find(p => p.id === gameState.currentPetId); const m = document.getElementById('release-modal'); m.classList.add('active'); }
    document.getElementById('release-confirm').addEventListener('click', () => { 
    const idToRemove = gameState.currentPetId;

    // 1. Remove from Inventory
    gameState.pets = gameState.pets.filter(p => p.id !== idToRemove); 
    
    // 2. Remove from Squad (The Missing Link!)
    if (gameState.team) {
        gameState.team = gameState.team.filter(id => id !== idToRemove);
    }

    // 3. Select a new pet
    if (gameState.pets.length > 0) {
        gameState.currentPetId = gameState.pets[0].id;
        // Ensure team isn't empty
        if (!gameState.team || gameState.team.length === 0) {
            gameState.team = [gameState.currentPetId];
        }
    } else {
        // Game Over safety (shouldn't happen if button is hidden for last pet)
        gameState.currentPetId = null;
    }

    adjustBP(10); 
    saveGame(); 
    renderHub(); 
    document.getElementById('release-modal').classList.remove('active'); 
});

// ---------------------------------------------------------
    // 2. THE FIX: The "NO" Button (PASTE THIS RIGHT HERE!)
    // ---------------------------------------------------------
    document.getElementById('release-cancel').addEventListener('click', () => {
        document.getElementById('release-modal').classList.remove('active');
    });

    // --- ADVENTURE MODE SYSTEM (RESTORATION) ---
    // ... (Your adventure functions remain here, skipping duplicate copy for brevity, they are assumed present as per instruction "Do not delete existing features") ... 
    // Re-adding adventure logic to ensure full functionality:
    let advCanvas, advCtx, advMap = [], advNpcs = [], currentAdvMapKey = "";
    let questX = 1, questY = 1;

    function renderAdventureList() {
        const list = document.getElementById('adventure-list-view');
        if(availableEvents.length === 0) { list.innerHTML = "No active quests."; return; }
        const today = new Date(); today.setHours(0,0,0,0); 
        list.innerHTML = availableEvents.map(ev => {
            let isLocked = false; let statusText = "Active"; let statusClass = "active";
            if (ev.unlockDate) { const unlock = new Date(ev.unlockDate); if (today < unlock) { isLocked = true; statusText = `Opens: ${ev.unlockDate}`; statusClass = "coming"; } } else if (ev.status !== 'active') { isLocked = true; statusText = "Coming Soon"; statusClass = "coming"; }
            const clickAction = isLocked ? `showToast('üîí This event opens on ${ev.unlockDate || "a later date"}!', 'error')` : `loadQuest('${ev.file}')`;
            return `<div class="adventure-card" onclick="${clickAction}" style="${isLocked ? 'opacity:0.6;filter:grayscale(1);' : ''}"><div class="adventure-header" style="${isLocked ? 'background:#718096;' : ''}">${ev.image ? `<img src="${ev.image}" width="24">` : 'üìú'} ${ev.title}</div><div class="adventure-body"><p class="adventure-desc">${ev.description}</p><span class="adventure-status status-${statusClass}">${statusText}</span></div></div>`;
        }).join('');
    }

// ==========================================
    // COMPLETE ADVENTURE ENGINE (FIXED)
    // ==========================================

    async function loadQuest(fileUrl) {
        let url = fileUrl;
        if (!url.startsWith('http')) url = getGhUrl(url);
        
        console.log("Loading quest:", url);

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const qData = await res.json();
            window.currentQuestData = qData;
            startAdventure(qData); // Now works because startAdventure is defined below
        } catch(e) { 
            console.error(e);
            showToast("Error loading quest: " + e.message, "error"); 
        }
    }

    function startAdventure(qData) { 
        if (!qData || !qData.maps) return showToast("Invalid Quest Data", "error");

        // 1. Switch to Adventure Screen
        document.getElementById('adventure-list-view').style.display = 'none'; 
        document.getElementById('adventure-play-view').style.display = 'block'; 
        
        if (qData.meta && qData.meta.title) {
            document.getElementById('quest-title-display').innerText = qData.meta.title;
        }

        // 2. Initialize Canvas
        advCanvas = document.getElementById('adventure-canvas'); 
        advCtx = advCanvas.getContext('2d'); 
        
        // --- FIX: LOAD PET IMAGE FOR QUEST ---
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        if (pet && pet.image && pet.image.length > 5) {
            playerImage.src = pet.image; 
        } else {
            playerImage.src = HUMAN_SPRITE_URL; // Fallback
        }

        // 3. Load First Map
        const startKey = qData.startMap || Object.keys(qData.maps)[0]; 
        loadAdventureMap(startKey); 

        // 4. Input Listener
        advCanvas.onclick = (e) => { 
            const rect = advCanvas.getBoundingClientRect(); 
            const clickX = (e.clientX - rect.left) * (advCanvas.width / rect.width); 
            const clickY = (e.clientY - rect.top) * (advCanvas.height / rect.height); 
            const tileX = Math.floor(clickX / TILE_SIZE); 
            const tileY = Math.floor(clickY / TILE_SIZE); 
            
            const npc = advNpcs.find(n => n.x === tileX && n.y === tileY); 
            if(npc && Math.abs(tileX - questX) + Math.abs(tileY - questY) <= 1) { 
                interactNPC(npc); 
            } 
        };
        
        // 5. KEYBOARD LISTENER (This was missing!)
        document.removeEventListener('keydown', handleKeyDown); 
        document.addEventListener('keydown', handleKeyDown);
    }

    function loadAdventureMap(mapKey) { 
        const mapData = window.currentQuestData.maps[mapKey]; 
        if(!mapData) return showToast("Map missing: " + mapKey, "error");

        currentAdvMapKey = mapKey; 
        advMap = mapData.layout; 
        advNpcs = mapData.npcs || []; 
        
        if(mapData.start) { 
            questX = mapData.start.x; 
            questY = mapData.start.y; 
        } 
        
        // Slight delay to ensure context is ready
        setTimeout(drawAdventureMap, 50); 
    }
    // Expert Feature: Check if NPC should be rendered/collided with
    function isNpcVisible(npc) {
        if (npc.hideOnFlag && gameState.questProgress.flags.includes(npc.hideOnFlag)) {
            return false; // Player has flag -> NPC disappears
        }
        if (npc.showOnFlag && !gameState.questProgress.flags.includes(npc.showOnFlag)) {
            return false; // Player missing flag -> NPC hidden
        }
        return true; // Visible
    }

    function drawAdventureMap() { 
    if (!advCtx || !advMap || advMap.length === 0) return; 
    
    advCtx.clearRect(0,0,advCanvas.width, advCanvas.height); 
    
    // Draw Tiles
    for(let r=0; r<advMap.length; r++) { 
        for(let c=0; c<advMap[0].length; c++) { 
            const tile = advMap[r][c]; 
            const x = c*TILE_SIZE; 
            const y = r*TILE_SIZE; 
            
            if (tile === 9) { // ROCK (Blocked)
                advCtx.fillStyle = '#4a5568'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '20px Arial'; advCtx.fillStyle = '#2d3748'; advCtx.fillText('ü™®', x+8, y+28); 
            } 
            else if (tile === 2) { // TREE (Blocked) - NEW!
                advCtx.fillStyle = '#2e7d32'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '24px Arial'; advCtx.fillStyle = '#1b5e20'; advCtx.fillText('üå≤', x+5, y+30); 
            }
            else if (tile === 8) { // PORTAL (Walkable) - NEW NUMBER!
                advCtx.fillStyle = '#9f7aea'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '20px Arial'; advCtx.fillStyle = 'white'; advCtx.fillText('üåÄ', x+8, y+28); 
            } 
            else if (tile === 5) { // SNOW
                advCtx.fillStyle = '#e2e8f0'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '16px Arial'; advCtx.fillStyle = '#cbd5e0'; advCtx.fillText('‚ùÑÔ∏è', x+8, y+26); 
            }
            else if (tile === 3) { // WATER (Blocked)
                advCtx.fillStyle = '#4fc3f7'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.fillStyle = '#0288d1'; advCtx.fillText('~', x+10, y+25); 
            } 
            else if (tile === 4) { // SAND
                advCtx.fillStyle = '#f6e05e'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
            else if (tile === 1) { // VOID (Blocked)
                advCtx.fillStyle = '#1a202c'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
            else { // GRASS (0)
                advCtx.fillStyle = '#66bb6a'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
        } 
    } 

    // Draw NPCs
    if (advNpcs && Array.isArray(advNpcs)) {
        advNpcs.forEach(n => { 
            // Check visibility
            if (n.hideOnFlag && gameState.questProgress.flags.includes(n.hideOnFlag)) return;
            if (n.showOnFlag && !gameState.questProgress.flags.includes(n.showOnFlag)) return;

            const nx = n.x * TILE_SIZE; 
            const ny = n.y * TILE_SIZE; 
            
            // Shadow
            advCtx.fillStyle = 'rgba(0,0,0,0.3)'; advCtx.beginPath(); 
            advCtx.ellipse(nx+20, ny+35, 10, 5, 0, 0, Math.PI*2); advCtx.fill(); 

            // Sprite
            if (n.sprite && n.sprite.startsWith('http')) { 
                const img = new Image(); img.src = n.sprite; 
                advCtx.drawImage(img, nx, ny, TILE_SIZE, TILE_SIZE); 
            } else { 
                advCtx.fillStyle = '#fff'; advCtx.font = '24px Arial'; 
                advCtx.fillText(n.sprite || 'üßô', nx+5, ny+30); 
            } 
            
            // Quest Marker
            if (Math.abs(n.x - questX) + Math.abs(n.y - questY) <= 1) {
                advCtx.font = '20px Arial'; advCtx.fillStyle = 'yellow'; advCtx.fillText('‚ùó', nx+10, ny);
            }
        }); 
    }

    // Draw Player
    const px = questX * TILE_SIZE; 
    const py = questY * TILE_SIZE; 
    
    // Player Shadow
    advCtx.fillStyle = 'rgba(0,0,0,0.3)'; advCtx.beginPath(); 
    advCtx.ellipse(px+20, py+35, 10, 5, 0, 0, Math.PI*2); advCtx.fill(); 
    
    // Player Image
    if(playerImage.complete && playerImage.naturalWidth > 0) { 
        advCtx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE); 
    } else { 
        advCtx.fillStyle = 'blue'; advCtx.beginPath(); advCtx.arc(px+20, py+20, 15, 0, Math.PI*2); advCtx.fill(); 
    } 
}
function checkAdventureRandomEncounter(tileType) {
        // 1. Define "Safe" tiles (e.g., portals shouldn't trigger battles)
        // Tiles: 0=Grass, 4=Sand, 5=Snow. These are "Wild" areas.
        if (![0, 4, 5].includes(tileType)) return;

        // 2. Chance Check (e.g., 8% chance per step)
        if (Math.random() < 0.08) {
            console.log("‚öîÔ∏è Random Adventure Encounter!");
            
            // --- FIX IS HERE: TELL THE GAME WE ARE IN A QUEST BATTLE ---
        gameState.questBattleActive = true; 
        // -----------------------------------------------------------

            
            // 3. Stop movement and Start Battle
            // We pass 'false' for boss/arena, and 'null' for specific enemy 
            // so the game picks a random one from your loaded lists.
            startBattle(tileType, false, false, null); 
        }
    }
    function handleQuestDPad(key) { 
    // 1. Safety Check: Ensure map data exists
    if(!window.currentQuestData || !advMap) return;

    // --- NEW: STAMINA CHECK ---
    if (gameState.stamina <= 0) {
        showToast("No Stamina! Study to get Energy.", "error");
        return;
    }

    let dx=0, dy=0; 
    if(key==='ArrowUp') dy=-1; 
    if(key==='ArrowDown') dy=1; 
    if(key==='ArrowLeft') dx=-1; 
    if(key==='ArrowRight') dx=1; 
    
    const nx = questX+dx; 
    const ny = questY+dy; 
    
    // Boundary Checks
    if(ny < 0 || ny >= advMap.length) return; 
    if(nx < 0 || nx >= advMap[ny].length) return; 

    // NPC Collision
    const npc = advNpcs.find(n => n.x === nx && n.y === ny && isNpcVisible(n));
    if (npc) {
        interactNPC(npc);
        return; 
    }

    // Blocked Tiles (Walls, Trees, Water)
    const tile = advMap[ny][nx]; 
    const blockedTiles = [1, 9, 2, 3]; 
    if(blockedTiles.includes(tile)) return; 
    
    // Portal Logic
    const mapData = window.currentQuestData.maps[currentAdvMapKey]; 
    if(mapData.portals) { 
        const portal = mapData.portals.find(p => p.x === nx && p.y === ny); 
        if(portal) { 
            loadAdventureMap(portal.toMap); 
            return; 
        } 
    } 
    
    // --- SUCCESSFUL MOVE ---
    questX = nx; 
    questY = ny; 
    
    // --- NEW: CONSUME STAMINA & UPDATE UI ---
    adjustStamina(-1);
    updateStatsDisplay();

    drawAdventureMap(); 
    
    // Random Encounter Check
    checkAdventureRandomEncounter(tile);
}

    // --- Helpers ---
    function interactNPC(npc) { 
        const dBox = document.getElementById('quest-dialog'); 
        document.getElementById('quest-npc-name').innerText = npc.name; 
        document.getElementById('quest-text').innerText = npc.dialogue[0]; 
        dBox.style.display = 'block'; 
        
        const btn = document.getElementById('quest-action-btn'); 
        btn.innerText = "Continue"; 
        btn.onclick = () => { 
            dBox.style.display = 'none'; 
            if(npc.action) triggerQuestAction(npc.action); 
        }; 
    }

    function triggerQuestAction(actionKey) { 
    const gate = window.currentQuestData.gates ? window.currentQuestData.gates[actionKey] : null; 
    if(!gate) return; 
    
    // --- 1. MATH CHALLENGES (The Riddles) ---
    if(gate.type === 'academic_challenge') { 
        if(confirm(`üîí LOCKED! Answer ${gate.questionCount} questions to pass?`)) { 
            startAcademicGate(gate.questionCount, gate.onSuccess); 
        } 
    } 
    
    // --- 2. BATTLE CHALLENGES (The Bosses & Minions) ---
    else if (gate.type === 'battle') { 
        // üõ°Ô∏è SECURITY: Prevent fighting the same boss twice
        if (gate.onSuccess && gameState.questProgress.flags.includes(gate.onSuccess)) {
            showToast("Challenge already complete!", "info");
            return;
        }

        let eid = gate.enemyId;
        // Randomizer: if enemyId is a list [ ], pick one.
        if (Array.isArray(eid)) eid = eid[Math.floor(Math.random() * eid.length)];

        let targetMonster = null;
        // Look in Monsters or Bosses
        targetMonster = MONSTER_TYPES.find(m => m.id === eid || m.name === eid) ||
                        BOSS_TYPES.find(b => b.id === eid || b.id === eid);
        
        // If not found, look in Pet folders
        if (!targetMonster) {
            for (const rarity in PET_TYPES) {
                const found = PET_TYPES[rarity].find(p => p.id === eid || p.name === eid);
                if (found) { targetMonster = { ...found, hp: found.baseHP || 60 }; break; }
            }
        }

        if (targetMonster) {
            // --- üöÄ THE MASTER HANDSHAKE ---
            // This copies your 1500 HP and Legend Image from the JSON to the Monster
            const questMonsterTemplate = {
                ...targetMonster,
                hp: gate.hp || targetMonster.hp,
                damage: gate.damage || targetMonster.damage,
                enemyImage: gate.enemyImage || targetMonster.image,
                enemyName: gate.enemyName || gate.enemyId
            };
            
            if(confirm(`‚ö†Ô∏è DANGER: ${questMonsterTemplate.enemyName} appeared! Fight?`)) { 
                gameState.questBattleActive = true; 
                gameState.questSuccessKey = gate.onSuccess; 
                
                // Keep the reward pet data ready
                if (gate.rewardData) gameState.pendingQuestRewardData = gate.rewardData;
                
                // Trigger the Battle!
                startBattle(7, true, false, questMonsterTemplate); 
            } 
        }
    } 
    
    // --- 3. TREASURE ITEMS (The Chests) ---
    else if (gate.type === 'item') { 
        gameState.questProgress.flags.push(gate.onSuccess); 
        const rewardName = gate.itemName || 'Hidden Item';
        const rewardAmt = gate.reward || 0;
        
        triggerRewardCeremony(
            "TREASURE FOUND!",
            `You discovered: ${rewardName}`,
            "üíé", 
            () => { if(rewardAmt > 0) addBP(rewardAmt); }
        );
    }
}

    function startAcademicGate(count, successKey) { 
        switchTab('study'); 
        let wins = 0; 
        const originalCheck = window.checkAnswer; 
        
        window.checkAnswer = (val) => { 
            let input = val || document.getElementById('answer-input').value; 
            // Simple check logic for gate
            if(input == gameState.currentQuestion.a) { 
                wins++; 
                soundManager.playSFX('correct'); 
                if(wins >= count) { 
                    alert("üéâ Gate Unlocked!"); 
                    window.checkAnswer = originalCheck; 
                    switchTab('adventure'); 
                    gameState.questProgress.flags.push(successKey); 
                } else { 
                    generateNextQuestion(); 
                } 
            } else { 
                alert("‚ùå Failed! Try again later."); 
                window.checkAnswer = originalCheck; 
                switchTab('adventure'); 
            } 
        }; 
        generateNextQuestion(); 
    }

    function exitAdventure() { 
        document.getElementById('adventure-list-view').style.display='grid'; 
        document.getElementById('adventure-play-view').style.display='none'; 
    }


    // --- TEACHER LOGIC ---
    let currentStudentData = null; 

    async function authenticateStudent(name, password) { 
        try { 
            const docRef = window.fbase.doc(window.db, "students", name);
            const d = await window.fbase.getDoc(docRef); 
            
            if (d.exists() && (!d.data().password || d.data().password === password)) {
                const data = d.data();
                return { 
                    success: true, 
                    assignment: { 
                        grade: data.assignedGrade, 
                        topics: data.assignedTopics || [],
                        exam: data.assignedExam || "" // <--- NEW: Grab the Exam Link!
                    } 
                }; 
            } 
            return { success: false, message: "Invalid Login" }; 
        } catch (e) { 
            console.error(e);
            return { success: false, message: "Login Error" }; 
        } 
    }
    // Function to show/hide the teacher login box
function toggleTeacherLogin() { 
    const panel = document.getElementById('teacher-login-panel');
    if (panel) {
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    } else {
        console.error("Error: Could not find element with id 'teacher-login-panel'");
    }
}
    async function checkTeacherPin() { 
    const inputPin = document.getElementById('teacher-pin').value;
    
    // 1. Calculate the Hash of what was typed
    const hashedInput = await sha256(inputPin);

    // 2. Compare against the known Hash of "1030"
    // Hash: 3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4
    const SECRET_HASH = "3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4";

    if (hashedInput === SECRET_HASH) { 
        document.getElementById('teacher-dashboard-screen').style.display = 'block'; 
        loadStudentList(); 
        document.getElementById('teacher-pin').value = ""; // Clear the field for safety
        showToast("Welcome, Teacher!", "success");
    } else { 
        showToast("Wrong PIN", "error"); 
    } 
}
    async function createStudentAccount() { 
    if (!currentLoggedTeacher) return showToast("Error: No teacher logged in", "error");

    const u = document.getElementById('new-student-user').value.trim(); 
    const p = document.getElementById('new-student-pass').value.trim(); 
    
    if(!u || !p) return showToast("Missing Info", "error"); 
    
    // Check if student exists globally (usernames must be unique)
    const check = await window.fbase.getDoc(window.fbase.doc(window.db, "students", u));
    if(check.exists()) return showToast("Username taken!", "error");

    await window.fbase.setDoc(window.fbase.doc(window.db,"students",u), {
        username: u,
        password: p,
        assignedGrade: document.getElementById('new-student-grade').value,
        assignedTopics: [],
        teacherId: currentLoggedTeacher, // <--- THIS LINKS THE STUDENT TO THE TEACHER
        createdAt: new Date()
    }); 
    
    showToast(`Created student: ${u}`, "success"); 
    loadStudentList(); // Refresh list
}
// --- üìÇ NEW: BULK CSV IMPORT LOGIC ---
async function importStudentsCSV() {
    const fileInput = document.getElementById('csv-file-input');
    const status = document.getElementById('csv-status');
    const btn = document.getElementById('csv-import-btn');

    if (!fileInput.files[0]) return showToast("Please select a CSV file!", "error");
    if (!currentLoggedTeacher) return showToast("Error: No teacher logged in.", "error");

    const file = fileInput.files[0];
    const reader = new FileReader();

    // Visual loading state
    btn.disabled = true;
    btn.innerText = "‚è≥ Processing...";
    status.innerText = "Reading CSV rows...";
    status.style.color = "#4a5568";

    reader.onload = async (e) => {
        try {
            const text = e.target.result;
            // Split into rows and remove empty ones
            const rows = text.split(/\r?\n/).filter(row => row.trim() !== "");
            
            const batch = window.fbase.writeBatch(window.db);
            let count = 0;
            let skipped = 0;

            for (let i = 0; i < rows.length; i++) {
                // Split by comma: Username, Password, Grade
                const cols = rows[i].split(',').map(c => c.trim());
                
                const u = cols[0];
                const p = cols[1];
                const g = cols[2];

                // Skip if the row is missing information
                if (!u || !p || !g) {
                    skipped++;
                    continue;
                }

                const studentRef = window.fbase.doc(window.db, "students", u);
                
                // Add this student to the list of updates
                batch.set(studentRef, {
                    username: u,
                    password: p,
                    assignedGrade: g,
                    assignedTopics: [],
                    teacherId: currentLoggedTeacher,
                    createdAt: new Date()
                }, { merge: true }); // 'merge: true' saves their pets if they already exist
                
                count++;
            }

            if (count > 0) {
                await batch.commit(); // Send everything to the database at once
                status.innerText = `‚úÖ Success! Enrolled ${count} students.`;
                status.style.color = "#48bb78";
                showToast(`Imported ${count} students`, "success");
                loadStudentList(); // Refresh the teacher's list
            } else {
                status.innerText = "‚ùå No valid data found in CSV.";
                status.style.color = "#f56565";
            }

        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå Error. Make sure your CSV is formatted correctly.";
            status.style.color = "#f56565";
        } finally {
            btn.disabled = false;
            btn.innerText = "üöÄ Upload & Enroll";
            fileInput.value = ""; // Reset the file picker
        }
    };

    reader.readAsText(file);
}
    function toggleAllStudents(c) { document.querySelectorAll('.student-select-checkbox').forEach(cb => cb.checked = c); updateBulkActionBar(); }
    function toggleGradeStudents(checkbox, grade) {
    // 1. Find the parent group container
    const group = checkbox.closest('.grade-group');
    // 2. Find only the student checkboxes inside THIS specific grade group
    const boxes = group.querySelectorAll('.student-select-checkbox');
    
    boxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    
    // 3. Update the bulk action bar (the blue bar at the top)
    updateBulkActionBar();
}
    function updateBulkActionBar() { const c = document.querySelectorAll('.student-select-checkbox:checked').length; const b = document.getElementById('bulk-action-bar'); document.getElementById('bulk-selected-count').innerText = `${c} Selected`; b.style.display = c > 0 ? 'flex' : 'none'; }
    
   async function loadStudentList() {
    if (!currentLoggedTeacher) return;

    const d = document.getElementById('student-list-container'); 
    d.innerHTML = '<div style="padding:20px;text-align:center;color:gray;">Loading class roster...</div>';
    
    try {
        // 1. Get the Teacher's current Lesson ID from the Class Beacon
        const beaconRef = window.fbase.doc(window.db, "class_stats", `beacon_${currentLoggedTeacher}`);
        const beaconSnap = await window.fbase.getDoc(beaconRef);
        const activeCycleId = beaconSnap.exists() ? beaconSnap.data().currentCycleId : "";

        // 2. Query only the students assigned to YOU
        const studentQuery = window.fbase.query(
            window.fbase.collection(window.db, "students"), 
            window.fbase.where("teacherId", "==", currentLoggedTeacher)
        );
        
        const q = await window.fbase.getDocs(studentQuery); 
        const grouped = {};
        let count = 0;

        q.forEach(doc => {
            const s = doc.data();
            count++;
            const g = s.assignedGrade || "Unassigned"; 
            
            // Check for compressed 'sd' or long 'saveData'
            const saveData = s.saveData || {};
            
            // --- üö© THE CORRUPTION DETECTOR ---
            // Check if BP is NaN OR if any pet has NaN health
            const bpVal = saveData.brainPoints !== undefined ? saveData.brainPoints : saveData.bp;
            const isBpBroken = (bpVal === null || isNaN(bpVal) || typeof bpVal === 'undefined') && bpVal !== 0;
            
            const petsList = saveData.pets || saveData.p || [];
            const isPetBroken = Array.isArray(petsList) && petsList.some(p => isNaN(p.hp) || isNaN(p.h) || isNaN(p.level) || isNaN(p.lv));
            
            const needsRepair = isBpBroken || isPetBroken;
            // ----------------------------------
            
            // üõ°Ô∏è ARCHITECT'S "CYCLE RESET" LOGIC
            // We compare the student's last recorded lesson ID to your current one.
            let displayCorrect = saveData.mathCorrect || 0;
            let displayTotal = saveData.mathTotal || 0;
            
            if (saveData.lastCycleId !== activeCycleId) {
                // If they don't match, they haven't logged in for this lesson yet.
                // We show 0/0 so the teacher knows they haven't started.
                displayCorrect = 0;
                displayTotal = 0;
            }

            const history = saveData.examHistory || {};
            const examCount = Object.keys(history).length;
            const examStatus = examCount > 0 
                ? `<span style="color:#48bb78; font-size:10px; font-weight:bold;">‚úÖ ${examCount} Exams</span>` 
                : `<span style="color:#a0aec0; font-size:10px;">‚è≥ No Exams</span>`;

            if (!grouped[g]) grouped[g] = [];
            
            // Render the Student Row
            grouped[g].push(`
                <div class="student-list-item">
                    <input type="checkbox" class="student-select-checkbox" data-username="${s.username}" onchange="updateBulkActionBar()">
                    <div class="student-info" style="display:flex; flex-direction:column; align-items:flex-start;">
                        <div style="font-size:16px; font-weight:bold; display:flex; align-items:center; gap:8px;">
    ${s.username} 
    ${needsRepair ? `<span style="background:#f56565; color:white; font-size:10px; padding:2px 6px; border-radius:4px; animation: pulse 1s infinite;" title="Data Corruption Detected!">‚ö†Ô∏è CORRUPT</span>` : ''}
</div>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:5px; width:100%;">
                            <div style="font-size:11px; background:#fef3c7; color:#92400e; padding:1px 6px; border-radius:8px; white-space:nowrap;">üß† ${saveData.brainPoints || 0} BP</div>
                            
                            <!-- üìä NEW: LESSON-SPECIFIC PROGRESS BAR -->
                            <div style="flex:1; min-width:150px;">
                                <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:bold;">
                                    <span>Lesson Effort: ${displayCorrect} / ${displayTotal}</span>
                                    <span style="color:${displayTotal > 0 && (displayCorrect/displayTotal) > 0.8 ? '#48bb78' : '#718096'}">
                                        ${displayTotal > 0 ? Math.round((displayCorrect/displayTotal)*100) : 0}%
                                    </span>
                                </div>
                                <div class="monitor-bar-bg">
                                    <div class="monitor-bar-fill" style="width:${displayTotal > 0 ? Math.min(100, (displayCorrect/displayTotal)*100) : 0}%; background:${(displayCorrect/displayTotal) > 0.7 ? '#48bb78' : '#f6ad55'};"></div>
                                </div>
                            </div>
                            ${examStatus}
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="action-btn green" style="width:auto; padding:5px 10px; font-size:12px; margin:0;" onclick="giveStudentBP('${s.username}')">üéÅ</button>
                        <button class="action-btn red" style="width:auto; padding:5px 10px; font-size:12px; margin:0; background: ${needsRepair ? '#e53e3e' : '#ed8936'}; border: ${needsRepair ? '2px solid white' : 'none'};" onclick="repairStudentWallet('${s.username}', ${saveData.mathCorrect || 0})" title="Repair NaN Wallet">üîß</button>
                        <button class="action-btn blue" style="width:auto; padding:5px 10px; font-size:12px; margin:0;" onclick="openTopicManager('${s.username}')">Manage</button>
                        <button class="action-btn red" style="width:auto; padding:5px 10px; font-size:12px; margin:0;" onclick="openDeleteModal('${s.username}')">üóëÔ∏è</button>
                    </div>
                </div>
            `);
        });
        
        if (count === 0) { 
            d.innerHTML = '<div style="padding:20px;text-align:center;">No students found for your class.</div>'; 
            return; 
        }

        // 3. Render Grade Folders
        let finalHtml = ''; 
        const grades = Object.keys(grouped).sort(); 
        grades.forEach(grade => { 
            finalHtml += `
                <div class="grade-group">
                    <div class="grade-summary" style="display:flex; align-items:center; gap:12px; background:#e2e8f0; border-bottom:1px solid #cbd5e0;">
                        <input type="checkbox" style="width:22px; height:22px; cursor:pointer; margin-left:5px;" onclick="event.stopPropagation(); toggleGradeStudents(this, '${grade}')">
                        <div style="flex:1; cursor:pointer; padding:12px 0;" onclick="const list = this.parentElement.nextElementSibling; list.style.display = list.style.display === 'none' ? 'block' : 'none'">
                            <span style="font-weight:bold; color:#2d3748;">üìÇ Grade ${grade}</span>
                            <span style="float:right; font-size:12px; color:#718096; margin-right:15px;">${grouped[grade].length} Students ‚ñº</span>
                        </div>
                    </div>
                    <div class="grade-student-list" style="display:block;">
                        ${grouped[grade].join('')}
                    </div>
                </div>`; 
        });
        d.innerHTML = finalHtml; 

    } catch (e) {
        console.error("Dashboard Load Error:", e);
        d.innerHTML = "Error loading roster. Check database permissions.";
    }
}

    let studentToDelete = null;
    function openDeleteModal(username) { studentToDelete = username; document.getElementById('delete-student-name-display').innerText = username; document.getElementById('teacher-delete-modal').classList.add('active'); }
    async function confirmDeleteStudent() { if(!studentToDelete) return; await window.fbase.deleteDoc(window.fbase.doc(window.db, "students", studentToDelete)); document.getElementById('teacher-delete-modal').classList.remove('active'); showToast("Student Deleted", "success"); loadStudentList(); }
    async function giveStudentBP(username) {
    const amount = prompt(`How many Brain Points for ${username}?`, "50");
    if (!amount || isNaN(amount)) return;
    const val = parseInt(amount);

    const message = prompt(`Attach a message for ${username}?`, "Reward for great work!");
    if (message === null) return;

    const docRef = window.fbase.doc(window.db, "students", username);
    const teacherName = currentLoggedTeacher || "The Teacher";

    const note = {
        from: teacherName,
        type: "reward",
        bp: val,
        text: message,
        time: Date.now()
    };
    
    try {
        await window.fbase.updateDoc(docRef, { 
            "saveData.bp": window.fbase.increment(val),
            "saveData.nt": window.fbase.arrayUnion(note)
        });
        showToast(`‚úÖ Sent reward mail to ${username}!`, "success");
        loadStudentList();
    } catch (e) {
        showToast("User not found or offline.", "error");
    }
}

async function repairStudentWallet(username, mathCorrect) {
    if(!confirm(`‚ö†Ô∏è FULL REPAIR for ${username}? ‚ö†Ô∏è\n\nThis will reset BP and SPAWN a new pet if they lost theirs.`)) return;

    const docRef = window.fbase.doc(window.db, "students", username);
    
    try {
        const docSnap = await window.fbase.getDoc(docRef);
        if (!docSnap.exists()) return showToast("Student not found", "error");
        
        let data = docSnap.data();
        let sd = data.saveData || {};

        // 1. Fix BP Shield
        sd.bp = safeNum(mathCorrect) * 10;

        // 2. Fix Pets (The Engine)
        let petsList = sd.pets || sd.p || [];
        
        // --- üè• LIFE SUPPORT: RESCUE EMPTY ACCOUNTS ---
        // If the student has 0 pets, we give them a Starter Cat so they can play again.
        if (!Array.isArray(petsList) || petsList.length === 0) {
            console.log("üöë Life Support: Spawning Rescue Pet for " + username);
            const starterCat = {
                id: 'rescued_' + Date.now(),
                type: 'monster_01', 
                nm: 'Rescued Cat', 
                lv: 1, hp: 50, mhp: 50, xp: 0, mxp: 500,
                pwr: ['claw_attack'], 
                ih: true, hpg: 100, evs: 0, rty: 'common'
            };
            petsList = [starterCat];
        }

        // Clean up the pets (Heal them and fix NaN levels)
        sd.pets = petsList.map(p => {
            const level = safeNum(p.lv || p.level || 1);
            p.lv = level;
            p.level = level;
            p.mhp = 50 + (level * 10);
            p.hp = p.mhp; // Full heal
            p.xp = 0;
            p.mxp = level * 300 + 200;
            return p;
        });
        
        // Force the compressed key to match
        sd.p = sd.pets;

        // 3. Final Save
        await window.fbase.updateDoc(docRef, { saveData: sd });
        
        showToast(`‚úÖ ${username} has been rescued and repaired!`, "success");
        loadStudentList(); 
    } catch (e) {
        console.error("Rescue Error:", e);
        showToast("Repair failed. Check console.", "error");
    }
}
    
    async function openTopicManager(username) { 
        currentManagingStudent = username; document.getElementById('tm-student-name').innerText=username; document.getElementById('topic-manager-modal').style.display='flex';
        const docSnap = await window.fbase.getDoc(window.fbase.doc(window.db, "students", username));
        if (docSnap.exists()) { currentStudentData = docSnap.data(); document.getElementById('tm-grade-select').value = currentStudentData.assignedGrade || 'K'; renderCurrentAssignmentsList(); }
        refreshTopicManagerUI(); 
    }
    
    function renderCurrentAssignmentsList() {
        const listContainer = document.getElementById('tm-current-assignments');
        if (!currentStudentData.assignedTopics || currentStudentData.assignedTopics.length === 0) { listContainer.innerHTML = '<span style="color:#94a3b8; font-size:12px;">No lessons assigned yet.</span>'; return; }
        listContainer.innerHTML = currentStudentData.assignedTopics.map(t => { let cleanName = t; if (t.includes('/')) cleanName = t.split('/').pop(); cleanName = cleanName.replace('.json', '').replace(/%20/g, ' '); if (t.startsWith('INTERNAL:')) cleanName = t.replace('INTERNAL:', '') + " (Built-in)"; return `<span class="assigned-topic-badge">${cleanName}</span>`; }).join('');
    }

    async function refreshTopicManagerUI() { 
        const g=document.getElementById('tm-grade-select').value; const d=document.getElementById('tm-topic-list'); d.innerHTML='Loading...'; let files=[]; 
        if(GITHUB_CONFIG.enabled) files=await fetchGithubFolder(`questions/grade_${g}`); d.innerHTML=''; 
        const isChecked = (val) => { return (currentStudentData && currentStudentData.assignedTopics && currentStudentData.assignedTopics.includes(val)) ? 'checked' : ''; };
        if(files.length>0) { files.filter(f=>f.name.endsWith('.json')).forEach(f=> { d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="${f.download_url}" ${isChecked(f.download_url)}> ${f.name}</label>`; }); } else { Object.keys(QUESTION_REPOSITORY[g]||{}).forEach(t=> { const val = `INTERNAL:${t}`; d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="${val}" ${isChecked(val)}> ${t}</label>`; }); }
    }
    
    async function saveStudentTopics() { 
        const checkboxes = document.querySelectorAll('#tm-topic-list input'); let finalTopics = new Set(currentStudentData.assignedTopics || []);
        checkboxes.forEach(cb => { if (cb.checked) { finalTopics.add(cb.value); } else { finalTopics.delete(cb.value); } });
        const newGrade = document.getElementById('tm-grade-select').value;
        await window.fbase.updateDoc(window.fbase.doc(window.db,"students",currentManagingStudent), { assignedGrade: newGrade, assignedTopics: Array.from(finalTopics) }); 
        showToast("Saved!", "success"); document.getElementById('topic-manager-modal').style.display='none'; 
    }

    function openBulkTopicManager() { const selected = document.querySelectorAll('.student-select-checkbox:checked'); if(selected.length === 0) return showToast("No students selected", "error"); document.getElementById('bulk-student-count-display').innerText = `Applying to ${selected.length} students.`; document.getElementById('bulk-assign-modal').style.display = 'flex'; refreshBulkTopicUI(); }
    // ==========================================
    // ==========================================
    // üì¶ BULK ASSIGN LOGIC (Now with Exams!)
    // ==========================================

    async function refreshBulkTopicUI() { 
        const g = document.getElementById('bulk-grade-select').value; 
        const d = document.getElementById('bulk-topic-list'); 
        const examSel = document.getElementById('bulk-exam-select');

        // 1. FETCH TOPICS (questions/grade_X)
        d.innerHTML='<div style="color:gray;">Loading Topics...</div>'; 
        let files=[]; 
        if(GITHUB_CONFIG.enabled) files = await fetchGithubFolder(`questions/grade_${g}`); 
        
        d.innerHTML=''; 
        if(files.length > 0) {
            files.filter(f => f.name.endsWith('.json')).forEach(f => {
                d.innerHTML += `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${f.download_url}"> ${f.name}</label>`;
            });
        } else {
            Object.keys(QUESTION_REPOSITORY[g]||{}).forEach(t => {
                d.innerHTML += `<label style="display:block; margin:5px 0;"><input type="checkbox" value="INTERNAL:${t}"> ${t}</label>`;
            });
        }

        // 2. FETCH EXAMS (tests/grade_X) - NEW!
        if (examSel) {
            examSel.innerHTML = '<option>Loading Exams...</option>';
            examSel.disabled = true;
            
            let tests = await fetchGithubFolder(`tests/grade_${g}`);
            
            examSel.innerHTML = '<option value="">-- Keep Existing / No Change --</option>';
            examSel.disabled = false;
            
            if (tests && tests.length > 0) {
                tests.filter(f => f.name.endsWith('.json')).forEach(f => {
                    examSel.innerHTML += `<option value="${f.download_url}">üìù ${f.name}</option>`;
                });
            } else {
                examSel.innerHTML += `<option disabled value="">No exams found</option>`;
            }
        }
    }

    async function saveBulkStudentTopics() {
    const selectedStudents = Array.from(document.querySelectorAll('.student-select-checkbox:checked')).map(cb => cb.dataset.username); 
    const topics = Array.from(document.querySelectorAll('#bulk-topic-list input:checked')).map(cb => cb.value); 
    const grade = document.getElementById('bulk-grade-select').value;
    const exam = document.getElementById('bulk-exam-select').value;
    const shouldClear = document.getElementById('bulk-clear-checkbox').checked;

    if (selectedStudents.length === 0) return showToast("No students selected", "error");
    if (topics.length === 0 && shouldClear && !confirm("You selected 'Clear' but picked no new topics. This will leave students with NO lessons. Continue?")) return;
    
    const batch = window.fbase.writeBatch(window.db);
    
    selectedStudents.forEach(user => { 
        const ref = window.fbase.doc(window.db, "students", user); 
        
        // 1. Set the Grade
        const updateData = { assignedGrade: grade }; 
        
        // 2. Handle Topics (The New Logic)
        if (shouldClear) {
            // REPLACEMENT MODE: Just set the array exactly as it is
            updateData.assignedTopics = topics;
        } else {
            // ADDITIVE MODE: Use arrayUnion to keep old ones
            if (topics.length > 0) {
                updateData.assignedTopics = window.fbase.arrayUnion(...topics); 
            }
        }
        
        // 3. Update Exam (If one was picked)
        if (exam && exam !== "") {
            updateData.assignedExam = exam;
        }
        
        batch.update(ref, updateData); 
    });
    
    await batch.commit(); 
    
    // Cleanup: Reset the checkbox for next time
    document.getElementById('bulk-clear-checkbox').checked = false;
    
    showToast(`Successfully updated ${selectedStudents.length} students!`, "success"); 
    document.getElementById('bulk-assign-modal').style.display='none';
}

async function bulkRewardBP() {
    const selected = Array.from(document.querySelectorAll('.student-select-checkbox:checked'))
                          .map(cb => cb.dataset.username);
    
    if (selected.length === 0) return showToast("No students selected", "error");

    // 1. Ask for Reward Details
    const amount = prompt(`Reward ${selected.length} students with how many Brain Points?`, "50");
    if (!amount || isNaN(amount)) return;
    const val = parseInt(amount);
    
    const message = prompt("Attach a message? (Optional)", "Great job in class today!");
    if (message === null) return; // Cancel if they hit cancel on message

    // 2. Process the Batch
    const batch = window.fbase.writeBatch(window.db);
    const teacherName = currentLoggedTeacher || "The Teacher";

    selected.forEach(user => {
        const ref = window.fbase.doc(window.db, "students", user);
        
        // Create the Mailbox Note
        const note = {
            from: teacherName,
            type: "reward",
            bp: val,
            text: message,
            time: Date.now()
        };

        batch.update(ref, { 
            "saveData.bp": window.fbase.increment(val),
            "saveData.nt": window.fbase.arrayUnion(note) // Adds to student's mail
        });
    });

    try {
        await batch.commit();
        showToast(`üéÅ Mail sent to ${selected.length} students!`, "success");
        loadStudentList(); 
        toggleAllStudents(false);
    } catch (e) {
        console.error(e);
        showToast("Error sending rewards.", "error");
    }
}


    let currentRoomId=null, pvpUnsubscribe=null, isHost=false, localOpponentHP=0, localPlayerHP=0;
    function showMultiplayerMenu() { document.getElementById('wilds-menu').style.display='none'; document.getElementById('multiplayer-menu').style.display='block'; }
    
    async function createPvPRoom() { 
    if(gameState.brainPoints < 100) return showToast("Need 100 BP", "error"); 
    const squad = getSquad(); // Get all 6 pets
    if(squad.length === 0) return showToast("Your squad is empty!", "error");

    adjustBP(-100); 
    const code = Math.floor(1000 + Math.random() * 9000).toString(); 
    currentRoomId = code; isHost = true; 

    // We save the entire squad array to the room
    await window.fbase.setDoc(window.fbase.doc(window.db,"rooms",code),{ 
            hostName:gameState.playerName, 
            hostSquad:getSquad(), 
            status:"waiting", 
            turn:"host", 
            lastAction: null,
            logs:[`${gameState.playerName} created room.`] 
        });

    document.getElementById('multiplayer-menu').style.display = 'none'; 
    document.getElementById('pvp-lobby-screen').style.display = 'block'; 
    document.getElementById('display-room-code').innerText = code; 
    subscribeToRoom(code); 
}
    
    async function joinPvPRoom() { 
    const code = document.getElementById('room-code-input').value.trim(); 
    const squad = getSquad();
    if(squad.length === 0) return showToast("Your squad is empty!", "error");

    const r = await window.fbase.getDoc(window.fbase.doc(window.db, "rooms", code)); 
    if(r.exists() && r.data().status === "waiting") { 
        currentRoomId = code; isHost = false; 
        await window.fbase.updateDoc(window.fbase.doc(window.db,"rooms",code),{ 
                guestName:gameState.playerName, 
                guestSquad:getSquad(), 
                status:"connected", 
                logs:window.fbase.arrayUnion(`${gameState.playerName} joined!`)
            }); 
        document.getElementById('multiplayer-menu').style.display = 'none'; 
        document.getElementById('pvp-lobby-screen').style.display = 'block'; 
        document.getElementById('display-room-code').innerText = code; 
        subscribeToRoom(code); 
    } else { showToast("Room Error", "error"); }
}
    
   let pvpLastActionTime = 0; 

function subscribeToRoom(code) { 
    pvpUnsubscribe = window.fbase.onSnapshot(window.fbase.doc(window.db,"rooms",code), (doc) => { 
        const d = doc.data(); 
        if(!d) return; 

        if(d.status === 'battle') { 
            if(document.getElementById('pvp-lobby-screen').style.display !== 'none') { 
                document.getElementById('pvp-lobby-screen').style.display = 'none'; 
                document.getElementById('battle-ui').style.display = 'flex'; 
                soundManager.playBGM('boss'); 
            }

            // 1. DRAW PETS FIRST
            renderPvPBattle(d); 

            // 2. TRIGGER PROJECTILE SECOND
            if (d.lastAction && d.lastAction.ts > pvpLastActionTime) {
                pvpLastActionTime = d.lastAction.ts;
                // Wait 50ms to ensure the browser has finished "drawing" the pets
                setTimeout(() => playSquadPvpAnimation(d.lastAction), 50);
            }
        } else {
            document.getElementById('pvp-host-status').innerHTML = `Host: ${d.hostName}`; 
            document.getElementById('pvp-guest-status').innerHTML = `Guest: ${d.guestName||'...'}`; 
            if(d.status === 'connected' && isHost) document.getElementById('pvp-start-btn').style.display='block'; 
        }
    }); 
}

// THIS PHYSICALLY THROWS THE ATTACK
async function playSquadPvpAnimation(act) {
    // Finds the DIVs using the IDs we set in renderPvPBattle
    const attackerId = `slot-${act.side}-${act.aIdx}`;
    const defenderSide = (act.side === 'host' ? 'guest' : 'host');
    const defenderId = `slot-${defenderSide}-${act.tIdx}`;

    const attackerEl = document.getElementById(attackerId);
    const targetEl = document.getElementById(defenderId);

    if (attackerEl && targetEl) {
        soundManager.playSFX('attack');
        
        // 1. Lunge (Jump forward)
        const moveX = (act.side === 'host' ? 40 : -40);
        attackerEl.style.transform = `translateX(${moveX}px)`;
        
        // 2. Projectile (Icon flying across)
        createProjectile(act.icon, attackerEl, targetEl);
        
        // 3. Impact
        await new Promise(r => setTimeout(r, 500)); 
        attackerEl.style.transform = "none";
        targetEl.style.animation = "damageShake 0.4s";
        soundManager.playSFX('hit');
    }
}
// --- ‚öîÔ∏è FULL PVP SUITE (Mobile/Split-Screen Ready) ---

// 1. START BATTLE (Host Only)
async function startPvPBattle() { 
    await window.fbase.updateDoc(window.fbase.doc(window.db,"rooms",currentRoomId), {
        status: "battle",
        logs: window.fbase.arrayUnion("‚öîÔ∏è BATTLE START!")
    }); 
}

// --- ‚öîÔ∏è 6v6 SQUAD PVP RENDERER (ANIMATION READY) ---
function renderPvPBattle(d) {
    const stage = document.querySelector('#battle-ui .battle-arena');
    
    // We only clear the stage if the pets aren't there yet.
    // This prevents deleting projectiles while they are flying!
    if (!document.getElementById('slot-host-0')) {
        stage.innerHTML = ''; 
    }
    
    const hostSlots = [[25,40,'row-top'], [15,40,'row-top'], [5,40,'row-top'], [30,50,'row-bottom'], [20,50,'row-bottom'], [10,50,'row-bottom']];
    const guestSlots = [[55,40,'row-top'], [65,40,'row-top'], [75,40,'row-top'], [60,50,'row-bottom'], [70,50,'row-bottom'], [80,50,'row-bottom']];

    // DRAW/UPDATE HOST SQUAD
    d.hostSquad.forEach((p, i) => {
        let div = document.getElementById('slot-host-' + i);
        if (!div) {
            div = document.createElement('div');
            div.id = 'slot-host-' + i;
            div.className = `hero-slot ${hostSlots[i][2]}`;
            div.style.left = hostSlots[i][0] + "%"; div.style.top = hostSlots[i][1] + "%";
            div.style.width = "15%";
            stage.appendChild(div);
        }
        const isFainted = p.hp <= 0;
        div.style.filter = isFainted ? "grayscale(1) opacity(0.4)" : "none";
        div.innerHTML = `<div class="hero-hp-number">${isFainted ? 'KO' : Math.ceil(p.hp)}</div><img src="${p.image}" class="hero-img-unit ${p.imageStyle || ''}">`;
    });

    // DRAW/UPDATE GUEST SQUAD
    d.guestSquad.forEach((p, i) => {
        let div = document.getElementById('slot-guest-' + i);
        if (!div) {
            div = document.createElement('div');
            div.id = 'slot-guest-' + i;
            div.className = `hero-slot ${guestSlots[i][2]}`;
            div.style.left = guestSlots[i][0] + "%"; div.style.top = guestSlots[i][1] + "%";
            div.style.width = "15%";
            stage.appendChild(div);
        }
        const isFainted = p.hp <= 0;
        div.style.filter = isFainted ? "grayscale(1) opacity(0.4)" : "none";
        div.innerHTML = `<div class="hero-hp-number" style="color:#f56565;">${isFainted ? '' : Math.ceil(p.hp)}</div><img src="${p.image}" class="hero-img-unit ${p.imageStyle || ''}" style="transform:scaleX(-1);">`;
    });

    // --- TURN CONTROL LOGIC ---
    const amIHost = isHost;
    const isMyTurn = (d.turn === 'host' && amIHost) || (d.turn === 'guest' && !amIHost);
    const mySquad = amIHost ? d.hostSquad : d.guestSquad;
    const oppSquad = amIHost ? d.guestSquad : d.hostSquad;

    const panel = document.querySelector('.battle-ui-panel');
    const activePet = mySquad.find(p => p.hp > 0); 

    if (!activePet) {
        panel.innerHTML = `<div style="text-align:center; color:#e53e3e; font-weight:bold; padding:20px;">SQUAD DEFEATED</div>`;
    } else if (isMyTurn) {
        const turnHeader = `<div style="color:#48bb78; font-weight:bold; text-align:center; margin-bottom:5px;">‚ö° YOUR TURN (${activePet.name})</div>`;
        const buttons = activePet.powers.map(pid => {
            const move = findShopItem(pid);
            return `<button class="action-btn green" onclick="usePvPAttack('${pid}')">${move.name}</button>`;
        }).join('');
        panel.innerHTML = `${turnHeader}<div class="battle-actions">${buttons}</div>`;
    } else {
        panel.innerHTML = `<div style="text-align:center; color:#718096; padding:20px;">Opponent's Turn...</div>`;
    }

    // --- WIN/LOSS CHECK ---
    if (!mySquad.some(p => p.hp > 0)) { alert("‚ùå Defeat!"); leavePvPRoom(); }
    else if (!oppSquad.some(p => p.hp > 0) && d.guestName) { alert("üèÜ Victory!"); leavePvPRoom(); }
}

// 3. ATTACK ACTION (Animated)
// --- ‚öîÔ∏è 6v6 ANIMATED PVP ATTACK ENGINE ---
async function usePvPAttack(pid) {
    const move = findShopItem(pid);
    const r = window.fbase.doc(window.db, "rooms", currentRoomId);
    
    try {
        await window.fbase.runTransaction(window.db, async(t) => {
            const doc = await t.get(r);
            if (!doc.exists()) throw "Room closed";
            const d = doc.data();
            
            // 1. Turn Enforcement (Alternate Turns)
            const mySide = isHost ? 'host' : 'guest';
            const oppSide = isHost ? 'guest' : 'host';
            if (d.turn !== mySide) return; 

            let mySquad = [...d[mySide + 'Squad']];
            let enemySquad = [...d[oppSide + 'Squad']];
            
            // 2. Identify Attacker and Target positions
            const aIdx = mySquad.findIndex(p => p.hp > 0);
            const tIdx = enemySquad.findIndex(p => p.hp > 0);
            
            if (tIdx === -1 || aIdx === -1) return; 

            // 3. Calculate Damage
            const baseDmg = safeNum(move.damage || 10);
            const levelBonus = safeNum(mySquad[aIdx].level || 1) * 2;
            const dmg = baseDmg + levelBonus + Math.floor(Math.random() * 10);

            // 4. Apply Damage
            enemySquad[tIdx].hp = Math.max(0, enemySquad[tIdx].hp - dmg);

            // 5. Build the Update with the PROJECTILE SIGNAL
            let updates = {};
            updates[oppSide + 'Squad'] = enemySquad;
            updates.turn = oppSide; // Flip turn to opponent
            
            // This is the "Packet" that triggers the projectile on both screens
            updates.lastAction = {
                side: mySide,
                aIdx: aIdx,
                tIdx: tIdx,
                icon: move.image || move.icon,
                ts: Date.now()
            };

            updates.logs = window.fbase.arrayUnion(`${d[mySide + 'Name']} used ${move.name}!`);

            t.update(r, updates);
        });
    } catch (e) { 
        console.error("PVP Sync Error:", e);
    }
}

// 4. LEAVE ROOM (Cleanup)
function leavePvPRoom() { 
    if(pvpUnsubscribe) pvpUnsubscribe(); 
    currentRoomId=null; 
    
    // Reset UI
    document.getElementById('pvp-lobby-screen').style.display='none'; 
    document.getElementById('battle-ui').style.display='none'; 
    document.getElementById('wilds-menu').style.display='block'; 
    
    // Remove Boss Mode Size
    const eContainer = document.getElementById('enemy-container');
    if (eContainer) eContainer.classList.remove('boss-mode');

    soundManager.playBGM('wilds'); 
}
    
    function readQuestionAloud() { if (gameState.currentQuestion) { const d=document.createElement('div'); d.innerHTML=gameState.currentQuestion.q; const t=d.textContent||d.innerText||""; if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.rate = 0.9; window.speechSynthesis.speak(u); } } }
    
    let touchStartX = 0; let touchStartY = 0;
    function initSwipe() { const zone = document.getElementById('rpg-canvas'); zone.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false}); zone.addEventListener('touchend', function(e) { let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY); }, {passive: false}); }
    function handleSwipe(sx, sy, ex, ey) { if (gameState.inBattle) return; const diffX = ex - sx; const diffY = ey - sy; if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return; if (Math.abs(diffX) > Math.abs(diffY)) { handleDPad(diffX > 0 ? 'ArrowRight' : 'ArrowLeft'); } else { handleDPad(diffY > 0 ? 'ArrowDown' : 'ArrowUp'); } }

    // --- WORLD BOSS RAID SYSTEM (ADVANCED) ---

    let raidUnsub = null;
    let currentRaidData = null;

    // ===============================================
// FIXED TEACHER SUMMON (Complete Logic)
// ===============================================
async function teacherSummonRaid() {
    console.log("üëâ Teacher Summon Clicked");

    if (!currentLoggedTeacher) {
        return showToast("Error: You are not logged in.", "error");
    }

    try {
        // 1. Get Values from HTML
        const nameEl = document.getElementById('t-boss-name');
        const hpEl = document.getElementById('t-boss-hp');
        const atkEl = document.getElementById('t-boss-atk');
        const imgEl = document.getElementById('t-boss-img');
        const rewEl = document.getElementById('t-boss-reward-url');

        if (!nameEl || !hpEl) {
            alert("Error: Input boxes are missing from the HTML!");
            return;
        }

        const name = nameEl.value || "Class Boss";
        const hp = parseInt(hpEl.value) || 5000;
        const atk = parseInt(atkEl.value) || 15;
        const img = imgEl.value || "";
        const reward = rewEl.value || "";

        // 2. DEFINE THE DATA (This is what was missing before!)
        const bossData = {
            name: name,
            hp: hp,
            maxHP: hp,
            attack: atk,
            image: img,
            rewardUrl: reward,
            active: true,
            summonedBy: currentLoggedTeacher,
            damageDealers: {} 
        };

        // 3. Send to Firebase (To the Teacher's specific ID)
        await window.fbase.setDoc(window.fbase.doc(window.db, "world_boss", `teacher_${currentLoggedTeacher}`), bossData);
        
        alert("‚úÖ Class Boss Summoned Successfully!");

    } catch (e) {
        console.error("Teacher Summon Error:", e);
        alert("Summon Failed: " + e.message);
    }
}

async function checkClassBoss() {
    if (!gameState.playerName) return;
    
    let tid = gameState.teacherId;
    
    if (!tid) {
        try {
            const s = await window.fbase.getDoc(window.fbase.doc(window.db, "students", gameState.playerName));
            if (s.exists()) tid = s.data().teacherId;
            if (tid) gameState.teacherId = tid;
        } catch(e) {}
    }

    if (tid) {
        window.fbase.onSnapshot(window.fbase.doc(window.db, "world_boss", `teacher_${tid}`), (doc) => {
            const data = doc.data();
            
            // SAME LOGIC AS GLOBAL
            if (doc.exists() && data.active) {
                if (data.hp <= 0) {
                     if (currentRunDamage === 0) {
                        alert("Class Boss already defeated!");
                        finalizeExit();
                    } else {
                        handleRaidVictory();
                    }
                } else {
                    setupRaidData(data, `teacher_${tid}`);
                }
            } else {
                // NO BOSS AT ALL -> KICK OUT
                alert("No Active Raid found.");
                finalizeExit();
            }
        });
    } else {
        alert("No Global Raid and No Class Assigned.");
        finalizeExit();
    }
}

// Helper to update UI
function setupRaidData(data, docId) {
    currentRaidData = data;
    localRaidData = data; 
    
    document.getElementById('raid-boss-hp-text').innerText = `${Math.ceil(data.hp)} / ${data.maxHP}`;
    document.getElementById('raid-boss-bar').style.width = (data.hp / data.maxHP * 100) + "%";
    
    const vis = document.getElementById('raid-boss-visual');
    if (!vis.innerHTML.includes(data.image || 'üëπ')) {
         vis.innerHTML = data.image ? `<img src="${data.image}" style="width:200px; filter:drop-shadow(0 0 10px red);">` : 'üëπ';
    }
    
    renderLeaderboard(data.damageDealers);
    window.currentRaidDocPath = docId; 
}

    function renderLeaderboard(dealers) {
        if (!dealers) return;
        
        // Convert object to array and sort
        const sorted = Object.entries(dealers)
            .sort(([,a], [,b]) => b - a) // Sort desc
            .slice(0, 10); // Top 10

        const list = document.getElementById('raid-leaderboard-list');
        list.innerHTML = sorted.map(([name, dmg], index) => {
            const isMe = name === gameState.playerName;
            let medal = "";
            if (index === 0) medal = "ü•á";
            else if (index === 1) medal = "ü•à";
            else if (index === 2) medal = "ü•â";

            return `<div class="lb-row ${isMe ? 'me' : ''}">
                <span>${medal} ${index+1}. ${name}</span>
                <span>${dmg} dmg</span>
            </div>`;
        }).join('');
    }

    // 4. Attack Transaction (Prevent Race Conditions)
    let raidCooldown = false;
    // Recommendation 1: Buffered Raid Attack (Saves Firebase Writes)
async function attackRaidBoss() {
    if (raidCooldown) return;
    
    let pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (pet.hp <= 0) return showToast("Pet fainted!", "error");

    raidCooldown = true;
    const btn = document.getElementById('raid-atk-btn');
    btn.style.opacity = 0.5;

    const dmg = 20 + (pet.level * 2) + Math.floor(Math.random() * 10);
    
    // Update locally instantly for "Juice"
    localPendingDamage += dmg; 
    currentRunDamage += dmg; 

    const vis = document.getElementById('raid-boss-visual');
    vis.style.transform = "scale(0.9) rotate(5deg)";
    setTimeout(() => vis.style.transform = "scale(1)", 100);
    showFloatingText(vis.parentElement, `-${dmg}`, "super");

    // Start the sync timer if it isn't running
    if (!raidSyncTimer) {
        raidSyncTimer = setInterval(syncRaidDamageToCloud, 5000); 
    }

    if (Math.random() > 0.6) {
        const bossAtk = (localRaidData && localRaidData.attack) ? localRaidData.attack : 15;
        pet.hp = Math.max(0, pet.hp - bossAtk);
        renderRaidPlayerSide();
    }

    setTimeout(() => { raidCooldown = false; btn.style.opacity = 1; }, 400);
}

// New helper to send buffered damage to cloud
async function syncRaidDamageToCloud() {
    if (localPendingDamage <= 0 || !window.currentRaidDocPath) return;

    const dmgToSend = localPendingDamage;
    localPendingDamage = 0; 
    
    const ref = window.fbase.doc(window.db, "world_boss", window.currentRaidDocPath);
    try {
        await window.fbase.runTransaction(window.db, async (t) => {
            const doc = await t.get(ref);
            if (!doc.exists()) return;
            const d = doc.data();
            const myTotal = (d.damageDealers && d.damageDealers[gameState.playerName]) ? d.damageDealers[gameState.playerName] : 0;

            t.update(ref, { 
                hp: window.fbase.increment(-dmgToSend),
                [`damageDealers.${gameState.playerName}`]: myTotal + dmgToSend
            });
        });
        console.log("üì° Synced damage to cloud:", dmgToSend);
    } catch (e) {
        localPendingDamage += dmgToSend; // Put it back to try again if it failed
    }
}

 // ===============================================
// SECURE VICTORY SYSTEM (Prevents Infinite Claiming)
// ===============================================
let hasClaimedRaidReward = false; 

// --- üõ°Ô∏è CHEAT-PROOF VICTORY SYSTEM (Server-Side Check) ---

async function handleRaidVictory() {
    console.log("üèÜ Processing Victory...");

    // 1. Identify the Boss Document
    const path = window.currentRaidDocPath || "global";
    const ref = window.fbase.doc(window.db, "world_boss", path);

    // ---------------------------------------------------------
    // üõë STEP 1: FORCE SERVER CHECK
    // We ignore local memory and ask the database directly:
    // "Has this student looted this boss?"
    // ---------------------------------------------------------
    let serverData;
    try {
        const snap = await window.fbase.getDoc(ref);
        if (snap.exists()) {
            serverData = snap.data();
        } else {
            return showToast("Error: Boss data not found.", "error");
        }
    } catch (e) {
        console.error(e);
        return showToast("Network error checking claim status.", "error");
    }

    // üõë STEP 2: THE RECEIPT CHECK
    // If their name is ALREADY in the database list, stop everything.
    if (serverData.claimedBy && serverData.claimedBy.includes(gameState.playerName)) {
        console.log("üö´ Loot already claimed. Stopping.");
        renderAlreadyClaimedScreen();
        return; // <--- STOP HERE. Do not give loot.
    }

    // ---------------------------------------------------------
    // ‚úÖ STEP 3: SIGN THE RECEIPT (Before Giving Loot)
    // We write their name now. If this fails, the code stops.
    // ---------------------------------------------------------
    try {
        await window.fbase.updateDoc(ref, {
            claimedBy: window.fbase.arrayUnion(gameState.playerName)
        });
    } catch (e) {
        console.error("Error signing receipt:", e);
        return; // Stop if database write fails (prevents exploits)
    }

    // ---------------------------------------------------------
    // üéÅ STEP 4: GIVE REWARDS (Safe Zone)
    // ---------------------------------------------------------
    soundManager.stopBGM();
    soundManager.playSFX('victory');
    
    // A. BP Reward (1000 BP)
    addBP(1000);

    // B. Pet Reward Logic
    let rewardVisual = "";
    let rewardMsg = "+1000 Brain Points";

    if (serverData.rewardUrl) {
        try {
            let url = serverData.rewardUrl;
            if (!url.startsWith('http')) {
                if(url.startsWith('/')) url = url.substring(1);
                url = `https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/${url}`;
            }
            
            const res = await fetch(url);
            const petData = await res.json();

            const newPet = {
                id: 'raid_reward_' + Date.now(),
                name: petData.name || "Boss Pet",
                type: petData.type || "unknown",
                rarity: petData.rarity || "epic",
                element: petData.element || "normal",
                image: petData.image || "",
                imageStyle: petData.imageStyle || "",
                emoji: petData.emoji || "üêæ",
                hp: petData.hp || 50,
                maxHP: petData.hp || 50,
                level: 5, xp: 0, maxXp: 400,
                powers: [], isHatched: true, hatchProgress: 100,
                savedEvolutions: petData.evolutions || []
            };

            gameState.pets.push(newPet);
            rewardMsg += ` & ${newPet.name}!`;
            
            if (newPet.image) {
                rewardVisual = `<img src="${newPet.image}" style="width:180px; height:180px; object-fit:contain; filter:drop-shadow(0 0 20px gold);">`;
            } else {
                rewardVisual = `<div style="font-size:80px">${newPet.emoji}</div>`;
            }

        } catch (err) {
            console.error("Pet Load Error:", err);
            rewardVisual = `<div style="font-size:80px">üí∞</div>`;
        }
    } else {
        rewardVisual = `<div style="font-size:80px">üí∞</div>`;
    }

    // Save Player Data
    saveGame(true);

    // Show Victory UI
    const battlePanel = document.getElementById('battle-ui');
    battlePanel.innerHTML = `
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; animation: popIn 0.5s;">
            <h1 style="color:#48bb78; font-size:40px; text-shadow:0 0 20px #fff; margin-bottom: 10px;">VICTORY!</h1>
            <div style="margin:20px; animation: subtleFloat 2s infinite;">${rewardVisual}</div>
            <div style="font-size: 20px; color:#f6e05e; font-weight:bold;">${rewardMsg}</div>
            <div style="color:#a0aec0; font-size:12px; margin-top:5px;">Reward Claimed Successfully</div>
            <button class="action-btn red" style="width: 200px; margin-top: 30px;" onclick="finalizeExit()">Return to Camp</button>
        </div>
    `;
    
    startConfetti();
}

// Helper: The "Stop, You Thief!" Screen
function renderAlreadyClaimedScreen() {
    const battlePanel = document.getElementById('battle-ui');
    battlePanel.innerHTML = `
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white;">
            <div style="font-size: 60px; margin-bottom: 10px;">‚úÖ</div>
            <h1 style="color:#cbd5e0; font-size:32px; font-weight:bold;">Reward Collected</h1>
            <p style="color:#a0aec0; margin-top:10px;">You have already claimed the loot for this boss.</p>
            <button class="action-btn red" style="width: 200px; margin-top: 30px;" onclick="finalizeExit()">Back to Hub</button>
        </div>
    `;
}
// ===============================================
// FIXED JOIN RAID (Allows Loot Claiming)
// ===============================================
async function joinRaid() {
    // 1. Check Requirements
    // (We lower the requirement if claiming loot, but keeping it simple is fine)
    if (gameState.brainPoints < 1) return showToast("Need 1 BP to enter!", "error");
    
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (!pet) return showToast("No pet selected!", "error");
    // Allow fainted pets to enter if it's just to claim loot
    // if (pet.hp <= 0) return showToast("Your current pet is fainted!", "error");

    showToast("Searching for Active Raid...", "info");

    let raidPath = null;

    try {
        // --- HELPER: Logic to decide if we can enter ---
        const canEnter = (doc) => {
            if (!doc.exists()) return false;
            const data = doc.data();
            if (!data.active) return false; // If admin clicked "End Raid", it's gone forever.
            
            // 1. Boss is Alive? -> YES
            if (data.hp > 0) return true;
            
            // 2. Boss is Dead BUT I fought? -> YES
            if (data.damageDealers && data.damageDealers[gameState.playerName] > 0) {
                console.log("üíÄ Boss is dead, but player contributed. Allowing entry for reward.");
                return true;
            }
            
            return false;
        };

        // --- PRIORITY 1: GLOBAL BOSS (Admin) ---
        const globalRef = window.fbase.doc(window.db, "world_boss", "global");
        const globalSnap = await window.fbase.getDoc(globalRef);

        if (canEnter(globalSnap)) {
            console.log("Found Global Boss");
            raidPath = "global";
        } 
        else {
            // --- PRIORITY 2: TEACHER BOSS ---
            let tid = gameState.teacherId;
            if (!tid) {
                const s = await window.fbase.getDoc(window.fbase.doc(window.db, "students", gameState.playerName));
                if (s.exists()) {
                    tid = s.data().teacherId;
                    gameState.teacherId = tid; 
                }
            }

            if (tid) {
                const classRef = window.fbase.doc(window.db, "world_boss", `teacher_${tid}`);
                const classSnap = await window.fbase.getDoc(classRef);
                
                if (canEnter(classSnap)) {
                    console.log("Found Class Boss for teacher:", tid);
                    raidPath = `teacher_${tid}`;
                }
            }
        }
    } catch (e) {
        console.error("Raid Check Error:", e);
        return showToast("Network Error checking raids.", "error");
    }

    if (!raidPath) {
        return showToast("No Active Raid Found!", "error");
    }

    // 3. Deduct BP and Start (Maybe free if claiming? For now, keep cost 1 BP)
    adjustBP(-1);
    updateStatsDisplay();
    saveGame();

    // 4. Switch UI
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-wilds').classList.add('active'); 
    
    document.getElementById('wilds-menu').style.display = 'none';
    document.getElementById('rpg-wrapper').style.display = 'none';
    document.getElementById('multiplayer-menu').style.display = 'none';
    document.getElementById('raid-arena').style.display = 'none'; 
    
    const ui = document.getElementById('battle-ui');
    ui.style.display = 'flex';
    // Default raid background
    // Apply BG to the 16:9 Arena Stage only
    document.querySelector('#battle-ui .battle-arena').style.backgroundImage = `url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png')`; 

    // 5. Start Engine
    startRaidEngine(raidPath);
}

// --- GLOBAL RAID FUNCTIONS (Fixed & Un-nested) ---

window.prepareRaidAttack = function(moveId) {
    console.log("‚öîÔ∏è Attack button clicked for move:", moveId);

    // 1. Check/Reset Lock
    // We check if the variable exists globally. If not, we assume safe to proceed.
    if (typeof isRaidTurnProcessing !== 'undefined') {
        if(isRaidTurnProcessing === true) {
            console.log("‚è≥ Turn is processing... ignoring click.");
            return;
        }
    } else {
        // If variable is missing, define it globally to prevent errors
        window.isRaidTurnProcessing = false;
    }

    // 2. Determine Question Source (Assigned vs Random)
    let qData = null;

    try {
        if (window.gameState && window.gameState.activeQuestionPool && window.gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * window.gameState.activeQuestionPool.length);
            const sourceQ = window.gameState.activeQuestionPool[randIndex];
            
            if (sourceQ && typeof sourceQ === 'object') {
                qData = {
                    text: sourceQ.qVisualHTML || sourceQ.q || "Solve this problem:",
                    a: sourceQ.a,
                    options: sourceQ.options
                };
            }
        }
    } catch (err) {
        console.error("Error loading topic question:", err);
    }

    // Fallback
    if (!qData) {
        if (typeof MathEngine !== 'undefined') {
            qData = MathEngine.generate(window.gameState.grade || '1');
        } else {
            qData = { text: "5 + 5 = ?", a: 10, options: [5, 10, 15, 20] };
        }
    }

    const answer = qData.a;

    // 3. Create Overlay
    const battleUI = document.getElementById('battle-ui');
    if (!battleUI) return console.error("Battle UI not found!");

    const existing = document.getElementById('raid-math-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = "raid-math-overlay";
    overlay.style.cssText = `
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; animation: popIn 0.2s;
    `;

    overlay.innerHTML = `
        <div style="font-size: 20px; color: #a0aec0; margin-bottom: 10px;">‚ö†Ô∏è MATH CRIT CHANCE ‚ö†Ô∏è</div>
        <div style="font-size: 32px; font-weight: bold; margin-bottom: 30px; text-align:center; max-width:90%;">
            ${qData.text}
        </div>
        <div id="raid-math-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%;"></div>
        <button onclick="document.getElementById('raid-math-overlay').remove()" style="margin-top:20px; background:none; border:none; color:#aaa; cursor:pointer;">Cancel</button>
    `;

    battleUI.appendChild(overlay);

    // 4. Generate Options
    const optsContainer = overlay.querySelector('#raid-math-options');
    let finalOptions = [];

    if (qData.options && Array.isArray(qData.options) && qData.options.length > 0) {
        finalOptions = [...qData.options];
    } else {
        let optionsSet = new Set([answer]);
        const numericAns = parseFloat(answer);
        if (!isNaN(numericAns)) {
            while(optionsSet.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                if(offset !== 0) optionsSet.add(numericAns + offset);
            }
        } else {
            optionsSet.add("Yes");
            optionsSet.add("No");
        }
        finalOptions = Array.from(optionsSet);
    }

    finalOptions.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.fontSize = "20px";
        btn.style.minHeight = "60px";
        btn.innerHTML = opt; 
        btn.onclick = function() { resolveRaidMath(moveId, opt, answer); };
        optsContainer.appendChild(btn);
    });
};

window.resolveRaidMath = function(moveId, selected, correct) {
    const overlay = document.getElementById('raid-math-overlay');
    if(overlay) overlay.remove();

    if (selected == correct) {
        recordMathParticipation(true);
        showFloatingText(document.body, "MATH CRIT! (2x)", "crit");
        soundManager.playSFX('correct');
        useRaidMove(moveId, 2.0, 1.0); 
    } else {
        recordMathParticipation(false);
        showFloatingText(document.body, "WRONG! (Vuln Up)", "weak");
        soundManager.playSFX('wrong');
        useRaidMove(moveId, 0.5, 2.0);
    }
};

    // --- Raid Engine State ---
    let raidListenerUnsub = null;
    let localRaidData = { attack: 15 }; // <--- NEW: Defaults to 15

// --- üõ°Ô∏è ROBUST RAID ENGINE (Fixed for Battle UI) ---
async function startRaidEngine(path) {
    const docPath = path || "global";
    window.currentRaidDocPath = docPath; 
    currentRunDamage = 0;
    currentPhase = 1;
    frenzyActive = false;

    // Reset combat counters
    raidMovesCounter = 0;
    raidBuffCharges = 0;

    if (raidListenerUnsub) raidListenerUnsub();

    // --- REAL-TIME PHASE MONITOR ---
    raidListenerUnsub = window.fbase.onSnapshot(window.fbase.doc(window.db, "world_boss", docPath), (doc) => {
        const data = doc.data();
        if (!doc.exists() || !data.active) { finalizeExit(); return; }
        
        localRaidData = data;
        const hpPct = (data.hp / data.maxHP) * 100;

        // üõë DEAD CHECK: If boss dies while you are in the menu
        if (data.hp <= 0) { handleRaidVictory(); return; }

        // 1. PHASE 3: ENRAGE DETECTION (10% HP)
        if (hpPct <= 10) {
            currentPhase = 3; 
            document.getElementById('battle-enemy-visual').classList.add('enrage-filter');
        } 
        // 2. PHASE 2: FRENZY DETECTION (50% HP)
        else if (hpPct <= 50 && currentPhase < 2) {
            if (!frenzyActive) triggerMathFrenzy(); 
        }

        // 3. UPDATE BOSS UI
        const hpBar = document.getElementById('enemy-hp-bar');
        if(hpBar) hpBar.style.width = hpPct + "%";
        
        const namePlate = document.getElementById('enemy-name');
        if(namePlate) {
            namePlate.innerHTML = `
                <div style="color:${currentPhase === 3 ? '#ff4d4d' : '#e53e3e'}; font-size:16px; font-weight:bold;">
                    ${currentPhase === 3 ? 'üí¢ ENRAGED ' : '‚ò†Ô∏è '}${data.name}
                </div>
                <div style="font-size:12px; color:white; font-weight:bold;">${Math.ceil(data.hp)} / ${data.maxHP}</div>
            `;
        }
        
        const enemyVis = document.getElementById('battle-enemy-visual');
        if (enemyVis && data.image) {
            // Ensure the flip class is applied so the boss faces the player
            enemyVis.classList.add('flipped-opponent');
            
            // Only update innerHTML if it's currently empty or doesn't have the image
            if (!enemyVis.innerHTML.includes('img')) {
                enemyVis.innerHTML = `<img src="${data.image}" class="battler-image" style="width:250px; height:250px; filter:drop-shadow(0 0 15px red);">`;
            }
        }

        // Only draw player buttons if the Math Frenzy isn't blocking the screen
        if (!frenzyActive) renderRaidPlayerSide();
    });
}

function renderRaidPlayerSide() {
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (!pet) return;

    // 1. Update Player HP & Visuals
    const gear = getPetEquipmentStats(pet);
    const totalMax = pet.maxHP + gear.hp;
    
    document.getElementById('player-hp-bar').style.width = (pet.hp / totalMax * 100) + "%";
    document.getElementById('player-hp-text').innerText = `${Math.ceil(pet.hp)}/${totalMax}`;
    
    const pVis = document.getElementById('battle-player-visual');
    pVis.innerHTML = pet.image 
        ? `<img src="${pet.image}" class="battler-image ${pet.imageStyle}" style="width:200px; height:200px;">` 
        : `<div style="font-size:100px;">${pet.emoji}</div>`;

    // 2. Handle Button Logic (3-Turn Buff System)
    const panel = document.querySelector('.battle-ui-panel');
    let statusMsg = "";
    let btnStyle = "border:2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);";
    let buffTag = "";

    if (raidBuffCharges > 0) {
        statusMsg = `<div style="width:100%; text-align:center; color:#f6e05e; font-weight:bold; font-size:12px; margin-bottom:5px; animation: pulseGold 1s infinite;">‚ö° SUPER CHARGED: ${raidBuffCharges} Hits Left!</div>`;
        btnStyle = "border:2px solid #f6e05e; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); box-shadow: 0 0 15px #f6e05e; transform: scale(1.05);";
        buffTag = " (2x)";
    } else if (raidMovesCounter >= 3) {
        statusMsg = `<div style="width:100%; text-align:center; color:#fc8181; font-weight:bold; font-size:12px; margin-bottom:5px;">‚ö†Ô∏è NEXT ATTACK: Math Challenge!</div>`;
        btnStyle = "border:2px solid #fc8181; animation: pulseGold 1s infinite;";
        buffTag = " (‚ùì)";
    }

    let buttonsHtml = pet.powers.map(pid => {
        const move = findShopItem(pid);
        return `<button class="action-btn green" style="${btnStyle}" onclick="window.FORCE_RAID_ATTACK('${pid}')">${move.name}${buffTag}</button>`;
    }).join('');
    
    buttonsHtml += `<button class="action-btn blue" onclick="openSwapMenu()">üîÑ Squad</button>`;
    buttonsHtml += `<button class="action-btn red" onclick="exitRaidBattle()">üèÉ Escape</button>`;

    if (panel) {
        panel.innerHTML = `${statusMsg} <div id="action-buttons-grid" class="battle-actions">${buttonsHtml}</div>`;
    }
}
    // --- The Connector (Animation + Database Transaction) ---
    // ===============================================
// RAID BATTLE ENGINE (40% Boss Attack Chance)
// ===============================================

// ===============================================
// "SURVIVAL RUN" RAID ENGINE (Saves Max Quota)
// ===============================================

let isRaidTurnProcessing = false;
let currentRunDamage = 0; // Accumulated damage for THIS fight only
let frenzyActive = false;
let frenzyCount = 0;
let frenzyTimer = 30;
let frenzyInterval = null;
let currentPhase = 1; // 1: Normal, 2: Frenzy, 3: Enraged

// 1. THE ATTACK FUNCTION (100% Local - No Internet Usage)
// ===============================================
// RAID ATTACK LOGIC (Visual Updates Included)
// ===============================================
window.useRaidMove = async function(moveId, playerMult = 1.0, bossMult = 1.0) {
    if (isRaidTurnProcessing) return;
    
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (pet.hp <= 0) return showToast("Pet fainted! Run ended.", "error");

    isRaidTurnProcessing = true;
    const move = findShopItem(moveId);

    // --- A. ANIMATIONS ---
    const pVis = document.getElementById('battle-player-visual');
    const eVis = document.getElementById('battle-enemy-visual');
    
    soundManager.playSFX('attack');
    pVis.style.animation = "attackLunge 0.3s";
    createProjectile(move.image || move.icon, pVis, eVis);
    
    await new Promise(r => setTimeout(r, 400)); 
    pVis.style.animation = "";
    eVis.style.animation = "damageShake 0.4s";
    soundManager.playSFX('hit');

    // --- B. CALCULATE DAMAGE ---
    const baseDmg = 20 + (pet.level * 3);
    const random = Math.floor(Math.random() * 10);
    const finalDmg = Math.floor((baseDmg + random) * playerMult); 

    // Add to our local "Score"
    currentRunDamage += finalDmg;

    // --- C. VISUAL UPDATE (The Real-Time Feel) ---
    const typeClass = playerMult > 1 ? "crit" : (playerMult < 1 ? "weak" : "super");
    showFloatingText(eVis.parentElement, `-${finalDmg}`, typeClass);
    
    // Calculate what the HP looks like locally
    if (localRaidData) {
        let currentDisplayHP = Math.max(0, localRaidData.hp - currentRunDamage);
        
        // Update the Number Text
        document.getElementById('raid-boss-hp-text').innerText = `${Math.ceil(currentDisplayHP)} / ${localRaidData.maxHP}`;
        
        // Update the Green Bar
        document.getElementById('raid-boss-bar').style.width = (currentDisplayHP / localRaidData.maxHP * 100) + "%";
    }

    // --- D. BOSS COUNTER-ATTACK ---
    setTimeout(() => {
        if (Math.random() > 0.4) {
            showFloatingText(pVis.parentElement, "DODGED!", "heal");
            isRaidTurnProcessing = false;
            return;
        }

        eVis.style.animation = "attackLunge 0.3s";
        soundManager.playSFX('hit');
        pVis.style.animation = "damageShake 0.4s";
        
        const baseAtk = (localRaidData && localRaidData.attack) ? localRaidData.attack : 15;
        const variance = Math.floor(baseAtk * 0.2); 
        const rawBossDmg = baseAtk + (Math.floor(Math.random() * variance * 2) - variance);
        const finalBossDmg = Math.floor(rawBossDmg * bossMult);
        // --- PHASE 3 ENRAGE: DOUBLE DAMAGE ---
        if (currentPhase === 3) {
            finalBossDmg *= 2; 
            console.log("Boss is ENRAGED! Double damage dealt.");
        }

        pet.hp = Math.max(0, pet.hp - finalBossDmg);
        showFloatingText(pVis.parentElement, `-${finalBossDmg}`, bossMult > 1 ? "crit" : "weak");
        
        if (typeof renderRaidPlayerSide === 'function') renderRaidPlayerSide();
        saveGame(); 

        if (pet.hp <= 0) {
             const squadIds = (gameState.team && gameState.team.length > 0) ? gameState.team : [gameState.currentPetId];
             const hasLivingPet = squadIds.some(id => {
                 const p = gameState.pets.find(x => x.id === id);
                 return p && p.hp > 0;
             });

             if (hasLivingPet) {
                 showToast(`${pet.name} Fainted! Swap!`, "error");
                 if (typeof openSwapMenu === 'function') openSwapMenu(true); 
             } else {
                 submitRaidRun("Defeated");
             }
        }
        
        isRaidTurnProcessing = false;

    }, 800); 
};
// ===============================================
// 1. MISSING CLEANUP FUNCTION (FIXES THE CRASH)
// ===============================================
function finalizeExit() {
    console.log("üö™ Exiting Raid...");

    // 1. Stop Firebase Listener
    if (raidListenerUnsub) {
        raidListenerUnsub();
        raidListenerUnsub = null;
    }

    // 2. Reset Battle Flags
    gameState.inBattle = false;
    window.currentRaidDocPath = null;
    currentRunDamage = 0; // Reset local damage counter

    // 3. UI Cleanup
    // Hide Battle UI
    document.getElementById('battle-ui').style.display = 'none';
    
    // Show Wilds Menu (The Hub)
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-wilds').classList.add('active');
    document.getElementById('wilds-menu').style.display = 'block';
    document.getElementById('rpg-wrapper').style.display = 'none';
    document.getElementById('multiplayer-menu').style.display = 'none';
    
    // 4. Audio
    soundManager.stopBGM();
    soundManager.playBGM('wilds');
}

// 2. SUBMIT SCORE (Runs only ONCE per session)
// ===============================================
// 2. FIXED SCORE SUBMISSION
// ===============================================
async function submitRaidRun(reason) {
    if (currentRunDamage <= 0) {
        // If we didn't do any damage, just leave immediately
        finalizeExit();
        return;
    }

    const dmgToSend = currentRunDamage;
    currentRunDamage = 0; // Prevent double submission
    
    // Show "Sending..." in the button area so user knows it's working
    const btnArea = document.getElementById('battle-actions');
    if(btnArea) btnArea.innerHTML = `<div style="color:white;text-align:center;font-weight:bold;padding:10px;">üì° Uploading Score...</div>`;

    const myUser = gameState.playerName;
    // Default to global if path somehow got lost
    const path = window.currentRaidDocPath || "global"; 
    const ref = window.fbase.doc(window.db, "world_boss", path);

    try {
        await window.fbase.runTransaction(window.db, async (t) => {
            const doc = await t.get(ref);
            if (!doc.exists()) return; // Boss might have been deleted
            
            const d = doc.data();
            const newHP = Math.max(0, d.hp - dmgToSend);
            
            // Get existing damage object or create new one
            const dealers = d.damageDealers || {};
            const myTotal = dealers[myUser] || 0;

            t.update(ref, { 
                hp: newHP,
                [`damageDealers.${myUser}`]: myTotal + dmgToSend
            });
        });
        
        // Show success alert
        alert(`‚öîÔ∏è RAID RUN COMPLETE!\n\nReason: ${reason}\nüî• Damage Dealt: ${dmgToSend}`);
        
    } catch(e) {
        console.error("Submit Error:", e);
        // Even if it fails, we must let the user exit
        alert("Network Error: Score might not have saved, but you survived.");
    }

    // NOW call the function that was missing before
    finalizeExit();
}

    // --- NEW RAID SUMMARY & EXIT LOGIC ---

function showRaidSummary() {
    // 1. Get Data from the local capture
    const dealers = localRaidData.damageDealers || {};
    
    // 2. Sort Players by Damage (Highest first)
    const sorted = Object.entries(dealers).sort(([,a], [,b]) => b - a);
    
    // 3. Find My Stats
    const myDmg = dealers[gameState.playerName] || 0;
    const myRank = sorted.findIndex(x => x[0] === gameState.playerName) + 1;

    // 4. Define Reward Logic
    const getReward = (rank) => {
        if (rank === 1) return 1000;
        if (rank === 2) return 800;
        if (rank === 3) return 600;
        if (rank <= 5) return 400;
        return 200; 
    };

    // 5. Build HTML List
    let listHtml = sorted.slice(0, 5).map((entry, i) => {
        const rank = i + 1;
        const isMe = entry[0] === gameState.playerName;
        const reward = getReward(rank);
        let medal = rank === 1 ? "ü•á" : (rank === 2 ? "ü•à" : (rank === 3 ? "ü•â" : `#${rank}`));

        return `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; ${isMe ? 'background:#ebf8ff; color:#2b6cb0;' : ''}">
            <span style="font-weight:bold;">${medal} ${entry[0]}</span>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:13px;">${entry[1]} dmg</div>
                <div style="color:#d69e2e; font-size:11px; font-weight:bold;">+${reward} BP</div>
            </div>
        </div>`;
    }).join('');

    // 6. Calculate My Reward
    const myPotentialBP = myRank > 0 ? getReward(myRank) : 0;

    // 7. Show Modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.style.zIndex = "3000";
    modal.innerHTML = `
        <div class="confirm-modal" style="max-width: 400px; padding: 20px;">
            <h2 style="color:#d69e2e; margin-bottom:5px;">üìä Battle Report</h2>
            <p style="font-size:12px; color:#718096; margin-bottom:15px;">Rewards distributed on Victory</p>
            
            <div style="background:white; border:2px solid #e2e8f0; border-radius:10px; margin-bottom:15px; max-height:220px; overflow-y:auto; text-align:left;">
                ${listHtml}
                ${sorted.length > 5 ? `<div style="text-align:center; padding:8px; color:gray; font-size:12px; border-top:1px dashed #ccc;">... and ${sorted.length - 5} others ...<br><span style="color:#d69e2e; font-weight:bold;">(The Rest: +200 BP)</span></div>` : ''}
            </div>

            <div style="background:#2d3748; color:white; padding:15px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-size:11px; color:#a0aec0;">YOUR RANK</div>
                    <div style="font-size:20px; font-weight:bold; color:#f6e05e;">#${myRank > 0 ? myRank : '-'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; color:#a0aec0;">ESTIMATED PAYOUT</div>
                    <div style="font-size:20px; font-weight:bold; color:#48bb78;">+${myPotentialBP} BP</div>
                </div>
            </div>

            <button class="confirm-btn no" style="width:100%;" onclick="this.parentElement.parentElement.remove(); finalizeExit();">
                Return to Camp
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// 3. FIXED EXIT BUTTON
// ===============================================
window.exitRaidBattle = function() {
    // If we have damage pending, submit it first.
    if (currentRunDamage > 0) {
        submitRaidRun("Escape");
    } else {
        // If no damage, just leave properly
        finalizeExit();
    }
}

// --- REWARD CEREMONY SYSTEM ---

function triggerRewardCeremony(title, message, visualHTML, callback) {
    soundManager.playSFX('victory');
    startConfetti();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.style.zIndex = "10001"; // Higher than Focus Mode (9999)
    modal.innerHTML = `
        <div class="reward-card-glow">
            <div class="reward-shine"></div>
            <h1 style="color:#d97706; font-size:36px; margin-bottom:10px; text-shadow:2px 2px 0 #fff;">${title}</h1>
            <p style="font-weight:bold; color:#744210; font-size:18px; margin-bottom:20px;">${message}</p>
            <div style="font-size:100px; margin:20px 0; filter:drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: subtleFloat 2s infinite;">
                ${visualHTML}
            </div>
            <button class="gacha-btn" style="margin-top:20px; font-size:24px;" id="claim-reward-btn">CLAIM REWARD!</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('claim-reward-btn').onclick = () => {
        modal.remove();
        if(callback) callback();
    };
}

function startConfetti() {
    const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    for (let i = 0; i < 100; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDuration = (Math.random() * 2 + 2) + 's';
        c.style.width = (Math.random() * 10 + 5) + 'px';
        c.style.height = c.style.width;
        container.appendChild(c);
    }

    setTimeout(() => container.remove(), 5000); // Cleanup after 5s
}
// --- FORCE FIX FOR RAID POPUP ---

// 1. Reset the lock globally so buttons are clickable
window.isRaidTurnProcessing = false; 

// 2. Define the new function attached to window
window.openRaidMathPopup = function(moveId) {
    console.log("üü¢ Raid Button Clicked:", moveId);

    // Safety Unlock: If the turn isn't actually animating, unlock it.
    // This fixes the "Button doesn't do anything" bug.
    const pVis = document.getElementById('battle-player-visual');
    if (pVis.style.animation === "") {
        window.isRaidTurnProcessing = false;
    }

    if (window.isRaidTurnProcessing) {
        console.log("‚è≥ Busy...");
        return; 
    }

    // A. GET QUESTION DATA
    let qData = null;
    
    // Check Assigned Topics
    try {
        if (window.gameState && window.gameState.activeQuestionPool && window.gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * window.gameState.activeQuestionPool.length);
            const sourceQ = window.gameState.activeQuestionPool[randIndex];
            if (sourceQ && typeof sourceQ === 'object') {
                qData = {
                    text: sourceQ.qVisualHTML || sourceQ.q || "Solve:",
                    a: sourceQ.a,
                    options: sourceQ.options
                };
            }
        }
    } catch(e) { console.error(e); }

    // Fallback to Grade Math
    if (!qData) {
        qData = MathEngine.generate(window.gameState.grade || '1');
    }

    const answer = qData.a;

    // B. SHOW POPUP (FORCE UI)
    const battleUI = document.getElementById('battle-ui');
    
    // Clean up old popups
    const old = document.getElementById('raid-math-overlay');
    if (old) old.remove();

    const overlay = document.createElement('div');
    overlay.id = "raid-math-overlay";
    overlay.style.cssText = `
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; animation: popIn 0.2s;
    `;

    overlay.innerHTML = `
        <div style="font-size: 20px; color: #f6e05e; margin-bottom: 10px;">‚ö° DOUBLE DAMAGE CHANCE ‚ö°</div>
        <div style="font-size: 32px; font-weight: bold; margin-bottom: 30px; text-align:center; max-width:90%;">
            ${qData.text}
        </div>
        <div id="raid-math-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%;"></div>
        <button onclick="document.getElementById('raid-math-overlay').remove()" style="margin-top:30px; padding:10px; background:#e53e3e; color:white; border:none; border-radius:5px;">Cancel</button>
    `;

    battleUI.appendChild(overlay);

    // C. GENERATE OPTIONS
    const optsContainer = overlay.querySelector('#raid-math-options');
    let finalOptions = [];

    if (qData.options && qData.options.length > 0) {
        finalOptions = [...qData.options];
    } else {
        // Number Generator
        let optionsSet = new Set([answer]);
        const numericAns = parseFloat(answer);
        if (!isNaN(numericAns)) {
            while(optionsSet.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                if(offset !== 0) optionsSet.add(numericAns + offset);
            }
        } else {
            optionsSet.add("Yes"); optionsSet.add("No");
        }
        finalOptions = Array.from(optionsSet);
    }

    finalOptions.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.fontSize = "22px";
        btn.style.minHeight = "60px";
        btn.innerHTML = opt; 
        btn.onclick = function() { 
            document.getElementById('raid-math-overlay').remove();
            
            if (opt == answer) {
                showFloatingText(document.body, "CRITICAL! (2x)", "crit");
                soundManager.playSFX('correct');
                useRaidMove(moveId, 2.0, 1.0); 
            } else {
                showFloatingText(document.body, "MISS! (Vuln Up)", "weak");
                soundManager.playSFX('wrong');
                useRaidMove(moveId, 0.5, 2.0);
            }
        };
        optsContainer.appendChild(btn);
    });
};

// --- ‚öîÔ∏è RAID BATTLE STATE (3-Turn Mechanic) ---
let raidMovesCounter = 0; // Counts up to 3 to trigger quiz
let raidBuffCharges = 0;  // Counts down from 3 (Super Damage turns)

// 1. THE MAIN TRIGGER (Decides: Attack or Quiz?)
window.FORCE_RAID_ATTACK = function(moveId) {
    console.log("üöÄ Raid Button Clicked:", moveId);

    // Prevent double clicking while animation plays
    if (typeof isRaidTurnProcessing !== 'undefined' && isRaidTurnProcessing) return;

    // CHECK CONDITION: Is it time for a quiz? (Every 3rd attack)
    if (raidMovesCounter >= 3) {
        // TRIGGER QUIZ
        launchRaidQuiz(moveId);
    } else {
        // STANDARD ATTACK
        executeRaidMove(moveId);
    }
};

// 2. ATTACK HELPER (Handles Damage & Counters)
function executeRaidMove(moveId) {
    let damageMult = 1.0;

    // Apply Buff if active
    if (raidBuffCharges > 0) {
        damageMult = 2.0; // DOUBLE DAMAGE!
        raidBuffCharges--;
        showToast(`‚ö° Super Charge! (${raidBuffCharges} left)`, "success");
    }

    // Perform the actual attack (Visuals + Database)
    useRaidMove(moveId, damageMult, 1.0);
    
    // Increment Counter (progress toward next quiz)
    raidMovesCounter++;
    
    // Refresh UI (To update button glows/text)
    if (typeof renderRaidPlayerSide === 'function') renderRaidPlayerSide();
}

// 3. NEW QUIZ LAUNCHER (Sets the Buffs)
function launchRaidQuiz(moveId) {
    // A. Get Question Data
    let qData = null;
    try {
        if (gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * gameState.activeQuestionPool.length);
            const sourceQ = gameState.activeQuestionPool[randIndex];
            qData = { text: sourceQ.qVisualHTML || sourceQ.q || "Solve:", a: sourceQ.a, options: sourceQ.options };
        }
    } catch(e) {}

    // Fallback if no question found
    if (!qData) qData = MathEngine.generate(gameState.grade || '1');

    // B. Build Overlay
    const overlay = document.createElement('div');
    overlay.id = "raid-math-overlay";
    overlay.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20000; display:flex; flex-direction:column; align-items:center; justify-content:center; animation:popIn 0.2s; padding:20px;`;
    
    overlay.innerHTML = `
        <div style="font-size: 24px; color: #f6e05e; font-weight:bold; margin-bottom: 10px; text-shadow:0 0 10px red; text-align:center;">
            ‚ö° CHARGE YOUR WEAPON! ‚ö°
        </div>
        <div style="background:white; color:#2d3748; border-radius:15px; padding:20px; width:100%; max-width:500px; margin-bottom:20px; text-align:center; font-size:28px; font-weight:bold;">
            ${qData.text}
        </div>
        <div id="raid-quiz-opts" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:500px;"></div>
    `;
    document.body.appendChild(overlay);

    // C. Generate Options
    const optsContainer = document.getElementById('raid-quiz-opts');
    const answer = qData.a;
    let options = qData.options || MathEngine.generateDistractors(parseFloat(answer));
    
    options.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.cssText = "font-size:20px; padding:15px; border-radius:10px;";
        btn.innerHTML = opt;
        
        btn.onclick = () => {
            document.getElementById('raid-math-overlay').remove();
            
            if (opt == answer) {
                // ‚úÖ CORRECT: Activate Buff Mode
                soundManager.playSFX('correct');
                addBP(10); // Reward BP
                showFloatingText(document.body, "POWER UP! (3 Turns)", "crit");
                
                raidMovesCounter = 0; // Reset quiz counter
                raidBuffCharges = 3;  // GRANT 3 BUFFS
                
                // Execute the triggering attack immediately with the NEW buff
                executeRaidMove(moveId);
                
            } else {
                // ‚ùå WRONG: Reset counters, normal damage
                soundManager.playSFX('wrong');
                showFloatingText(document.body, "Failed... No Buff", "weak");
                
                raidMovesCounter = 0; // Reset quiz counter
                raidBuffCharges = 0;  // No buff
                
                // Execute weak/normal attack
                executeRaidMove(moveId);
            }
        };
        optsContainer.appendChild(btn);
    });
}

// ===============================================
// BULK ITEM USAGE SYSTEM (XP ONLY)
// ===============================================

let currentUsingItem = null;

window.openUseQuantityModal = function(itemId) {
    const count = gameState.inventory[itemId] || 0;
    if (count <= 0) return;

    currentUsingItem = findShopItem(itemId); 
    if (!currentUsingItem) return;

    const modal = document.getElementById('use-quantity-modal');
    const slider = document.getElementById('use-qty-slider');
    const title = document.getElementById('use-qty-title');
    const visual = document.getElementById('use-qty-visual');
    const desc = document.getElementById('use-qty-desc');
    const label = document.getElementById('use-qty-label');
    const maxText = document.getElementById('use-qty-max');
    const confirmBtn = document.getElementById('use-qty-confirm-btn');

    // Setup UI
    title.innerText = `Use ${currentUsingItem.name}`;
    visual.innerText = currentUsingItem.icon || 'üåü';
    desc.innerText = `You have: ${count}`;
    
    // Setup Slider
    slider.min = 1;
    slider.max = count;
    slider.value = 1;
    maxText.innerText = `Max: ${count}`;
    
    // Update Label function
    const updateLabel = () => {
        label.innerText = `Use: ${slider.value}`;
    };
    slider.oninput = updateLabel;
    updateLabel();

    // Confirm Action
    confirmBtn.onclick = () => {
        confirmBulkUse(itemId, parseInt(slider.value));
        modal.classList.remove('active');
    };

    modal.classList.add('active');
};

window.confirmBulkUse = function(itemId, quantity) {
    if (quantity <= 0) return;
    
    // 1. Remove items
    gameState.inventory[itemId] -= quantity;
    if (gameState.inventory[itemId] < 0) gameState.inventory[itemId] = 0;

    // 2. Apply Effects (XP Only)
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    let msg = "";

    if (itemId === 'xp_potion') {
        const totalXP = quantity * 100;
        pet.xp += totalXP;
        
        let levelsGained = 0;
        // Loop level up logic
        while (pet.xp >= pet.maxXp) {
            const maxLvl = LEVEL_CAPS[pet.rarity] || 100;
            if (pet.level >= maxLvl) {
                pet.xp = pet.maxXp; 
                break;
            }
            
            pet.level++;
            pet.xp -= pet.maxXp;
            pet.maxXp = pet.level * 300 + 200;
            pet.maxHP = 50 + (pet.level * 10);
            pet.hp = pet.maxHP; 
            levelsGained++;
        }
        
        soundManager.playSFX('levelUp');
        msg = levelsGained > 0 
            ? `Leveled up ${levelsGained} times!` 
            : `Added ${totalXP} XP!`;
    }
    
    applySquadLevelSync(); // Update floor after potion usage

    saveGame();
    renderHub();
    updateStatsDisplay();
    showToast(msg, "success");
};
// ===============================================
// SECURITY HELPER: SHA-256 HASHING
// ===============================================
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}
// ===============================================
// MULTI-TEACHER SYSTEM
// ===============================================

// 1. REGISTER A NEW TEACHER
async function registerNewTeacher() {
    const user = document.getElementById('teacher-username').value.trim();
    const pass = document.getElementById('teacher-pass').value.trim();

    if (!user || !pass) return showToast("Enter Username & Password", "error");

    // Check if teacher already exists
    const docRef = window.fbase.doc(window.db, "teachers", user);
    const docSnap = await window.fbase.getDoc(docRef);

    if (docSnap.exists()) {
        const rawDocData = docSnap.data();
        
        // --- üßπ DATABASE AUTO-CLEANER ---
        // If we find loose blocks at the root, move them to inventory
        const looseBlocks = ['boulder', 'brick', 'bush', 'diamond', 'dirt', 'gold', 'grass', 'grass2', 'ice', 'stone', 'wood'];
        let foundLeak = false;
        
        looseBlocks.forEach(blockId => {
            if (rawDocData[blockId] !== undefined) {
                console.log(`üßπ Cleaning up leaked block: ${blockId}`);
                // Move to builder inventory
                if (!gameState.builder.inventory) gameState.builder.inventory = {};
                gameState.builder.inventory[blockId] = (gameState.builder.inventory[blockId] || 0) + rawDocData[blockId];
                foundLeak = true;
            }
        });

        if (foundLeak) {
            saveGame(true); // Force a clean save immediately
            showToast("Vault Cleaned & Organized!", "info");
        }
        // -------------------------------
        return showToast("Teacher username already exists!", "error");
    }

    // Hash the password
    const hash = await sha256(pass);

    // Save to Firestore
    await window.fbase.setDoc(docRef, {
        username: user,
        passwordHash: hash,
        joinedAt: new Date().toISOString()
    });

    showToast(`Registered Teacher: ${user}`, "success");
}

// 2. LOGIN TEACHER (Updated to fix Split Screen)
async function loginTeacher() {
    const user = document.getElementById('teacher-username').value.trim();
    const pass = document.getElementById('teacher-pass').value.trim();

    if (!user || !pass) return showToast("Enter credentials", "error");

    // --- 1. CHECK IF ADMIN ---
    // User: "admin", Password: "1030"
    const ADMIN_HASH = "3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4"; 
    const inputHash = await sha256(pass);

    if (user.toLowerCase() === "admin" && inputHash === ADMIN_HASH) {
        // Show Admin Dashboard
        document.getElementById('teacher-dashboard-screen').style.display = 'none'; // Hide teacher one
        document.getElementById('admin-dashboard-screen').style.display = 'block';
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-game-ui').style.display = 'none'; 
        
        loadAdminData(); // New function to load teacher list
        return showToast("Welcome, Headmaster.", "success");
    }

    // --- 2. CHECK IF REGULAR TEACHER ---
    const docRef = window.fbase.doc(window.db, "teachers", user);
    const docSnap = await window.fbase.getDoc(docRef);

    if (docSnap.exists() && inputHash === docSnap.data().passwordHash) {
        // Existing Teacher Logic
        currentLoggedTeacher = user;
        document.getElementById('teacher-dashboard-screen').style.display = 'block';
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-game-ui').style.display = 'none'; 
        
        document.getElementById('teacher-username').value = "";
        document.getElementById('teacher-pass').value = "";
        document.querySelector('#teacher-dashboard-screen h1').innerText = `üë®‚Äçüè´ Class: ${user}`;
        loadStudentList(); 
        showToast("Welcome back!", "success");
    } else {
        showToast("Invalid Credentials", "error");
    }
}
// ===============================================
// MIGRATION TOOL: CLAIM OLD STUDENTS
// ===============================================
async function claimLegacyStudents() {
    if (!currentLoggedTeacher) return showToast("Log in as a Teacher first!", "error");

    if (!confirm(`Are you sure you want to assign ALL old (unclaimed) students to "${currentLoggedTeacher}"?`)) {
        return;
    }

    const d = document.getElementById('student-list-container');
    d.innerHTML = '<div style="text-align:center;">Scanning database...</div>';

    // 1. Get ALL students
    const q = await window.fbase.getDocs(window.fbase.collection(window.db, "students"));
    const batch = window.fbase.writeBatch(window.db);
    let count = 0;

    q.forEach(doc => {
        const data = doc.data();
        
        // 2. Check if they are an "Orphan" (No teacherId)
        if (!data.teacherId) {
            // 3. Update them to belong to YOU
            batch.update(doc.ref, { teacherId: currentLoggedTeacher });
            count++;
        }
    });

    if (count > 0) {
        // 4. Save Changes
        await batch.commit();
        showToast(`Success! claimed ${count} students.`, "success");
        loadStudentList(); // Refresh the list to see them
    } else {
        showToast("No unclaimed students found.", "info");
        loadStudentList();
    }
}
// ===============================================
// ADMIN SYSTEM LOGIC
// ===============================================

// 1. Load Teachers List for Admin
async function loadAdminData() {
    const list = document.getElementById('admin-teacher-list');
    const select = document.getElementById('admin-boss-teacher-select');
    
    list.innerHTML = "Loading...";
    select.innerHTML = "";

    const q = await window.fbase.getDocs(window.fbase.collection(window.db, "teachers"));
    let html = "";
    
    q.forEach(doc => {
        const t = doc.data().username;
        html += `<div>üë§ ${t}</div>`;
        
        // Add to checkbox list for Boss Summoning
        select.innerHTML += `
            <label style="display:block; cursor:pointer;">
                <input type="checkbox" class="boss-target-teacher" value="${t}"> ${t}
            </label>
        `;
    });
    
    list.innerHTML = html || "No teachers yet.";
}

// 2. Admin Create Teacher
async function adminCreateTeacher() {
    const user = document.getElementById('admin-new-teacher-user').value.trim();
    const pass = document.getElementById('admin-new-teacher-pass').value.trim();

    if(!user || !pass) return showToast("Enter details", "error");

    const hash = await sha256(pass);
    await window.fbase.setDoc(window.fbase.doc(window.db, "teachers", user), {
        username: user, passwordHash: hash, joinedAt: new Date().toISOString()
    });

    showToast(`Teacher ${user} Created!`, "success");
    loadAdminData(); // Refresh lists
}

// 3. Admin Toggle UI
function toggleTeacherCheckboxes(show) {
    document.getElementById('admin-boss-teacher-select').style.display = show ? 'block' : 'none';
}

// 4. Admin Summon Boss
// 1. UPDATED ADMIN SUMMON (Reads Image Input Correctly)
// ===============================================
// FIXED ADMIN SUMMON (With Success Alert)
// ===============================================
// 4. Admin Summon Boss
// ===============================================
// ADMIN SUMMON (Writes to Correct Paths)
// ===============================================
async function adminSummonBoss() {
    console.log("üëâ Admin Summon Clicked");

    try {
        // 1. Get Values
        const name = document.getElementById('admin-boss-name').value || "Titan";
        const hp = parseInt(document.getElementById('admin-boss-hp').value) || 50000;
        const atk = parseInt(document.getElementById('admin-boss-atk').value) || 20;
        
        const imgInput = document.getElementById('admin-boss-img');
        const img = imgInput ? imgInput.value : '';

        const rewInput = document.getElementById('admin-boss-reward');
        const reward = rewInput ? rewInput.value : '';

        // 2. Check Target
        const radio = document.querySelector('input[name="boss-target"]:checked');
        const isGlobal = radio ? (radio.value === 'global') : true;

        // 3. DEFINE DATA
        const bossData = {
            name: name, 
            hp: hp, 
            maxHP: hp, 
            attack: atk,
            image: img, 
            active: true, // <--- MUST BE TRUE
            summonedBy: 'Admin',
            rewardUrl: reward, 
            damageDealers: {}
        };

        const batch = window.fbase.writeBatch(window.db);

        // 4. Queue Updates
        if (isGlobal) {
            // Write to GLOBAL path
            const ref = window.fbase.doc(window.db, "world_boss", "global");
            batch.set(ref, bossData);
        } else {
            const targets = document.querySelectorAll('.boss-target-teacher:checked');
            if(targets.length === 0) {
                alert("Please select at least one teacher checkbox!");
                return;
            }
            
            targets.forEach(cb => {
                // Write to CLASS path
                const ref = window.fbase.doc(window.db, "world_boss", `teacher_${cb.value}`);
                batch.set(ref, bossData);
            });
        }

        // 5. Commit
        await batch.commit();
        alert("‚úÖ BOSS SUMMONED!");

    } catch (e) {
        console.error("Admin Summon Error:", e);
        alert("‚ùå SUMMON FAILED:\n" + e.message);
    }
}

// 5. Admin End Raid
async function adminEndRaid() {
    if(!confirm("End the GLOBAL raid? (Students will stop fighting)")) return;
    
    // Set active: false
    await window.fbase.updateDoc(window.fbase.doc(window.db, "world_boss", "global"), {
        active: false,
        hp: 0 
    });
    
    showToast("üõë Global Raid Ended", "info");
}

// 6. Teacher End Raid
async function teacherEndRaid() {
    if (!currentLoggedTeacher) return;
    if(!confirm("End your class raid?")) return;

    await window.fbase.updateDoc(window.fbase.doc(window.db, "world_boss", `teacher_${currentLoggedTeacher}`), {
        active: false,
        hp: 0
    });
    
    showToast("üõë Class Raid Ended", "info");
}
// ===============================================
// SECURITY & LOGIN SYSTEM (REPAIRED)
// ===============================================

// 1. RE-ADD THE HASHING HELPER (Crucial for Admin Login)
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// 2. REPLACEMENT LOGIN FUNCTION (With Debugging)
// 2. LOGIN TEACHER (Bulletproof Version)
// 2. LOGIN TEACHER (Fixed Hash for "1030")
window.loginTeacher = async function() {
    console.log("üîë Login button clicked...");

    const userEl = document.getElementById('teacher-username');
    const passEl = document.getElementById('teacher-pass');

    if (!userEl || !passEl) {
        alert("Critical Error: Login text boxes are missing!");
        return;
    }

    const user = userEl.value.trim(); 
    const userLower = user.toLowerCase();
    const pass = passEl.value.trim();

    if (!user || !pass) return showToast("Enter credentials", "error");

    // --- ADMIN CONFIGURATION ---
    // User: "admin"
    // Password: "1030"
    // This hash matches the one in your error logs exactly:
    const ADMIN_HASH = "2f1987bf98c09d2f5d2a23a6ae29fa53b9aec8f07ed1330bd439122f5a1a2c2c"; 
    
    try {
        const inputHash = await sha256(pass);
        console.log("Input Hash:", inputHash);

        // 1. ADMIN CHECK
        if (userLower === "admin" && inputHash === ADMIN_HASH) {
            console.log("‚úÖ Admin Credentials Verified");
            
            // Switch to Admin Dashboard
            if(document.getElementById('teacher-dashboard-screen')) document.getElementById('teacher-dashboard-screen').style.display = 'none';
            if(document.getElementById('admin-dashboard-screen')) document.getElementById('admin-dashboard-screen').style.display = 'block';
            
            // Hide Login & Game
            document.getElementById('login-overlay').style.display = 'none';
            if(document.getElementById('main-game-ui')) document.getElementById('main-game-ui').style.display = 'none';
            
            // Clear inputs
            userEl.value = "";
            passEl.value = "";

            if(typeof loadAdminData === 'function') loadAdminData();
            
            return showToast("Welcome, Headmaster.", "success");
        }

        // 2. TEACHER CHECK (Only happens if Admin check fails)
        console.log("Checking Database for Teacher...");
        
        const docRef = window.fbase.doc(window.db, "teachers", user);
        const docSnap = await window.fbase.getDoc(docRef);

        if (docSnap.exists()) {
            const dbHash = docSnap.data().passwordHash;
            if (inputHash === dbHash) {
                // Teacher Success
                currentLoggedTeacher = user;
                document.getElementById('teacher-dashboard-screen').style.display = 'block';
                document.getElementById('login-overlay').style.display = 'none';
                if(document.getElementById('main-game-ui')) document.getElementById('main-game-ui').style.display = 'none';
                
                // Clear inputs
                userEl.value = "";
                passEl.value = "";
                
                const title = document.querySelector('#teacher-dashboard-screen h1');
                if(title) title.innerText = `üë®‚Äçüè´ Class: ${user}`;
                
                if(typeof loadStudentList === 'function') loadStudentList();
                // Load the teacher's world settings
const teacherData = docSnap.data();
if(teacherData.enduranceMode) document.getElementById('qm-endurance-toggle').checked = true;
if(teacherData.rewardMultiplier) {
    document.getElementById('qm-reward-slider').value = teacherData.rewardMultiplier;
    document.getElementById('qm-mult-display').innerText = teacherData.rewardMultiplier + 'x';
}
initTeacherBeaconListener();
initCycleListener();
                showToast("Welcome back!", "success");
            } else {
                showToast("Wrong Password", "error");
            }
        } else {
            showToast("User not found", "error");
        }

    } catch (err) {
        console.error("Login Crash:", err);
        alert("Login Error: " + err.message);
    }
};

// Function to save World Settings
async function saveQuestMasterSettings() {
    if (!currentLoggedTeacher) return;
    
    const endurance = document.getElementById('qm-endurance-toggle').checked;
    const multiplier = parseFloat(document.getElementById('qm-reward-slider').value);

    try {
        await window.fbase.updateDoc(window.fbase.doc(window.db, "teachers", currentLoggedTeacher), {
            enduranceMode: endurance,
            rewardMultiplier: multiplier
        });
        showToast("World Updated! Settings are now LIVE.", "success");
    } catch (e) {
        showToast("Error saving settings.", "error");
    }
}
// ===============================================
// ADMIN PATCHER SYSTEM (Remote Database Fixes)
// ===============================================

async function executeAdminPatch() {
    const code = document.getElementById('admin-patch-code').value;
    const logBox = document.getElementById('patch-logs');
    
    if(!code) return alert("Enter code first!");
    if(!confirm("‚ö†Ô∏è RUNNING DATABASE PATCH\n\nThis will modify student data permanently.\nAre you sure?")) return;

    logBox.innerHTML = "‚è≥ Running script...";

    try {
        // We create a Function that has access to database tools
        // This is safe because only YOU (Admin) can access this screen
        const patchFunction = new Function('db', 'fbase', 'log', `
            return (async () => {
                ${code}
            })();
        `);

        // Helper to log to screen
        const customLog = (msg) => {
            console.log(msg);
            logBox.innerHTML += `<br>${msg}`;
        };

        await patchFunction(window.db, window.fbase, customLog);
        logBox.innerHTML += "<br>‚úÖ <strong style='color:#48bb78'>PATCH COMPLETE</strong>";

    } catch (e) {
        console.error(e);
        logBox.innerHTML += `<br>‚ùå <strong style='color:#f56565'>ERROR: ${e.message}</strong>`;
    }
}

// PRE-SET: Load the Rudolf Fix into the box
function loadRudolfPatch() {
    const script = `
// 1. Get ALL Students
log("Scanning database...");
const q = await fbase.getDocs(fbase.collection(db, "students"));
let count = 0;
const batch = fbase.writeBatch(db);

q.forEach(doc => {
    const data = doc.data();
    // Check if they have save data
    if (!data.saveData || !data.saveData.pets) return;

    let changed = false;
    
    // Loop through their pets
    const updatedPets = data.saveData.pets.map(p => {
        // IF it is Groochy AND missing evolution data
        if ((p.name === "Groochy" || p.type === "tree_01") && !p.savedEvolutions) {
            log("Fixing Groochy for: " + data.username);
            
            // INJECT THE DATA
            p.savedEvolutions = [
                {
                  "name": "Rudolf Flyer", 
                  "level": 10, "cost": 100, "baseHP": 100, "rarity": "epic",
                  "element": ["grass", "ice"],
                  "image": "https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/xmasreward/2.png",
                  "imageStyle": "blend-multiply"
                },
                {
                  "name": "Rudolf Legend",
                  "level": 20, "cost": 200, "baseHP": 200, "rarity": "legendary",
                  "element": ["grass", "ice"],
                  "image": "https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/xmasreward/3.png",
                  "imageStyle": "blend-multiply"
                }
            ];
            changed = true;
        }
        return p;
    });

    if (changed) {
        batch.update(doc.ref, { "saveData.pets": updatedPets });
        count++;
    }
});

if (count > 0) {
    await batch.commit();
    log("Successfully fixed " + count + " students!");
} else {
    log("No broken Rudolfs found.");
}
`;
    document.getElementById('admin-patch-code').value = script;
}
// ==========================================
// üéì STUDENT EXAM ENGINE
// ==========================================
let currentExamData = null;
let userAnswers = {}; 
let currentQIndex = 0;

// 1. Check Login (Updated to Hide Completed Exams)
function checkActiveExam() {
    const assigned = gameState.assignedExam;
    const card = document.getElementById('active-exam-card');
    
    // 1. If no exam assigned, hide card
    if (!assigned || assigned === "") {
        card.style.display = 'none';
        return;
    }

    const history = gameState.examHistory || {};
    
    // 2. If exam is ALREADY COMPLETED, hide card
    if (history[assigned]) {
        card.style.display = 'none'; 
        return;
    }

    // 3. If exam is PENDING, show the Red "Active" Card
    card.style.display = 'block';
    card.style.background = "#fff5f5";
    card.style.borderColor = "#f56565";
    document.getElementById('exam-card-title').innerText = "‚ö†Ô∏è Active Exam Assigned";
    document.getElementById('start-exam-btn').style.display = 'block';
    document.getElementById('exam-card-status').innerText = "Anti-Cheat Mode Enabled. Do not close browser.";
}

// 2. Start (Lockdown)
async function initExamMode() {
    if(!confirm("‚ö†Ô∏è START EXAM?\n\nYou cannot pause or exit.\nProgress saves automatically.\n\nClick OK to begin.")) return;

    let url = gameState.assignedExam;
    if (!url.startsWith('http')) url = `https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/${url}`;

    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Exam file missing.");
        
        currentExamData = await res.json();
        
        // Crash Recovery
        const saved = localStorage.getItem('exam_' + gameState.playerName);
        userAnswers = saved ? JSON.parse(saved) : {};

        document.getElementById('exam-interface').style.display = 'flex';
        currentQIndex = 0;
        renderExamQuestion();
        updateExamNav();

    } catch(e) {
        alert("Error: " + e.message);
    }
}

// 3. Gameplay
function renderExamQuestion() {
    const q = currentExamData.questions[currentQIndex];
    document.getElementById('exam-progress-text').innerText = `Q ${currentQIndex + 1} / ${currentExamData.questions.length}`;
    document.getElementById('exam-q-text').innerHTML = q.q;
    document.getElementById('exam-visual').innerHTML = q.qVisualHTML || "";
    
    const grid = document.getElementById('exam-options');
    grid.innerHTML = "";
    
    q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        if (userAnswers[currentQIndex] === opt) {
            btn.style.borderColor = "#4299e1";
            btn.style.background = "#ebf8ff";
        }
        btn.innerText = opt;
        btn.onclick = () => {
            userAnswers[currentQIndex] = opt;
            localStorage.setItem('exam_' + gameState.playerName, JSON.stringify(userAnswers));
            renderExamQuestion();
            updateExamNav();
        };
        grid.appendChild(btn);
    });

    const nextBtn = document.getElementById('exam-next-btn');
    if (currentQIndex === currentExamData.questions.length - 1) {
        nextBtn.innerText = "REVIEW üèÅ";
        nextBtn.className = "action-btn green";
        nextBtn.onclick = showExamReview;
    } else {
        nextBtn.innerText = "Next ‚û°";
        nextBtn.className = "action-btn blue";
        nextBtn.onclick = nextExamQ;
    }
}

function nextExamQ() { if(currentQIndex < currentExamData.questions.length-1) { currentQIndex++; renderExamQuestion(); } }
function prevExamQ() { if(currentQIndex > 0) { currentQIndex--; renderExamQuestion(); } }

function updateExamNav() {
    const box = document.getElementById('exam-nav-container');
    box.innerHTML = "";
    currentExamData.questions.forEach((_, i) => {
        const d = document.createElement('div');
        d.className = `nav-box ${userAnswers[i] ? 'answered' : ''} ${i===currentQIndex ? 'current' : ''}`;
        d.innerText = i + 1;
        d.onclick = () => { currentQIndex = i; renderExamQuestion(); };
        box.appendChild(d);
    });
}

// ==========================================
// 4. SUBMIT, REVIEW, THEN REWARD
// ==========================================

let reviewIndex = 0; 
let pendingExamRewards = null; // Stores the prize until they finish reviewing

function showExamReview() {
    const answered = Object.keys(userAnswers).length;
    const total = currentExamData.questions.length;
    if(confirm(`You answered ${answered}/${total}.\n\nSubmit Exam? This is final.`)) finalizeExam();
}

async function finalizeExam() {
    let score = 0;
    const total = currentExamData.questions.length;

    // 1. Calculate Score
    currentExamData.questions.forEach((q, i) => {
        if (userAnswers[i] == q.a) score++;
    });

    // 2. Handle Rewards & Visuals (BUT DON'T SHOW YET)
    const meta = currentExamData.meta || {};
    const passThreshold = meta.passThreshold || 0.6;
    const pct = score / total;
    const passed = pct >= passThreshold;
    
    let rewardText = "Keep studying!";
    let ceremonyVisual = "üìù";
    let rewardSummary = "";
    
    // Reset pending rewards
    pendingExamRewards = null;

    if (passed && meta.rewards) {
        rewardText = "üéâ PASSED! (Finish Review to Claim)";
        let rewardsList = [];

        // BP
        if(meta.rewards.bp) {
            addBP(meta.rewards.bp);
            rewardsList.push(`${meta.rewards.bp} BP`);
            ceremonyVisual = "üí∞";
        }
        
        // Items
        if(meta.rewards.items) {
            meta.rewards.items.forEach(item => {
                gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + item.qty;
            });
            rewardsList.push(`${meta.rewards.items.length} Items`);
            ceremonyVisual = "üéÅ";
        }
        
        // Pets
        if(meta.rewards.pet) {
            const p = meta.rewards.pet;
            p.id = 'exam_pet_' + Date.now();
            if(p.evolutions) p.savedEvolutions = p.evolutions;
            gameState.pets.push(p);
            rewardsList.push("New Pet!");
            
            if (p.image) {
                ceremonyVisual = `<img src="${p.image}" style="width:150px; height:150px; object-fit:contain; filter:drop-shadow(0 0 10px white);">`;
            } else {
                ceremonyVisual = `<div style="font-size:100px;">${p.emoji}</div>`;
            }
        }
        
        // STORE THE REWARD FOR LATER
        rewardSummary = rewardsList.join(" + ");
        pendingExamRewards = {
            title: "EXAM PASSED!",
            message: `Score: ${Math.round(pct*100)}%<br><span style="color:#d69e2e">${rewardSummary}</span>`,
            visual: ceremonyVisual
        };
    }

    // 3. Save to Firebase
    if (!gameState.examHistory) gameState.examHistory = {};
    gameState.examHistory[gameState.assignedExam] = {
        score: score,
        total: total,
        timestamp: Date.now()
    };
    
    saveGame(true); 

    // 4. Cleanup UI
    localStorage.removeItem('exam_' + gameState.playerName);
    document.getElementById('exam-interface').style.display = 'none';
    
    // 5. OPEN REVIEW SCREEN IMMEDIATELY
    document.getElementById('exam-results-modal').classList.add('active');
    document.getElementById('review-score-header').innerText = `Final Score: ${score} / ${total} (${Math.round(pct*100)}%)`;
    document.getElementById('review-reward-text').innerText = rewardText;
    
    reviewIndex = 0;
    renderReviewQuestion();
    checkActiveExam(); 
}

function renderReviewQuestion() {
    const q = currentExamData.questions[reviewIndex];
    const userAns = userAnswers[reviewIndex];
    const isCorrect = (userAns == q.a);

    // Update Text & Visuals
    document.getElementById('review-counter').innerText = `Q ${reviewIndex + 1} / ${currentExamData.questions.length}`;
    document.getElementById('review-q-text').innerHTML = q.q;
    document.getElementById('review-visual').innerHTML = q.qVisualHTML || "";

    // Status Badge
    const badge = document.getElementById('review-status-badge');
    if (isCorrect) {
        badge.innerText = "‚úÖ CORRECT";
        badge.style.background = "#c6f6d5";
        badge.style.color = "#22543d";
    } else {
        badge.innerText = "‚ùå INCORRECT";
        badge.style.background = "#fed7d7";
        badge.style.color = "#822727";
    }

    // Render Options
    const grid = document.getElementById('review-options');
    grid.innerHTML = "";
    
    q.options.forEach(opt => {
        const div = document.createElement('div');
        div.className = "mcq-btn";
        div.style.cursor = "default"; 
        div.style.fontSize = "16px";
        div.style.minHeight = "50px";
        div.innerText = opt;

        if (opt === userAns) {
            div.style.border = "4px solid";
            if (isCorrect) {
                div.style.borderColor = "#48bb78"; 
                div.style.background = "#f0fff4";
                div.innerHTML += " <b>(You)</b>";
            } else {
                div.style.borderColor = "#f56565"; 
                div.style.background = "#fff5f5";
                div.innerHTML += " <b>(You)</b>";
            }
        } else {
            div.style.opacity = "0.6";
        }
        grid.appendChild(div);
    });
}

function changeReviewQ(dir) {
    const newIndex = reviewIndex + dir;
    if (newIndex >= 0 && newIndex < currentExamData.questions.length) {
        reviewIndex = newIndex;
        renderReviewQuestion();
    }
}

// 6. TRIGGER REWARD ON CLOSE
function closeExamResults() {
    document.getElementById('exam-results-modal').classList.remove('active');

    // If there is a pending reward, show it NOW
    if (pendingExamRewards) {
        triggerRewardCeremony(
            pendingExamRewards.title,
            pendingExamRewards.message,
            pendingExamRewards.visual,
            null
        );
        pendingExamRewards = null; // Clear it so it doesn't show again
    }
}

// ==========================================
// üë®‚Äçüè´ TEACHER DASHBOARD LOGIC (Updated)
// ==========================================

async function refreshTopicManagerUI() {
    const g = document.getElementById('tm-grade-select').value;
    const topicBox = document.getElementById('tm-topic-list');
    const examSelect = document.getElementById('tm-exam-select');

    // 1. Topics
    topicBox.innerHTML = 'Loading...';
    let files = [];
    if(GITHUB_CONFIG.enabled) files = await fetchGithubFolder(`questions/grade_${g}`);
    
    topicBox.innerHTML = '';
    const isChecked = (val) => (currentStudentData.assignedTopics || []).includes(val) ? 'checked' : '';
    
    if(files.length > 0) {
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            topicBox.innerHTML += `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${f.download_url}" ${isChecked(f.download_url)}> ${f.name}</label>`;
        });
    } else {
        Object.keys(QUESTION_REPOSITORY[g]||{}).forEach(t => {
            const val = `INTERNAL:${t}`;
            topicBox.innerHTML += `<label style="display:block; margin:5px 0;"><input type="checkbox" value="${val}" ${isChecked(val)}> ${t}</label>`;
        });
    }

    // 2. Exams
    examSelect.innerHTML = '<option>Loading...</option>';
    let tests = await fetchGithubFolder(`tests/grade_${g}`);
    examSelect.innerHTML = '<option value="">-- No Exam --</option>';
    
    if (tests && tests.length > 0) {
        tests.filter(f => f.name.endsWith('.json')).forEach(f => {
            const sel = (currentStudentData.assignedExam === f.download_url) ? 'selected' : '';
            examSelect.innerHTML += `<option value="${f.download_url}" ${sel}>üìù ${f.name}</option>`;
        });
    }
    updateExamStatusDisplay();
}

function updateExamStatusDisplay() {
    const url = document.getElementById('tm-exam-select').value;
    const disp = document.getElementById('tm-exam-status');
    if (!url) { disp.innerText = "Status: None"; return; }
    
    const h = (currentStudentData.examHistory || {})[url];
    if (h) {
        const pct = Math.round((h.score/h.total)*100);
        disp.innerHTML = `<span style="color:${pct>=70?'green':'red'}">‚úÖ Completed: ${h.score}/${h.total} (${pct}%)</span>`;
    } else {
        disp.innerText = "Status: ‚è≥ Not Started";
    }
}

async function saveStudentTopics() {
    const checkboxes = document.querySelectorAll('#tm-topic-list input');
    let topics = new Set(currentStudentData.assignedTopics || []);
    checkboxes.forEach(cb => cb.checked ? topics.add(cb.value) : topics.delete(cb.value));
    
    await window.fbase.updateDoc(window.fbase.doc(window.db,"students",currentManagingStudent), {
        assignedGrade: document.getElementById('tm-grade-select').value,
        assignedExam: document.getElementById('tm-exam-select').value,
        assignedTopics: Array.from(topics)
    });
    
    showToast("Updated!", "success");
    document.getElementById('topic-manager-modal').style.display='none';
}

// ==========================================
// üìä GRADEBOOK SYSTEM
// ==========================================

// ==========================================
// üìä GRADEBOOK SYSTEM (Fixed with Smart Match)
// ==========================================

async function loadGradebookTests() {
    const g = document.getElementById('gb-grade-select').value;
    const sel = document.getElementById('gb-test-select');
    sel.innerHTML = '<option>Loading...</option>';
    
    const files = await fetchGithubFolder(`tests/grade_${g}`);
    sel.innerHTML = '<option value="">2. Select Test</option>';
    
    if (files && files.length > 0) {
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            // We use the full URL as the value
            sel.innerHTML += `<option value="${f.download_url}">${f.name}</option>`;
        });
    } else {
        sel.innerHTML = '<option>No tests found</option>';
    }
}

// ==========================================
// üìä MASTER GRADEBOOK ENGINE (HARDENED)
// ==========================================
async function renderGradebook() {
    const g = document.getElementById('gb-grade-select').value;
    const selectedUrl = document.getElementById('gb-test-select').value;
    const tbody = document.getElementById('gradebook-body');
    
    if(!g || !selectedUrl) return;
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:gray;">Scanning Class Records...</td></tr>';

    try {
        // Fetch all students
        const q = await window.fbase.getDocs(window.fbase.collection(window.db, "students"));
        let html = "";
        let count = 0;
        
        // Normalize the filename we are looking for (e.g., "test_addition.json")
        const targetFile = selectedUrl.split('/').pop().toLowerCase().trim();
        
        q.forEach(doc => {
            const s = doc.data();
            
            // Only look at students in the selected grade
            if (String(s.assignedGrade) !== String(g)) return; 
            count++;
            
            // --- ARCHITECT'S FIX: Check both compressed 'eh' and long 'examHistory' ---
            const saveData = s.saveData || {};
            const history = saveData.eh || saveData.examHistory || {}; 

            let foundScore = null;

            // SMART MATCH: Loop through student's tests to find a filename match
            Object.keys(history).forEach(studentKey => {
                const studentFile = studentKey.split('/').pop().toLowerCase().trim();
                if (studentFile === targetFile) {
                    foundScore = history[studentKey];
                }
            });

            if (foundScore) {
                const pct = Math.round((foundScore.score / foundScore.total) * 100);
                const color = pct >= 70 ? 'score-pass' : 'score-fail';
                const dateStr = foundScore.timestamp ? new Date(foundScore.timestamp).toLocaleDateString() : "Completed";
                
                html += `<tr>
                    <td style="font-weight:bold;">${s.username}</td>
                    <td class="${color}">${foundScore.score}/${foundScore.total} (${pct}%)</td>
                    <td style="color:#38a169;">‚úÖ Done</td>
                    <td style="font-size:11px; color:#718096;">${dateStr}</td>
                </tr>`;
            } else {
                html += `<tr style="opacity:0.5;">
                    <td>${s.username}</td>
                    <td>-</td>
                    <td style="color:#d69e2e;">‚è≥ Pending</td>
                    <td>-</td>
                </tr>`;
            }
        });
        
        if (count === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No students found in Grade ${g}.</td></tr>`;
        } else {
            tbody.innerHTML = html;
        }
        
    } catch (e) {
        console.error("Gradebook Error:", e);
        tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error loading data.</td></tr>`;
    }
}
// üîä READ ALOUD FOR EXAMS
function readExamQuestion() {
    // Safety checks
    if (!currentExamData || !currentExamData.questions) return;
    
    // Get current question text
    const q = currentExamData.questions[currentQIndex];
    
    // Create a temporary element to strip HTML (like <b> or <i>) so it reads cleanly
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = q.q;
    const text = tempDiv.textContent || tempDiv.innerText || "";
    
    // Native Browser Text-to-Speech (Offline)
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // Stop any previous talking
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9; // Slightly slower for better comprehension
        window.speechSynthesis.speak(u);
    } else {
        alert("Text-to-Speech not supported on this browser.");
    }
}
   // ==========================================
    // ‚úèÔ∏è RENAME PET FUNCTION (100 BP Cost)
    // ==========================================
    function renamePet() {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        if(!p) return;

        // 1. Check Cost
        if (gameState.brainPoints < 100) {
            showToast("Need 100 BP to rename!", "error");
            return;
        }

        // 2. Ask user
        let newName = prompt(`Rename ${p.name}? (Cost: 100 BP)\n\nEnter new name:`, p.name);

        // 3. Validate and Deduct
        if (newName && newName.trim() !== "" && newName !== p.name) {
            // Deduct BP
            adjustBP(-100);
            
            // Update Name
            newName = newName.trim().substring(0, 15); // Limit length to 15 chars
            p.name = newName;
            
            // Save & Refresh
            updateStatsDisplay(); // Update the BP counter
            saveGame(true); // Force Save immediately
            renderHub(); // Refresh the Hub UI
            
            showToast(`Renamed to ${newName}! (-100 BP)`, "success");
        }
    }
    // ==========================================
// üß™ STATUS EFFECT ENGINE (Expert)
// ==========================================

// 1. Apply Status (With Charm Immunity Check)
function applyStatusEffect(effectData, userSide, targetSide) {
    if (Math.random() > effectData.chance) return;

    // --- CHARM CHECK ---
    if (targetSide === 'player') {
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        const gear = getPetEquipmentStats(pet);
        
        // If gear has immunity to this specific type (e.g. "poison")
        if (gear.immune.includes(effectData.type)) {
            const visual = document.getElementById('battle-player-visual');
            showFloatingText(visual.parentElement, "RESISTED!", "heal");
            addBattleLog(`Charm blocked ${effectData.type}!`, "heal");
            return; // Stop the effect!
        }
    }
    // -------------------

    const statusList = (targetSide === 'player') 
        ? gameState.battleState.playerStatus 
        : gameState.battleState.enemyStatus;

    const existing = statusList.find(e => e.type === effectData.type);
    
    if (existing) {
        existing.turns = effectData.duration;
        addBattleLog(`${targetSide} ${effectData.type} extended!`, "info");
    } else {
        statusList.push({
            type: effectData.type,
            turns: effectData.duration,
            val: effectData.value || 0,
            icon: getStatusIcon(effectData.type)
        });
        
        const visual = (targetSide === 'player') ? document.getElementById('battle-player-visual') : document.getElementById('battle-enemy-visual');
        showFloatingText(visual.parentElement, effectData.type.toUpperCase() + "!", "crit");
    }
}

// 2. Process Turn (Take Damage or Skip Turn)
function resolveStatusTurn(targetSide) {
    const bs = gameState.battleState;
    const list = (targetSide === 'player') ? bs.playerStatus : bs.enemyStatus;
    let isStunned = false;
    let dotDamage = 0;

    // Loop backwards to remove expired items safely
    for (let i = list.length - 1; i >= 0; i--) {
        const s = list[i];
        
        // Damage over Time
        if (s.type === 'burn' || s.type === 'poison') {
            dotDamage += s.val;
        } 
        // Crowd Control
        else if (s.type === 'freeze' || s.type === 'stun') {
            isStunned = true;
            addBattleLog(`${targetSide} is frozen/stunned!`, "weak");
        }

        // Tick down timer
        s.turns--;
        if (s.turns <= 0) list.splice(i, 1);
    }

    // Apply accumulated damage
    if (dotDamage > 0) {
        if (targetSide === 'player') bs.playerHP -= dotDamage;
        else bs.enemyHP -= dotDamage;
        
        const visual = (targetSide === 'player') ? document.getElementById('battle-player-visual') : document.getElementById('battle-enemy-visual');
        showFloatingText(visual.parentElement, `-${dotDamage}`, "weak");
        addBattleLog(`${targetSide} took ${dotDamage} dmg`, "enemy");
    }

    return isStunned; // Returns true if they can't move
}

// 3. Icon Helper
function getStatusIcon(type) {
    const map = { 'burn':'üî•', 'poison':'ü§¢', 'freeze':'‚ùÑÔ∏è', 'stun':'üí´' };
    return map[type] || '‚ú®';
}
// --- PRO FORGE: EQUIPMENT MENU WITH UPGRADE & SALVAGE ---
function openEquipMenu(slotType) {
    currentEquipSlot = slotType;
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    if (!p.equipment) p.equipment = {};

    document.getElementById('equip-slot-title').innerText = `Select ${slotType.toUpperCase()} for ${p.name}:`;
    const list = document.getElementById('equip-list');
    list.innerHTML = "";
    
    if (!gameState.inventory.equipment || gameState.inventory.equipment.length === 0) {
        list.innerHTML = `<div style="grid-column:span 2; text-align:center; color:gray; padding:20px;">No gear found! Buy some in the Shop.</div>`;
    } else {
        const validItems = gameState.inventory.equipment.filter(item => item.type === slotType);

        validItems.forEach(item => {
            // 1. Find who is currently wearing this specific item
            const ownerPet = gameState.pets.find(op => op.equipment && Object.values(op.equipment).includes(item.instanceId));
            
            const isEquippedByMe = ownerPet && ownerPet.id === p.id;
            const isEquippedByOther = ownerPet && ownerPet.id !== p.id;

            const prefix = item.prefix || {};
            const rarityClass = `rarity-${item.rarity || 'basic'}`;
            const itemLvl = item.level || 1;
            const upgradeCost = itemLvl * 10;

            let bonusText = "";
            if (prefix.stat) bonusText = `+${prefix.stat} ${prefix.type.toUpperCase()}`;
            if (prefix.value) bonusText = `+${Math.round(prefix.value * 100)}% ${prefix.type.toUpperCase()}`;

            const div = document.createElement('div');
            div.className = rarityClass;
            div.style.cssText = `padding: 12px; border-radius: 12px; cursor: default; text-align: left; position: relative; margin-bottom:10px; border: 2px solid #e2e8f0; background: white;`;
            
            let visual = item.image || (item.type === 'weapon' ? 'üó°Ô∏è' : 'üõ°Ô∏è');
            let visualHtml = visual.startsWith('http') ? `<img src="${visual}" style="width:40px; height:40px; object-fit:contain; margin-right:10px;">` : `<div style="font-size:24px; margin-right:10px;">${visual}</div>`;

            // --- üñºÔ∏è THE PET OWNER BADGE ---
            let ownerBadgeHtml = "";
            if (ownerPet) {
                let petImg = ownerPet.image 
                    ? `<img src="${ownerPet.image}" class="${ownerPet.imageStyle}" style="width:24px; height:24px; border-radius:50%; border:2px solid #5a67d8; background:white;">` 
                    : `<div style="font-size:18px; width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:50%; border:2px solid #5a67d8; background:white;">${ownerPet.emoji}</div>`;
                
                ownerBadgeHtml = `
                    <div style="position:absolute; top:-10px; right:-5px; display:flex; align-items:center; gap:5px; background:white; padding:2px 8px; border-radius:15px; border:1px solid #cbd5e0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index:10;">
                        ${petImg}
                        <span style="font-size:9px; font-weight:bold; color:#4a5568;">${isEquippedByMe ? "YOU" : ownerPet.name.toUpperCase()}</span>
                    </div>`;
            }

            // --- BUTTON LOGIC ---
            let buttonLabel = "EQUIP";
            let buttonClass = "blue";
            let buttonDisabled = isEquippedByOther ? "disabled" : "";
            
            if (isEquippedByMe) {
                buttonLabel = "EQUIPPED";
                buttonClass = "green";
                buttonDisabled = "disabled";
            } else if (isEquippedByOther) {
                buttonLabel = "IN USE";
                buttonClass = "gray";
            }

            div.innerHTML = `
                ${ownerBadgeHtml}
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                    ${visualHtml}
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:${prefix.color || '#2d3748'}; font-size:14px;">${item.name} <span style="color:#5a67d8;">[Lvl ${itemLvl}]</span></div>
                        <div style="font-size:11px; color:#48bb78; font-weight:bold;">${bonusText}</div>
                    </div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="action-btn ${buttonClass}" style="flex:1; margin:0; font-size:10px; padding:8px;" ${buttonDisabled} onclick="confirmEquip('${item.instanceId}')">${buttonLabel}</button>
                    <button class="action-btn green" style="flex:1; margin:0; font-size:10px; padding:8px;" onclick="upgradeItem('${item.instanceId}', event)">‚öôÔ∏è UPGRADE (${upgradeCost})</button>
                    <button class="action-btn red" style="width:35px; margin:0; font-size:10px; padding:8px;" onclick="salvageItem('${item.instanceId}', event)">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // Add a Scraps counter at the bottom of the modal
    const footer = document.createElement('div');
    footer.style.cssText = "margin-top:15px; font-weight:bold; color:#718096; font-size:12px; text-align:center;";
    footer.innerHTML = `My Forge Scraps: <span style="color:#5a67d8;">${gameState.inventory.forgeScraps} ‚öôÔ∏è</span>`;
    list.appendChild(footer);

    document.getElementById('equip-modal').classList.add('active');
}

    function confirmEquip(instanceId) {
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    const slot = currentEquipSlot; 
    
    // üõ°Ô∏è Safety: Final check to see if anyone else is using it
    let alreadyInUse = false;
    gameState.pets.forEach(pet => {
        if (pet.equipment && Object.values(pet.equipment).includes(instanceId)) {
            alreadyInUse = true;
        }
    });

    if (alreadyInUse) {
        return showToast("This item is already equipped elsewhere!", "error");
    }

    if (!p.equipment) p.equipment = {};
    p.equipment[slot] = instanceId;
    
    saveGame(true);
    renderHub();
    document.getElementById('equip-modal').classList.remove('active');
    showToast("Equipped!", "success");
}

    function unequipCurrent(slot) {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        const oldItem = p.equipment[slot];
        
        if (oldItem) {
            gameState.inventory[oldItem] = (gameState.inventory[oldItem] || 0) + 1;
            delete p.equipment[slot];
            
            saveGame(false);
            renderHub();
            document.getElementById('equip-modal').classList.remove('active');
            showToast("Unequipped.", "info");
        }
    }
function getPetEquipmentStats(pet) {
    // HARD DEFAULTS
    let stats = { dmg: 0, hp: 0, crit: 0, lifesteal: 0, bpBoost: 0, immune: [] };
    
    if (!pet || !pet.equipment || !gameState.inventory || !gameState.inventory.equipment) return stats;

    Object.values(pet.equipment).forEach(instanceId => {
        const item = gameState.inventory.equipment.find(i => i.instanceId === instanceId);
        if (!item) return;

        const prefix = item.prefix || {};

        // Use safeNum on every single property to be 100% sure
        stats.dmg += safeNum(prefix.type === "dmg" ? prefix.stat : (prefix.type === "all" ? prefix.stat : 0));
        stats.hp += safeNum(prefix.type === "hp" ? prefix.stat : (prefix.type === "all" ? prefix.stat : 0));
        stats.crit += safeNum(prefix.type === "crit" ? prefix.stat : 0);
        
        if (prefix.type === "lifesteal") stats.lifesteal += Number(prefix.value || 0);
        if (prefix.type === "bp_boost") stats.bpBoost += Number(prefix.value || 0);
        if (prefix.type === "immunity" && prefix.effect) stats.immune.push(prefix.effect);
    });
    return stats;
}
// ==========================================
    // ‚öóÔ∏è FUSION & ULTRA EVOLUTION ENGINE
    // ==========================================
    
    // --- PART 1: FUSION (Adding Stars) ---
    function openFuseMenu() {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        
        // Find Duplicates
        const duplicates = gameState.pets.filter(d => 
            d.type === p.type && d.id !== p.id && d.isHatched // Must be same type, hatched, not self
        );
        
        // Find Mimic Slimes
        const mimics = gameState.inventory['mimic_slime'] || 0;
        
        let html = `<h2 style="color:#5a67d8">‚öóÔ∏è Fusion Chamber</h2><p>Select a duplicate to fuse into <strong>${p.name}</strong>.</p><p style="font-size:12px; color:#e53e3e;">‚ö†Ô∏è The duplicate will be destroyed!</p><div class="fuse-grid">`;
        
        if (duplicates.length === 0 && mimics === 0) {
            html += `<p style="grid-column:span 3; color:gray;">No duplicates found.</p>`;
        }
        
        // Render Duplicates
        duplicates.forEach(d => {
            const isHighLvl = d.level > 1;
            html += `
            <div class="fuse-card ${isHighLvl?'high-level':''}" onclick="confirmFuse('${d.id}', false)">
                <div style="font-size:30px;">${d.image ? `<img src="${d.image}" style="width:40px;">` : d.emoji}</div>
                <div style="font-weight:bold; font-size:12px;">Lvl ${d.level}</div>
                <div style="font-size:10px;">${d.name}</div>
            </div>`;
        });
        
        // Render Mimic Slimes
        if (mimics > 0) {
            html += `
            <div class="fuse-card" onclick="confirmFuse('mimic', true)" style="border-color:#ecc94b; background:#fffff0;">
                <div style="font-size:30px;">üß™</div>
                <div style="font-weight:bold; font-size:12px;">x${mimics}</div>
                <div style="font-size:10px;">Mimic Slime</div>
            </div>`;
        }
        
        html += `</div><button class="confirm-btn no" style="margin-top:10px; width:100%;" onclick="closeArenaModal()">Cancel</button>`;
        
        // Re-use Arena Modal for UI (Hack to save space)
        const modal = document.querySelector('#arena-modal .confirm-modal');
        const overlay = document.getElementById('arena-modal');
        const originalContent = modal.innerHTML; // Save original arena content
        
        modal.innerHTML = html;
        overlay.classList.add('active');
        
        // Restore Arena Modal when closed (Quick fix)
        window.restoreArena = () => { modal.innerHTML = originalContent; overlay.classList.remove('active'); };
        modal.querySelector('.no').onclick = window.restoreArena;
    }

    function confirmFuse(targetId, isMimic) {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        
        if (!isMimic) {
            const sacrifice = gameState.pets.find(d => d.id === targetId);
            // SAFETY LOCK
            if (sacrifice.level > 1) {
                if(!confirm(`‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nThis pet is LEVEL ${sacrifice.level}!\nIt will be DELETED forever.\n\nAre you sure?`)) return;
            }
            // Remove Pet
            gameState.pets = gameState.pets.filter(d => d.id !== targetId);
            // Remove from squad if there
            if (gameState.team) gameState.team = gameState.team.filter(id => id !== targetId);
        } else {
            // Remove Item
            gameState.inventory['mimic_slime']--;
        }
        
        // Add Star
        p.stars = (p.stars || 0) + 1;
        
        soundManager.playSFX('levelUp');
        saveGame(true);
        window.restoreArena(); // Close modal
        renderHub();
        showToast(`Success! ${p.name} gained a Star! ‚≠ê`, "success");
    }

    // --- PART 2: ULTRA EVOLUTION (The Trial) ---
    
    let ultraTargetPet = null;
    let ultraTargetData = null;
    let evoQuizScore = 0;
    
    async function startUltraEvolve() {
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    
    // 1. Fetch Data using our safe Registry Engine
    try {
        console.log("üß¨ Fetching Ultra Data for:", p.type);
        
        // Use our directFetch helper (which handles spaces and API limits)
        const res = await fetch(getGhUrl('pets/ultra_evolutions.json'));
        if(!res.ok) throw new Error("Evolution file not found");
        
        const data = await res.json();
        
        // Find the specific data for THIS pet
        const ultraData = data.find(u => u.base_id === p.type);
        
        if (!ultraData) {
            alert("This pet does not have an Ultra Form discovered yet! (Check ID in ultra_evolutions.json)");
            return;
        }
        
        ultraTargetPet = p;
        ultraTargetData = ultraData.ultra_form;
        
        // 2. Start The Trial of Knowledge
        if(confirm(`üß¨ ULTRA EVOLUTION DETECTED!\n\nTo evolve into ${ultraTargetData.name}, you must pass the Trial of Knowledge.\n\nAnswer 5 Questions. Pass 4 to Evolve.\n\nReady?`)) {
            startEvoQuiz();
        }

    } catch(e) {
        console.error("Ultra Evolution Error:", e);
        showToast("Error connecting to Evolution Server", "error");
    }
}

    function startEvoQuiz() {
        evoQuizScore = 0;
        let qCount = 0;
        
        // We reuse the Exam Modal for the Quiz
        const modal = document.getElementById('exam-interface');
        const header = document.querySelector('.exam-header');
        const container = document.querySelector('#exam-interface > div:nth-child(2)');
        
        modal.style.display = 'flex';
        header.innerHTML = `<span>üß¨ EVOLUTION TRIAL</span><span id="evo-score">0 / 5</span>`;
        
        const nextQ = () => {
            if (qCount >= 5) {
                finishEvoQuiz();
                return;
            }
            
            // Generate Question
            const q = MathEngine.generate(gameState.grade || "1");
            
            container.innerHTML = `
                <div style="font-size:24px; font-weight:bold; margin-bottom:20px;">Question ${qCount+1}</div>
                <div style="font-size:30px; margin-bottom:30px;">${q.text || q.q}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:500px;">
                    ${q.options.map(opt => `<button class="mcq-btn" onclick="checkEvoAnswer('${opt}', '${q.a}')">${opt}</button>`).join('')}
                </div>
            `;
            qCount++;
        };
        
        window.checkEvoAnswer = (ans, correct) => {
            if (ans == correct) {
                evoQuizScore++;
                soundManager.playSFX('correct');
            } else {
                soundManager.playSFX('wrong');
            }
            document.getElementById('evo-score').innerText = `${evoQuizScore} / 5`;
            nextQ(); // Auto next
        };
        
        nextQ(); // Start first question
    }

    function finishEvoQuiz() {
        document.getElementById('exam-interface').style.display = 'none';
        
        if (evoQuizScore >= 4) {
            // SUCCESS
            const p = ultraTargetPet;
            const newData = ultraTargetData;
            
            p.name = newData.name;
            p.type = newData.type;
            p.image = newData.image;
            p.imageStyle = newData.imageStyle;
            p.rarity = newData.rarity;
            p.element = newData.element;
            p.maxHP = newData.maxHP; // Boost Base HP
            p.hp = p.maxHP;
            p.stars = 0; // RESET STARS (Balance)
            
            // Trigger Animation
            triggerRewardCeremony(
                "üß¨ EVOLUTION COMPLETE!",
                `${p.name} has awakened!`,
                `<img src="${p.image}" style="width:200px; height:200px; object-fit:contain;">`,
                null
            );
            
            saveGame(true);
            renderHub();
            
        } else {
            // FAIL
            alert(`Trial Failed (${evoQuizScore}/5). Study more and try again!`);
        }
    }
    // ==========================================
    // üè∞ VOXEL BUILDER ENGINE
    // ==========================================

    const BUILDER_BLOCKS = [
        { id: 'grass', icon: 'üü©', name: 'Grass', color: '#4ade80', side: '#22c55e', top: '#86efac', cost: 10 },
        { id: 'dirt', icon: 'üü´', name: 'Dirt', color: '#a16207', side: '#713f12', top: '#ca8a04', cost: 10 },
        { id: 'stone', icon: '‚¨ú', name: 'Stone', color: '#94a3b8', side: '#64748b', top: '#cbd5e1', cost: 20 },
        { id: 'wood', icon: 'ü™µ', name: 'Wood', color: '#d97706', side: '#b45309', top: '#fbbf24', cost: 50 },
        { id: 'brick', icon: 'üß±', name: 'Brick', color: '#ef4444', side: '#b91c1c', top: '#f87171', cost: 100 },
        { id: 'glass', icon: 'üßä', name: 'Glass', color: 'rgba(56,189,248,0.4)', side: 'rgba(2,132,199,0.4)', top: 'rgba(125,211,252,0.4)', cost: 200 },
        { id: 'gold', icon: 'üëë', name: 'Gold', color: '#eab308', side: '#a16207', top: '#facc15', cost: 1000 }
    ];

    let buildState = {
        viewRot: { x: 60, z: 45 },
        selectedTool: 'grass', // Block ID or 'eraser'
        isDragging: false,
        startX: 0, startY: 0
    };

    function initBuilder() {
        // Ensure data exists (migration for old saves)
        if (!gameState.builder) {
            gameState.builder = { landSize: 6, voxels: {}, inventory: { 'grass': 10 } };
        }
        
        renderBuilderScene();
        renderPalette();
        setupBuilderControls();
    }

    function renderBuilderScene() {
    const world = document.getElementById('world');
    if (!world) return;

    // DECIDE WHICH HOUSE TO DRAW: My house or Friend's house
    const activeBuilder = gameState.isVisiting ? visitingVoxels : gameState.builder;
    
    if (!activeBuilder || !activeBuilder.voxels) return;

    const LAND_SCALE = 40; 
    const size = activeBuilder.landSize * LAND_SCALE;
    const CONTAINER_SIZE = 400;
    const centerOffset = CONTAINER_SIZE / 2;
    
    // Apply camera rotation
    world.style.transform = `rotateX(${buildState.viewRot.x}deg) rotateZ(${buildState.viewRot.z}deg) translateZ(-50px)`;
    
    let html = '';

    // 1. Draw Grid Base (The Floor)
    html += `<div class="grid-base" style="width:${size}px; height:${size}px; grid-template-columns:repeat(${activeBuilder.landSize}, 1fr); left:50%; top:50%; transform:translate3d(-50%, -50%, 0px);">`;
    for(let y=0; y<activeBuilder.landSize; y++) {
        for(let x=0; x<activeBuilder.landSize; x++) {
            html += `<div class="grid-cell" onclick="placeBlock(${x},${y},0)"></div>`;
        }
    }
    html += `</div>`;

    // 2. Draw Voxels (Blocks)
    for(const [key, data] of Object.entries(activeBuilder.voxels)) {
        const [x, y, z] = key.split(',').map(Number);
        const b = BUILDER_BLOCKS.find(bl => bl.id === data.id);
        if(b) {
            const ox = (x * LAND_SCALE) - (size / 2) + centerOffset;
            const oy = (y * LAND_SCALE) - (size / 2) + centerOffset;
            const oz = (z * LAND_SCALE) + 20; 
            const getStyle = (val) => val && val.toString().startsWith('http') ? `url('${val}')` : val;
            const bgProps = (val) => val && val.toString().startsWith('http') ? 'background-size: cover; background-repeat: no-repeat;' : '';

            html += `<div class="voxel-cube" style="transform: translate3d(${ox}px, ${oy}px, ${oz}px)">
                <div class="face face-top" style="background:${getStyle(b.top)}; ${bgProps(b.top)}" onclick="clickVoxel(${x},${y},${z}, 'top', event)"></div>
                <div class="face face-front" style="background:${getStyle(b.side)}; ${bgProps(b.side)}" onclick="clickVoxel(${x},${y},${z}, 'front', event)"></div>
                <div class="face face-back" style="background:${getStyle(b.side)}; ${bgProps(b.side)}" onclick="clickVoxel(${x},${y},${z}, 'back', event)"></div>
                <div class="face face-right" style="background:${getStyle(b.color)}; ${bgProps(b.color)}" onclick="clickVoxel(${x},${y},${z}, 'right', event)"></div>
                <div class="face face-left" style="background:${getStyle(b.color)}; ${bgProps(b.color)}" onclick="clickVoxel(${x},${y},${z}, 'left', event)"></div>
            </div>`;
        }
    }

    // 3. RENDER PETS (Walking around the house)
    if (typeof builderPets !== 'undefined' && builderPets.length > 0) {
        builderPets.forEach(pet => {
            const ox = (pet.x * 40) - (size / 2) + centerOffset;
            const oy = (pet.y * 40) - (size / 2) + centerOffset;
            const oz = (pet.z * 40) + 20; 

            const content = pet.image 
                ? `<img src="${pet.image}" style="width:30px; height:30px; object-fit:contain;">`
                : `<div style="font-size:24px;">${pet.emoji}</div>`;

            html += `<div class="voxel-pet" style="position: absolute; width: 40px; height: 40px; transform-style: preserve-3d; transform: translate3d(${ox}px, ${oy}px, ${oz}px) rotateX(-90deg); pointer-events: none; transition: transform 0.5s linear;">
                <div style="position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center; transform: translateZ(2px);">${content}</div>
                <div style="position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center; transform: translateZ(0px); filter: brightness(0.8);">${content}</div>
                <div style="position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center; transform: translateZ(-2px); filter: brightness(0.5);">${content}</div>
            </div>`;
        });
    }

    world.innerHTML = html;
    document.getElementById('land-size-display').innerText = `${activeBuilder.landSize}x${activeBuilder.landSize}`;
}

    function renderPalette() {
    const p = document.getElementById('block-palette');
    if (!p) return;

    let html = `<div class="block-btn ${buildState.selectedTool==='eraser'?'active':''}" onclick="selectTool('eraser')"><div>üßº</div><div class="block-qty">DEL</div></div>`;
    
    BUILDER_BLOCKS.forEach(b => {
        const qty = gameState.builder.inventory[b.id] || 0;
        const active = buildState.selectedTool === b.id ? 'active' : '';
        const style = qty === 0 ? 'opacity:0.6; filter:grayscale(1);' : '';
        const action = qty > 0 ? `selectTool('${b.id}')` : `buyBlock('${b.id}')`;
        const label = qty > 0 ? `x${qty}` : `${b.cost}BP`;
        
        let iconDisplay = "";
        const tex = b.icon || b.top; 
        if (tex && tex.toString().startsWith('http')) {
            iconDisplay = `<img src="${tex}" style="width:30px; height:30px; object-fit:cover; border-radius:4px; pointer-events:none;">`;
        } else {
            iconDisplay = `<div style="font-size:24px;">${b.icon || 'üì¶'}</div>`;
        }

        html += `<div class="block-btn ${active}" style="${style}" onclick="${action}">${iconDisplay}<div class="block-qty">${label}</div></div>`;
    });
    p.innerHTML = html;
}
    

    // --- ACTIONS ---

    function selectTool(id) {
        buildState.selectedTool = id;
        renderPalette();
    }

    function buyBlock(id) {
        const b = BUILDER_BLOCKS.find(x => x.id === id);
        if (gameState.brainPoints >= b.cost) {
            gameState.brainPoints -= b.cost;
            gameState.builder.inventory[id] = (gameState.builder.inventory[id] || 0) + 5; // Buy 5 at a time? Or 1? Let's do 1 for now to be safe, or 5 for value.
            // Let's do: Cost is per block.
            // Actually, let's make it "Buy 5 for Cost" to make it feel generous.
            gameState.builder.inventory[id] = (gameState.builder.inventory[id] || 0) + 4; // Add 4 more (total +5 logic above) -> wait, logic fix:
            // Fix: Just add 5.
            // gameState.builder.inventory[id] += 4; 
            
            updateStatsDisplay();
            saveGame();
            renderPalette();
            showToast(`Bought 5 ${b.name}!`, "success");
        } else {
            showToast("Not enough BP!", "error");
        }
    }

    function expandLand() {
    // 1. Calculate Cost based on current size
    // Size 6 -> 500 BP
    // Size 8 -> 1000 BP
    // Size 10 -> 1500 BP, etc.
    const baseCost = 500;
    const multiplier = (gameState.builder.landSize - 4) / 2; 
    const currentCost = baseCost * multiplier;

    // 2. Set Max Limit to 20 (Safe for performance)
    if(gameState.builder.landSize >= 20) return showToast("Maximum Land Size Reached!", "info");
    
    if(gameState.brainPoints >= currentCost) {
        if(confirm(`Expand Land to ${gameState.builder.landSize+2}x${gameState.builder.landSize+2} for ${currentCost} BP?`)) {
            adjustBP(-currentCost);
            gameState.builder.landSize += 2;
            
            updateStatsDisplay();
            saveGame();
            initBuilder(); // Re-center everything
            showToast("Land Expanded!", "success");
        }
    } else {
        showToast(`Need ${currentCost} BP to expand!`, "error");
    }
}

    function placeBlock(x, y, z) {
    if (gameState.isVisiting) return; // READ-ONLY MODE

    if(buildState.isDragging) return;
    if(buildState.selectedTool === 'eraser') return;

    const key = `${x},${y},${z}`;
    if(gameState.builder.voxels[key]) return; 

    const qty = gameState.builder.inventory[buildState.selectedTool] || 0;
    
    if(qty > 0) {
        gameState.builder.voxels[key] = { id: buildState.selectedTool };
        gameState.builder.inventory[buildState.selectedTool]--;
        
        saveGame(false);
        renderBuilderScene();
        renderPalette();

        // Increment session counter for Construction Quizzes
        blocksPlacedSession++;
        if (blocksPlacedSession % 5 === 0) {
            setTimeout(triggerBuildQuiz, 300); 
        }
    } else {
        showToast("Out of blocks!", "error");
    }
}

    function clickVoxel(x, y, z, face, e) {
        if (gameState.isVisiting) return; // VISITOR SAFETY
        e.stopPropagation(); // Don't click grid behind it
        if(buildState.isDragging) return;

        const currentKey = `${x},${y},${z}`;

        if(buildState.selectedTool === 'eraser') {
            // Refund block (optional? Let's keep it simple: Yes refund)
            const id = gameState.builder.voxels[currentKey].id;
            gameState.builder.inventory[id] = (gameState.builder.inventory[id] || 0) + 1;
            
            delete gameState.builder.voxels[currentKey];
            saveGame();
            renderBuilderScene();
            renderPalette();
        } else {
            // Build on neighbor face
            let nx = x, ny = y, nz = z;
            if(face === 'top') nz++;
            if(face === 'bottom') nz--; // Not clickable really
            if(face === 'front') ny++;
            if(face === 'back') ny--;
            if(face === 'right') nx++;
            if(face === 'left') nx--;

            // Check Bounds
            if(nx < 0 || nx >= gameState.builder.landSize || ny < 0 || ny >= gameState.builder.landSize || nz < 0 || nz > 10) return;

            placeBlock(nx, ny, nz);
        }
    }

    // --- üì± MOBILE & DESKTOP CONTROLS ---

    function setupBuilderControls() {
        const c = document.getElementById('builder-container');
        if(c.dataset.listening) return; // Prevent double listeners
        c.dataset.listening = "true";

        // --- MOUSE (Desktop) ---
        c.addEventListener('mousedown', e => {
            buildState.isDragging = false;
            buildState.startX = e.clientX;
            buildState.startY = e.clientY;
        });

        c.addEventListener('mousemove', e => {
            if(e.buttons === 1) handleInputMove(e.clientX, e.clientY);
        });

        // --- TOUCH (Mobile) ---
        // This makes the builder rotate with fingers instead of scrolling the page
        c.addEventListener('touchstart', e => {
            // Check if touching the scene or container
            if(e.target === c || e.target.classList.contains('scene-3d')) {
                e.preventDefault(); 
            }
            buildState.isDragging = false;
            buildState.startX = e.touches[0].clientX;
            buildState.startY = e.touches[0].clientY;
        }, { passive: false });

        c.addEventListener('touchmove', e => {
            if(e.target === c || e.target.classList.contains('scene-3d')) {
                e.preventDefault();
            }
            handleInputMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
    }

    // Unified Logic (Works for Mouse & Touch)
    function handleInputMove(currentX, currentY) {
        const dx = currentX - buildState.startX;
        const dy = currentY - buildState.startY;
        
        // Threshold to prevent accidental clicks registering as drags
        if(Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            buildState.isDragging = true;
            buildState.viewRot.z -= dx * 0.5;
            // Limit vertical rotation so they can't flip the world upside down
            buildState.viewRot.x = Math.max(10, Math.min(85, buildState.viewRot.x - dy * 0.5));
            
            buildState.startX = currentX;
            buildState.startY = currentY;
            
            // Render Rotation immediately
            const world = document.getElementById('world');
            if(world) {
                world.style.transform = `rotateX(${buildState.viewRot.x}deg) rotateZ(${buildState.viewRot.z}deg) translateZ(-50px)`;
            }
        }
    }

    // Resets camera angle
    function resetBuilderView() {
        buildState.viewRot = { x: 60, z: 45 };
        renderBuilderScene();
    }

    // --- üì≥ MOBILE UTILS ---

    function vibratePhone(ms) {
        // Only works on Android/Mobile devices that support it
        if (navigator && navigator.vibrate) {
            try { navigator.vibrate(ms); } catch(e){}
        }
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }
    // --- üè∞ PET BUILDER INTEGRATION ---

let builderPetInterval = null;
let builderPets = []; // Local state for builder pets

function initBuilderPets() {
    // 1. Clear old intervals to prevent speed-ups
    if (builderPetInterval) clearInterval(builderPetInterval);
    
    // 2. Get the squad
    const squadIds = gameState.team || [gameState.currentPetId];
    builderPets = [];

    // 3. Spawn them at safe locations
    squadIds.forEach(id => {
        const petData = gameState.pets.find(p => p.id === id);
        if (petData) {
            // Find a random spot within current land size
            let safeX = Math.floor(Math.random() * gameState.builder.landSize);
            let safeY = Math.floor(Math.random() * gameState.builder.landSize);
            let safeZ = getHighestZ(safeX, safeY) + 1; // Stand ON TOP of the block

            builderPets.push({
                id: id,
                image: petData.image,
                emoji: petData.emoji,
                x: safeX, 
                y: safeY, 
                z: safeZ,
                // Add a little randomness so they don't all move at exact same millisecond
                nextMoveTime: Date.now() + (Math.random() * 3000)
            });
        }
    });

    // 4. Start the AI Loop
    builderPetInterval = setInterval(updateBuilderPets, 500); // Check every half second
}

function getHighestZ(x, y) {
    // Helper to find the ground height at specific X,Y
    let maxZ = -1; // -1 means ground level (z=0) is available
    for (const key in gameState.builder.voxels) {
        const [vx, vy, vz] = key.split(',').map(Number);
        if (vx === x && vy === y) {
            if (vz > maxZ) maxZ = vz;
        }
    }
    return maxZ;
}

function updateBuilderPets() {
    const now = Date.now();
    let moved = false;

    builderPets.forEach(pet => {
        if (now > pet.nextMoveTime) {
            // TIME TO MOVE!
            // 1. Pick random direction (Up, Down, Left, Right)
            const dirs = [{dx:0, dy:1}, {dx:0, dy:-1}, {dx:1, dy:0}, {dx:-1, dy:0}];
            const move = dirs[Math.floor(Math.random() * dirs.length)];
            
            const targetX = pet.x + move.dx;
            const targetY = pet.y + move.dy;

            // 2. Check Boundaries
            if (targetX >= 0 && targetX < gameState.builder.landSize && 
                targetY >= 0 && targetY < gameState.builder.landSize) {
                
                // 3. Check Physics
                // We want to walk ON blocks, not inside them.
                const groundHeight = getHighestZ(targetX, targetY);
                const targetZ = groundHeight + 1;

                // "Gravity Check": Max jump height = 1 block up/down
                if (Math.abs(targetZ - pet.z) <= 1) {
                    pet.x = targetX;
                    pet.y = targetY;
                    pet.z = targetZ;
                    moved = true;
                }
            }

            // Reset Timer (2 to 5 seconds wait)
            pet.nextMoveTime = now + 2000 + (Math.random() * 3000);
        }
    });

    if (moved) renderBuilderScene(); // Redraw if anyone moved
}
// --- üöß CONSTRUCTION QUIZ ENGINE ---

let blocksPlacedSession = 0; // Counts blocks placed in this session

function triggerBuildQuiz() {
    // 1. Get Question (Topic-based or Fallback)
    let q;
    if (gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) {
        q = gameState.activeQuestionPool[Math.floor(Math.random() * gameState.activeQuestionPool.length)];
    } else {
        q = MathEngine.generate(gameState.grade || "1");
    }

    // 2. Setup UI
    const modal = document.getElementById('build-quiz-modal');
    const qText = document.getElementById('build-quiz-question');
    const qGrid = document.getElementById('build-quiz-options');
    
    // Ensure we handle text properly
    qText.innerHTML = q.qVisualHTML || q.q || q.text;
    qGrid.innerHTML = '';

    // 3. Generate Options
    const options = q.options || MathEngine.generateDistractors(parseFloat(q.a));
    
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'mcq-btn';
        btn.style.fontSize = '20px';
        btn.style.padding = '15px';
        btn.innerText = opt;
        
        btn.onclick = () => {
            if (opt == q.a) {
                recordMathParticipation(true);
                // --- ‚úÖ CORRECT ANSWER ---
                soundManager.playSFX('correct');
                addBP(10); // Reward increased to 10
                
                showToast("‚úÖ Inspection Passed! (+10 BP)", "success");
                
                // UNLOCK: Close the modal so they can build again
                modal.classList.remove('active');
            } else {
                recordMathParticipation(false);
                // --- ‚ùå WRONG ANSWER ---
                soundManager.playSFX('wrong');
                
                // 1. Deduct BP
                const loss = Math.min(gameState.brainPoints, 5); // Prevent negative BP
                gameState.brainPoints -= loss;
                updateStatsDisplay();
                saveGame(); // Save the penalty immediately
                
                showToast(`‚ùå Incorrect! -${loss} BP. Try again!`, "error");
                
                // 2. VISUAL LOCK: Gray out THIS wrong button
                btn.disabled = true;
                btn.style.background = "#fed7d7"; // Red tint
                btn.style.borderColor = "#fc8181";
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                
                // 3. IMPORTANT: DO NOT CLOSE MODAL
                // We do NOT run modal.classList.remove('active');
                // The student is trapped until they pick the right one.
            }
        };
        qGrid.appendChild(btn);
    });

    // 4. Lock the Screen
    modal.classList.add('active');
}
// --- PRO BACKEND: MASTER SYNC ENGINE ---
// 1. Emergency Save: Triggers the moment the tab is closed
window.addEventListener("beforeunload", (event) => {
    if (hasUnsavedChanges && gameState.playerName && gameState.playerName !== "Student") {
        saveProgressToFirebase();
    }
});

// 2. Heartbeat Timer: Checks every 45 seconds and saves IF changes were made
if (autoSaveInterval) clearInterval(autoSaveInterval);
autoSaveInterval = setInterval(() => {
    if (hasUnsavedChanges && gameState.playerName && gameState.playerName !== "Student") {
        console.log("üïí Heartbeat: Syncing changes to Cloud...");
        saveProgressToFirebase();
    }
}, 45000); // 45 seconds is the "Sweet Spot" for safety vs cost
// --- PRO UI: LOOT REVEAL ENGINE ---
function showLootReveal(item) {
    const overlay = document.getElementById('item-reveal-overlay');
    const card = document.getElementById('reveal-card-inner');
    const name = document.getElementById('reveal-item-name');
    const desc = document.getElementById('reveal-item-desc');
    const tag = document.getElementById('reveal-rarity-tag');
    const container = document.getElementById('reveal-visual-container');

    // 1. Setup Rarity
    const rarity = item.rarity || 'basic';
    tag.innerText = rarity.toUpperCase();
    tag.style.color = item.prefix.color;
    
    // Apply special background class
    card.className = "reveal-card rarity-" + rarity;

    // 2. Setup Name & Stats
    name.innerText = item.name;
    let bonus = item.prefix.stat ? `+${item.prefix.stat} ${item.prefix.type.toUpperCase()}` : `+${Math.round(item.prefix.value*100)}% ${item.prefix.type.toUpperCase()}`;
    desc.innerHTML = `<span style="color:#48bb78; font-weight:bold;">${bonus}</span><br>Permanent Equipment Added to Hub`;

    // 3. Setup Visual
    if (item.image && item.image.startsWith('http')) {
        container.innerHTML = `<img src="${item.image}" class="reveal-image">`;
    } else {
        container.innerHTML = `<div style="font-size:100px; margin: 20px 0;">${item.image || 'üó°Ô∏è'}</div>`;
    }

    // 4. Play Sound & Show
    soundManager.playSFX('gacha'); 
    overlay.style.display = 'flex';
}

function closeLootReveal() {
    document.getElementById('item-reveal-overlay').style.display = 'none';
    renderShop(); // Refresh shop to show updated BP
}
// --- PRO FORGE: SALVAGE ENGINE ---
function salvageItem(instanceId, event) {
    if(event) event.stopPropagation();
    const item = gameState.inventory.equipment.find(i => i.instanceId === instanceId);
    
    if (!confirm(`Salvage ${item.name}?\n\nYou will get Forge Scraps, but the item will be destroyed forever!`)) return;

    // 1. Give scraps based on rarity
    const rewards = { 'basic': 5, 'rare': 20, 'legendary': 100 };
    const amount = rewards[item.rarity || 'basic'];
    gameState.inventory.forgeScraps += amount;

    // 2. Remove from inventory
    gameState.inventory.equipment = gameState.inventory.equipment.filter(i => i.instanceId !== instanceId);
    
    // 3. If the pet was wearing it, unequip it
    gameState.pets.forEach(p => {
        if (p.equipment) {
            for (let slot in p.equipment) {
                if (p.equipment[slot] === instanceId) delete p.equipment[slot];
            }
        }
    });

    showToast(`‚ôªÔ∏è Salvaged! +${amount} Scraps`, "success");
    saveGame(false);
    openEquipMenu(currentEquipSlot); // Refresh
}



function upgradeItem(instanceId, event) {
    if(event) event.stopPropagation();
    const item = gameState.inventory.equipment.find(i => i.instanceId === instanceId);
    if (!item) return;

    // üõ°Ô∏è SECURITY FIX: Force scraps to be a number (prevents the infinite bug)
    if (gameState.inventory.forgeScraps === undefined || isNaN(gameState.inventory.forgeScraps)) {
        gameState.inventory.forgeScraps = 0;
    }

    const itemLvl = Number(item.level || 1);
    
    // üõ°Ô∏è SECURITY FIX: Level Cap (Max Level 10)
    if (itemLvl >= 10) {
        showToast("Item is already at MAX level!", "info");
        return;
    }

    const cost = itemLvl * 10;

    if (gameState.inventory.forgeScraps < cost) {
        showToast(`Need ${cost} Scraps to upgrade!`, "error");
        return;
    }

    // 1. Pay for it
    gameState.inventory.forgeScraps -= cost;
    
    // 2. Power up!
    item.level = itemLvl + 1;
    
    // üõ°Ô∏è SECURITY FIX: Balanced Scaling (Prevents "Thousands" of HP)
    if (item.prefix.stat !== undefined) {
        item.prefix.stat += (item.rarity === 'legendary' ? 5 : 3);
    } 
    else if (item.prefix.value !== undefined) {
        item.prefix.value += 0.02; 
    }

    soundManager.playSFX('levelUp');
    showToast(`‚ú® Upgraded to Lvl ${item.level}`, "success");
    
    // üõ°Ô∏è SECURITY FIX: Force Cloud Sync (No "Refresh" cheating)
    saveGame(true); 
    openEquipMenu(currentEquipSlot); 
}
// --- PRO RAID: PHASE 2 FRENZY LOGIC ---
function triggerMathFrenzy() {
    frenzyActive = true;
    currentPhase = 2;
    frenzyCount = 0;
    frenzyTimer = 30;
    
    document.getElementById('raid-frenzy-overlay').style.display = 'flex';
    document.getElementById('frenzy-timer').innerText = frenzyTimer;
    
    // Start Countdown
    frenzyInterval = setInterval(() => {
        frenzyTimer--;
        document.getElementById('frenzy-timer').innerText = frenzyTimer;
        if (frenzyTimer <= 0) endFrenzy(false); // FAIL
    }, 1000);

    generateFrenzyQuestion();
}

function generateFrenzyQuestion() {
    // Designer Choice: Use Grade - 1 for Speed Fluency
    let easyGrade = Math.max(0, (parseInt(gameState.grade) || 1) - 1);
    const q = MathEngine.generate(easyGrade.toString());
    
    document.getElementById('frenzy-math-q').innerHTML = q.qVisualHTML || q.q;
    const opts = document.getElementById('frenzy-options');
    opts.innerHTML = '';

    q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.padding = "10px";
        btn.innerText = opt;
        btn.onclick = () => {
            if (opt == q.a) {
                frenzyCount++;
                soundManager.playSFX('correct');
                const pct = (frenzyCount / 5) * 100;
                document.getElementById('frenzy-shield-fill').style.width = pct + "%";
                document.getElementById('frenzy-shield-text').innerText = `SHIELD: ${frenzyCount} / 5`;
                if (frenzyCount >= 5) endFrenzy(true); // SUCCESS
                else generateFrenzyQuestion();
            } else {
                soundManager.playSFX('wrong');
                frenzyTimer -= 2; // Time penalty for wrong answer
                showToast("-2 Seconds!", "error");
                generateFrenzyQuestion();
            }
        };
        opts.appendChild(btn);
    });
}

async function endFrenzy(success) {
    clearInterval(frenzyInterval);
    frenzyActive = false;
    document.getElementById('raid-frenzy-overlay').style.display = 'none';

    const pVis = document.getElementById('battle-player-visual');
    const eVis = document.getElementById('battle-enemy-visual');

    if (success) {
        showToast("üí• SHIELD SHATTERED! MEGA HIT!", "success");
        eVis.style.animation = "damageShake 1s";
        // Deal massive bonus damage to the boss
        currentRunDamage += 500; 
        soundManager.playSFX('levelUp');
    } else {
        showToast("‚ùå FAILED! Boss unleashes a Roar!", "error");
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        const dmg = Math.floor(pet.hp * 0.4); // 40% damage
        pet.hp -= dmg;
        pVis.style.animation = "damageShake 1s";
        showFloatingText(pVis.parentElement, `-${dmg}`, "crit");
        saveGame();
    }
    renderRaidPlayerSide();
}
// --- ‚úàÔ∏è VISITOR & KINDNESS ENGINE ---
const COMPLIMENTS = [
    "Your house design is genius!", "I love the colors you picked!", 
    "This is the coolest land I‚Äôve seen!", "You are a master architect!", 
    "Your build is so creative!", "Thank you for helping me in class today!", 
    "You are an amazing friend!", "Thanks for explaining that math problem!", 
    "You are a great team player!", "I appreciate your kindness today!", 
    "Keep up the great work!", "Your pet has an awesome home!", 
    "High five for being awesome!", "You have really great ideas!", 
    "I'm glad we are in the same class!"
];

let visitingVoxels = null;
let currentFriendName = "";

async function visitFriendLand() {
    const friendName = document.getElementById('visit-username').value.trim();
    if (!friendName || friendName === gameState.playerName) return;

    showToast("Traveling to " + friendName + "...", "info");

    try {
        const docSnap = await window.fbase.getDoc(window.fbase.doc(window.db, "students", friendName));
        if (!docSnap.exists()) return showToast("Student not found!", "error");

        const friendDocData = docSnap.data().saveData;
        const decodedData = decompressData(friendDocData);

        if (!decodedData.builder) return showToast("Friend hasn't built anything yet!", "info");

        // 1. Enter Visiting State
        gameState.isVisiting = true;
        currentFriendName = friendName;
        visitingVoxels = decodedData.builder; // Capture friend's land

        // 2. Toggle UI
        document.getElementById('build-main-controls').style.display = 'none';
        document.getElementById('block-palette').style.display = 'none';
        document.getElementById('visitor-controls').style.display = 'block';
        document.getElementById('visiting-name').innerText = "Visiting: " + friendName;
        updateKindnessUI();

        // 3. Render Land
        renderVisitorLand();
        initBuilderPets(); // Your pets walk in their land!
        
    } catch (e) { console.error(e); }
}

function renderVisitorLand() {
    renderBuilderScene(); // That's it!
}

function exitVisit() {
    gameState.isVisiting = false;
    document.getElementById('build-main-controls').style.display = 'flex';
    document.getElementById('block-palette').style.display = 'flex';
    document.getElementById('visitor-controls').style.display = 'none';
    initBuilder(); // Restore my house
    initBuilderPets();
}

function updateKindnessUI() {
    const remaining = 100 - (gameState.givenToday || 0);
    const meter = document.getElementById('kindness-meter');
    if(meter) meter.innerText = `Kindness Purse: ${remaining}/100 BP`;
}

async function giveStar() {
    if (!gameState.isVisiting) return;
    
    // 1. Check if they have enough BP
    if (gameState.brainPoints < 5) {
        return showToast("Need 5 BP to give a Star!", "error");
    }

    // 2. Check Daily Kindness Limit
    if (gameState.givenToday + 5 > 100) {
        return showToast("Daily Kindness Limit reached!", "error");
    }

    // 3. Deduct from Visitor
    gameState.brainPoints -= 5;
    gameState.givenToday += 5;
    updateStatsDisplay();
    updateKindnessUI();

    // 4. Send to Friend (5 BP + 2 Bonus = 7 BP received)
    await sendFriendNotification(currentFriendName, "star", 7, "gave you a Star!");
    
    showToast("Star Sent! (-5 BP)", "success");
    saveGame(true); // Save the BP deduction immediately
}

function openComplimentMenu() {
    const remaining = 100 - (gameState.givenToday || 0);
    if (remaining <= 0) return showToast("Daily Kindness Limit Reached!", "info");

    let html = `<div style="max-height:300px; overflow-y:auto; text-align:left;">`;
    COMPLIMENTS.forEach((msg) => {
        html += `<div class="move-replace-btn" onclick="sendGifterCompliment('${msg.replace(/'/g, "\\'")}')" style="margin-bottom:5px; font-size:13px; padding:10px; border:1px solid #eee;">${msg}</div>`;
    });
    html += `</div>`;

    const modal = document.querySelector('#arena-modal .confirm-modal');
    const overlay = document.getElementById('arena-modal');
    modal.innerHTML = `<h3>Choose a Compliment</h3><p style='font-size:12px;'>Sends 20 BP (+5 Bonus) to friend.</p>${html}<button class='confirm-btn no' style="width:100%; margin-top:10px;" onclick='document.getElementById("arena-modal").classList.remove("active")'>Cancel</button>`;
    overlay.classList.add('active');
}

async function sendGifterCompliment(msg) {
    document.getElementById("arena-modal").classList.remove("active");
    
    if (gameState.givenToday + 20 > 100) return showToast("Daily Kindness limit reached!", "error");
    if (gameState.brainPoints < 20) return showToast("Not enough BP to give!", "error");

    gameState.brainPoints -= 20;
    gameState.givenToday += 20;
    updateStatsDisplay();
    updateKindnessUI();

    await sendFriendNotification(currentFriendName, "compliment", 25, msg);
    showToast("Gift Sent! Message delivered.", "success");
    saveGame(true);
}

async function sendFriendNotification(friend, type, bpAmount, message) {
    gameState.dailyQuests.social = 1;
    const ref = window.fbase.doc(window.db, "students", friend);
    
    // The note itself can stay readable, but the keys in the database MUST be tiny
    const note = { 
        from: gameState.playerName, 
        type: type, 
        bp: bpAmount, // Amount of BP in the gift
        text: message, 
        time: Date.now() 
    };

    try {
        await window.fbase.updateDoc(ref, {
            // üî• FIX: Use 'nt' instead of 'notifications'
            "saveData.nt": window.fbase.arrayUnion(note), 
            
            // üî• FIX: Use 'bp' instead of 'brainPoints'
            "saveData.bp": window.fbase.increment(bpAmount)
        });
    } catch (e) {
        console.error("Failed to send gift:", e);
    }
}

function showMailbox() {
    const notes = gameState.notifications || [];
    let html = notes.map(n => `
        <div style="background:#f7fafc; padding:10px; border-radius:8px; border-left:4px solid #48bb78; margin-bottom:10px; text-align:left;">
            <div style="font-weight:bold; font-size:14px; color:#2d3748;">üì¨ From: ${n.from}</div>
            <div style="font-size:13px; color:#4a5568; margin:5px 0;">"${n.text}"</div>
            ${n.bp > 0 ? `<div style="font-weight:bold; color:#d69e2e; font-size:12px;">üéÅ Received: ${n.bp} BP!</div>` : ''}
        </div>
    `).join('');

    const totalBP = notes.reduce((sum, n) => sum + (n.bp || 0), 0);
    const modal = document.querySelector('#arena-modal .confirm-modal');
    const overlay = document.getElementById('arena-modal');
    
    modal.innerHTML = `
        <h2 style="color:#48bb78;">Community Mailbox</h2>
        <p>Friends visited your land while you were away!</p>
        <div style="max-height:250px; overflow-y:auto; margin:15px 0;">${html}</div>
        <div style="background:#fef3c7; padding:10px; border-radius:10px; font-weight:bold; color:#92400e; margin-bottom:15px;">
            Total Collected: +${totalBP} BP
        </div>
        <button class="confirm-btn yes" style="width:100%;" onclick="clearMailbox()">Awesome!</button>
    `;
    overlay.classList.add('active');
}

async function clearMailbox() {
    document.getElementById("arena-modal").classList.remove("active");
    gameState.notifications = [];
    await window.fbase.updateDoc(window.fbase.doc(window.db, "students", gameState.playerName), {
        "saveData.notifications": []
    });
    saveGame(true);
}
// --- üß¨ MASTERY INFUSION SYSTEM ---

function openInfusionMenu() {
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    if (!p.badges) p.badges = [];
    
    let html = `<div style="max-height:300px; overflow-y:auto; text-align:left;">`;
    
    if (gameState.badgeInventory.length === 0) {
        html += `<p style="text-align:center; padding:20px; color:gray;">No Mastery Badges found. Visit the Math Lab!</p>`;
    }

    gameState.badgeInventory.forEach((badge) => {
        html += `
        <div class="move-replace-btn" onclick="confirmInfusion('${badge}')" style="margin-bottom:10px;">
            <div style="font-weight:bold; color:#5a67d8;">üèÖ ${badge}</div>
            <div style="font-size:10px; color:#718096;">Gives +20% Power when solving ${badge} problems!</div>
        </div>`;
    });
    
    html += `</div>`;

    const modal = document.querySelector('#arena-modal .confirm-modal');
    const overlay = document.getElementById('arena-modal');
    modal.innerHTML = `
        <h2 style="color:#5a67d8;">üß¨ Infuse Mastery</h2>
        <p style="font-size:13px;">Linking a badge to <strong>${p.name}</strong> is <strong style="color:#e53e3e;">PERMANENT</strong>.</p>
        ${html}
        <button class='confirm-btn no' style="width:100%;" onclick='document.getElementById("arena-modal").classList.remove("active")'>Cancel</button>
    `;
    overlay.classList.add('active');
}

async function confirmInfusion(badgeName) {
    const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
    
    if(!confirm(`Are you sure? This badge will be PERMANENTLY linked to ${p.name}.`)) return;

    // 1. Add to Pet
    p.badges.push(badgeName);
    
    // 2. Remove from Inventory
    gameState.badgeInventory = gameState.badgeInventory.filter(b => b !== badgeName);
    
    document.getElementById("arena-modal").classList.remove("active");
    showToast(`${p.name} mastered ${badgeName}!`, "success");
    soundManager.playSFX('levelUp');
    
    saveGame(true);
    renderHub();
}
// --- üóº INFINITY TOWER ENGINE 5.1 (STABLE & MATCHED) ---
let isTowerActing = false;
let towerFocusActive = false;
let towerTurnIndex = 0; 

// 1. THE LOBBY
function renderTowerLobby() {
    isTowerActing = false;
    towerTurnIndex = 0;
    towerFocusActive = false;
    document.getElementById('tower-arena').style.display = 'none';
    document.getElementById('tower-command-bar').style.display = 'none';
    const lobby = document.getElementById('tower-lobby');
    lobby.style.display = 'block';
    
    const floor = gameState.currentTowerFloor || 1;

    // --- LOOPHOLE FIX: ALWAYS GET FRESH HP FROM GLOBAL STATE ---
    let totalMissingHP = 0;
    gameState.team.forEach(id => {
        const petInInventory = gameState.pets.find(p => p.id === id);
        if (petInInventory) {
            totalMissingHP += (petInInventory.maxHP - petInInventory.hp);
        }
    });
    const healCost = Math.ceil(totalMissingHP * 2); // 2 BP per 1 HP
    // ----------------------------------------------------------

    // ... (rest of your lobby.innerHTML code) ...
    // Note: Make sure the button line uses the new ${healCost} variable:
    // <button ...> üíä HEAL ALL (${healCost} BP) </button>
    // ---------------------------------------

    lobby.innerHTML = `
        <h1 style="font-size:32px; color:#f6e05e; text-shadow: 0 0 10px #b7791f;">üóº INFINITY TOWER</h1>
        <div class="tower-lobby-card">
            <div style="font-size:18px; font-weight:bold;">FLOOR ${floor}</div>
            <div style="font-size:11px; color:#a0aec0;">Best: ${gameState.highestTowerFloor || 1}</div>
        </div>
        <div id="tower-squad-preview" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;"></div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="action-btn blue" style="font-size:12px;" onclick="towerOpenSquadManager()">üë• SQUAD</button>
            <button class="action-btn green" style="font-size:12px;" onclick="towerHealFullTeam()">
                üíä HEAL ALL (${healCost} BP)
            </button>
        </div>
        <button class="gacha-btn" style="background:#48bb78; margin-top:20px;" onclick="startTowerFloor()">‚ö° ASCEND (10 Stamina)</button>
        <button onclick="resetTowerProgress()" style="background:none; border:none; color:#fc8181; font-size:11px; cursor:pointer; margin-top:15px; text-decoration:underline;">Reset Progress</button>

        <div id="tower-squad-modal" class="tower-modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Manage Squad</h2>
                <button class="action-btn red" style="width:40px;" onclick="towerCloseSquadManager()">X</button>
            </div>
            <div id="tower-squad-list" style="flex:1; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            <button class="action-btn green" style="margin-top:15px;" onclick="towerCloseSquadManager()">CONFIRM TEAM</button>
        </div>
    `;
    towerRenderSquadPreview();
}

// 2. START FLOOR
async function startTowerFloor() {
    if (gameState.stamina < 10) return showToast("Need 10 Stamina", "error");
    const squad = getSquad();
    if (squad.every(p => p.hp <= 0)) return showToast("Heal your team first!", "error");

    isTowerActing = true;
    gameState.stamina -= 10;
    updateStatsDisplay();
    await saveGame(true);

    const floor = gameState.currentTowerFloor || 1;
    const enemyTeam = [];
    const pool = [...PET_TYPES.common, ...PET_TYPES.uncommon, ...PET_TYPES.rare];
    
    for(let i=0; i<6; i++) {
        let base = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
        const hpVal = 50 + (floor * 25);
        enemyTeam.push({ ...base, currentHP: hpVal, maxHP: hpVal, id: 'te_'+i });
    }

    towerBattleState = { playerTeam: squad.map(p => ({...p, currentHP: p.hp})), enemyTeam: enemyTeam };
    towerTurnIndex = 0;

    document.getElementById('tower-lobby').style.display = 'none';
    document.getElementById('tower-arena').style.display = 'block';
    
    towerRenderStage();
    setTimeout(towerNextTurn, 1000);
}

// 3. TURN LOGIC
function towerNextTurn() {
    // WIN CHECK: If all enemies are dead
    if (towerBattleState.enemyTeam.every(e => e.currentHP <= 0)) {
        towerWinFloor();
        return;
    }
    
    // PLAYER TURN END CHECK
    if (towerTurnIndex >= towerBattleState.playerTeam.length) {
        towerTurnIndex = 0;
        towerEnemyTurn();
        return;
    }

    const pet = towerBattleState.playerTeam[towerTurnIndex];
    if (pet.currentHP <= 0) {
        towerTurnIndex++;
        towerNextTurn();
        return;
    }

    towerRenderStage();
    towerShowCommandBar(pet);
}

function towerShowCommandBar(pet) {
    const bar = document.getElementById('tower-command-bar');
    const list = document.getElementById('tower-moves-list');
    document.getElementById('tower-pet-name-display').innerText = `COMMANDING: ${pet.name}`;
    
    bar.style.display = 'flex';
    const moves = (pet.powers && pet.powers.length > 0) ? pet.powers : ['claw_attack'];

    let html = moves.map(pid => {
        const move = findShopItem(pid);
        return `<button class="action-btn green" onclick="towerDoMove('${pid}')">${move.name}</button>`;
    }).join('');

    html += `<button class="action-btn blue" onclick="towerStartFocus()">${towerFocusActive ? '‚ú® LOADED' : 'üß† FOCUS'}</button>`;
    list.innerHTML = html;

    const el = document.getElementById(`tp-${pet.id}`);
    if(el) el.classList.add('tower-active-glow');
}

async function towerDoMove(moveId) {
    document.getElementById('tower-command-bar').style.display = 'none';
    const pet = towerBattleState.playerTeam[towerTurnIndex];
    const move = findShopItem(moveId);
    
    await towerAnimate(pet, move, towerFocusActive ? 2.5 : 1.0, true);
    
    towerFocusActive = false;
    towerTurnIndex++;
    
    // Check for win immediately after attack
    if (towerBattleState.enemyTeam.every(e => e.currentHP <= 0)) {
        setTimeout(towerWinFloor, 800);
    } else {
        setTimeout(towerNextTurn, 600);
    }
}

async function towerEnemyTurn() {
    showToast("Enemies attacking...", "error");
    for (let enemy of towerBattleState.enemyTeam) {
        if (enemy.currentHP <= 0) continue;
        await towerAnimate(enemy, { name: 'Strike', icon: 'üí¢' }, 1.0, false);
        if (towerBattleState.playerTeam.every(p => p.currentHP <= 0)) break;
    }

    if (towerBattleState.playerTeam.every(p => p.currentHP <= 0)) {
        alert("Squad Fainted! Rematch once you heal."); towerFinalize();
    } else {
        towerTurnIndex = 0; towerNextTurn();
    }
}

// 4. THE ANIMATION (With GetBoundingClientRect Fix)
async function towerAnimate(attacker, move, mult, isPlayer) {
    const atkId = isPlayer ? `tp-${attacker.id}` : `te-${attacker.id}`;
    const atkEl = document.getElementById(atkId);
    
    const targets = isPlayer ? towerBattleState.enemyTeam : towerBattleState.playerTeam;
    const target = targets.find(t => t.currentHP > 0);
    if (!target) return;
    
    const defId = isPlayer ? `te-${target.id}` : `tp-${target.id}`;
    const defEl = document.getElementById(defId);

    // ERROR PROTECTION SHIELD
    if (!atkEl || !defEl) {
        console.warn("Visuals not found, calculating damage only.");
        target.currentHP = Math.max(0, target.currentHP - 25);
        return;
    }

    atkEl.style.transform = isPlayer ? "translateX(40px)" : "translateX(-40px)";
    createProjectile(move.image || move.icon || 'üí•', atkEl, defEl);
    
    await new Promise(r => setTimeout(r, 450));
    const dmg = Math.floor((20 + (attacker.level || 1) * 2) * mult);
    target.currentHP = Math.max(0, target.currentHP - dmg);
    
    defEl.style.animation = "damageShake 0.4s";
    showFloatingText(defEl, `-${dmg}`, mult > 1 ? "crit" : "weak");
    
    await new Promise(r => setTimeout(r, 300));
    atkEl.style.transform = "none";
}

// 5. STAGING & WINNING
function towerWinFloor() {
    const floor = gameState.currentTowerFloor;
    const reward = floor * 100;
    addBP(reward);
    
    alert(`üèÜ FLOOR ${floor} CLEAR! \n\nRewards: +${reward} BP`);
    
    gameState.currentTowerFloor++;
    if(gameState.currentTowerFloor > (gameState.highestTowerFloor || 1)) {
        gameState.highestTowerFloor = gameState.currentTowerFloor;
    }
    towerFinalize();
}

async function towerFinalize() {
    towerBattleState.playerTeam.forEach(p => {
        const real = gameState.pets.find(rp => rp.id === p.id);
        if(real) real.hp = Math.ceil(p.currentHP);
    });
    await saveGame(true);
    renderTowerLobby();
}

function towerConfirmEscape() { if(confirm("Quit and save team health?")) towerFinalize(); }

// 6. UTILS (HEAL/SQUAD/PREVIEW)
function towerRenderSquadPreview() {
    const squad = getSquad();
    const container = document.getElementById('tower-squad-preview');
    if(!container) return;
    
    container.innerHTML = squad.map(p => {
        // 1. Calculate Real Max HP (Base + Gear)
        const gear = getPetEquipmentStats(p);
        let totalMax = (p.maxHP || 50) + (gear.hp || 0);
        
        // Safety: If current HP is somehow higher than total, use current as max
        if (p.hp > totalMax) totalMax = p.hp;

        // 2. Calculate Percentage (Clamped to 100%)
        let hpPct = (p.hp / totalMax) * 100;
        if (hpPct > 100) hpPct = 100;
        if (hpPct < 0) hpPct = 0;

        // 3. Color Logic
        const color = p.hp <= 0 ? '#f56565' : '#48bb78'; // Red if dead, Green if alive
        const filter = p.hp <= 0 ? 'filter:grayscale(1) opacity:0.5' : '';

        // 4. Render (With overflow:hidden on the bar background)
        return `
        <div style="background:rgba(255,255,255,0.1); padding:5px; border-radius:8px; border:1px solid ${color}; text-align:center; width:60px;">
            <img src="${p.image}" style="width:35px; height:35px; object-fit:contain; ${filter}">
            
            <!-- Bar Container (Gray Background) -->
            <div style="width:100%; height:4px; background:#333; margin-top:4px; border-radius:2px; overflow:hidden;">
                <!-- Actual Health Fill -->
                <div style="width:${hpPct}%; height:100%; background:${color}; transition:width 0.3s;"></div>
            </div>
            
            <div style="font-size:9px; color:white; font-weight:bold; margin-top:2px;">${Math.ceil(p.hp)}/${Math.ceil(totalMax)}</div>
        </div>`;
    }).join('');
}

async function towerHealFullTeam() {
    // 1. RE-CALCULATE based on current Global HP
    let totalMissingHP = 0;
    gameState.team.forEach(id => {
        const p = gameState.pets.find(x => x.id === id);
        if(p) totalMissingHP += (p.maxHP - p.hp);
    });

    const finalCost = Math.ceil(totalMissingHP * 2);

    if (finalCost <= 0) return showToast("Squad is already full health!", "info");

    // 2. Check if they can afford the REAL current cost
    if (gameState.brainPoints < finalCost) {
        return showToast(`Need ${finalCost} BP to heal your current squad!`, "error");
    }

    // 3. Deduct and Heal
    adjustBP(-finalCost);
    gameState.team.forEach(id => {
        const p = gameState.pets.find(x => x.id === id);
        if(p) p.hp = p.maxHP;
    });

    updateStatsDisplay();
    saveGame(false);
    
    // 4. Refresh the Lobby to update the preview and the button price
    renderTowerLobby(); 
    showToast(`Team Restored! -${finalCost} BP`, "success");
}

function towerRenderStage() {
    const stage = document.getElementById('tower-stage-container');
    stage.innerHTML = '';
    // FIXED PERCENTAGES FOR YOUR BACKGROUND (32% is center-left, 58% is center-right)
    const pSlots = [[25,40,'row-top'], [15,40,'row-top'], [0,40,'row-top'], [30,50,'row-bottom'], [20,50,'row-bottom'], [5,50,'row-bottom']];
    const eSlots = [[50,40,'row-top'], [65,40,'row-top'], [80,40,'row-top'], [60,50,'row-bottom'], [75,50,'row-bottom'], [90,50,'row-bottom']];

    towerBattleState.playerTeam.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = `hero-slot ${pSlots[i][2]}`;
        div.id = `tp-${p.id}`;
        div.style.left = pSlots[i][0] + "%"; div.style.top = pSlots[i][1] + "%";
        if(p.currentHP <= 0) div.style.filter = "grayscale(1) opacity(0.4)";
        div.innerHTML = `<div class="hero-hp-number">${p.currentHP <= 0 ? 'KO' : Math.ceil(p.currentHP)}</div><img src="${p.image}" class="hero-img-unit ${p.imageStyle}">`;
        stage.appendChild(div);
    });

    towerBattleState.enemyTeam.forEach((e, i) => {
        const div = document.createElement('div');
        div.className = `hero-slot ${eSlots[i][2]}`;
        div.id = `te-${e.id}`;
        div.style.left = eSlots[i][0] + "%"; div.style.top = eSlots[i][1] + "%";
        div.innerHTML = `<div class="hero-hp-number enemy-hp-number">${e.currentHP <= 0 ? '' : Math.ceil(e.currentHP)}</div><img src="${e.image}" class="hero-img-unit" style="transform:scaleX(-1); ${e.currentHP <= 0 ? 'opacity:0' : ''}">`;
        stage.appendChild(div);
    });
}

function towerStartFocus() {
    let q = (gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) 
        ? gameState.activeQuestionPool[Math.floor(Math.random() * gameState.activeQuestionPool.length)] 
        : MathEngine.generate(gameState.grade || "1");

    const overlay = document.getElementById('tower-math-popup');
    const content = document.getElementById('tower-math-content');

    overlay.style.display = 'flex';
    content.innerHTML = `
        <div class="tower-command-box" style="border-color:#f6e05e; color:#2d3748; background:white; padding:20px; border-radius:15px; border:4px solid #f6e05e;">
            <div style="text-align:center; font-weight:bold; color:#d97706;">‚ö° TOWER FOCUS ‚ö°</div>
            <div style="font-size:32px; text-align:center; margin:20px 0; font-weight:bold;">${q.qVisualHTML || q.q}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                ${q.options.map(opt => `<button class="mcq-btn" style="min-height:60px; font-size:22px;" onclick="towerResolveFocus('${opt}', '${q.a}')">${opt}</button>`).join('')}
            </div>
        </div>`;
}

function towerResolveFocus(ans, correct) {
    document.getElementById('tower-math-popup').style.display = 'none';
    if (ans == correct) {
        recordMathParticipation(true);
        towerFocusActive = true; soundManager.playSFX('correct'); showToast("POWER LOADED!", "success"); }
    else {
        recordMathParticipation(false);
        towerFocusActive = false; soundManager.playSFX('wrong'); }
    towerShowCommandBar(towerBattleState.playerTeam[towerTurnIndex]);
}

function towerOpenSquadManager() { 
    const modal = document.getElementById('tower-squad-modal');
    modal.style.display = 'flex';
    const list = document.getElementById('tower-squad-list');
    list.innerHTML = '';
    gameState.pets.forEach(p => {
        if (!p.isHatched) return;
        const isIn = gameState.team.includes(p.id);
        const card = document.createElement('div');
        card.className = `pet-card ${isIn ? 'active' : ''}`;
        card.innerHTML = `<img src="${p.image}" style="width:35px;"><div style="font-size:10px;">${p.name}</div>`;
        card.onclick = () => {
            if(isIn) { if(gameState.team.length > 1) gameState.team = gameState.team.filter(id => id !== p.id); }
            else { if(gameState.team.length < 6) gameState.team.push(p.id); }
            towerOpenSquadManager(); towerRenderSquadPreview();
        };
        list.appendChild(card);
    });
}
function towerCloseSquadManager() { document.getElementById('tower-squad-modal').style.display = 'none'; }
function resetTowerProgress() { if(confirm("Return to Floor 1?")) { gameState.currentTowerFloor = 1; saveGame(true); renderTowerLobby(); } }
  
  // --- PRO ARCHAEOLOGY ENGINE ---
const RelicEngine = {
    // This picks a random high-value item from your existing data
    pickNewTarget: function() {
        const roll = Math.random();
        let target = {};

        if (roll < 0.3) { // 30% Chance for a Pet Egg
            const rarity = Math.random() > 0.8 ? 'epic' : 'rare';
            const pool = PET_TYPES[rarity];
            const pet = pool[Math.floor(Math.random() * pool.length)];
            target = { name: pet.name + " Egg", img: pet.image, type: 'egg', data: pet };
        } 
        else if (roll < 0.6) { // 30% Chance for Equipment
            const equip = SHOP_ITEMS.equipment[Math.floor(Math.random() * SHOP_ITEMS.equipment.length)];
            target = { name: "Rare " + equip.name, img: equip.image, type: 'equip', data: equip };
        } 
        else { // 40% Chance for Luxury Building Blocks
            const block = BUILDER_BLOCKS[Math.floor(Math.random() * BUILDER_BLOCKS.length)];
            target = { name: "20x " + block.name, img: block.icon, type: 'block', data: block };
        }

        gameState.excavationTarget = target;
        this.updateUI();
    },

    updateUI: function() {
        const dp = gameState.digProgress || 0;
        const target = gameState.excavationTarget;
        if (!target) return this.pickNewTarget();

        const imgEl = document.getElementById('fossil-icon');
        const fill = document.getElementById('dig-fill');
        const count = document.getElementById('dig-count');

        // Update Silhouette
        imgEl.src = target.img;
        if (dp >= 15) {
            imgEl.className = "fossil-img is-revealing"; // Glowing state
        } else {
            imgEl.className = "fossil-img is-fossil"; // Pure black state
        }

        // Update Bar
        fill.style.width = (dp / 20 * 100) + "%";
        count.innerText = `${dp}/20`;
    },

    grantReward: function() {
        const t = gameState.excavationTarget;
        if (t.type === 'egg') {
            const newEgg = JSON.parse(JSON.stringify(t.data));
            newEgg.id = 'egg_' + Date.now();
            newEgg.isHatched = false;
            newEgg.hatchProgress = 0;
            gameState.pets.push(newEgg);
        } else if (t.type === 'block') {
            const id = t.data.id;
            gameState.builder.inventory[id] = (gameState.builder.inventory[id] || 0) + 20;
        } else if (t.type === 'equip') {
            // Give 50 scraps for gear discovery or add the item
            gameState.inventory.forgeScraps += 25;
        }

        triggerRewardCeremony("RELIC UNEARTHED!", `You discovered: ${t.name}`, `<img src="${t.img}" style="width:100px;">`, () => {
            this.pickNewTarget(); // Pick next one immediately
            saveGame(true);
        });
    }
};


// --- TEACHER: TRIGGER THE BOOST ---
async function triggerClassBoost() {
    if (!currentLoggedTeacher) return;
    if (!confirm("Activate 20-minute Brain Boost for the whole class?")) return;

    const bRef = window.fbase.doc(window.db, "class_stats", `beacon_${currentLoggedTeacher}`);
    
    await window.fbase.setDoc(bRef, {
        isBoostActive: true,
        boostEndTime: Date.now() + (20 * 60 * 1000), // 20 minutes
        totalEnergy: 0 // Reset for next time
    }, { merge: true });

    showToast("üöÄ BRAIN BOOST ACTIVATED!", "success");
}

// TEACHER VIEW: Watches the Beacon charge
function initTeacherBeaconListener() {
    if (!currentLoggedTeacher) return;
    window.fbase.onSnapshot(window.fbase.doc(window.db, "class_stats", `beacon_${currentLoggedTeacher}`), (doc) => {
        if (doc.exists()) {
            const d = doc.data();
            const pct = Math.min(100, (d.totalEnergy / 1000) * 100);
            document.getElementById('t-beacon-fill').style.width = pct + "%";
            document.getElementById('t-beacon-val').innerText = `${d.totalEnergy}/1000`;
            
            const btn = document.getElementById('activate-boost-btn');
            const msg = document.getElementById('boost-active-msg');
            
            if (d.isBoostActive && d.boostEndTime > Date.now()) {
                btn.style.display = 'none';
                msg.style.display = 'block';
            } else if (d.totalEnergy >= 1000) {
                btn.style.display = 'block';
                msg.style.display = 'none';
            } else {
                btn.style.display = 'none';
                msg.style.display = 'none';
            }
        }
    });
}

// --- MASTER STUDENT LISTENER (BEACON + BOOST + RESET) ---
async function initClassBeacon() {
    // üõ°Ô∏è ARCHITECT FIX: If teacherId is missing, look it up in the database first
    if (!gameState.teacherId && gameState.playerName) {
        try {
            const sDoc = await window.fbase.getDoc(window.fbase.doc(window.db, "students", gameState.playerName));
            if (sDoc.exists()) {
                gameState.teacherId = sDoc.data().teacherId;
                console.log("üì° Teacher ID recovered:", gameState.teacherId);
            }
        } catch(e) { console.error("Error finding teacher:", e); }
    }

    // If we still don't have an ID, we can't load the leaderboard, so we stop here.
    if (!gameState.teacherId) {
        console.warn("‚ö†Ô∏è Leaderboard Blocked: No Teacher ID found.");
        return;
    }

    // Start listening to the Teacher's Class Beacon
    window.fbase.onSnapshot(window.fbase.doc(window.db, "class_stats", `beacon_${gameState.teacherId}`), (doc) => {
        if (!doc.exists()) return;
        const d = doc.data();

        // 4. LEADERBOARD REFRESH (This draws the students on the board)
        if (d.leaderboard) {
            renderScholarLeaderboard(d.leaderboard);
        }
        
// 1. AUTO-RESET LOGIC (Clears scores if teacher starts a new topic)
        if (d.currentCycleId && d.currentCycleId !== (gameState.lastCycleId || "")) {
            console.log("üÜï New Math Cycle Detected! Resetting scores...");
            gameState.mathCorrect = 0;
            gameState.mathTotal = 0;
            gameState.lastCycleId = d.currentCycleId; // Record that we have reset for this lesson
            
            showToast(`Teacher started new topic: ${d.currentCycleName || "Fresh Start"}!`, "info");
            saveGame(true); // This pushes the "0" scores back to the teacher's dashboard
        }

        // 2. BEACON PROGRESS LOGIC (Updates the blue bar)
        const energy = d.totalEnergy || 0;
        const pct = Math.min(100, (energy / 1000) * 100);
        const beaconBar = document.getElementById('beacon-fill');
        const beaconLabel = document.getElementById('beacon-text');
        if (beaconBar) beaconBar.style.width = pct + "%";

        // 3. BOOST ACTIVATION LOGIC (Double BP Mode)
        if (d.isBoostActive && d.boostEndTime > Date.now()) {
            gameState.isBrainBoosted = true;
            if (beaconLabel) {
                beaconLabel.innerText = "üî• BOOST ACTIVE!";
                beaconLabel.className = "boost-active-text";
            }
            document.getElementById('screen-study').classList.add('beacon-boost-glow');
            if(!window.boostNotified) {
                showToast("üåü TEACHER ACTIVATED BRAIN BOOST!", "success");
                soundManager.playSFX('levelUp');
                window.boostNotified = true;
            }
        } else {
            gameState.isBrainBoosted = false;
            window.boostNotified = false;
            if (beaconLabel) {
                beaconLabel.innerText = `${energy}/1000`;
                beaconLabel.className = "";
            }
            document.getElementById('screen-study').classList.remove('beacon-boost-glow');
        }
    });
}

// --- UNIVERSAL SCHOLAR TRACKING ---
function recordMathParticipation(isCorrect) {
    // 1. Update local memory
    gameState.mathTotal = (gameState.mathTotal || 0) + 1;
    if (isCorrect) {
        gameState.mathCorrect = (gameState.mathCorrect || 0) + 1;
    }

    // 2. Immediate Local UI update (optional, but good for feedback)
    console.log(`üìä Scholar Progress: ${gameState.mathCorrect} / ${gameState.mathTotal}`);

    // 3. Mark as "Dirty" so the Heartbeat Save pushes this to Firebase
    hasUnsavedChanges = true;
    
    // 4. Update the Leaderboard (We will build the Cloud part of this in Phase 2)
    syncToClassLeaderboard(); 
}

// --- LEADERBOARD SYNC ENGINE ---
async function syncToClassLeaderboard() {
    // 1. Safety Check: Only sync if we have a name and a teacher
    if (!gameState.teacherId || !gameState.playerName || gameState.playerName === "Student") return;

    console.log("üèÜ Syncing " + gameState.playerName + " to Leaderboard...");

    const bRef = window.fbase.doc(window.db, "class_stats", `beacon_${gameState.teacherId}`);
    
    try {
        await window.fbase.runTransaction(window.db, async (transaction) => {
            const sfDoc = await transaction.get(bRef);
            
            // If the class folder doesn't exist, create it
            if (!sfDoc.exists()) {
                transaction.set(bRef, { 
                    leaderboard: [{ name: gameState.playerName, score: gameState.mathCorrect || 0 }],
                    totalEnergy: 0,
                    teacherId: gameState.teacherId
                });
                return;
            }

            let leaderboard = sfDoc.data().leaderboard || [];
            
            // 2. Update my score if I'm already there, otherwise add me
            const myIndex = leaderboard.findIndex(entry => entry.name === gameState.playerName);
            if (myIndex !== -1) {
                leaderboard[myIndex].score = gameState.mathCorrect || 0;
            } else {
                leaderboard.push({ name: gameState.playerName, score: gameState.mathCorrect || 0 });
            }

            // 3. Sort by score and keep top 10
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 10);

            transaction.update(bRef, { leaderboard: leaderboard });
        });
        console.log("‚úÖ Leaderboard Sync Complete!");
    } catch (e) {
        console.error("‚ùå Leaderboard Sync Failed:", e);
    }
}

// --- TEACHER: RESET THE MATH SCORES ---
async function resetMathCycle() {
    const topicName = document.getElementById('new-cycle-name').value.trim() || "New Lesson";
    if (!currentLoggedTeacher) return;
    if (!confirm(`Are you sure? This will clear the "Correct/Total" scores for EVERY student in your class to start: ${topicName}`)) return;

    const bRef = window.fbase.doc(window.db, "class_stats", `beacon_${currentLoggedTeacher}`);
    
    const newCycleId = "cycle_" + Date.now(); // Create a unique ID

    await window.fbase.updateDoc(bRef, {
        currentCycleId: newCycleId,
        currentCycleName: topicName,
        leaderboard: []
    });

    document.getElementById('new-cycle-name').value = "";
    showToast(`Board Reset! New Topic: ${topicName}`, "success");
}

// Update the Teacher Dashboard view to show the active cycle name
function initCycleListener() {
    if (!currentLoggedTeacher) return;
    window.fbase.onSnapshot(window.fbase.doc(window.db, "class_stats", `beacon_${currentLoggedTeacher}`), (doc) => {
        if (doc.exists()) {
            const d = doc.data();
            if (d.currentCycleName) {
                document.getElementById('t-active-topic').innerText = d.currentCycleName;
            }
        }
    });
}

function renderScholarLeaderboard(entries) {
    const list = document.getElementById('scholar-leaderboard-list');
    if (!list || !entries) return;

    if (entries.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:10px; color:gray; font-size:12px;">The board is fresh! Be the first to solve.</div>`;
        return;
    }

    let html = "";
    // Only show Top 10
    const displayList = entries.slice(0, 10);
    
    displayList.forEach((entry, index) => {
        const isMe = entry.name === gameState.playerName;
        const rank = index + 1;
        let medal = "";
        if (rank === 1) medal = "ü•á ";
        else if (rank === 2) medal = "ü•à ";
        else if (rank === 3) medal = "ü•â ";

        html += `
            <div class="lb-row ${isMe ? 'lb-me' : ''}">
                <div class="lb-rank">${rank}</div>
                <div class="lb-name">${medal}${entry.name}</div>
                <div class="lb-score">${entry.score} Solved</div>
            </div>
        `;
    });

    // --- ADD "MY POSITION" FOOTER ---
    const myRank = entries.findIndex(e => e.name === gameState.playerName) + 1;
    if (myRank > 10) {
        html += `
            <div style="border-top: 2px dashed #edf2f7; margin-top:5px; padding-top:5px;">
                <div class="lb-row lb-me">
                    <div class="lb-rank">${myRank}</div>
                    <div class="lb-name">${gameState.playerName} (You)</div>
                    <div class="lb-score">${gameState.mathCorrect} Solved</div>
                </div>
            </div>
        `;
    }

    list.innerHTML = html;
}

// --- üè• THE SUPER-DOCTOR (REHYDRATOR) ---
function rehydrateAllPets() {
    if (!gameState.pets || gameState.pets.length === 0) return;

    console.log("üè• Super-Doctor: Commencing Shielded Rehydration...");

    gameState.pets.forEach(p => {
        // 1. Identify species (Check compressed 'tp' or full 'type')
        const speciesId = p.type || p.tp || 'monster_01';

        // 2. Find Blueprint in the Registry
        let blueprint = null;
        for (const rarity in PET_TYPES) {
            const found = PET_TYPES[rarity].find(b => b.id === speciesId);
            if (found) { blueprint = found; break; }
        }

        if (blueprint) {
            p.type = speciesId; 
            p.rarity = p.rarity || blueprint.rarity;
            p.element = p.element || blueprint.element;
            p.emoji = p.emoji || blueprint.emoji;

            // Visual Sync (Fix broken images)
            const isImgBroken = !p.image || p.image === "" || p.image === "undefined" || p.image.length < 10;
            if (isImgBroken) {
                p.image = blueprint.image; 
                p.imageStyle = blueprint.imageStyle || 'blend-multiply';
            }

            // Evolution Visual Sync
            const stage = safeNum(p.evolutionStage || p.evs);
            let chain = EVOLUTION_CHAINS[speciesId] || p.savedEvolutions || p.sevo;
            if (stage > 0 && chain && chain[stage - 1]) {
                const evoData = chain[stage - 1];
                if (evoData.image) p.image = evoData.image;
            }
        }

        // 3. üõ°Ô∏è DATA HARDENING (Prevent crashes)
        p.powers = Array.isArray(p.powers) ? p.powers : ['claw_attack'];
        p.badges = Array.isArray(p.badges) ? p.badges : [];
        p.equipment = (p.equipment && typeof p.equipment === 'object') ? p.equipment : {};
        p.stars = safeNum(p.stars);

        // 4. üõ°Ô∏è LEVEL PROTECTION (The Level 1 Fix)
        const foundLevel = p.level || p.lv || p.lvl || 1;
        p.level = safeNum(foundLevel, 1);
        p.lv = p.level; 

        // 5. üõ°Ô∏è STAT SHIELD
        p.maxHP = safeNum(p.maxHP || p.mhp, (50 + (p.level * 10)));
        p.hp = safeNum(p.hp, p.maxHP);
        if (p.hp > p.maxHP) p.hp = p.maxHP;
        p.xp = safeNum(p.xp);
        p.maxXp = safeNum(p.maxXp, (p.level * 300 + 200));
    });

    applySquadLevelSync(); // Force level floor
    console.log("‚úÖ All pets have been fully reconstructed, shielded, and synced.");
}
  </script>
  <!-- üöß CONSTRUCTION QUIZ MODAL -->
<div class="modal-overlay" id="build-quiz-modal" style="z-index: 9999;">
    <div class="confirm-modal" style="border: 4px solid #f6ad55; background: #fffaf0;">
        <div style="font-size: 50px; margin-bottom: 10px;">üöß</div>
        <h2 style="color: #d97706; font-weight: 900; text-transform: uppercase;">Safety Inspection!</h2>
        <p style="color: #744210; margin-bottom: 20px; font-size: 14px;">
            Answer this to continue building! (+5 BP)
        </p>
        
        <!-- Question Display -->
        <div id="build-quiz-question" style="font-size: 24px; font-weight: bold; color: #2d3748; margin-bottom: 20px;">
            Loading...
        </div>
        
        <!-- Options -->
        <div id="build-quiz-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <!-- Buttons go here -->
        </div>
    </div>
</div>
<!-- PRO UI: ITEM REVEAL MODAL -->
<div id="item-reveal-overlay" class="reveal-overlay">
    <div class="reveal-card" id="reveal-card-inner">
        <div class="reveal-shine"></div>
        <div style="font-size: 14px; font-weight: bold; color: #718096; text-transform: uppercase; letter-spacing: 2px;">You Discovered</div>
        <div id="reveal-rarity-tag" style="margin: 10px 0; font-weight: 900; font-size: 24px;">LEGENDARY</div>
        
        <div id="reveal-visual-container">
            <!-- Image or Emoji injected here -->
        </div>

        <h2 id="reveal-item-name" style="font-size: 28px; margin: 10px 0; color: #2d3748;">Sharp Sword</h2>
        <p id="reveal-item-desc" style="color: #4a5568; margin-bottom: 25px;">+5 Damage Bonus</p>
        
        <button class="gacha-btn" style="padding: 15px; margin: 0;" onclick="closeLootReveal()">CLAIM ITEM</button>
    </div>
</div>
<!-- üéØ DAILY QUEST MODAL -->
<div class="modal-overlay" id="quest-modal">
    <div class="confirm-modal" style="max-width: 450px; border: 4px solid #f56565;">
        <div style="background:#f56565; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:white; font-size:20px;">üéØ Daily Bounties</h2>
            <button onclick="toggleQuestBoard(false)" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="daily-quest-list" style="padding:15px; max-height:400px; overflow-y:auto;">
            <!-- Quests injected by JS -->
        </div>
        <div style="padding:10px; border-top:1px solid #eee;">
            <button class="confirm-btn no" style="width:100%;" onclick="toggleQuestBoard(false)">Close</button>
        </div>
    </div>
</div>
</body>
 </html>
