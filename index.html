<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Math Pet Adventure RPG (Pro Edition)</title>
  
  <!-- 1. LOAD FIREBASE LIBRARIES -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, runTransaction, arrayUnion, deleteDoc, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAw7gJ8lN5BNE2a74jdAoSu9vrpAsBgcpc",
      authDomain: "petadventure-b73c8.firebaseapp.com",
      projectId: "petadventure-b73c8",
      storageBucket: "petadventure-b73c8.firebase.storage.app",
      messagingSenderId: "590511399628",
      appId: "1:590511399628:web:400e68086ccfaba2e65869"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.fbase = { doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDocs, runTransaction, arrayUnion, deleteDoc, writeBatch, increment };
    console.log("üî• Firebase Initialized");
  </script>

  <!-- Load Tailwind -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  
  <style>@view-transition { navigation: auto; }</style>
  
  <!-- Custom Game Styles -->
  <style>
    :root {
        --bg-login: url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/Untitled%20design.png'); 
        --bg-game:  url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/Untitled%20design%20(1).png'); 
    }

    body { 
        box-sizing: border-box; margin: 0; padding: 0; 
        font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', cursive, sans-serif; 
        background: var(--bg-game) no-repeat center center fixed; 
        background-size: cover;
        height: 100vh; width: 100vw; overflow: hidden; 
        overscroll-behavior: none;
        user-select: none; -webkit-user-select: none; caret-color: transparent;   
    }

    input, textarea { user-select: text; -webkit-user-select: text; caret-color: auto; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    /* Login & Setup Screen */
    /* Update or Check this CSS block */
.login-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; /* Force full viewport width */
    height: 100vh; /* Force full viewport height */
    background: var(--bg-login) no-repeat center center fixed; 
    background-size: cover; 
    z-index: 5000; /* Increased Z-Index to be sure */
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow-y: auto; 
    padding: 20px; 
}
    .login-overlay.hidden { display: none; }
    .login-box { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.5); border-radius: 20px; padding: 30px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); text-align: center; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
    .login-title { font-size: clamp(24px, 5vw, 32px); color: #5a67d8; margin-bottom: 10px; font-weight: bold; }
    .setup-section { margin-bottom: 20px; text-align: left; border-bottom: 2px solid #edf2f7; padding-bottom: 15px; }
    .setup-label { display: block; font-size: 16px; font-weight: bold; color: #2d3748; margin-bottom: 8px; }
    .login-input { width: 100%; padding: 12px; font-size: 16px; border: 3px solid #e5e7eb; border-radius: 10px; font-family: inherit; margin-bottom: 10px; }
    
    /* Buttons */
    .login-btn, .submit-btn, .explore-btn, .btn-green { width: 100%; padding: 15px; background: #48bb78; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #2f855a; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; touch-action: manipulation; }
    .login-btn:active, .submit-btn:active, .explore-btn:active, .btn-green:active { transform: translateY(5px); box-shadow: none; }
    .login-btn:disabled, .submit-btn:disabled, .explore-btn:disabled { background: #cbd5e0; box-shadow: none; cursor: not-allowed; transform: none; }
    
    /* Layout */
    .game-container { max-width: 1000px; margin: 0 auto; padding: 10px; height: 100vh; display: flex; flex-direction: column; }
    .header { background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 8px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; z-index: 100; position: relative; }
    .tabs { display: flex; gap: 8px; margin-bottom: 5px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; z-index: 100; position: relative;}
    .tab { flex: 1; padding: 10px; background: rgba(255,255,255,0.6); border: none; border-radius: 12px; color: #2d3748; font-weight: bold; cursor: pointer; white-space: nowrap; text-align: center; font-size: 15px; transition: all 0.2s; min-width: 80px; backdrop-filter: blur(5px); }
    .tab.active { background: white; color: #5a67d8; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-2px); }
    .tab.adventure-tab { background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); color: white; display: none; } 
    .content { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); flex: 1; overflow-y: auto; min-height: 0; position: relative; }
    .screen { display: none; height: 100%; } .screen.active { display: block; }

    /* Study & Quiz */
    .quiz-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 800px; margin: 0 auto; padding-top: 10px; transition: box-shadow 0.3s; border-radius: 20px; padding: 20px;}
    .question-text { font-size: clamp(24px, 5vw, 36px); text-align: center; font-weight: bold; color: #2d3748; margin: 20px 0; line-height: 1.3; }
    .mcq-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-top: 20px; }
    .mcq-btn { background: white; border: 3px solid #e2e8f0; border-radius: 15px; padding: 20px 10px; font-size: 22px; font-weight: bold; color: #4a5568; cursor: pointer; transition: all 0.1s; box-shadow: 0 6px 0 #cbd5e0; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 80px; user-select: none; }
    .mcq-btn:active { transform: translateY(6px); box-shadow: none; background-color: #f7fafc; }
    
    /* Hub & Grids */
    .hub-grid { display: flex; flex-direction: column; gap: 20px; }
    @media(min-width: 768px) { .hub-grid { flex-direction: row; align-items: flex-start; } .hub-left { flex: 1; max-width: 350px; position: sticky; top: 0; } .hub-right { flex: 1.5; } }
    .pet-display { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
    
    /* Battle Screen */
    .battle-screen { display: none; background-color: #2d3748; background-size: cover; background-position: center bottom; background-repeat: no-repeat; border-radius: 15px; aspect-ratio: 16/9; width: 100%; max-height: 100%; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.6); }
    .battle-screen.active { display: block; height: 100%; width: 100%; position: relative; }
    .battle-arena { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
    .battler { position: absolute; text-align: center; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6)); width: 40%; max-width: 400px; transition: all 0.3s ease-out; }
    #player-container { bottom: 15%; left: 15%; z-index: 20; }
    #enemy-container { bottom: 15%; right: 12%; z-index: 20; transform: none; }
    .battler-visual { font-size: clamp(60px, 15vw, 140px); margin-bottom: 10px; position: relative; transition: transform 0.1s; }
    
    /* DAMAGE TEXT SYSTEM */
    .floating-text { position: absolute; top: 0; left: 50%; transform: translate(-50%, -50%); color: #fff; font-family: 'Arial Black', sans-serif; font-size: 40px; font-weight: 900; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 100; animation: floatUp 1s ease-out forwards; }
    .floating-text.heal { color: #48bb78; text-shadow: 2px 2px 0 #047857; }
    .floating-text.super { color: #48bb78; font-size: 60px; text-shadow: 3px 3px 0 #064e3b; z-index: 200; }
    .floating-text.weak { color: #a0aec0; font-size: 30px; text-shadow: 1px 1px 0 #2d3748; }
    .floating-text.crit { color: #ffeb3b; font-size: 50px; text-shadow: 3px 3px 0 #b91c1c; animation: critShake 0.3s; }

    @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 20% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -100px) scale(1); opacity: 0; } }
    @keyframes critShake { 0% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-55%, -55%) rotate(-10deg); } 75% { transform: translate(-45%, -45%) rotate(10deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }

    .hp-bar-container { background: rgba(0,0,0,0.7); border-radius: 15px; height: 15px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); max-width: 100%; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 5px; }
    .hp-bar { height: 100%; background: linear-gradient(180deg, #48bb78 0%, #2f855a 100%); transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); position: relative; z-index: 2; }
    .hp-bar-trail { position: absolute; top:0; left:0; height:100%; width:100%; background: white; z-index: 1; transition: width 0.8s ease-out 0.3s; }
    @keyframes attackLunge { 0% { transform: translateX(0) scale(1); } 50% { transform: translateX(60px) scale(1.1); } 100% { transform: translateX(0) scale(1); } }
    @keyframes damageShake { 0%, 100% { transform: translate(0, 0); filter: brightness(1); } 10%, 90% { transform: translate(-8px, -2px); filter: brightness(2) saturate(0); } 20%, 80% { transform: translate(6px, 4px); } 30%, 50%, 70% { transform: translate(-8px, -8px); } 40%, 60% { transform: translate(8px, 8px); } }
    .battler-visual.flipped-opponent { transform: none; }
    .battler-visual.flipped-opponent img, .battler-visual.flipped-opponent .emoji-wrapper { transform: scaleX(-1); display: inline-block; }
    .battle-ui-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: auto; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.4); padding: 10px; box-shadow: 0 -4px 30px rgba(0,0,0,0.1); z-index: 50; display: flex; flex-direction: column; }
    .battle-actions { display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 8px; width: 100%; }
    .battle-actions .action-btn { margin: 0; padding: 12px 2px; font-size: 13px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; flex: 1; min-width: 0; border-radius: 8px; }
    
    /* Battle Name Plates with Elements */
    .battle-name-plate { font-size: 14px; margin-top: 5px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .element-icon { font-size: 16px; filter: drop-shadow(0 0 2px white); }

    /* Common */
    .player-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .stats-container { display: flex; gap: 10px; align-items: center; }
    .logout-btn { padding: 6px 12px; background: #e53e3e; color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: auto; }
    .currency-display { background: #fef3c7; padding: 6px 12px; border-radius: 20px; font-weight: bold; color: #92400e; border: 2px solid #fcd34d; font-size: 14px; white-space: nowrap; }
    .stamina-display { background: #e0f2fe; padding: 6px 12px; border-radius: 20px; font-weight: bold; color: #0369a1; border: 2px solid #7dd3fc; font-size: 14px; white-space: nowrap; }
    .pet-visual { font-size: 150px; margin: 10px 0; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); position: relative; display: inline-block; min-width: 200px; min-height: 200px; }
    .pet-image { width: 350px; height: 350px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
    .blend-multiply { mix-blend-mode: multiply; }
    .battler-image { width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2)); }
    .pet-name { font-size: 20px; color: #2c5282; margin: 10px 0; font-weight: bold; }
    .rarity-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .rarity-common { background: #9ca3af; color: white; }
    .rarity-uncommon { background: #10b981; color: white; }
    .rarity-rare { background: #3b82f6; color: white; }
    .rarity-epic { background: #a855f7; color: white; }
    .rarity-legendary { background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.3); } }
    .projectile { position: fixed; width: 150px; height: 150px; font-size: 60px; pointer-events: none; z-index: 3000; display: flex; justify-content: center; align-items: center; filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8)); text-shadow: -15px 0 10px rgba(255, 255, 255, 0.8), -30px 0 15px rgba(255, 255, 255, 0.4); color: white; }
    .projectile img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px #fff); }
    .pet-stats { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
    .stat-box { background: white; padding: 8px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 70px; }
    .stat-label { font-size: 11px; color: #718096; margin-bottom: 3px; }
    .stat-value { font-size: 16px; color: #5a67d8; font-weight: bold; }
    .inventory-section, .evolution-info { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .inventory-item { display: inline-block; background: white; padding: 8px; margin: 4px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .action-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: transform 0.1s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); font-size: 14px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    .action-btn:active { transform: translateY(4px); box-shadow: none; }
    .action-btn.green { background: #48bb78; color: white; }
    .action-btn.red { background: #f56565; color: white; }
    .action-btn.blue { background: #4299e1; color: white; }
    .evolution-btn { margin-top: 10px; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 0 #d97706; }
    .evolution-btn:active { transform: translateY(4px); box-shadow: none; }
    .evolution-btn:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; transform: none; }
    .pet-collection { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
    .pet-card { background: #fff; padding: 8px; border-radius: 10px; text-align: center; cursor: pointer; border: 3px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .pet-card.active { border-color: #5a67d8; background: #ebf8ff; }
    .pet-card-visual { font-size: 30px; }
    .shop-section { margin-bottom: 25px; }
    .shop-section h2 { color: #5a67d8; border-bottom: 2px solid #5a67d8; margin-bottom: 12px; font-size: 20px; }
    .shop-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .shop-item { background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .shop-item-price { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 15px; font-weight: bold; display: inline-block; margin: 8px 0; font-size: 14px; }
    .buy-btn { width: 100%; padding: 8px; background: #5a67d8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 0 #434190; }
    .buy-btn:active { transform: translateY(3px); box-shadow: none; }
    .gacha-btn { background: linear-gradient(135deg, #a855f7, #6366f1); color: white; padding: 15px; border-radius: 15px; border: none; font-size: 20px; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 5px 0 #5b21b6; transition: all 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .gacha-btn:active { transform: translateY(5px); box-shadow: none; }
    .gacha-results { display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    .gacha-card { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.5s ease-out; min-width: 120px; }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
    .wilds-container { text-align: center; padding: 20px 10px; }
    .rpg-container { width: 100%; max-width: 500px; margin: 0 auto; position: relative; border: 4px solid #2d3748; border-radius: 10px; overflow: hidden; background: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    canvas#rpg-canvas { display: block; width: 100%; height: auto; background: #81c784; image-rendering: pixelated; touch-action: none; }
    .d-pad { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px; gap: 10px; justify-content: center; margin-top: 20px; touch-action: manipulation; }
    .d-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.7); border: 2px solid #2d3748; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; color: #2d3748; -webkit-tap-highlight-color: transparent; }
    .d-btn:active { background: white; transform: scale(0.9); }
    .d-up { grid-column: 2; grid-row: 1; }
    .d-left { grid-column: 1; grid-row: 2; }
    .d-down { grid-column: 2; grid-row: 2; }
    .d-right { grid-column: 3; grid-row: 2; }
    .controls-hint { text-align: center; color: #4a5568; margin-top: 10px; font-size: 13px; font-style: italic; }
    .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); font-size: 16px; font-weight: bold; z-index: 3000; animation: slideIn 0.3s ease-out; max-width: 90%; }
    .toast.success { border-left: 5px solid #48bb78; color: #276749; }
    .toast.error { border-left: 5px solid #f56565; color: #742a2a; }
    .toast.info { border-left: 5px solid #4299e1; color: #2c5282; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2500; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .confirm-modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
    .confirm-modal h2 { color: #f56565; margin-bottom: 15px; font-size: 24px; }
    .confirm-modal p { color: #374151; font-size: 16px; margin-bottom: 15px; line-height: 1.6; }
    .confirm-modal .pet-preview { font-size: 60px; margin: 15px 0; }
    .confirm-reward { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 10px; font-weight: bold; margin: 15px 0; }
    .confirm-warning { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: bold; margin: 15px 0; }
    .confirm-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
    .confirm-btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-family: inherit; }
    .confirm-btn.yes { background: #f56565; color: white; }
    .confirm-btn.yes:hover { background: #e53e3e; transform: scale(1.05); }
    .confirm-btn.no { background: #5a67d8; color: white; }
    .confirm-btn.no:hover { background: #4c51bf; transform: scale(1.05); }
    .move-replace-list { display: grid; gap: 10px; margin: 20px 0; }
    .move-replace-btn { background: white; border: 2px solid #cbd5e0; padding: 15px; border-radius: 10px; text-align: left; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-weight: bold; transition: all 0.2s; }
    .move-replace-btn:hover { border-color: #f56565; background: #fff5f5; color: #c53030; }
    .move-replace-btn span { pointer-events: none; }
    .student-list-item { background: white; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .student-list-item:last-child { border-bottom: none; }
    .student-info { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
    .student-info strong { color: #2d3748; font-size: 16px; }
    .student-info span { color: #718096; font-size: 12px; margin-left: 5px; }
    .delete-confirm-modal .confirm-buttons { display: flex; justify-content: space-between; gap: 10px; }
    .delete-confirm-modal .confirm-buttons .confirm-btn.yes { background: #e53e3e; }
    .grade-group { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; background: #f7fafc; overflow: hidden; }
    .grade-summary { display: flex; justify-content: space-between; padding: 12px 15px; font-weight: bold; font-size: 16px; background: #e9eef2; cursor: pointer; }
    .grade-student-list { background: white; }
    /* New Monitoring Badge Style */
    .assigned-topic-badge { display: inline-block; background: #e0f2fe; color: #0284c7; font-size: 11px; padding: 3px 8px; border-radius: 12px; margin: 2px; border: 1px solid #7dd3fc; }

    #evolution-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; transition: opacity 0.5s; }
    .evo-message { font-size: clamp(20px, 5vw, 40px); font-weight: bold; margin-bottom: 40px; opacity: 0; }
    .evo-pet-visual { font-size: 180px; min-width: 200px; min-height: 200px; position: relative; display: inline-block; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
    .evo-pet-image { width: 200px; height: 200px; object-fit: contain; }
    @keyframes evolutionFlash { 0% { opacity: 1; transform: scale(1); filter: brightness(1); } 3% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 7% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 11% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 15% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 18% { opacity: 0.5; transform: scale(1.05); filter: brightness(2) drop-shadow(0 0 20px #ffeb3b); } 20% { opacity: 1; transform: scale(1); filter: brightness(1.5); } 30% { opacity: 0; transform: scale(0.5); filter: brightness(5) drop-shadow(0 0 50px #ffea00); } 40% { opacity: 0; transform: scale(0); } 60% { opacity: 1; transform: scale(1.3); filter: brightness(3) drop-shadow(0 0 30px #ffffff); } 100% { opacity: 1; transform: scale(1); filter: brightness(1); } }
    .flash-and-scale { animation: evolutionFlash 1.5s ease-in-out forwards; }
    @keyframes subtleFloat { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(-3px) scale(1.01); } 100% { transform: translateY(0) scale(1); } }
    .pet-visual, .battler-visual { animation: subtleFloat 4s ease-in-out infinite; }
    
    #gacha-cinematic-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e003a 0%, #0d011a 100%); z-index: 5500; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; overflow: hidden; }
    .summoning-circle { width: clamp(200px, 60vw, 400px); height: clamp(200px, 60vw, 400px); border-radius: 50%; border: 5px solid #8e24aa; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 40px #a855f7, inset 0 0 30px #673ab7; animation: gachaCharge 1.5s linear infinite; transform-origin: center; transition: opacity 0.5s; will-change: transform; }
    .summoning-core { width: 100px; height: 100px; background: radial-gradient(circle, #ffdb00 0%, #e65100 80%); border-radius: 50%; box-shadow: 0 0 60px #ffdb00; opacity: 0; transition: all 0.2s; }
    @keyframes gachaCharge { 0% { transform: rotate(0deg); opacity: 0.8; } 50% { opacity: 1; } 100% { transform: rotate(360deg); opacity: 0.8; } }
    @keyframes gachaFlash { 0% { background: rgba(255, 255, 255, 0); } 50% { background: rgba(255, 255, 255, 1); transform: scale(5); } 100% { background: rgba(255, 255, 255, 0); } }
    .flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 6000; pointer-events: none; }
    .gacha-pet-reveal { position: absolute; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(200, 220, 255, 0) 70%); border-radius: 50%; opacity: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .gacha-pet-reveal.rare { box-shadow: 0 0 30px 10px rgba(59, 130, 246, 0.6); }
    .gacha-pet-reveal.epic { box-shadow: 0 0 30px 10px rgba(168, 85, 247, 0.8); }
    .gacha-pet-reveal.legendary { box-shadow: 0 0 40px 15px rgba(245, 158, 11, 0.9); }
    .gacha-reveal-visual { width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 4px 15px rgba(0,0,0,0.5)); }
    @keyframes petPopIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    
    @keyframes eggShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
    .egg-shaking { animation: eggShake 0.5s infinite; }
    .hatch-light { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
    @keyframes flashWhite { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    
    /* Streak Calendar */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
    .calendar-day { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; text-align: center; opacity: 0.5; }
    .calendar-day.active { background: #ebf8ff; border-color: #4299e1; opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .calendar-day.claimed { background: #f0fff4; border-color: #48bb78; opacity: 1; }
    
    /* Quest/Dialog */
    .dialog-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background: rgba(255,255,255,0.95); border-radius: 15px; border: 3px solid #2d3748; padding: 20px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 16px; color: #2d3748; display: none; }
    .dialog-name { font-weight: bold; color: #5a67d8; margin-bottom: 5px; text-transform: uppercase; font-size: 14px; }
    .burst-glow { box-shadow: 0 0 15px #f6e05e, inset 0 0 10px #d69e2e; border-color: #ecc94b !important; }

    /* Adventure Card Grid */
    .adventure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 10px; }
    .adventure-card { background: white; border: 2px solid #ed8936; border-radius: 15px; overflow: hidden; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .adventure-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(237, 137, 54, 0.3); }
    .adventure-header { background: #f6ad55; padding: 10px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
    .adventure-body { padding: 15px; }
    .adventure-desc { font-size: 13px; color: #4a5568; margin-bottom: 10px; }
    .adventure-status { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    .status-active { background: #c6f6d5; color: #276749; }
    .status-coming { background: #e2e8f0; color: #718096; }

    /* Feature 2: Swap Card */
    .swap-card { 
        background: white; 
        border: 2px solid #e2e8f0; 
        border-radius: 12px; 
        padding: 10px; 
        cursor: pointer; 
        transition: all 0.2s; 
        opacity: 1; 
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
    }
    .swap-card:hover { border-color: #4299e1; transform: translateX(5px); }
    .swap-card.active-pet { border-color: #48bb78; background: #f0fff4; pointer-events: none; border-width: 3px; }
    .swap-card.fainted { opacity: 0.6; filter: grayscale(1); background: #f7fafc; cursor: not-allowed; }
    .swap-card.fainted::after { content: "FAINTED"; position: absolute; top: 50%; right: 10px; transform: translateY(-50%) rotate(-10deg); font-weight: 900; color: #e53e3e; border: 2px solid #e53e3e; padding: 2px 5px; font-size: 10px; border-radius: 4px; }

    /* MINI HP BAR FOR MENU */
    .mini-hp-bg { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .mini-hp-fill { height: 100%; background: #48bb78; transition: width 0.3s; }
    .mini-hp-fill.low { background: #f56565; }
    .mini-hp-fill.mid { background: #ecc94b; }

    /* VISUAL POLISH: Animated Bars */
    .xp-bar-container, .hatch-bar-container {
        width: 100%; height: 12px; background: #2d3748; border-radius: 6px; overflow: hidden; margin-top: 5px; border: 1px solid rgba(255,255,255,0.2);
    }

    .xp-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 0 10px #667eea;
        transition: width 0.5s ease;
    }

    .hatch-bar {
        height: 100%;
        background: repeating-linear-gradient(
          45deg,
          #f6ad55,
          #f6ad55 10px,
          #ed8936 10px,
          #ed8936 20px
        );
        background-size: 200% 200%;
        animation: barStripes 2s linear infinite;
        transition: width 0.5s ease;
    }
    @keyframes barStripes { 100% { background-position: 100% 100%; } }

    /* RAID BOSS UI */
    .raid-container { display:flex; flex-direction: column; height: 100%; }
    .raid-split { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; flex-grow: 1; height: 0; min-height: 0; }
    .leaderboard-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; overflow-y: auto; color: white; font-size: 12px; }
    .lb-row { display: flex; justify-content: space-between; padding: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .lb-row.me { color: #f6e05e; font-weight: bold; background: rgba(255,255,255,0.1); }

    /* TYPE EFFECTIVENESS INDICATORS */
    .type-indicator { font-size: 16px; margin-left: 5px; font-weight: bold; }
    .eff-up { color: #48bb78; } 
    .eff-down { color: #f56565; }

    /* --- NEW PRO RPG STYLES --- */
    /* Burst Mode: Makes buttons glow when you have a Math Streak */
    .burst-ready {
        box-shadow: 0 0 15px #f6ad55, inset 0 0 10px #f6e05e;
        border: 2px solid #ecc94b !important;
        animation: pulseGold 1s infinite alternate;
    }

    @keyframes pulseGold {
        from { box-shadow: 0 0 10px #f6ad55; }
        to { box-shadow: 0 0 25px #ed8936, 0 0 10px white; }
    }

    /* Combat Log: Professional scrolling text */
    .battle-log-container {
        display: none;
        width: 100%;
        height: 60px; /* Compact height */
        background: rgba(0, 0, 0, 0.6);
        border-radius: 8px;
        margin-bottom: 8px;
        padding: 5px 10px;
        overflow-y: auto;
        font-size: 12px;
        color: white;
        font-family: monospace;
        display: flex;
        flex-direction: column-reverse; /* Newest logs at bottom */
        border: 1px solid rgba(255,255,255,0.3);
    }

    .log-entry { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .log-entry.player { color: #68d391; } /* Green for player */
    .log-entry.enemy { color: #fc8181; }  /* Red for enemy */
    .log-entry.crit { color: #f6e05e; font-weight: bold; } /* Gold for crit */
    
    /* --- NEW REWARD ANIMATIONS --- */
.confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; overflow: hidden; }
.confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; }

@keyframes fall {
  to { transform: translateY(100vh) rotate(720deg); }
}

.reward-card-glow {
  background: radial-gradient(circle, #fff 0%, #f6e05e 40%, #d69e2e 100%);
  padding: 30px; border-radius: 20px;
  box-shadow: 0 0 50px #f6e05e, 0 0 100px rgba(255,215,0,0.5);
  animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  text-align: center;
  position: relative;
  border: 4px solid #fff;
}

.reward-shine {
  position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
  transform: rotate(45deg);
  animation: shineMove 3s infinite linear;
  pointer-events: none;
}

@keyframes shineMove { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
    
  </style>
  </head>
 <body><!-- Login Screen -->
  <div class="login-overlay" id="login-overlay">
   <div class="login-box">
    <div class="login-icon" style="font-size: 40px; margin-bottom: 10px;">üè´</div>
    <h1 class="login-title">Math Pet Adventure</h1>
    <p style="color: #4a5568; margin-bottom: 20px; font-size: 14px; font-weight:bold;">Customize your learning journey!</p>
    
    <!-- STUDENT LOGIN FORM -->
    <form id="setup-form">
     <div class="setup-section"><label class="setup-label">1. Username</label><input type="text" id="student-name" class="login-input" placeholder="Enter Username" required></div>
     <div class="setup-section"><label class="setup-label">2. Password</label><input type="password" id="student-pass" class="login-input" placeholder="Enter Password" required></div>
     <button type="submit" class="login-btn">Start Adventure! üöÄ</button>
    </form>

    <!-- SECRET TRIGGER -->
    <div style="margin-top: 30px; font-size: 10px; color: #4a5568; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;" onclick="toggleTeacherLogin()">raymondanacaya</div>
    
    <!-- TEACHER/ADMIN LOGIN PANEL (Clean Version) -->
    <div id="teacher-login-panel" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
        <h3 style="color:#d69e2e; font-weight:bold; margin-bottom:10px;">Staff Access</h3>
        <input type="text" id="teacher-username" class="login-input" placeholder="Username (e.g. admin)">
        <input type="password" id="teacher-pass" class="login-input" placeholder="Password">
        <button class="action-btn blue" onclick="loginTeacher()">Log In</button>
    </div>
   </div>
  </div>
 <!-- ADMIN DASHBOARD (Hidden, High Security) -->
<div id="admin-dashboard-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#2d3748; z-index:2200; padding:40px; overflow-y:auto; color:white;">
    <div style="max-width:1000px; margin:0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #4a5568; padding-bottom:20px;">
            <h1 style="font-size:32px; font-weight:bold; color:#f6ad55;">üõ°Ô∏è HEADMASTER ADMIN</h1>
            <button class="action-btn red" style="width:auto;" onclick="location.reload()">Log Out</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
            
            <!-- COLUMN 1: MANAGE TEACHERS -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #4a5568;">
                <h2 style="color:#63b3ed; border-bottom:1px solid #4a5568; padding-bottom:10px; margin-bottom:15px;">üë®‚Äçüè´ Create Teacher Account</h2>
                <input type="text" id="admin-new-teacher-user" class="login-input" placeholder="Teacher Username" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="password" id="admin-new-teacher-pass" class="login-input" placeholder="Password" style="background:#4a5568; color:white; border-color:#718096;">
                <button class="action-btn blue" onclick="adminCreateTeacher()">Create Account</button>
                
                <h3 style="margin-top:20px; color:#cbd5e0;">Existing Teachers</h3>
                <div id="admin-teacher-list" style="max-height:200px; overflow-y:auto; font-size:14px; color:#a0aec0;">Loading...</div>
            </div>

            <!-- COLUMN 2: SUMMON BOSS (Fixed: Added Image Input) -->
            <div style="background:rgba(0,0,0,0.3); padding:20px; border-radius:15px; border:1px solid #4a5568;">
                <h2 style="color:#f56565; border-bottom:1px solid #4a5568; padding-bottom:10px; margin-bottom:15px;">‚ò†Ô∏è Summon World Boss</h2>
                
                <input type="text" id="admin-boss-name" class="login-input" placeholder="Boss Name (e.g. Titan)" value="Titan" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="number" id="admin-boss-hp" class="login-input" placeholder="HP" value="50000" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="number" id="admin-boss-atk" class="login-input" placeholder="Attack" value="20" style="background:#4a5568; color:white; border-color:#718096;">
                
                <!-- MISSING INPUTS ADDED HERE -->
                <input type="text" id="admin-boss-img" class="login-input" placeholder="Image URL (e.g. https://...)" style="background:#4a5568; color:white; border-color:#718096;">
                <input type="text" id="admin-boss-reward" class="login-input" placeholder="Reward JSON URL" value="events/boss_reward.json" style="background:#4a5568; color:white; border-color:#718096;">
                
                <div style="margin:15px 0; background:#1a202c; padding:10px; border-radius:10px;">
                    <label style="font-weight:bold; color:#f6ad55; display:block; margin-bottom:5px;">Target:</label>
                    <label style="display:block; margin-bottom:5px;">
                        <input type="radio" name="boss-target" value="global" checked onchange="toggleTeacherCheckboxes(false)"> 
                        üåç Global (All Students)
                    </label>
                    <label style="display:block;">
                        <input type="radio" name="boss-target" value="specific" onchange="toggleTeacherCheckboxes(true)"> 
                        üéØ Specific Classes
                    </label>
                </div>

                <div id="admin-boss-teacher-select" style="display:none; margin-bottom:15px; max-height:100px; overflow-y:auto; background:#1a202c; padding:5px;">
                    <!-- Teacher checkboxes injected here -->
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="action-btn red" onclick="adminSummonBoss()">SUMMON BOSS</button>
                    <button class="action-btn" style="background:#718096;" onclick="adminEndRaid()">üõë END RAID</button>
                </div>
            </div>
            </div>
    </div>
</div>
   
   <!-- TEACHER DASHBOARD (Fixed & Reorganized) -->
   <!-- TEACHER DASHBOARD (Clean & Verified) -->
   <div id="teacher-dashboard-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2100; padding:40px; overflow-y:auto;">
       <div style="max-width:1000px; margin:0 auto;">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
               <h1 style="font-size:32px; font-weight:bold; color:#5a67d8;">üë©‚Äçüè´ Teacher Dashboard</h1>
               <button class="action-btn red" style="width:auto; padding:10px 20px;" onclick="location.reload()">Log Out</button>
           </div>
           
           <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:40px;">
               <!-- LEFT COLUMN: Controls -->
               <div>
                   <!-- 1. Create Student -->
                   <div style="background:#f7fafc; padding:25px; border-radius:15px; border:2px solid #e2e8f0; margin-bottom: 20px;">
                       <h2 style="font-size:20px; font-weight:bold; margin-bottom:15px;">Create Student Account</h2>
                       <input type="text" id="new-student-user" class="login-input" placeholder="Username">
                       <input type="password" id="new-student-pass" class="login-input" placeholder="Password">
                       <label style="display:block; font-weight:bold; margin-top:10px;">Assign Grade:</label>
                       <select id="new-student-grade" class="login-input">
                           <option value="K">Kindergarten</option>
                           <option value="1">Grade 1</option>
                           <option value="2">Grade 2</option>
                           <option value="3">Grade 3</option>
                           <option value="4">Grade 4</option>
                           <option value="5">Grade 5</option>
                           <option value="6">Grade 6</option>
                       </select>
                       <button class="action-btn green" onclick="createStudentAccount()">Create Account</button>
                   </div>

                   <!-- 2. CLASS RAID CONTROLS -->
                   <div style="background:#2d3748; padding:20px; border-radius:15px; border:2px solid #4a5568; margin-bottom: 20px; color: white;">
                        <h2 style="color:#f6ad55; font-weight:bold; margin-bottom:10px;">‚ò†Ô∏è Class Raid Boss</h2>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            
                            <!-- Updated Inputs with Dark Background and White Text -->
                            <input type="text" id="t-boss-name" class="login-input" placeholder="Boss Name" value="Titan" 
                                   style="background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="number" id="t-boss-hp" class="login-input" placeholder="HP" value="10000" 
                                   style="background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="number" id="t-boss-atk" class="login-input" placeholder="Atk" value="15" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="text" id="t-boss-img" class="login-input" placeholder="Image URL" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                                   
                            <input type="text" id="t-boss-reward-url" class="login-input" placeholder="Reward JSON" value="events/boss_reward.json" 
                                   style="grid-column: span 2; background:#4a5568; color:white; border-color:#718096;">
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="action-btn red" onclick="teacherSummonRaid()">SUMMON</button>
                            <button class="action-btn" style="background:#718096;" onclick="teacherEndRaid()">üõë STOP</button>
                        </div>
                   </div>
               </div>

               <!-- RIGHT COLUMN: Student List -->
               <div style="background:#fff; border:2px solid #e2e8f0; border-radius:15px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
                   <div style="background:#f7fafc; padding:15px; border-bottom:2px solid #e2e8f0; font-weight:bold; color:#4a5568; display:flex; justify-content:space-between; align-items:center;">
                       <label style="display:flex; align-items:center; cursor:pointer;">
                           <input type="checkbox" id="select-all-students" onchange="toggleAllStudents(this.checked)" style="margin-right:8px; transform:scale(1.2);">
                           <span>My Students</span>
                       </label>
                       <div>
                           <button class="action-btn blue" style="width:auto; padding:5px 10px; font-size:12px; margin-top:-2px;" onclick="loadStudentList()">Refresh</button>
                           <button class="action-btn" style="width:auto; padding:5px 10px; font-size:12px; margin-top:-2px; background:#d69e2e; margin-left:5px;" onclick="claimLegacyStudents()">‚ö†Ô∏è Claim Old</button>
                       </div>
                   </div>
                   <div id="bulk-action-bar" style="background:#ebf8ff; padding:10px 15px; border-bottom:1px solid #cceeff; display:none; justify-content:space-between; align-items:center;">
                       <span id="bulk-selected-count" style="font-weight:bold; color:#5a67d8;">0 Selected</span>
                       <button class="action-btn green" style="width:auto; padding:5px 10px; font-size:12px;" onclick="openBulkTopicManager()">Assign Topics</button>
                   </div>
                   <div id="student-list-container" style="flex:1; overflow-y: auto;">
                       <div style="padding:20px; text-align:center; color:gray;">Loading list...</div>
                   </div>
               </div>
           </div>
       </div>

       <!-- Modals included inside dashboard -->
       <div id="topic-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#5a67d8; margin-bottom:10px;">Manage Student</h2>
               <p id="tm-student-name" style="font-weight:bold; color:#2d3748; margin-bottom:10px;">Student: -</p>
               <div style="margin-bottom:15px; background:#e0f2fe; padding:10px; border-radius:8px; border:1px solid #7dd3fc;">
                   <label style="font-weight:bold; color:#0369a1; font-size:12px; display:block; margin-bottom:5px;">Currently Assigned Lessons:</label>
                   <div id="tm-current-assignments" style="display:flex; flex-wrap:wrap; max-height:80px; overflow-y:auto;"><span style="color:#64748b; font-size:12px;">Loading...</span></div>
               </div>
               <div style="margin-bottom:15px; background:#f7fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                   <label style="font-weight:bold; color:#4a5568; font-size:14px;">Select Grade Source:</label>
                   <select id="tm-grade-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="refreshTopicManagerUI()">
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
               </div>
               <div id="tm-topic-list" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:20px;">Loading...</div>
               <div style="display:flex; gap:10px;">
                   <button class="action-btn blue" onclick="saveStudentTopics()">Save Changes</button>
                   <button class="action-btn red" onclick="document.getElementById('topic-manager-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <div id="bulk-assign-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#48bb78; margin-bottom:10px;">Bulk Assign</h2>
               <p id="bulk-student-count-display" style="margin-bottom:15px;">...</p>
               <select id="bulk-grade-select" style="width:100%; padding:8px; margin-bottom:10px;" onchange="refreshBulkTopicUI()">
                   <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
               </select>
               <div id="bulk-topic-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:20px;">Loading...</div>
               <div style="display:flex; gap:10px;">
                   <button class="action-btn green" onclick="saveBulkStudentTopics()">Apply</button>
                   <button class="action-btn red" onclick="document.getElementById('bulk-assign-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <div class="modal-overlay" id="teacher-delete-modal" style="z-index:2300;">
           <div class="confirm-modal delete-confirm-modal">
               <div style="font-size: 60px;">üóëÔ∏è</div>
               <h2 style="color: #e53e3e;">Delete Account?</h2>
               <p>Delete <strong id="delete-student-name-display">STUDENT</strong>?</p>
               <div class="confirm-buttons">
                   <button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> 
                   <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Delete</button>
               </div>
           </div>
       </div>
   </div>
       <!-- Modals included inside dashboard -->
       <div id="topic-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#5a67d8; margin-bottom:10px;">Manage Student</h2>
               <p id="tm-student-name" style="font-weight:bold; color:#2d3748; margin-bottom:10px;">Student: -</p>
               <div style="margin-bottom:15px; background:#e0f2fe; padding:10px; border-radius:8px; border:1px solid #7dd3fc;">
                   <label style="font-weight:bold; color:#0369a1; font-size:12px; display:block; margin-bottom:5px;">Currently Assigned Lessons:</label>
                   <div id="tm-current-assignments" style="display:flex; flex-wrap:wrap; max-height:80px; overflow-y:auto;"><span style="color:#64748b; font-size:12px;">Loading...</span></div>
               </div>
               <div style="margin-bottom:15px; background:#f7fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                   <label style="font-weight:bold; color:#4a5568; font-size:14px;">Select Grade Source:</label>
                   <select id="tm-grade-select" style="width:100%; padding:8px; margin-top:5px; border:1px solid #cbd5e0; border-radius:5px;" onchange="refreshTopicManagerUI()">
                       <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                   </select>
               </div>
               <div id="tm-topic-list" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:20px;">Loading...</div>
               <div style="display:flex; gap:10px;">
                   <button class="action-btn blue" onclick="saveStudentTopics()">Save Changes</button>
                   <button class="action-btn red" onclick="document.getElementById('topic-manager-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <div id="bulk-assign-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2200;">
           <div style="background:white; padding:30px; border-radius:15px; width:500px; max-width:90%;">
               <h2 style="font-size:22px; font-weight:bold; color:#48bb78; margin-bottom:10px;">Bulk Assign</h2>
               <p id="bulk-student-count-display" style="margin-bottom:15px;">...</p>
               <select id="bulk-grade-select" style="width:100%; padding:8px; margin-bottom:10px;" onchange="refreshBulkTopicUI()">
                   <option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
               </select>
               <div id="bulk-topic-list" style="max-height:300px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:20px;">Loading...</div>
               <div style="display:flex; gap:10px;">
                   <button class="action-btn green" onclick="saveBulkStudentTopics()">Apply</button>
                   <button class="action-btn red" onclick="document.getElementById('bulk-assign-modal').style.display='none'">Cancel</button>
               </div>
           </div>
       </div>

       <div class="modal-overlay" id="teacher-delete-modal" style="z-index:2300;">
           <div class="confirm-modal delete-confirm-modal">
               <div style="font-size: 60px;">üóëÔ∏è</div>
               <h2 style="color: #e53e3e;">Delete Account?</h2>
               <p>Delete <strong id="delete-student-name-display">STUDENT</strong>?</p>
               <div class="confirm-buttons">
                   <button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> 
                   <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Delete</button>
               </div>
           </div>
       </div>
  </div><!-- Main Game -->
  
  <!-- We add an ID and force it to be hidden initially -->
<div class="game-container" id="main-game-ui" style="display: none;">
   <header class="header">
    <div class="player-info"><span style="font-size: 24px; margin-right: 5px;">üë§</span><div><div style="font-weight: bold; font-size: 16px;" id="display-name">Player</div><div style="font-size: 12px; color: #718096;" id="display-grade">Grade: -</div></div><button class="logout-btn" onclick="logout()">Logout</button></div>
    <div class="stats-container"><button id="mute-btn" onclick="toggleAudio()" style="background:none; border:none; font-size:24px; cursor:pointer;" title="Mute/Unmute">üîä</button><div class="stamina-display">‚ö° <span id="stamina-display">100</span>/100</div><div class="currency-display">üß† <span id="bp-display">0</span> BP</div></div>
   </header>
   <nav class="tabs">
       <button class="tab active" data-tab="study" onclick="switchTab('study')">üìö Study</button> 
       <button class="tab" data-tab="hub" onclick="switchTab('hub')">üè† Pet Hub</button> 
       <button class="tab" data-tab="shop" onclick="switchTab('shop')">üõí Shop</button> 
       <button class="tab" data-tab="wilds" onclick="switchTab('wilds')">üå≤ Wilds</button>
       <button class="tab adventure-tab" data-tab="adventure" onclick="switchTab('adventure')">üåü Adventure</button>
   </nav>
   <main class="content">
    <section id="screen-study" class="screen active">
     <div class="quiz-container">
      <div style="color: #718096; margin-bottom: 10px; font-size: 14px;">Solve to earn Brain Points!</div>
      <div id="question-visual-container" class="my-4 mx-auto" style="max-width: 90%; height: auto; display: flex; justify-content: center;"></div>
      <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;"><div class="question-text" id="question-text" style="margin: 0;">Loading question...</div><button id="tts-speaker-btn" onclick="readQuestionAloud()" class="bg-indigo-500 text-white p-2 rounded-full shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150" style="width: 40px; height: 40px; line-height: 1;">üîä</button></div>
      <div id="input-mode-container"><input type="number" id="answer-input" class="answer-input" placeholder="?"> <br> <button class="submit-btn" id="check-btn" style="margin-top: 20px;">Check Answer</button></div>
      <div id="mcq-mode-container" class="mcq-options" style="display:none"></div>
      <div id="feedback" class="feedback"></div>
     </div>
    </section>
    <section id="screen-hub" class="screen"><div id="hub-content"></div></section>
    <section id="screen-shop" class="screen"><div id="shop-content"></div></section>
    <section id="screen-wilds" class="screen">
     <div class="wilds-container" id="wilds-menu">
       <div style="font-size: 60px; margin-bottom: 20px;">üå≤üåæüå≤</div>
       <h2 class="section-title">The Wild Grass</h2>
       <p style="margin-bottom: 20px;">Explore to find wild monsters and items!</p>
       <button class="explore-btn" onclick="startExploration()">Explore (Requires Pet)</button>
       <div style="margin-top:20px; border-top: 1px solid #eee; padding-top:20px;">
           <h3 style="color:#d69e2e;">‚öîÔ∏è Multiplayer Arena</h3>
           <p style="font-size:13px; margin-bottom:10px;">Challenge a classmate! (Cost: 100 BP)</p>
           <button class="action-btn blue" onclick="showMultiplayerMenu()">Create / Join Room</button>
           <div style="margin-top: 15px;">
               <button class="action-btn red" onclick="joinRaid()">‚ò†Ô∏è World Boss Raid (Live)</button>
           </div>
       </div>
     </div>
     <div id="multiplayer-menu" style="display:none; text-align:center; padding-top:10px;">
         <h2 style="margin-bottom:20px;">‚öîÔ∏è PVP Arena Lobby</h2>
         <div style="background:#f0f9ff; padding:20px; border-radius:15px; margin-bottom:20px;"><h3>Create Room</h3><p style="font-size:12px; color:#666;">Generate a code for your friend.</p><button class="action-btn green" onclick="createPvPRoom()">Create Room (100 BP)</button></div>
         <div style="background:#fff5f5; padding:20px; border-radius:15px;"><h3>Join Room</h3><p style="font-size:12px; color:#666;">Enter your friend's code.</p><input type="text" id="room-code-input" placeholder="1234" style="padding:10px; border-radius:5px; border:1px solid #ccc; width:100px; text-align:center; font-size:20px; margin:10px 0;"><button class="action-btn blue" onclick="joinPvPRoom()">Join Room</button></div>
         <button class="action-btn red" style="margin-top:20px;" onclick="document.getElementById('multiplayer-menu').style.display='none'; document.getElementById('wilds-menu').style.display='block';">Back</button>
     </div>
     <div id="pvp-lobby-screen" style="display:none; text-align:center; padding-top:40px;">
         <h2 id="pvp-status-msg" style="font-size:24px; margin-bottom:10px; color:#2d3748;">Waiting...</h2>
         <div style="font-size:60px; margin:20px 0; letter-spacing:10px; font-family:monospace; color:#5a67d8;" id="display-room-code">----</div>
         <p id="pvp-host-status"></p>
         <p id="pvp-guest-status"></p>
         <button id="pvp-start-btn" class="action-btn green" style="display:none; width:250px; margin:20px auto;" onclick="startPvPBattle()">START BATTLE! ‚öîÔ∏è</button>
         <button class="action-btn red" style="width:200px; margin:20px auto;" onclick="leavePvPRoom()">Cancel</button>
     </div>
     
     <!-- UPDATED RPG WRAPPER -->
     <div id="rpg-wrapper" style="display:none; text-align:center; padding-top:10px;">
        <div style="background: rgba(0,0,0,0.8); color: white; padding: 5px; border-radius: 8px; font-size: 12px; margin-bottom: 5px; display:flex; justify-content:space-between; align-items:center;">
            <span id="wild-hp-display">HP: --/--</span>
            <span>
                <button class="action-btn green" style="width:auto; padding: 4px 8px; font-size:10px; margin:0;" onclick="quickUseItem('health_potion')">üíä Heal</button>
                <button class="action-btn blue" style="width:auto; padding: 4px 8px; font-size:10px; margin:0;" onclick="quickUseItem('stamina_potion')">‚ö° Energy</button>
            </span>
        </div>
         <div class="rpg-container"><canvas id="rpg-canvas" width="480" height="400"></canvas></div>
         <div class="d-pad"><div class="d-btn d-up" onclick="handleDPad('ArrowUp')">‚¨ÜÔ∏è</div><div class="d-btn d-left" onclick="handleDPad('ArrowLeft')">‚¨ÖÔ∏è</div><div class="d-btn d-down" onclick="handleDPad('ArrowDown')">‚¨áÔ∏è</div><div class="d-btn d-right" onclick="handleDPad('ArrowRight')">‚û°Ô∏è</div></div>
         <div class="controls-hint">Swipe on the map or use the buttons!</div>
         <button class="action-btn red" style="width:100%; max-width: 200px; margin-top:20px;" onclick="stopExploration()">Stop Exploring</button>
     </div>
     
     <div id="battle-ui" class="battle-screen">
      <div class="battle-arena">
       <div class="battler" id="player-container">
        <div id="battle-player-visual" class="battler-visual">ü•ö</div>
        <div class="hp-bar-container">
            <div id="player-hp-trail" class="hp-bar-trail" style="width: 100%;"></div>
            <div id="player-hp-bar" class="hp-bar" style="width: 100%;"></div>
        </div>
        <div id="player-battle-name" class="battle-name-plate">Player</div>
        <div id="player-hp-text" style="font-size: 14px; margin-top: 2px; font-weight: bold; color:white; text-shadow:1px 1px 2px black;">100/100</div>
       </div>
       
       <div class="battler" id="enemy-container">
        <div id="battle-enemy-visual" class="battler-visual">üëæ</div>
        <div class="hp-bar-container">
            <div id="enemy-hp-trail" class="hp-bar-trail" style="width: 100%;"></div>
            <div id="enemy-hp-bar" class="hp-bar" style="width: 100%;"></div>
        </div>
        <div id="enemy-name" class="battle-name-plate">Enemy</div>
       </div>
      </div>
      
      <div class="battle-ui-panel">
          <div id="battle-actions" class="battle-actions"></div>
      </div>
     </div>
    </section>

    <!-- NEW RAID SCREEN -->
    <section id="screen-raid" class="screen">
        <div id="raid-lobby" style="text-align:center; padding-top: 50px;">
            <h1 style="font-size: 40px; color:#e53e3e;">‚ò†Ô∏è WORLD RAID</h1>
            <p>Join the class to defeat the Titan!</p>
            <button class="action-btn red" style="width: 200px; font-size: 20px;" onclick="joinRaid()">Enter Raid (1 BP)</button>
        </div>

        <div id="raid-arena" style="display:none; height:100%; flex-direction:column;">
            <div class="raid-container">
                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:10px; border-bottom:1px solid #ccc;">
                    <div style="font-weight:bold; color:#e53e3e;">HP: <span id="raid-boss-hp-text">Loading...</span></div>
                    <button class="action-btn" style="width:auto; padding:5px 10px; font-size:12px;" onclick="exitRaid()">Exit</button>
                </div>
                
                <!-- Main Content Split -->
                <div class="raid-split">
                    <!-- Left: Battle Area -->
                    <div style="position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <div class="hp-bar-container" style="height:25px; margin-bottom:10px;">
                            <div id="raid-boss-bar" class="hp-bar" style="width:100%; background: linear-gradient(90deg, #c53030, #9b2c2c);"></div>
                        </div>
                        <div id="raid-boss-visual" style="font-size:120px; transition: transform 0.1s;">üëπ</div>
                        
                        <!-- Player Squad Preview -->
                        <div id="raid-squad-preview" style="display:flex; gap:5px; margin-top:20px; height: 40px;"></div>

                        <!-- Controls -->
                        <div style="margin-top: 20px; width: 100%;">
                            <button id="raid-atk-btn" class="gacha-btn" style="background:#c53030;" onclick="attackRaidBoss()">‚öîÔ∏è ATTACK!</button>
                        </div>
                    </div>

                    <!-- Right: Leaderboard -->
                    <div class="leaderboard-panel">
                        <h3 style="text-align:center; color:#f6ad55; margin-bottom:10px;">üèÜ Top Damage</h3>
                        <div id="raid-leaderboard-list">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- New Adventure Screen with Quest List -->
    <section id="screen-adventure" class="screen">
        <div style="text-align: center; padding: 20px;">
            <h2 style="color: #ed8936; font-size: 24px; margin-bottom: 20px;">üó∫Ô∏è Quest Board</h2>
            
            <!-- LIST OF EVENTS -->
            <div id="adventure-list-view" class="adventure-grid">
                <div style="color:#718096; width:100%;">Loading available quests...</div>
            </div>

            <!-- ACTIVE QUEST VIEW (Hidden by default) -->
            <div id="adventure-play-view" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button class="action-btn red" style="width:auto; padding: 5px 10px;" onclick="exitAdventure()">Quit Quest</button>
                    <span id="quest-title-display" style="font-weight:bold; color: #ed8936;">Quest Title</span>
                </div>
                <div class="rpg-container">
                    <canvas id="adventure-canvas" width="480" height="400" style="background:#2d3748; width:100%; display:block; image-rendering: pixelated;"></canvas>
                </div>
                <div class="dialog-box" id="quest-dialog">
                    <div class="dialog-name" id="quest-npc-name">NPC</div>
                    <div id="quest-text">Hello traveler!</div>
                    <button class="action-btn blue" id="quest-action-btn" style="margin-top: 10px;">Continue</button>
                </div>
                 <div class="d-pad" style="margin-top:10px;">
                    <div class="d-btn d-up" onclick="handleQuestDPad('ArrowUp')">‚¨ÜÔ∏è</div>
                    <div class="d-btn d-left" onclick="handleQuestDPad('ArrowLeft')">‚¨ÖÔ∏è</div>
                    <div class="d-btn d-down" onclick="handleQuestDPad('ArrowDown')">‚¨áÔ∏è</div>
                    <div class="d-btn d-right" onclick="handleQuestDPad('ArrowRight')">‚û°Ô∏è</div>
                </div>
            </div>
        </div>
    </section>
   </main>
  </div>
  
  <div class="modal-overlay" id="release-modal"><div class="confirm-modal"><h2>‚ö†Ô∏è Release Pet?</h2><div class="pet-preview" id="release-pet-preview">üê±</div><p id="release-pet-text" style="font-weight: bold; font-size: 18px;">Are you sure you want to release <strong>Cat</strong>?</p><p style="color: #6b7280; font-size: 14px;">This pet will leave your collection forever and return to the wild.</p><div class="confirm-reward">‚úÖ You will receive +10 Brain Points</div><div class="confirm-warning">üö® WARNING: This action cannot be undone!</div><div class="confirm-buttons"><button class="confirm-btn no" id="release-cancel">No, Keep</button> <button class="confirm-btn yes" id="release-confirm">Yes, Release</button></div></div></div>
  <div class="modal-overlay" id="gacha-reveal-modal"><div class="confirm-modal" style="max-width: 800px;"><h2 id="reveal-title">üåü Legendary Summon Results! üåü</h2><p id="reveal-message">You summoned 3 powerful companions!</p><div id="gacha-reveal-container" class="gacha-results"></div><div style="margin-top: 30px;"><button class="confirm-btn yes" onclick="closeGacha()">Awesome!</button></div></div></div>
  <div id="gacha-cinematic-modal"><div class="flash-overlay" id="gacha-flash-overlay"></div><div id="gacha-message" class="evo-message" style="margin-bottom: 50px; font-size: 28px; transition: opacity 1s;">Summoning Legendary Power...</div><div class="summoning-circle" id="summoning-circle"><div class="summoning-core" id="summoning-core"></div></div><div id="pet-reveal-container" style="position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none;"></div><div id="gacha-cinematic-controls" style="position: absolute; bottom: 10%; opacity: 0; transition: opacity 0.5s;"></div></div>
  <div class="modal-overlay" id="arena-modal"><div class="confirm-modal"><div style="font-size: 60px; margin-bottom: 10px;">üèüÔ∏è</div><h2 style="color: #d69e2e;">Championship Arena</h2><p style="font-weight: bold; font-size: 18px;">Challenge a Powerful Champion?</p><div style="background: #fffbeb; padding: 15px; border-radius: 10px; border: 2px solid #fbd38d; margin: 15px 0; text-align: left;"><div>üéüÔ∏è <strong>Ticket Cost:</strong> 1</div><div id="arena-ticket-display" style="color: #744210; font-size: 14px; margin-bottom: 10px;">(You have: 0)</div><hr style="border-color: #fbd38d; margin: 10px 0;"><div style="font-size: 14px;"><div>üèÜ <strong>Win:</strong> Rare, Epic, or Legendary Egg</div><div style="color: #e53e3e;">üíÄ <strong>Lose:</strong> -20 Stamina</div></div></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="closeArenaModal()">Leave</button> <button class="confirm-btn yes" id="enter-arena-btn" style="background: #d69e2e;">Fight! ‚öîÔ∏è</button></div></div></div>
  <div class="modal-overlay" id="replace-move-modal"><div class="confirm-modal"><h2 style="color: #4299e1;">üß† Move Relearner</h2><p>Your pet already knows 4 moves!</p><p style="font-size: 14px; color: #718096;">Select a move to <strong>forget</strong> to learn <strong id="new-move-name" style="color: #48bb78;">New Move</strong>:</p><div id="replace-move-list" class="move-replace-list"></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="closeReplaceModal()">Cancel</button></div></div></div>
  <div class="modal-overlay" id="teacher-delete-modal"><div class="confirm-modal delete-confirm-modal"><div style="font-size: 60px; margin-bottom: 10px;">üóëÔ∏è</div><h2 style="color: #e53e3e;">Delete Student Account?</h2><p style="font-weight: bold; font-size: 18px;">Are you sure you want to delete account: <strong id="delete-student-name-display">STUDENT_NAME</strong>?</p><div class="confirm-warning">üö® WARNING: All associated data will be permanently lost! This cannot be undone.</div><div class="confirm-buttons"><button class="confirm-btn no" onclick="document.getElementById('teacher-delete-modal').classList.remove('active');">Cancel</button> <button class="confirm-btn yes" id="delete-student-confirm-btn" onclick="confirmDeleteStudent()">Yes, Delete Permanently</button></div></div></div>
  <div id="evolution-modal"><div id="evo-message-1" class="evo-message" style="transition: opacity 1s;">...The aura is changing...</div><div id="evo-pet-container" class="evo-pet-visual"></div><div id="evo-message-2" class="evo-message" style="transition: opacity 1s; margin-top: 40px;"></div><button id="evo-continue-btn" class="action-btn green" style="width:200px; padding:12px; margin-top: 40px; display:none;">Continue</button></div>
  <div class="modal-overlay" id="quantity-modal"><div class="confirm-modal"><h2 id="qty-item-name" style="color: #48bb78;">Buy Item</h2><div id="qty-item-visual" class="pet-preview" style="font-size: 50px;">üõí</div><p id="qty-cost-display" style="font-weight: bold; font-size: 16px; color:#92400e; margin-bottom: 20px;">Cost: 0 BP</p><label for="quantity-slider" id="quantity-label" style="display:block; font-weight:bold; margin-bottom:10px;">Quantity: 1</label><input type="range" id="quantity-slider" min="1" max="1" value="1" style="width: 100%; height: 25px; cursor: pointer;"><div style="display:flex; justify-content:space-between; font-size:12px; color:#718096; margin-bottom:20px;"><span>1</span><span id="max-affordable-qty">Max: 1</span></div><div class="confirm-buttons"><button class="confirm-btn no" onclick="document.getElementById('quantity-modal').classList.remove('active');">Cancel</button> <button class="confirm-btn green" id="qty-buy-confirm-btn" style="background: #48bb78;">Buy 1 (0 BP)</button></div></div></div>

  <div id="hatch-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:6000; flex-direction:column; align-items:center; justify-content:center;">
      <div id="hatch-light" class="hatch-light"></div>
      <div id="hatch-egg-visual" style="font-size:150px;">ü•ö</div>
      <h2 id="hatch-text" style="color:white; margin-top:20px; font-size:32px;">It's hatching!</h2>
      <button id="hatch-finish-btn" class="action-btn green" style="width:200px; display:none; margin-top:20px;">Awesome!</button>
  </div>
  
  <!-- BULK USE MODAL -->
<div class="modal-overlay" id="use-quantity-modal" style="z-index: 4000;">
    <div class="confirm-modal">
        <h2 id="use-qty-title" style="color: #4299e1;">Use Item</h2>
        <div id="use-qty-visual" class="pet-preview" style="font-size: 50px;">üß™</div>
        
        <p id="use-qty-desc" style="font-weight: bold; color:#2d3748; margin-bottom: 20px;">
            You have: 0
        </p>

        <label id="use-qty-label" style="display:block; font-weight:bold; margin-bottom:10px;">
            Use: 1
        </label>
        
        <input type="range" id="use-qty-slider" min="1" max="1" value="1" 
               style="width: 100%; height: 25px; cursor: pointer; accent-color: #4299e1;">
        
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#718096; margin-bottom:20px;">
            <span>1</span>
            <span id="use-qty-max">Max: 1</span>
        </div>

        <div class="confirm-buttons">
            <button class="confirm-btn no" onclick="document.getElementById('use-quantity-modal').classList.remove('active')">
                Cancel
            </button> 
            <button class="confirm-btn yes" id="use-qty-confirm-btn" style="background: #4299e1;">
                Confirm
            </button>
        </div>
    </div>
</div>
  
  <!-- Daily Reward Modal -->
  <div class="modal-overlay" id="daily-modal"><div class="confirm-modal"><h2>üìÖ Daily Reward</h2><p>Welcome back! Keep your streak alive.</p><div class="calendar-grid" id="daily-calendar"></div><button class="confirm-btn green" style="margin-top:20px; width:100%;" onclick="document.getElementById('daily-modal').classList.remove('active')">Collect Reward</button></div></div>

  <!-- FEATURE 2: TEAM SWAP MODAL -->
  <div class="modal-overlay" id="swap-pet-modal">
    <div class="confirm-modal" style="width: 95%; max-width: 600px;">
        <h2 style="color: #4299e1;">üîÑ Switch Pet</h2>
        <p style="margin-bottom:15px;">Choose a companion to send into battle:</p>
        <div id="swap-list-container" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto; padding:5px;">
            <!-- Pet Cards injected here -->
        </div>
        <div class="confirm-buttons">
            <button class="confirm-btn no" id="swap-cancel-btn" onclick="document.getElementById('swap-pet-modal').classList.remove('active')">Cancel</button>
        </div>
    </div>
  </div>

  <script>
    // --- GLOBAL GAME STATE DEFINITION ---
    let gameState = { 
        playerName: "Student", grade: null, selectedTopics: [], activeQuestionPool: [], currentQuestion: null, brainPoints: 0, 
        pets: [], currentPetId: null, inventory: {}, inBattle: false, battleState: null, mapX: 2, mapY: 2, stamina: 100, maxStamina: 100, tempMoveToLearn: null,
        combo: 0, burstMode: false, dailyStreak: 0, lastLoginDate: null, questProgress: { active: false, flags: [] },
        questBattleActive: false, questSuccessKey: null, pendingQuestRewardData: null,
        team: [] // ADDED: Squad Array
    };

    const AUDIO_ASSETS = {
        bgm: { 
            login: "audio/login.mp3", 
            hub: "audio/hub.mp3", 
            wilds: "audio/wild.mp3", 
            battle: "audio/battle.mp3", 
            boss: "audio/boss.mp3", 
            victory: "audio/win.mp3" 
        },
        sfx: { 
            click: "audio/click.mp3", 
            correct: "audio/correct.mp3", 
            wrong: "audio/wrong.mp3", 
            attack: "audio/attack.mp3", 
            hit: "audio/hit.mp3", 
            levelUp: "audio/levelup.mp3", 
            gacha: "audio/gacha.mp3",
            heal: "audio/heal.mp3"
        }
    };

    const soundManager = {
        currentBGM: null, currentBGMKey: null, isMuted: false,
        playBGM: function(key) { 
            if (this.isMuted || this.currentBGMKey === key) return; 
            this.stopBGM(); 
            const url = AUDIO_ASSETS.bgm[key]; 
            if (!url) return; 
            this.currentBGM = new Audio(url); 
            this.currentBGM.loop = true; 
            this.currentBGM.volume = 0.4; 
            this.currentBGM.play().catch(() => {}); 
            this.currentBGMKey = key; 
        },
        stopBGM: function() { 
            if (this.currentBGM) { this.currentBGM.pause(); this.currentBGM.currentTime = 0; this.currentBGM = null; this.currentBGMKey = null; } 
        },
        playSFX: function(key) { 
            if (this.isMuted) return; 
            const url = AUDIO_ASSETS.sfx[key]; 
            if (!url) return; 
            const sfx = new Audio(url); sfx.volume = 0.6; sfx.play().catch(() => {}); 
        },
        toggleMute: function() { 
            this.isMuted = !this.isMuted; 
            if (this.isMuted) { this.stopBGM(); return "üîá"; } 
            else { 
                const t = document.querySelector('.tab.active'); 
                const id = t ? t.dataset.tab : 'hub'; 
                if (gameState.inBattle) this.playBGM(gameState.battleState.isBoss ? 'boss' : 'battle'); 
                else if (id === 'wilds') this.playBGM('wilds'); 
                else this.playBGM('hub'); 
                return "üîä"; 
            } 
        }
    };
    function toggleAudio() { document.getElementById('mute-btn').innerText = soundManager.toggleMute(); }

    const MAP_ROWS = 10;
    const MAP_COLS = 12;

    const MAP_1 = [ [2,2,0,0,0,2,2,0,0,0,2,2], [2,0,0,1,1,1,1,0,0,0,0,2], [0,0,1,1,1,2,2,1,0,0,0,0], [0,0,1,2,2,8,2,2,1,0,0,0], [0,0,1,1,1,2,2,1,1,0,0,0], [0,0,0,0,0,0,0,0,0,0,1,0], [2,1,1,0,0,0,0,0,1,1,1,2], [2,1,0,0,7,0,0,0,0,1,1,2], [2,0,0,0,0,0,0,0,0,0,0,2], [2,2,0,0,0,2,2,0,0,0,2,2] ];
    const MAP_2 = [ [4,4,4,4,4,0,0,4,4,4,4,4], [4,4,9,9,4,4,4,4,9,9,4,4], [4,9,4,4,4,4,4,4,4,4,9,4], [4,9,4,3,3,3,3,3,3,4,9,4], [0,4,4,3,3,8,3,3,3,4,4,0], [0,4,4,3,3,3,3,3,3,4,4,0], [4,9,4,4,4,4,4,4,4,4,9,4], [4,9,9,4,4,4,4,4,4,9,9,4], [4,4,4,4,4,0,0,4,4,4,4,4], [4,4,4,4,4,0,0,4,4,4,4,4] ];
    const MAP_3 = [ [5,5,0,0,5,5,5,5,0,0,5,5], [5,5,0,0,5,5,5,5,0,0,5,5], [5,3,3,3,5,5,5,5,3,3,3,5], [5,3,8,3,5,5,5,5,3,3,3,5], [0,5,5,5,5,2,2,5,5,5,5,0], [0,5,5,5,5,2,2,5,5,5,5,0], [5,9,9,5,5,5,5,5,5,9,9,5], [5,5,5,5,5,7,5,5,5,5,5,5], [5,5,0,0,5,5,5,5,0,0,5,5], [5,5,0,0,5,5,5,5,0,0,5,5] ];
    const MAP_4 = [ [1,1,0,0,1,1,1,1,0,0,1,1], [1,6,6,6,1,1,1,1,6,6,6,1], [0,6,8,6,0,0,0,0,6,6,6,0], [0,6,6,6,0,3,3,0,6,6,6,0], [0,0,0,0,0,3,3,0,0,0,0,0], [0,0,0,0,0,3,3,0,0,0,0,0], [0,6,6,6,0,0,0,0,6,6,6,0], [1,6,6,6,1,1,1,1,6,6,6,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1] ];
    const MAP_5 = [ [0,0,0,0,0,9,9,0,0,0,0,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,9,8,0,0,0,0,0,0,0,9,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,0,0,0,0,9,9,0,0,0,0,0], [0,0,0,0,0,9,9,0,0,0,0,0], [0,9,9,0,0,0,0,0,0,9,9,0], [0,9,7,0,0,9,9,0,0,0,9,0], [0,9,9,0,0,9,9,0,0,9,9,0], [0,0,0,0,0,9,9,0,0,0,0,0] ];
    const MAP_6 = [ [3,3,0,0,3,3,3,3,0,0,3,3], [3,0,0,0,0,3,3,0,0,0,0,3], [3,0,4,4,0,3,3,0,4,4,0,3], [3,0,4,8,0,3,3,0,4,4,0,3], [3,3,3,3,3,3,3,3,3,3,3,3], [3,3,3,3,3,3,3,3,3,3,3,3], [3,0,4,4,0,3,3,0,4,4,0,3], [3,0,4,4,0,0,0,0,4,4,0,3], [3,3,0,0,3,3,3,3,0,0,3,3], [3,3,0,0,3,3,3,3,0,0,3,3] ];
    const MAP_7 = [ [2,2,0,0,2,2,2,2,0,0,2,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,1,8,1,2,1,1,2,1,7,1,2], [2,1,1,1,0,0,0,0,1,1,1,2], [0,0,0,0,0,2,2,0,0,0,0,0], [0,0,0,0,0,2,2,0,0,0,0,0], [2,1,1,1,0,0,0,0,1,1,1,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,1,1,1,2,1,1,2,1,1,1,2], [2,2,0,0,2,2,2,2,0,0,2,2] ];
    const MAP_8 = [ [4,4,0,0,4,4,4,4,0,0,4,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,0,0,0,0,8,0,0,0,0,0,4], [0,0,9,9,0,0,0,0,9,9,0,0], [0,0,9,9,0,0,0,0,9,9,0,0], [4,0,0,0,0,0,0,0,0,0,0,4], [4,9,0,9,4,9,9,4,9,0,9,4], [4,4,0,0,4,4,4,4,0,0,4,4], [4,4,0,0,4,4,4,4,0,0,4,4] ];
    const MAP_9 = [ [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,3,3,3,3,3,3,0,1,1], [1,1,0,3,3,8,3,3,3,0,1,1], [0,0,0,3,3,3,3,3,3,0,0,0], [0,0,0,3,3,3,3,3,3,0,0,0], [1,1,0,3,3,3,3,3,3,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1], [1,1,0,0,1,1,1,1,0,0,1,1] ];
    const MAP_10 = [ [9,9,0,0,9,9,9,9,0,0,9,9], [9,5,0,0,5,5,5,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [0,0,0,0,0,8,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0,0,0], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,9,9,5,0,0,5,9], [9,5,0,0,5,5,5,5,0,0,5,9], [9,9,0,0,9,9,9,9,0,0,9,9] ];

    const MAP_COLLECTION = [
        { data: MAP_1, name: "Mystic Forest" }, { data: MAP_2, name: "Desert Oasis" }, { data: MAP_3, name: "Frozen Tundra" },
        { data: MAP_4, name: "Flower Garden" }, { data: MAP_5, name: "Rocky Wasteland" }, { data: MAP_6, name: "Island Hop" },
        { data: MAP_7, name: "Deep Jungle" }, { data: MAP_8, name: "Ancient Ruins" }, { data: MAP_9, name: "Lakeside Path" },
        { data: MAP_10, name: "Mountain Pass" }
    ];

    let currentMapData = JSON.parse(JSON.stringify(MAP_1));
    let currentMapName = "Mystic Forest";

    const GITHUB_CONFIG = { enabled: true, username: "rye-ai", repo: "MathPetRPG", branch: "main" };
    function getGhUrl(path) { return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`; }
    async function fetchGithubFolder(folderPath) { try { const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${folderPath}?ref=${GITHUB_CONFIG.branch}`); if (res.status === 404 || !res.ok) return []; return await res.json(); } catch (e) { return []; } }
    let currentLoggedTeacher = null; // Stores "MrSmith" after login
    let EXTERNAL_PET_DATA = [ { id: 'shadow_dragon_line', base: { id: 'light_bearcat_baby', name: 'OlaBear', rarity: 'legendary', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/43.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 50 }, evolutions: [ { name: 'Teen Shadow Dragon', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/43.png', imageStyle: 'blend-multiply', emoji: '‚ùì', rarity: 'legendary', baseHP: 100, cost: 100 }, { name: 'Elder Shadow Dragon', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/43.png', imageStyle: 'blend-multiply', emoji: '‚ùì', rarity: 'legendary', baseHP: 150, cost: 200 } ] } ];
    let QUESTION_REPOSITORY = {}; const LEVEL_CAPS = { common: 50, uncommon: 50, rare: 60, epic: 75, legendary: 100 };
    const BATTLE_BACKGROUNDS = { 1: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur.png', 4: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(1).png', 5: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png', 6: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(2).png', 7: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/%E2%80%9CA%20high-quality%20monster-inspired%20battle%20arena%20in%20landscape%20orientation.%20A%20large%2C%20circular%20stadium%20floor%20made%20of%20smooth%20stone%20tiles%20with%20subtle%20glowing%20patterns.%20Surrounding%20the%20arena%20are%20tall%20stadium%20walls%2C%20bright%20.jpg' }; const ARENA_IMGS = [ 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur.png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(1).png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(2).png', 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png' ];
    
    const PET_TYPES = {
      common: [
        { id: 'monster_01', name: 'Kittire', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/1.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'normal' },
        { id: 'monster_02', name: 'CaidICE', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/28.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'ice' }, 
        { id: 'monster_03', name: 'KatieDro', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/7.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'water' },
        { id: 'monster_04', name: 'Royalion', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/19.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'electric'] }, 
        { id: 'monster_05', name: 'KingBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/25.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 45, rarity: 'common', element: ['earth', 'normal'] },
        { id: 'monster_06', name: 'Kaifire', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/13.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'shadow'] }, 
        { id: 'monster_07', name: 'Teviphant', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/37.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'shadow'] },
        { id: 'monster_08', name: 'Augustur', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/16.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'ice' },
        { id: 'monster_09', name: 'Luking', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/4.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: ['fire', 'water'] },
        { id: 'monster_10', name: 'Kaylight', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/10.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'light' },
        { id: 'monster_11', name: 'Zyfir', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/22.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 40, rarity: 'common', element: 'fire' }
      ],
      uncommon: [ { id: 'monster_12', name: 'Malachice', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/40.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 50, rarity: 'uncommon', element: 'ice' } ],
      rare: [ { id: 'monster_13', name: 'CaraBrown', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/31.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 60, rarity: 'rare', element: 'earth' } ],
      epic: [ { id: 'monster_14', name: 'Ms.Mckenfish', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/1.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 70, rarity: 'epic', element: 'fire' } ],
      legendary: [ { id: 'monster_15', name: 'Pilandoc', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/34.png', imageStyle: 'blend-multiply', emoji: '‚ùì', baseHP: 90, rarity: 'legendary', element: ['light', 'fire'] } ],
      event: [] 
    };

    const EVOLUTION_CHAINS = {
      'monster_01': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/2.png', imageStyle: 'blend-multiply', emoji: 'üê±', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/3.png', imageStyle: 'blend-multiply', emoji: 'ü¶Å', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
     'monster_02': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/29.png', imageStyle: 'blend-multiply', emoji: '‚ùÑÔ∏è', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/30.png', imageStyle: 'blend-multiply', emoji: '‚ùÑÔ∏è', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_03': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/8.png', imageStyle: 'blend-multiply', emoji: 'üíß', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/9.png', imageStyle: 'blend-multiply', emoji: 'üíß', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_04': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/20.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/21.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_05': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/26.png', imageStyle: 'blend-multiply', emoji: 'üêª', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/27.png', imageStyle: 'blend-multiply', emoji: 'üêª', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_06': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/14.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/15.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_07': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/38.png', imageStyle: 'blend-multiply', emoji: 'üêò', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/39.png', imageStyle: 'blend-multiply', emoji: 'üêò', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_08': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/17.png', imageStyle: 'blend-multiply', emoji: 'ü¶â', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/18.png', imageStyle: 'blend-multiply', emoji: 'ü¶â', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_09': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/5.png', imageStyle: 'blend-multiply', emoji: 'ü§¥', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/6.png', imageStyle: 'blend-multiply', emoji: 'ü§¥', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_10': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/11.png', imageStyle: 'blend-multiply', emoji: '‚ú®', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/12.png', imageStyle: 'blend-multiply', emoji: '‚ú®', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_11': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/23.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/24.png', imageStyle: 'blend-multiply', emoji: 'üî•', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_12': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/41.png', imageStyle: 'blend-multiply', emoji: 'üßä', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/42.png', imageStyle: 'blend-multiply', emoji: 'üßä', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_13': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/32.png', imageStyle: 'blend-multiply', emoji: 'üü§', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/33.png', imageStyle: 'blend-multiply', emoji: 'üü§', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_14': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/2.png', imageStyle: 'blend-multiply', emoji: 'üê†', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/3.png', imageStyle: 'blend-multiply', emoji: 'üê†', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'monster_15': [
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/35.png', imageStyle: 'blend-multiply', emoji: 'ü¶å', rarity: 'common', baseHP: 60, cost: 50, level: 10 },
        { image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/36.png', imageStyle: 'blend-multiply', emoji: 'ü¶å', rarity: 'rare',   baseHP: 80, cost: 100, level: 20 }
      ],
      'light_bearcat_baby': [
        { name: 'Teen OlaBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/44.png', imageStyle: 'blend-multiply', emoji: 'üêº', rarity: 'legendary', baseHP: 100, cost: 100, level: 10 },
        { name: 'Elder OlaBear', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V1/45.png', imageStyle: 'blend-multiply', emoji: 'üêº', rarity: 'legendary', baseHP: 150, cost: 200, level: 20 }
      ]
    };

    let MONSTER_TYPES = [
      { id: 'Bugja', emoji: 'üëæ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/5.png', imageStyle: 'blend-multiply', name: 'Bugja', hp: 30, damage: 8, xp: 15, element: 'grass' },
      { id: 'Plup', emoji: 'üëπ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/3.png', imageStyle: 'blend-multiply', name: 'Plup', hp: 35, damage: 10, xp: 20, element: 'fire' },
      { id: 'Jap', emoji: 'ü¶á', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/1.png', imageStyle: 'blend-multiply', name: 'Jap', hp: 25, damage: 7, xp: 15, element: 'wind' },
      { id: 'Sap', emoji: 'üêç', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/4.png', imageStyle: 'blend-multiply', name: 'Sap', hp: 28, damage: 9, xp: 18, element: 'earth' },
      { id: 'Slimax', emoji: 'üï∑Ô∏è', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/2.png', imageStyle: 'blend-multiply', name: 'Slimax', hp: 32, damage: 8, xp: 18, element: 'water' }
    ];

    let BOSS_TYPES = [
       { id: 'Shadow King', emoji: 'üíÄ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/9.png', imageStyle: 'blend-multiply', name: 'Shadow King', hp: 300, damage: 20, xp: 100, isBoss: true, element: 'shadow' }
    ];
    
    let ARENA_MONSTERS = [
       { emoji: 'üêâ', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/7.png', imageStyle: 'blend-multiply', name: 'Krackince', hp: 120, damage: 18, xp: 80, element: 'ice' },
       { emoji: 'ü¶Ö', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/8.png', imageStyle: 'blend-multiply', name: 'Trum', hp: 110, damage: 22, xp: 80, element: 'grass' },
       { emoji: 'ü¶ï', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/enemy/6.png', imageStyle: 'blend-multiply', name: 'Draire', hp: 140, damage: 15, xp: 80, element: 'fire' }
    ];

    let SHOP_ITEMS = { 
        egg_items: [ 
            { id: 'premium_food', name: 'Premium Food', icon: 'ü•©', price: 50, desc: 'Adds 20% to hatch progress', effect: 20 }, 
            { id: 'warmer', name: 'Warmer', icon: 'üî•', price: 30, desc: 'Adds 10% to hatch progress', effect: 10 }, 
            { id: 'hatching_machine', name: 'Hatching Machine', icon: '‚öôÔ∏è', price: 100, desc: 'Adds 50% to hatch progress', effect: 50 } 
        ], 
        power_items: [ 
            { id: 'claw_attack', name: 'Claw Attack', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/2.png', icon: 'ü¶Ö', price: 80, desc: 'Normal damage', damage: 10, element: 'normal' }, 
            { id: 'fire_spell', name: 'Fire Spell', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/1.png', icon: 'üî•', price: 120, desc: 'Burn the target', damage: 15, element: 'fire' }, 
            { id: 'quick_dodge', name: 'Cloud Strike', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/3.png', icon: 'üí®', price: 100, desc: 'Normal damage', damage: 15, element: 'normal' }, 
            { id: 'ice_blast', name: 'Ice Blast', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/4.png', icon: '‚ùÑÔ∏è', price: 110, desc: 'Freezing cold', damage: 12, element: 'ice' }, 
            { id: 'thunder_strike', name: 'Thunder Strike', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/5.png', icon: '‚ö°', price: 150, desc: 'Shocking hit', damage: 18, element: 'electric' }, 
            { id: 'water_wave', name: 'Water Wave', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/6.png', icon: 'üåä', price: 90, desc: 'Soaking wet', damage: 11, element: 'water' }, 
            { id: 'earth_slam', name: 'Earth Slam', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/7.png', icon: 'ü™®', price: 100, desc: 'Rock solid', damage: 13, element: 'earth' }, 
            { id: 'wind_slash', name: 'Wind Slash', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/12.png', icon: 'üå™Ô∏è', price: 95, desc: 'Fast cut', damage: 10, element: 'wind' }, 
            { id: 'shadow_strike', name: 'Shadow Strike', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/8.png', icon: 'üåë', price: 130, desc: 'Dark energy', damage: 16, element: 'shadow' }, 
            { id: 'light_beam', name: 'Light Beam', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/9.png', icon: '‚ú®', price: 140, desc: 'Holy light', damage: 17, element: 'light' }, 
            { id: 'poison_fang', name: 'Poison Fang', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/10.png', icon: 'üêç', price: 105, desc: 'Toxic bite', damage: 14, element: 'grass' }, 
            { id: 'mega_punch', name: 'Mega Punch', image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/power/11.png', icon: 'üëä', price: 115, desc: 'Heavy hit', damage: 15, element: 'normal' } 
        ],
        consumable_items: [ 
            { id: 'health_potion', name: 'Health Potion', icon: 'üß™', price: 50, desc: 'Restores 30 HP', healing: 30 }, 
            { id: 'stamina_potion', name: 'Stamina Potion', icon: '‚ö°', price: 40, desc: 'Restores 50 Stamina', stamina: 50 }, 
            { id: 'xp_potion', name: 'XP Potion', icon: 'üåü', price: 50, desc: 'Gives 100 XP to active pet', xp: 100 }, 
            { id: 'arena_ticket', name: 'Arena Ticket', icon: 'üéüÔ∏è', price: 150, desc: 'Enter 1 Arena Fight', type: 'ticket' } 
        ] 
    };

    const MathEngine = {
        generate: (gradeInput) => {
            let grade = gradeInput === 'K' ? 0 : parseInt(gradeInput);
            if (isNaN(grade)) grade = 1;
            let types = ['add'];
            if (grade >= 1) types.push('sub');
            if (grade >= 3) types.push('mul');

            const type = types[Math.floor(Math.random() * types.length)];
            let n1, n2, a, q, htmlQ;
            const baseMax = grade === 0 ? 5 : grade * 10; 

            if (type === 'add') {
                n1 = Math.floor(Math.random() * baseMax);
                n2 = Math.floor(Math.random() * baseMax);
                a = n1 + n2;
                q = `${n1} + ${n2} = ?`;
            } else if (type === 'sub') {
                n1 = Math.floor(Math.random() * baseMax);
                n2 = Math.floor(Math.random() * n1); 
                a = n1 - n2;
                q = `${n1} - ${n2} = ?`;
            } else if (type === 'mul') {
                const limit = grade === 3 ? 5 : 12; 
                n1 = Math.floor(Math.random() * limit);
                n2 = Math.floor(Math.random() * 10);
                a = n1 * n2;
                q = `${n1} √ó ${n2} = ?`;
            }

            if (grade === 0) {
                 const icon = ['üçé','üçå','‚≠ê','üê±'][Math.floor(Math.random()*4)];
                 htmlQ = `<div style="font-size:30px">${icon.repeat(n1)} ${type==='add' ? '+' : '-'} ${icon.repeat(n2)}</div>`;
            } else {
                 htmlQ = `<div style="font-size: 40px; font-weight:bold; color:#2d3748;">${q}</div>`;
            }

            return { q: htmlQ, qVisualHTML: htmlQ, text: q, a: a, options: MathEngine.generateDistractors(a, type) };
        },
        generateDistractors: (answer, type) => {
            let opts = new Set([answer]);
            let range = Math.max(5, Math.ceil(answer * 0.5)); 
            while(opts.size < 4) {
                let offset = Math.floor(Math.random() * (range * 2)) - range;
                let val = answer + offset;
                if(val >= 0 && val !== answer) opts.add(val);
            }
            return Array.from(opts).sort(() => Math.random() - 0.5);
        }
    };

    // QUEST & DATA LOADING
    let availableEvents = [];

    async function loadGitHubData() {
        if (!GITHUB_CONFIG.enabled) return;
        
        console.log("‚òÅÔ∏è Connecting to GitHub Content...");

        // ===============================================
        // DYNAMIC ENEMY LOADER (AUTO-FETCH FROM GITHUB)
        // ===============================================
        try {
            console.log("üìÇ Scanning 'enemies' folder...");
            // 1. Get list of all files in the 'enemies' folder
            const enemyFiles = await fetchGithubFolder('enemies');
            
            if (enemyFiles && Array.isArray(enemyFiles)) {
                for (const file of enemyFiles) {
                    // Only process JSON files
                    if (file.name.endsWith('.json')) {
                        try {
                            const res = await fetch(file.download_url);
                            if (res.ok) {
                                const data = await res.json();
                                if (Array.isArray(data)) {
                                    // 2. Sort them into the right categories based on filename
                                    if (file.name.includes('boss')) {
                                        BOSS_TYPES = [...BOSS_TYPES, ...data];
                                        console.log(`üíÄ Loaded Bosses from: ${file.name}`);
                                    } 
                                    else if (file.name.includes('arena')) {
                                        ARENA_MONSTERS = [...ARENA_MONSTERS, ...data];
                                        console.log(`‚öîÔ∏è Loaded Arena foes from: ${file.name}`);
                                    } 
                                    else {
                                        // Everything else (forest.json, christmas.json, etc.) goes to Wilds
                                        MONSTER_TYPES = [...MONSTER_TYPES, ...data];
                                        console.log(`üå≤ Loaded Wild Monsters from: ${file.name}`);
                                    }
                                }
                            }
                        } catch (err) { 
                            console.warn("Skipped invalid file:", file.name); 
                        }
                    }
                }
            }
        } catch (e) { 
            console.error("Could not fetch enemy folder list. Check GitHub config."); 
        }
        // ===============================================
        
        // 1. Load Event List (Quest Board)
        try {
            const res = await fetch(getGhUrl('events/event_list.json'));
            if(res.ok) {
                availableEvents = await res.json();
                if(availableEvents.length > 0) {
                     document.querySelector('.adventure-tab').style.display = 'block';
                     renderAdventureList();
                }
            }
        } catch(e) { console.log("No event list found."); }

        // 2. Load Pets/Evolutions
        try { 
            const res = await fetch(getGhUrl('pets/evolutions.json')); 
            if(res.ok) { 
                const data = await res.json(); 
                if (Array.isArray(data)) { 
                    const newData = data.filter(d => !EXTERNAL_PET_DATA.find(e => e.id === d.id));
                    EXTERNAL_PET_DATA = [...EXTERNAL_PET_DATA, ...newData]; 
                    loadExternalPets(); 
                } 
            } 
        } catch(e) { console.error("Error loading evolutions:", e); }

        // 3. Dynamic Powers
        try {
            const files = await fetchGithubFolder('powers');
            if (files && files.length > 0) {
                let addedCount = 0;
                const existingIds = new Set(SHOP_ITEMS.power_items.map(p => p.id));
                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        try {
                            const res = await fetch(file.download_url);
                            if (res.ok) {
                                const newPowers = await res.json();
                                if (Array.isArray(newPowers)) {
                                    newPowers.forEach(power => {
                                        if (!existingIds.has(power.id)) {
                                            if (!power.image && !power.icon) power.icon = 'üìú';
                                            SHOP_ITEMS.power_items.push(power);
                                            existingIds.add(power.id);
                                            addedCount++;
                                        }
                                    });
                                }
                            }
                        } catch (err) {}
                    }
                }
                if (document.getElementById('screen-shop').classList.contains('active')) { renderShop(); }
            }
        } catch(e) {}
    }
    loadGitHubData();

    async function loadProgressFromFirebase(username) {
        try { const docSnap = await window.fbase.getDoc(window.fbase.doc(window.db, "students", username)); if (docSnap.exists() && docSnap.data().saveData) { gameState = { ...gameState, ...docSnap.data().saveData }; repairSaveData(); return true; } } catch (e) { console.error("Cloud Load Error:", e); } return false;
    }

    async function saveProgressToFirebase() {
        if (!gameState.playerName) return;
        let cleanState = JSON.parse(JSON.stringify(gameState));
        delete cleanState.activeQuestionPool; 
        delete cleanState.battleState;
        delete cleanState.currentQuestion;
        try { await window.fbase.setDoc(window.fbase.doc(window.db, "students", gameState.playerName), { saveData: cleanState, lastSaved: new Date() }, { merge: true }); } catch (e) { console.error("Cloud Save Error:", e); }
    }

    function repairSaveData() {
        let fixed = false;
        
        // 1. Init missing systems
        if(gameState.combo === undefined) { gameState.combo = 0; fixed=true; }
        if(gameState.dailyStreak === undefined) { gameState.dailyStreak = 0; fixed=true; }
        if(!gameState.questProgress) { gameState.questProgress = { active: false, flags: [] }; fixed=true; }
        if(!gameState.team) { gameState.team = [gameState.currentPetId]; fixed=true; }

        // --- 2. FIX SQUAD GHOSTS (The Fix for You) ---
        // Filter the team to ONLY keep pets that actually exist in your inventory
        const initialTeamSize = gameState.team.length;
        gameState.team = gameState.team.filter(teamId => 
            gameState.pets.some(p => p.id === teamId)
        );
        
        if (gameState.team.length !== initialTeamSize) {
            console.log("üëª Removed Ghost Pets from Squad");
            fixed = true;
        }
        
        // If squad ended up empty, add current pet
        if (gameState.team.length === 0 && gameState.pets.length > 0) {
            gameState.team.push(gameState.pets[0].id);
            fixed = true;
        }
        // ---------------------------------------------

        // 3. Fix Pet Data
        gameState.pets.forEach(p => {
            if (!p.powers || !Array.isArray(p.powers)) { p.powers = []; fixed = true; }
            
            if (isNaN(p.hp) || isNaN(p.maxHP) || !p.maxHP) {
                p.maxHP = 50 + ((p.level||1) * 10);
                p.hp = p.maxHP; 
                fixed = true;
            }
        });
        
        if (fixed) saveGame();
    }
    
    // RPG Variables
    const TILE_SIZE = 40; 
    let canvas, ctx, playerImage = new Image(), arenaIcon = new Image(); const HUMAN_SPRITE_URL = "https://i.imgur.com/J6eL2tY.png"; arenaIcon.src = 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/Copy%20of%20Zyfire%20(1).png';

    function isWalkable(tile) { return tile === 0 || tile === 1 || tile === 4 || tile === 5 || tile === 6; }

    function initRPG() {
      canvas = document.getElementById('rpg-canvas'); ctx = canvas.getContext('2d');
      const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
      if (pet && pet.image && pet.image.length > 5) playerImage.src = pet.image; else playerImage.src = HUMAN_SPRITE_URL; 
      
      injectRandomArena(); 
      playerImage.onload = () => drawMap(); 
      drawMap();
      
      document.removeEventListener('keydown', handleKeyDown); document.addEventListener('keydown', handleKeyDown);
      initSwipe(); 
      
      canvas.addEventListener('click', (e) => {
          if (gameState.inBattle) return; const rect = canvas.getBoundingClientRect(); const clickX = (e.clientX - rect.left) * (canvas.width / rect.width); const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
          const tileX = Math.floor(clickX / TILE_SIZE); const tileY = Math.floor(clickY / TILE_SIZE);
          if (tileX < 0 || tileX >= MAP_COLS || tileY < 0 || tileY >= MAP_ROWS) return;
          if (Math.abs(tileX - gameState.mapX) + Math.abs(tileY - gameState.mapY) <= 2) { const t = currentMapData[tileY][tileX]; if (t === 8) checkArenaEntry(); else if (t === 7) confirmBossBattle(7); }
      });
      
      // Update Wilds HUD
      document.getElementById('wild-hp-display').innerText = `HP: ${pet.hp}/${pet.maxHP}`;
    }

    function drawMap() {
      if (!ctx) return; ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let r = 0; r < MAP_ROWS; r++) {
        for (let c = 0; c < MAP_COLS; c++) {
          const tile = currentMapData[r][c]; const x = c * TILE_SIZE; const y = r * TILE_SIZE;
          if (tile === 2) { ctx.fillStyle = '#2e7d32'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '24px Arial'; ctx.fillStyle = '#1b5e20'; ctx.fillText('üå≤', x+5, y+30); } 
          else if (tile === 3) { ctx.fillStyle = '#4fc3f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#0288d1'; ctx.fillText('~', x+10, y+25); } 
          else if (tile === 1) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#388e3c'; ctx.fillText('w', x+5, y+15); ctx.fillText('w', x+20, y+30); } 
          else if (tile === 4) { ctx.fillStyle = '#f6e05e'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('.', x+10, y+15); ctx.fillText('.', x+25, y+30); }
          else if (tile === 5) { ctx.fillStyle = '#e2e8f0'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#cbd5e0'; ctx.fillText('‚ùÑÔ∏è', x+8, y+26); }
          else if (tile === 6) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#ed64a6'; ctx.fillText('üå∏', x+5, y+28); }
          else if (tile === 9) { ctx.fillStyle = '#4a5568'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '20px Arial'; ctx.fillStyle = '#2d3748'; ctx.fillText('ü™®', x+8, y+28); }
          else if (tile === 7) { ctx.fillStyle = '#2d3748'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#e53e3e'; ctx.fillText('üíÄ', x+10, y+25); } 
          else if (tile === 8) { if (arenaIcon.complete && arenaIcon.naturalWidth > 0) { ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.drawImage(arenaIcon, x, y, TILE_SIZE, TILE_SIZE); } else { ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '18px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('üèüÔ∏è', x+5, y+28); } } 
          else { ctx.fillStyle = '#d7ccc8'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); }
        }
      }
      const px = gameState.mapX * TILE_SIZE; const py = gameState.mapY * TILE_SIZE;
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; ctx.lineWidth = 3; ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE);
      if (playerImage.complete && playerImage.naturalWidth !== 0) ctx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE);
      else { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke(); }
      ctx.font = "bold 14px Arial"; ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(5, 5, 120, 25); ctx.fillStyle = "white"; ctx.fillText(currentMapName || "Wilds", 10, 22);
    }

    function handleKeyDown(e) { 
        if(gameState.inBattle) return; 
        
        // Prevent scrolling with arrows
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.key) > -1) {
            e.preventDefault(); 
        }

        // Check if we are in Adventure Mode or Wilds Mode
        const isAdventure = document.getElementById('screen-adventure').classList.contains('active');
        const isQuestPlaying = document.getElementById('adventure-play-view').style.display !== 'none';

        if (isAdventure && isQuestPlaying) {
            // Use Adventure Controls
            handleQuestDPad(e.key);
        } else {
            // Use Wilds Controls
            handleDPad(e.key);
        }
    }
    function handleDPad(key) { if (gameState.inBattle) return; let dx = 0; let dy = 0; if (key === 'ArrowUp') dy = -1; if (key === 'ArrowDown') dy = 1; if (key === 'ArrowLeft') dx = -1; if (key === 'ArrowRight') dx = 1; if (dx !== 0 || dy !== 0) tryMove(dx, dy); }
    
    function tryMove(dx, dy) {
      if (gameState.stamina <= 0) { showToast("No Stamina! Study to buy Energy!", "error"); return; }
      const newX = gameState.mapX + dx; const newY = gameState.mapY + dy;
      if (newX < 0) { switchMap('left'); return; } 
      if (newX >= MAP_COLS) { switchMap('right'); return; } 
      if (newY < 0) { switchMap('up'); return; } 
      if (newY >= MAP_ROWS) { switchMap('down'); return; }

      const targetTile = currentMapData[newY][newX];
      if (targetTile === 7) { confirmBossBattle(7); return; } 
      if (targetTile === 8) { checkArenaEntry(); return; }
      if (!isWalkable(targetTile)) return;
      
      gameState.mapX = newX; gameState.mapY = newY; 
      gameState.stamina = Math.max(0, gameState.stamina - 1); 
      updateStatsDisplay(); 
      drawMap();
      if ([1,4,5,6].includes(targetTile)) checkEncounter(targetTile);
    }
    
    function injectRandomArena() { let hasArena = false; for(let r=0; r<MAP_ROWS; r++) { for(let c=0; c<MAP_COLS; c++) { if (currentMapData[r][c] === 8) hasArena = true; } } if (!hasArena) { let possibleSpots = []; for(let r=1; r<MAP_ROWS-1; r++) { for(let c=1; c<MAP_COLS-1; c++) { const t = currentMapData[r][c]; if (t === 0 || t === 1 || t === 4 || t === 5) possibleSpots.push({r, c}); } } if (possibleSpots.length > 0) { const spot = possibleSpots[Math.floor(Math.random() * possibleSpots.length)]; currentMapData[spot.r][spot.c] = 8; } } }
    
    function switchMap(d) { 
        const rand = Math.floor(Math.random() * MAP_COLLECTION.length);
        const selectedMap = MAP_COLLECTION[rand];
        currentMapData = JSON.parse(JSON.stringify(selectedMap.data)); 
        currentMapName = selectedMap.name;
        injectRandomArena(); 
        gameState.mapX = d === 'left' ? MAP_COLS-1 : (d === 'right' ? 0 : gameState.mapX); 
        gameState.mapY = d === 'up' ? MAP_ROWS-1 : (d === 'down' ? 0 : gameState.mapY); 
        let safetyAttempts = 0;
        while (!isWalkable(currentMapData[gameState.mapY][gameState.mapX]) && safetyAttempts < 50) { gameState.mapX = Math.floor(Math.random() * MAP_COLS); gameState.mapY = Math.floor(Math.random() * MAP_ROWS); safetyAttempts++; }
        drawMap(); showToast(`Entered: ${currentMapName}`, "info"); 
    }
    
    function checkEncounter(t) { if (Math.random() < 0.4) startBattle(t, false, false); }
    function confirmBossBattle(t) { if(confirm("‚ö†Ô∏è DANGER! Boss Lair ahead. Fight?")) startBattle(t, true, false); }
    function checkArenaEntry() { if (document.getElementById('arena-modal').classList.contains('active')) return; const t = gameState.inventory['arena_ticket'] || 0; document.getElementById('arena-ticket-display').innerText = `(You have: ${t})`; document.getElementById('arena-modal').classList.add('active'); document.getElementById('enter-arena-btn').onclick = () => { if (t > 0) { gameState.inventory['arena_ticket']--; closeArenaModal(); startBattle(8, false, true); } else { showToast("No tickets!", "error"); closeArenaModal(); } }; }
    function closeArenaModal() { document.getElementById('arena-modal').classList.remove('active'); }

    async function loadAssignmentAndQuestions(a) { if (!a || !a.grade || !a.topics || a.topics.length === 0) { gameState.activeQuestionPool = []; return false; } gameState.activeQuestionPool = []; for (const val of a.topics) { if (val.startsWith('INTERNAL:')) { const k = val.replace('INTERNAL:', ''); const q = QUESTION_REPOSITORY[a.grade][k]; if (q) gameState.activeQuestionPool = gameState.activeQuestionPool.concat(q); } else { try { const res = await fetch(val); if (res.ok) { const q = await res.json(); if (Array.isArray(q)) gameState.activeQuestionPool = gameState.activeQuestionPool.concat(q); } } catch (err) {} } } if (gameState.activeQuestionPool.length === 0) return false; return true; }

    document.getElementById('check-btn').addEventListener('click', () => checkAnswer());
    document.getElementById('answer-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
    document.getElementById('setup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const n = document.getElementById('student-name').value.trim(); const p = document.getElementById('student-pass').value.trim();
      if (!n || !p) { showToast("Enter credentials!", "error"); return; }
      const auth = await authenticateStudent(n, p);
      if (!auth.success) { showToast(auth.message, "error"); return; }
      gameState.playerName = n; loadExternalPets();
      const cloudLoaded = await loadProgressFromFirebase(n);
      if (!cloudLoaded || gameState.pets.length === 0) if (gameState.pets.length === 0) initializeGame();
      if (auth.assignment?.grade) { gameState.grade = auth.assignment.grade; gameState.selectedTopics = auth.assignment.topics || []; }
      await loadAssignmentAndQuestions(auth.assignment);
      checkDailyLogin();
      document.getElementById('display-name').innerText = gameState.playerName; 
      document.getElementById('display-grade').innerText = `Grade: ${gameState.grade}`;
      updateStatsDisplay();
      
      // --- START OF FIX ---
      
      // 1. Hide the Login Screen completely
      document.getElementById('login-overlay').style.display = 'none';
      
      // 2. Show the Game UI (We use 'flex' to maintain your layout)
      // Note: If this line causes an error, check that your HTML div has id="main-game-ui"
      document.getElementById('main-game-ui').style.display = 'flex'; 
      
      // --- END OF FIX ---
      
      soundManager.playBGM('hub'); 
      generateNextQuestion(); 
      renderHub();
    });

    function loadExternalPets() {
        EXTERNAL_PET_DATA.forEach(line => {
            if (PET_TYPES[line.base.rarity]) {
                if (!PET_TYPES[line.base.rarity].find(p => p.id === line.base.id)) { PET_TYPES[line.base.rarity].push(line.base); }
            }
            if (line.evolutions && Array.isArray(line.evolutions)) { EVOLUTION_CHAINS[line.base.id] = line.evolutions; }
        });
    }

    function initializeGame() { 
        // Create Starter Cat
        const starterId = 'starter_cat';
        gameState.pets.push({ 
            id: starterId, type: 'monster_01', emoji: 'üê±', 
            image: 'https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/mons/V2/1.png', 
            imageStyle: 'blend-multiply', name: 'Cat', 
            hatchProgress: 100, isHatched: true, hp: 40, maxHP: 40, 
            powers: ['claw_attack'], rarity: 'common', evolutionStage: 0, 
            level: 1, xp: 0, maxXp: 300, element: 'normal' 
        }); 

        // Create Starter Egg
        const eggPool = PET_TYPES.common;
        const base = eggPool[Math.floor(Math.random() * eggPool.length)];
        const freeEgg = JSON.parse(JSON.stringify(base));
        freeEgg.id = 'starter_egg_' + Date.now(); 
        freeEgg.type = base.id; freeEgg.isHatched = false; 
        freeEgg.hatchProgress = 0; freeEgg.level = 1; freeEgg.xp = 0; 
        freeEgg.maxXp = 100; freeEgg.powers = []; freeEgg.maxHP = base.baseHP; 
        freeEgg.hp = base.baseHP;
        gameState.pets.push(freeEgg);

        // --- SQUAD UPDATE ---
        gameState.team = [starterId]; 
        // --------------------

        gameState.currentPetId = starterId; 
        gameState.brainPoints = 100; 
        gameState.stamina = 100; 
        gameState.inventory['arena_ticket'] = 1; 
    }
    
    // --- DAILY LOGIN LOGIC ---
    function checkDailyLogin() {
        const today = new Date().toDateString();
        if (gameState.lastLoginDate !== today) {
            if (isConsecutiveDay(gameState.lastLoginDate, today)) { gameState.dailyStreak++; } else { gameState.dailyStreak = 1; }
            gameState.lastLoginDate = today;
            saveGame();
            showDailyModal();
        }
    }
    function isConsecutiveDay(lastStr, todayStr) {
        if(!lastStr) return false;
        const last = new Date(lastStr); const now = new Date(todayStr);
        const diff = (now - last) / (1000 * 3600 * 24);
        return diff >= 0.9 && diff < 2.1;
    }
    function showDailyModal() {
        const c = document.getElementById('daily-calendar'); c.innerHTML='';
        const days = ['50 BP', 'Potion', '100 BP', 'Potion', '200 BP', 'Rare Egg', 'EPIC EGG!'];
        let streak = gameState.dailyStreak > 7 ? (gameState.dailyStreak % 7) || 7 : gameState.dailyStreak;
        days.forEach((reward, i) => {
            const dayNum = i+1;
            let cls = 'calendar-day';
            if (dayNum < streak) cls += ' claimed';
            if (dayNum === streak) cls += ' active';
            c.innerHTML += `<div class="${cls}"><div>Day ${dayNum}</div><div style="font-weight:bold; font-size:12px;">${reward}</div></div>`;
        });
        
        // Give Reward
        const r = days[streak-1];
        if(r.includes('BP')) addBP(parseInt(r));
        if(r.includes('Potion')) { gameState.inventory['health_potion']=(gameState.inventory['health_potion']||0)+1; showToast("Got Daily Potion!", "success"); }
        if(r.includes('Rare')) { showToast("Free Rare Egg next battle!", "info"); } // Placeholder logic
        document.getElementById('daily-modal').classList.add('active');
    }

    function generateNextQuestion() { 
        let q;
        if (!gameState.activeQuestionPool || gameState.activeQuestionPool.length === 0) { q = MathEngine.generate(gameState.grade); } 
        else { q = gameState.activeQuestionPool[Math.floor(Math.random() * gameState.activeQuestionPool.length)]; }
        gameState.currentQuestion = q; 
        document.getElementById('question-visual-container').innerHTML = q.qVisualHTML || ''; 
        document.getElementById('question-text').innerHTML = q.q; 
        document.getElementById('feedback').innerText = ''; 
        document.getElementById('input-mode-container').style.display = 'none'; 
        const c = document.getElementById('mcq-mode-container'); c.style.display = 'grid'; c.innerHTML = ''; 
        const options = q.options || MathEngine.generateDistractors(parseFloat(q.a));
        options.forEach(opt => { const b = document.createElement('div'); b.className = 'mcq-btn'; b.innerText = opt; b.onclick = () => checkAnswer(opt); c.appendChild(b); }); 
    }

    // UPDATED MATH LOGIC: CONNECTS MATH TO BATTLE (BURST MODE)
    function checkAnswer(val) { 
        let input = val; 
        if (input === undefined) { 
            input = document.getElementById('answer-input').value; 
            if(typeof gameState.currentQuestion.a === 'number') input = parseFloat(input); 
        } 
        
        const fb = document.getElementById('feedback'); 
        
        if (input == gameState.currentQuestion.a) { 
            // Correct Answer
            soundManager.playSFX('correct'); 
            addBP(10); 
            
            // COMBO LOGIC
            gameState.combo = (gameState.combo || 0) + 1;
            
            if (gameState.combo >= 3) {
                gameState.burstMode = true; // <--- THIS FLAG IS KEY
                fb.innerText = "üî• BRAIN BURST ACTIVATED! Next Attack CRIT! üî•";
                fb.className = "feedback correct";
                // Visual feedback
                document.querySelector('.quiz-container').style.boxShadow = "0 0 30px #f6e05e";
            } else {
                fb.innerText = `Correct! Streak: ${gameState.combo}`; 
                fb.className = "feedback correct";
                document.querySelector('.quiz-container').style.boxShadow = "none";
            }
            
            setTimeout(() => {
                generateNextQuestion(); 
                // Reset visual glow after moving to next question
                if(gameState.combo < 3) document.querySelector('.quiz-container').style.boxShadow = "none";
            }, 1000); 

        } else { 
            // Wrong Answer
            const d = Math.min(gameState.brainPoints, 5); 
            gameState.brainPoints -= d; 
            updateStatsDisplay(); 
            
            gameState.combo = 0; 
            gameState.burstMode = false; // Lose the buff
            document.querySelector('.quiz-container').style.boxShadow = "none";
            
            saveGame(); 
            fb.innerText = `Incorrect! -${d} BP`; 
            fb.className = "feedback incorrect"; 
            soundManager.playSFX('wrong'); 
        } 
    }
    function addBP(a) { gameState.brainPoints += a; updateStatsDisplay(); saveGame(); }

    // --- SQUAD SYSTEM ---

    // 1. Toggle Logic
    function toggleSquadMember(petId) {
        if (!gameState.team) gameState.team = [];
        
        const idx = gameState.team.indexOf(petId);
        if (idx > -1) {
            if (gameState.team.length <= 1) return showToast("Squad cannot be empty!", "error");
            gameState.team.splice(idx, 1);
            showToast("Removed from Squad", "info");
        } else {
            if (gameState.team.length >= 6) return showToast("Squad Full (Max 6)!", "error");
            gameState.team.push(petId);
            showToast("Added to Squad", "success");
        }
        saveGame();
        renderHub(); // Refresh UI
    }

    // 2. Helper: Get Squad Objects
    function getSquad() {
        if (!gameState.team || gameState.team.length === 0) return [gameState.pets.find(p => p.id === gameState.currentPetId)];
        return gameState.team.map(id => gameState.pets.find(p => p.id === id)).filter(p => p !== undefined);
    }

    function renderHub() {
      const c = document.getElementById('hub-content'); const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
      if (!p) { c.innerHTML = "<div class='no-pet-message'>No pet selected.</div>"; return; }
      
      if (!gameState.team) gameState.team = [p.id]; // Safety

      if(!p.level) p.level = 1; if(!p.xp) p.xp = 0; if(!p.maxXp) p.maxXp = 100; const currentStage = typeof p.evolutionStage === 'number' ? p.evolutionStage : 0;
      
      let v = p.image ? `<img src="${p.image}" class="pet-image ${p.imageStyle||''}" alt="${p.name}">` : `<div style="font-size:80px">${p.emoji}</div>`;
      
      if (!p.isHatched) { 
          c.innerHTML = `<div style="text-align:center; padding:20px;"><h2>ü•ö Incubator</h2><div class="pet-visual" style="font-size:100px;">ü•ö</div><h3>${p.isHatched ? p.name : "Mystery Egg"}</h3><div style="margin:20px 0;">${p.hatchProgress}% <div class="hatch-bar-container"><div class="hatch-bar" style="width: ${p.hatchProgress}%;"></div></div></div>${p.hatchProgress >= 100 ? `<button class="action-btn green" onclick="hatchPet()">‚ú® HATCH NOW! ‚ú®</button>` : `<p style="color:#718096">Use Items in Shop to speed up!</p>`}<div style="margin-top:20px;">${renderInventory(true)}</div></div><div class="pet-collection">${renderCollection()}</div>`; return; 
      }
      
      let ch = EVOLUTION_CHAINS[p.type]; 
      const nextEvo = (ch && ch[currentStage]) ? ch[currentStage] : null;
      const can = nextEvo && p.level >= nextEvo.level;

      let ev = nextEvo ? `<div class="evolution-info"><h3>üß¨ Evolution</h3><p>Next: <strong>${nextEvo.name || ('Teen ' + p.name)}</strong></p><button class="evolution-btn" ${can?'':'disabled'} onclick="evolvePet()">${can?`‚ú® Evolve (Lvl ${nextEvo.level})`:`üîí Need Level ${nextEvo.level}`}</button></div>` : `<div class="evolution-info" style="background:#fef3c7"><h3>üëë Max Level</h3></div>`;
      
      // SQUAD UI (NEW)
      const isInSquad = gameState.team ? gameState.team.includes(p.id) : false;
      const squadBtnColor = isInSquad ? 'red' : 'blue';
      const squadBtnText = isInSquad ? 'Remove from Squad' : 'Add to Squad';
      const squadDisplay = `
        <div style="margin-top:10px; padding:10px; background:#edf2f7; border-radius:8px; font-size:14px;">
            <div style="display:flex; justify-content:space-between;">
                <strong>üõ°Ô∏è Squad (${(gameState.team||[]).length}/6)</strong>
                <button class="action-btn ${squadBtnColor}" style="width:auto; padding:5px 10px; font-size:11px; margin:0;" onclick="toggleSquadMember('${p.id}')">${squadBtnText}</button>
            </div>
            <div style="display:flex; gap:5px; margin-top:5px; overflow-x:auto;">
                ${(gameState.team||[]).map(tid => {
                    const mp = gameState.pets.find(x => x.id === tid);
                    return `<div style="width:20px; height:20px; background:white; border-radius:50%; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; font-size:12px;">${mp ? (mp.emoji || 'üêæ') : '?'}</div>`
                }).join('')}
            </div>
        </div>`;

      c.innerHTML = `<div class="hub-grid"><div class="hub-left"><div class="pet-display"><div class="pet-visual">${v}</div><div class="pet-name">Lvl ${p.level} ${p.name} <span class="rarity-badge rarity-${p.rarity}">${p.rarity}</span></div><div style="font-size:12px;">XP: ${p.xp} / ${p.maxXp}</div><div class="xp-bar-container"><div class="xp-bar" style="width: ${(p.xp/p.maxXp)*100}%"></div></div><button class="action-btn red" style="margin-top:15px;" onclick="releasePet()">Release</button></div></div><div class="hub-right"><div class="inventory-section"><h3>Stats</h3><div class="pet-stats"><div class="stat-box"><div class="stat-label">HP</div><div class="stat-value">${p.hp}/${p.maxHP}</div></div><div class="stat-box"><div class="stat-label">Power</div><div class="stat-value">${p.powers.length}/4</div></div></div>${squadDisplay}</div>${ev}<div class="inventory-section"><h3>üéí Inventory</h3>${renderInventory(false)}</div><div class="inventory-section"><h3>‚öîÔ∏è Powers</h3>${renderPowersList(p)}</div></div></div><div class="pet-collection">${renderCollection()}</div>`;
    }
    
    function renderCollection() { return gameState.pets.map(p => `<div class="pet-card ${p.id===gameState.currentPetId?'active':''}" onclick="switchPet('${p.id}')"><div class="pet-card-visual">${!p.isHatched?'ü•ö':(p.image?`<img src="${p.image}" class="${p.imageStyle}" style="width:40px;height:40px;">`:p.emoji)}</div><div style="font-size:12px;">${p.isHatched ? p.name : "Mystery Egg"}</div></div>`).join(''); }

    function renderInventory(isEgg) { 
    let h = ""; 
    const i = gameState.inventory;
    
    // Helper to generate button
    const btn = (key, name, icon) => {
        const count = i[key] || 0;
        if(count <= 0) return '';
        
        // --- LOGIC CHANGE: Only allow Bulk Mode for XP Potion ---
        const action = (key === 'xp_potion' && count > 1) 
            ? `openUseQuantityModal('${key}')` 
            : `useItem('${key}')`;

        return `<div class="inventory-item">
            <div style="font-size:20px;">${icon}</div>
            <div style="font-weight:bold; font-size:12px;">x${count}</div>
            <button class="buy-btn" style="padding:4px 8px; font-size:12px;" onclick="${action}">Use</button>
        </div>`;
    };

    if(!isEgg) { 
        h += btn('health_potion', 'Health', 'üß™');
        h += btn('stamina_potion', 'Stamina', '‚ö°');
        h += btn('xp_potion', 'XP Potion', 'üåü');
    } else { 
        if(i['premium_food']) h += `<div class="inventory-item"><div>ü•©</div><div>x${i['premium_food']}</div><button class="buy-btn" onclick="useItem('premium_food')">+20%</button></div>`; 
        if(i['warmer']) h += `<div class="inventory-item"><div>üî•</div><div>x${i['warmer']}</div><button class="buy-btn" onclick="useItem('warmer')">+10%</button></div>`; 
        if(i['hatching_machine']) h += `<div class="inventory-item"><div>‚öôÔ∏è</div><div>x${i['hatching_machine']}</div><button class="buy-btn" onclick="useItem('hatching_machine')">+50%</button></div>`; 
    }
    
    return h || "<p style='color:#718096'>Empty.</p>";
}
    function renderPowersList(p) { return p.powers.length===0?"None.":p.powers.map(pid=>{const i=findShopItem(pid);return i?`<div style="padding:5px;">${i.image?`<img src="${i.image}" style="width:20px;">`:i.icon} ${i.name}</div>`:'';}).join(''); }
    function switchPet(id) { gameState.currentPetId = id; saveGame(); renderHub(); }
    
    function hatchPet() { 
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        if(p.hatchProgress>=100) { 
            p.isHatched=true; 
            for(const r in PET_TYPES) { 
                const f=PET_TYPES[r].find(b=>b.id===p.type); 
                if(f) { p.name=f.name; p.element = f.element; p.maxHP = f.baseHP; p.hp = f.baseHP; } 
            } 
            // Auto add to squad if space
            if (!gameState.team) gameState.team = [];
            if (gameState.team.length < 6 && !gameState.team.includes(p.id)) { gameState.team.push(p.id); }

            const m = document.getElementById('hatch-modal');
            const v = document.getElementById('hatch-egg-visual');
            const t = document.getElementById('hatch-text');
            const l = document.getElementById('hatch-light');
            const b = document.getElementById('hatch-finish-btn');
            m.style.display = 'flex'; v.innerHTML = 'ü•ö'; v.className = 'egg-shaking'; t.innerText = "It's hatching..."; b.style.display = 'none';
            setTimeout(() => { l.style.animation = "flashWhite 1s forwards"; soundManager.playSFX('levelUp'); }, 2000);
            setTimeout(() => { v.className = ''; v.innerHTML = p.image ? `<img src="${p.image}" class="pet-image ${p.imageStyle}" style="width:300px; height:300px;">` : p.emoji; v.style.animation = "petPopIn 0.8s"; t.innerText = `Hatched ${p.name}!`; b.style.display = 'block'; saveGame(); renderHub(); }, 2500);
            b.onclick = () => { m.style.display = 'none'; };
        } 
    }

    // WILDS QUICK ITEM USAGE
    function quickUseItem(id) {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId);
        if (!gameState.inventory[id] || gameState.inventory[id] <= 0) { showToast("You don't have any!", "error"); return; }
        if (id === 'health_potion') {
            if (p.hp >= p.maxHP) return showToast("HP is full!", "info");
            gameState.inventory[id]--;
            p.hp = Math.min(p.hp + 30, p.maxHP);
            showToast("Used Potion! (+30 HP)", "success");
            soundManager.playSFX('heal'); 
        } else if (id === 'stamina_potion') {
            if (gameState.stamina >= 100) return showToast("Stamina full!", "info");
            gameState.inventory[id]--;
            gameState.stamina = Math.min(gameState.stamina + 50, 100);
            showToast("Used Energy! (+50)", "success");
        }
        updateStatsDisplay();
        document.getElementById('wild-hp-display').innerText = `HP: ${p.hp}/${p.maxHP}`;
        saveGame();
    }

    function useItem(id) {
        if(gameState.inventory[id]>0) {
            const p = gameState.pets.find(pet=>pet.id===gameState.currentPetId); const maxLvl = LEVEL_CAPS[p.rarity] || 100;
            if(id==='health_potion') { if(p.hp >= p.maxHP) return showToast("Health is already full!", "error"); p.hp=Math.min(p.hp+30,p.maxHP); showToast("Healed!", "success"); }
            else if(id==='stamina_potion') { if(gameState.stamina >= 100) return showToast("Stamina is full!", "error"); gameState.stamina=Math.min(gameState.stamina+50,100); updateStatsDisplay(); showToast("Stamina Up!", "success"); }
            else if(id==='xp_potion') { if(p.level>=maxLvl) return showToast("Max Level!", "error"); gameState.inventory[id]--; p.xp+=100; if(p.xp>=p.maxXp && p.level<maxLvl) { p.level++; p.xp=0; p.maxXp=p.level*300+200; p.maxHP+=10; p.hp=p.maxHP; showToast("Level Up!", "success"); soundManager.playSFX('levelUp'); } else showToast("+100 XP", "success"); saveGame(); renderHub(); return; }
            else if(id==='premium_food') p.hatchProgress=Math.min(100,p.hatchProgress+20); else if(id==='warmer') p.hatchProgress=Math.min(100,p.hatchProgress+10); else if(id==='hatching_machine') p.hatchProgress=Math.min(100,p.hatchProgress+50);
            if(id !== 'xp_potion') gameState.inventory[id]--; 
            saveGame(); renderHub();
        }
    }
    
    async function evolvePet() {
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        let ch = EVOLUTION_CHAINS[p.type]; 
        if (!ch) return showToast(`Error: Evolution data missing`, "error");
        const currentStage = typeof p.evolutionStage === 'number' ? p.evolutionStage : 0;
        if (!ch[currentStage]) return showToast("Max Evolution!", "info");
        const next = ch[currentStage];
        if (p.level < next.level) { showToast(`Need Lvl ${next.level} to evolve!`, "error"); return; }
        if (gameState.brainPoints < next.cost) { showToast(`Need ${next.cost} BP to evolve!`, "error"); return; }
        let newName = next.name || ("Teen " + p.name);

        const m = document.getElementById('evolution-modal'); const c = document.getElementById('evo-pet-container'); m.style.display = 'flex'; 
        document.getElementById('evo-message-1').innerText = ""; document.getElementById('evo-message-2').innerText = "";
        document.getElementById('evo-continue-btn').style.display='none';
        c.innerHTML = p.image ? `<img src="${p.image}" class="evo-pet-image ${p.imageStyle}">` : p.emoji; c.classList.remove('flash-and-scale');
        
        setTimeout(() => { document.getElementById('evo-message-1').innerText = "The aura is changing..."; document.getElementById('evo-message-1').style.opacity = 1; }, 500);
        setTimeout(() => { 
            gameState.brainPoints -= next.cost; updateStatsDisplay();
            p.name = newName; p.image = next.image; p.imageStyle = next.imageStyle; p.rarity = next.rarity; p.maxHP = next.baseHP; p.hp = p.maxHP; p.evolutionStage = currentStage + 1;
            if (next.element) p.element = next.element;
            c.innerHTML = next.image ? `<img src="${next.image}" class="evo-pet-image ${next.imageStyle}">` : next.emoji; c.classList.add('flash-and-scale'); soundManager.playSFX('levelUp'); 
        }, 3000);
        setTimeout(() => { document.getElementById('evo-message-2').innerText = `Evolved into ${newName}!`; document.getElementById('evo-message-2').style.opacity = 1; document.getElementById('evo-continue-btn').style.display = 'block'; }, 5000);
        document.getElementById('evo-continue-btn').onclick = () => { m.style.display = 'none'; saveGame(); renderHub(); };
    }
    
    function renderShop() {
        const c = document.getElementById('shop-content'); let h = `<div class="shop-section" style="text-align:center; background:#f3e8ff; padding:15px; border-radius:15px; border:2px solid #a855f7; margin-bottom:30px;"><h2 style="color:#6b21a8; border-bottom:none;">üîÆ Legendary Summon</h2><button class="gacha-btn" onclick="buyGacha()">SUMMON (5000 BP)</button></div>`;
        [{t:'ü•ö Egg Care',i:SHOP_ITEMS.egg_items,k:'egg'},{t:'‚öîÔ∏è Powers',i:SHOP_ITEMS.power_items,k:'power'},{t:'üß™ Consumables',i:SHOP_ITEMS.consumable_items,k:'consumable'}].forEach(cat=>{ h+=`<div class="shop-section"><h2>${cat.t}</h2><div class="shop-items">${cat.i.map(item=>`<div class="shop-item"><div style="height:50px;display:flex;align-items:center;justify-content:center;">${item.image?`<img src="${item.image}" style="width:40px;">`:item.icon}</div><div style="font-weight:bold;">${item.name}</div><div class="shop-item-price">üß† ${item.price}</div><button class="buy-btn" onclick="${cat.k==='power'?`buyItem('${item.id}','power')`:`openQuantityModal('${item.id}')`}">Buy</button></div>`).join('')}</div></div>`; }); c.innerHTML = h;
    }
    function buyGacha() {
        if(gameState.brainPoints<5000) { showToast("Need 5000 BP!", "error"); return; }
        gameState.brainPoints-=5000; updateStatsDisplay(); saveGame();
        const pulls=[]; for(let i=0;i<3;i++){ const r=Math.random(); const pool=r<0.75?PET_TYPES.rare:(r<0.95?PET_TYPES.epic:PET_TYPES.legendary); const p=pool[Math.floor(Math.random()*pool.length)]; pulls.push({id:'p'+Date.now()+i,type:p.id,name:p.name,image:p.image,imageStyle:p.imageStyle,emoji:p.emoji,rarity:p.rarity||'rare',hp:p.baseHP,maxHP:p.baseHP,powers:[],isHatched:true,hatchProgress:100,evolutionStage:0,level:1,xp:0,maxXp:100,element:p.element}); }
        gameState.pets.push(...pulls); startGachaAnimation(pulls);
    }
    function startGachaAnimation(pulls) { soundManager.playSFX('gacha'); document.getElementById('gacha-cinematic-modal').style.display='flex'; document.getElementById('gacha-flash-overlay').style.animation='gachaFlash 1s ease-out 1.5s'; setTimeout(()=>revealNextPet(pulls,0), 2500); }
    function revealNextPet(pulls,i) { const p=pulls[i]; const c=document.getElementById('pet-reveal-container'); c.innerHTML=''; const vis = p.image?`<img src="${p.image}" class="gacha-reveal-visual ${p.imageStyle}">`:`<div style="font-size:100px">${p.emoji}</div>`; const el = document.createElement('div'); el.className=`gacha-pet-reveal ${p.rarity}`; el.style.animation='petPopIn 1s forwards'; el.innerHTML = `<div class="rarity-badge rarity-${p.rarity}">${p.rarity}</div>${vis}<div style="font-weight:bold;margin-top:15px;">${p.name}</div>`; c.appendChild(el); const ctrl = document.getElementById('gacha-cinematic-controls'); ctrl.innerHTML=''; ctrl.style.opacity=1; const btn = document.createElement('button'); btn.className='gacha-btn'; btn.innerText=i<2?'Continue':'Finish'; btn.onclick=()=>i<2?revealNextPet(pulls,i+1):closeGachaCinematic(pulls); ctrl.appendChild(btn); }
    function closeGachaCinematic(pulls) { document.getElementById('gacha-cinematic-modal').style.display='none'; const c=document.getElementById('gacha-reveal-container'); c.innerHTML=pulls.map(p=>`<div class="gacha-card"><div>${p.image?`<img src="${p.image}" class="${p.imageStyle}" style="width:60px;">`:p.emoji}</div><div>${p.name}</div><div class="rarity-badge rarity-${p.rarity}">${p.rarity}</div></div>`).join(''); document.getElementById('gacha-reveal-modal').classList.add('active'); }
    function closeGacha() { document.getElementById('gacha-reveal-modal').classList.remove('active'); switchTab('hub'); }
    function findShopItem(id) { for(const k in SHOP_ITEMS) { const f=SHOP_ITEMS[k].find(i=>i.id===id); if(f) return f; } return null; }
    function buyItem(id, type) { const item=findShopItem(id); if(gameState.brainPoints<item.price) return showToast("Not enough BP", "error"); const p=gameState.pets.find(pet=>pet.id===gameState.currentPetId); if(type==='power') { if(p.powers.includes(id)) return; if(p.powers.length>=4) { openReplaceModal(item); return; } p.powers.push(id); } else { gameState.inventory[id]=(gameState.inventory[id]||0)+1; } gameState.brainPoints-=item.price; saveGame(); updateStatsDisplay(); renderShop(); showToast("Bought!", "success"); }
    function openQuantityModal(id) { currentBuyingItem=findShopItem(id); const max=Math.floor(gameState.brainPoints/currentBuyingItem.price); if(max===0) return showToast("Too expensive!", "error"); document.getElementById('quantity-modal').classList.add('active'); const sl=document.getElementById('quantity-slider'); sl.max=max; sl.value=1; document.getElementById('qty-item-name').innerText=`Buy ${currentBuyingItem.name}`; document.getElementById('qty-buy-confirm-btn').onclick=()=>confirmBulkBuy(currentBuyingItem.price); updateQuantityModalDisplay(1,currentBuyingItem.price); sl.oninput=(e)=>updateQuantityModalDisplay(e.target.value,currentBuyingItem.price); }
    function updateQuantityModalDisplay(q,p) { document.getElementById('quantity-label').innerText=`Qty: ${q}`; document.getElementById('qty-cost-display').innerText=`Total: ${q*p} BP`; document.getElementById('qty-buy-confirm-btn').innerText=`Buy ${q}`; }
    function confirmBulkBuy(p) { const q=parseInt(document.getElementById('quantity-slider').value); if(gameState.brainPoints<q*p) return; gameState.brainPoints-=q*p; gameState.inventory[currentBuyingItem.id]=(gameState.inventory[currentBuyingItem.id]||0)+q; saveGame(); updateStatsDisplay(); renderShop(); document.getElementById('quantity-modal').classList.remove('active'); showToast(`Bought ${q}!`, "success"); }
    function openReplaceModal(item) { gameState.tempMoveToLearn=item; document.getElementById('new-move-name').innerText=item.name; const list=document.getElementById('replace-move-list'); list.innerHTML=''; const p=gameState.pets.find(pet=>pet.id===gameState.currentPetId); p.powers.forEach((pid,i)=>{const m=findShopItem(pid); const d=document.createElement('div'); d.className='move-replace-btn'; d.innerHTML=`${m.name} <span>üóëÔ∏è</span>`; d.onclick=()=>confirmReplaceMove(i); list.appendChild(d);}); document.getElementById('replace-move-modal').classList.add('active'); }
    function closeReplaceModal() { document.getElementById('replace-move-modal').classList.remove('active'); gameState.tempMoveToLearn=null; }
    function confirmReplaceMove(i) { const p=gameState.pets.find(pet=>pet.id===gameState.currentPetId); p.powers.splice(i,1); p.powers.push(gameState.tempMoveToLearn.id); gameState.brainPoints-=gameState.tempMoveToLearn.price; saveGame(); renderShop(); closeReplaceModal(); showToast("Move Learned!", "success"); }
    // ==========================================
    // FIXED EXPLORATION & MAP ENGINE
    // (Paste this ABOVE 'function getArenaEnemy')
    // ==========================================

    function startExploration() { 
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        
        // 1. Safety Checks
        if(!p) { showToast("No pet selected!", "error"); return; }
        if(p.hp <= 0) { showToast("Your pet has fainted! Heal first.", "error"); return; }
        if(!p.isHatched) { showToast("You need a hatched pet!", "error"); return; }
        if(!p.powers || p.powers.length === 0) { showToast("You need at least 1 power!", "error"); return; }
        if(gameState.stamina <= 0) { showToast("No Stamina! Study to get Energy.", "error"); return; }
        
        // 2. Prepare Game State
        gameState.inBattle = false; 
        gameState.battleState = null; 
        
        // 3. Switch Screens
        document.getElementById('wilds-menu').style.display = 'none'; 
        document.getElementById('rpg-wrapper').style.display = 'block'; 
        
        // 4. Start the Map Engine
        initRPG(); 
        soundManager.playBGM('wilds'); 
    }

    function stopExploration() { 
        document.getElementById('wilds-menu').style.display = 'block'; 
        document.getElementById('rpg-wrapper').style.display = 'none'; 
        soundManager.playBGM('hub'); 
    }

    function initRPG() {
      // Initialize Canvas
      canvas = document.getElementById('rpg-canvas'); 
      ctx = canvas.getContext('2d');
      
      const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
      
      // Load Player Sprite
      if (pet && pet.image && pet.image.length > 5) {
          playerImage.src = pet.image; 
      } else {
          playerImage.src = HUMAN_SPRITE_URL; 
      }
      
      injectRandomArena(); 
      
      // Draw Map
      if(playerImage.complete) {
          drawMap();
      } else {
          playerImage.onload = () => drawMap(); 
      }
      
      // Attach Controls
      document.removeEventListener('keydown', handleKeyDown); 
      document.addEventListener('keydown', handleKeyDown);
      initSwipe(); 
      
      // Click Interaction
      canvas.onclick = (e) => {
          if (gameState.inBattle) return; 
          const rect = canvas.getBoundingClientRect(); 
          const clickX = (e.clientX - rect.left) * (canvas.width / rect.width); 
          const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
          const tileX = Math.floor(clickX / TILE_SIZE); 
          const tileY = Math.floor(clickY / TILE_SIZE);
          
          if (tileX < 0 || tileX >= MAP_COLS || tileY < 0 || tileY >= MAP_ROWS) return;
          
          // Check distance
          if (Math.abs(tileX - gameState.mapX) + Math.abs(tileY - gameState.mapY) <= 2) { 
              const t = currentMapData[tileY][tileX]; 
              if (t === 8) checkArenaEntry(); 
              else if (t === 7) confirmBossBattle(7); 
          }
      };
      
      // Update UI
      document.getElementById('wild-hp-display').innerText = `HP: ${pet.hp}/${pet.maxHP}`;
    }

    function drawMap() {
      if (!ctx) return; 
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw Tiles
      for (let r = 0; r < MAP_ROWS; r++) {
        for (let c = 0; c < MAP_COLS; c++) {
          const tile = currentMapData[r][c]; 
          const x = c * TILE_SIZE; 
          const y = r * TILE_SIZE;
          
          if (tile === 2) { ctx.fillStyle = '#2e7d32'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '24px Arial'; ctx.fillStyle = '#1b5e20'; ctx.fillText('üå≤', x+5, y+30); } 
          else if (tile === 3) { ctx.fillStyle = '#4fc3f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#0288d1'; ctx.fillText('~', x+10, y+25); } 
          else if (tile === 1) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#388e3c'; ctx.fillText('w', x+5, y+15); ctx.fillText('w', x+20, y+30); } 
          else if (tile === 4) { ctx.fillStyle = '#f6e05e'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '10px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('.', x+10, y+15); ctx.fillText('.', x+25, y+30); }
          else if (tile === 5) { ctx.fillStyle = '#e2e8f0'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#cbd5e0'; ctx.fillText('‚ùÑÔ∏è', x+8, y+26); }
          else if (tile === 6) { ctx.fillStyle = '#66bb6a'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#ed64a6'; ctx.fillText('üå∏', x+5, y+28); }
          else if (tile === 9) { ctx.fillStyle = '#4a5568'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '20px Arial'; ctx.fillStyle = '#2d3748'; ctx.fillText('ü™®', x+8, y+28); }
          else if (tile === 7) { ctx.fillStyle = '#2d3748'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '16px Arial'; ctx.fillStyle = '#e53e3e'; ctx.fillText('üíÄ', x+10, y+25); } 
          else if (tile === 8) { 
              if (arenaIcon.complete && arenaIcon.naturalWidth > 0) { 
                  ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.drawImage(arenaIcon, x, y, TILE_SIZE, TILE_SIZE); 
              } else { 
                  ctx.fillStyle = '#edf2f7'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); ctx.font = '18px Arial'; ctx.fillStyle = '#d69e2e'; ctx.fillText('üèüÔ∏è', x+5, y+28); 
              } 
          } 
          else { ctx.fillStyle = '#d7ccc8'; ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE); }
        }
      }
      
      // Draw Player
      const px = gameState.mapX * TILE_SIZE; 
      const py = gameState.mapY * TILE_SIZE;
      
      // Selection Box
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)'; 
      ctx.lineWidth = 3; 
      ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE);
      
      if (playerImage.complete && playerImage.naturalWidth !== 0) {
          ctx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE);
      } else { 
          // Fallback circle if image fails
          ctx.fillStyle = 'red'; 
          ctx.beginPath(); 
          ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, TILE_SIZE/3, 0, Math.PI * 2); 
          ctx.fill(); 
          ctx.strokeStyle = 'white'; 
          ctx.lineWidth = 2; 
          ctx.stroke(); 
      }
      
      // Map Name
      ctx.font = "bold 14px Arial"; 
      ctx.fillStyle = "rgba(0,0,0,0.5)"; 
      ctx.fillRect(5, 5, 120, 25); 
      ctx.fillStyle = "white"; 
      ctx.fillText(currentMapName || "Wilds", 10, 22);
    }
    function getArenaEnemy() { const pool = [...PET_TYPES.rare, ...PET_TYPES.epic, ...PET_TYPES.legendary]; const base = pool[Math.floor(Math.random() * pool.length)]; return { name: "Champion " + base.name, image: base.image, imageStyle: base.imageStyle, emoji: base.emoji, hp: Math.floor(base.baseHP * 2.5), damage: Math.floor(base.baseHP * 0.3), xp: 100 }; }
    
    function getScaledEnemy(baseEnemyTemplate, playerLevel) {
        let enemy = JSON.parse(JSON.stringify(baseEnemyTemplate));
        const hpGrowth = (playerLevel - 1) * 5; 
        const dmgGrowth = Math.floor((playerLevel - 1) * 0.4);
        const xpGrowth = (playerLevel - 1) * 15; 
        enemy.hp = (enemy.hp || 30) + hpGrowth;
        enemy.damage = (enemy.damage || 5) + dmgGrowth;
        enemy.xp = (enemy.xp || 10) + xpGrowth;
        enemy.hp = Math.floor(enemy.hp * (0.9 + (Math.random() * 0.2)));
        enemy.hp = Math.max(10, enemy.hp);
        enemy.name = `Lvl ${playerLevel} ${enemy.name}`;
        return enemy;
    }
    
    function getBattlerSize(entity, isBoss, isArena) {
        let size = 200; 
        const stage = entity.evolutionStage !== undefined ? entity.evolutionStage : (entity.level > 20 ? 2 : (entity.level > 10 ? 1 : 0));
        if (stage === 0) size = 180; else if (stage === 1) size = 240; else if (stage >= 2) size = 300; 
        if (isArena) size = 220; if (isBoss) size = 350; 
        return size;
    }

    const TYPE_CHART = { fire: { strong: ['grass', 'ice'], weak: ['water', 'earth', 'rock'] }, water: { strong: ['fire', 'earth', 'rock'], weak: ['grass', 'electric'] }, grass: { strong: ['water', 'earth', 'rock'], weak: ['fire', 'ice', 'wind'] }, electric: { strong: ['water', 'wind'], weak: ['earth'] }, earth: { strong: ['fire', 'electric'], weak: ['water', 'grass', 'ice'] }, ice: { strong: ['grass', 'wind'], weak: ['fire'] }, wind: { strong: ['grass'], weak: ['electric', 'ice'] }, shadow: { strong: ['light'], weak: ['light'] }, light: { strong: ['shadow'], weak: ['shadow'] }, normal: { strong: [], weak: [] } };
    const ELEMENT_ICONS = { fire: 'üî•', water: 'üåä', grass: 'üåø', electric: '‚ö°', earth: 'ü™®', ice: '‚ùÑÔ∏è', wind: 'üå™Ô∏è', shadow: 'üåë', light: '‚ú®', normal: '‚ö™' };
    function getElIcon(t) { if(Array.isArray(t)) return t.map(x=>ELEMENT_ICONS[x]).join(''); return ELEMENT_ICONS[t] || '‚ö™'; }
    function getElementMultiplier(moveType, targetInput) { if (!moveType || !targetInput) return 1.0; const atk = moveType.toLowerCase(); const targetTypes = Array.isArray(targetInput) ? targetInput : [targetInput]; let totalMultiplier = 1.0; targetTypes.forEach(defType => { const def = defType.toLowerCase(); const typeData = TYPE_CHART[atk]; if (typeData) { if (typeData.strong.includes(def)) totalMultiplier *= 2.0; else if (typeData.weak.includes(def)) totalMultiplier *= 0.5; } }); return totalMultiplier; }

    function startBattle(tileType, isBoss, isArena, specificEnemy = null) {
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        
        // Element failsafe
        if (!pet.element) { 
            for (const rarity in PET_TYPES) { 
                const def = PET_TYPES[rarity].find(d => d.id === pet.type); 
                if (def) { pet.element = def.element; break; } 
            } 
            if (!pet.element) pet.element = 'normal'; 
        }
        
        let enemy;
        
        // 1. SPECIFIC ENEMY (From Quest JSON)
        if (specificEnemy) {
            enemy = getScaledEnemy(specificEnemy, pet.level);
        }
        // 2. Arena Logic
        else if (isArena) { 
            const baseArena = getArenaEnemy(); 
            enemy = getScaledEnemy(baseArena, pet.level + 2); 
        } 
        // 3. Boss Logic
        else if (isBoss) { 
            enemy = getScaledEnemy(BOSS_TYPES[0], pet.level + 5); 
        } 
        // 4. Random Wild Logic
        else { 
            const randomBase = MONSTER_TYPES[Math.floor(Math.random() * MONSTER_TYPES.length)]; 
            enemy = getScaledEnemy(randomBase, pet.level); 
        }

        gameState.inBattle = true;
        gameState.battleState = { 
            enemy: enemy, 
            playerHP: pet.hp, 
            enemyHP: enemy.hp, 
            isBoss: isBoss, 
            isArena: isArena, 
            turnInProgress: false, 
            log: [`A wild ${enemy.name} appeared!`], 
            showBag: false 
        };
        
        soundManager.playBGM(isBoss || isArena ? 'boss' : 'battle');
        const bg = isArena ? ARENA_IMGS[0] : (BATTLE_BACKGROUNDS[tileType] || BATTLE_BACKGROUNDS[1]);
        
        // --- UI SWITCHING FIX (The part you asked about) ---
        // 1. Force the Wilds Screen to be active (where Battle UI lives)
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-wilds').classList.add('active');
        
        // 2. Hide other Wilds components so only Battle is visible
        document.getElementById('wilds-menu').style.display = 'none'; 
        document.getElementById('rpg-wrapper').style.display = 'none'; 
        document.getElementById('multiplayer-menu').style.display = 'none';
        document.getElementById('raid-arena').style.display = 'none'; // Also hide raid if active

        // 3. Show Battle UI
        document.getElementById('battle-ui').style.backgroundImage = `url('${bg}')`;
        document.getElementById('battle-ui').style.display = 'flex'; 
        
        renderBattle();
    }
    
    function showFloatingText(targetEl, text, type) { const ft = document.createElement('div'); ft.className = 'floating-text ' + (type||''); ft.innerText = text; targetEl.appendChild(ft); setTimeout(() => ft.remove(), 1000); }
    
    // --- EXPERT COMBAT ENGINE (UPDATED) ---

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function getTypeMult(moveType, defenderTypes) {
        if (!moveType || !defenderTypes) return 1.0;
        let mult = 1.0;
        const defArr = Array.isArray(defenderTypes) ? defenderTypes : [defenderTypes];
        const chart = {
            fire: { weak: ['water', 'rock'], strong: ['grass', 'ice'] },
            water: { weak: ['grass', 'electric'], strong: ['fire', 'rock'] },
            grass: { weak: ['fire', 'ice'], strong: ['water', 'rock'] },
            electric: { weak: ['rock'], strong: ['water'] },
            rock: { weak: ['water', 'grass'], strong: ['fire', 'electric'] },
            ice: { weak: ['fire'], strong: ['grass'] }
        };
        const atkData = chart[moveType];
        if (atkData) { defArr.forEach(def => { if (atkData.strong.includes(def)) mult *= 2.0; if (atkData.weak.includes(def)) mult *= 0.5; }); }
        return mult;
    }

    // NEW: SWAP SYSTEM LOGIC
    let isForcedSwap = false; 

    function openSwapMenu(forced = false) {
        isForcedSwap = forced;
        const modal = document.getElementById('swap-pet-modal');
        const container = document.getElementById('swap-list-container');
        const cancelBtn = document.getElementById('swap-cancel-btn');
        
        container.innerHTML = '';
        cancelBtn.style.display = forced ? 'none' : 'block';

        let availablePets = (gameState.team && gameState.team.length > 0) ? gameState.team.map(id => gameState.pets.find(p => p.id === id)) : gameState.pets;
        availablePets = availablePets.filter(p => p);

        availablePets.forEach(pet => {
            const isCurrent = pet.id === gameState.currentPetId;
            const isFainted = pet.hp <= 0;
            const card = document.createElement('div');
            card.className = `swap-card ${isCurrent ? 'active-pet' : ''} ${isFainted ? 'fainted' : ''}`;
            const visual = pet.image ? `<img src="${pet.image}" style="width:40px; height:40px; object-fit:contain;">` : `<div style="font-size:30px;">${pet.emoji}</div>`;
            const hpPercent = (pet.hp / pet.maxHP) * 100;
            const hpColor = hpPercent < 30 ? 'low' : (hpPercent < 60 ? 'mid' : '');
            card.innerHTML = `${visual}<div style="flex:1;"><div style="font-weight:bold; font-size:14px;">${pet.name} <span style="font-size:10px; color:#718096">Lvl ${pet.level}</span></div><div class="mini-hp-bg"><div class="mini-hp-fill ${hpColor}" style="width:${hpPercent}%"></div></div><div style="font-size:11px; text-align:right;">${pet.hp}/${pet.maxHP} HP</div></div>`;
            if (!isFainted && !isCurrent) card.onclick = () => confirmBattleSwap(pet.id);
            container.appendChild(card);
        });

        modal.classList.add('active');
    }

    async function confirmBattleSwap(newPetId) {
        document.getElementById('swap-pet-modal').classList.remove('active');
        gameState.currentPetId = newPetId;
        const newPet = gameState.pets.find(p => p.id === newPetId);
        if (gameState.inBattle) gameState.battleState.playerHP = newPet.hp;
        showToast(`Go ${newPet.name}!`, "info");
        renderBattle();
        if (!isForcedSwap && gameState.inBattle) {
            showToast("Swapping took your turn!", "warning");
            await wait(1000); 
            await processEnemyTurnAsync();
        } 
        if (gameState.inBattle) { gameState.battleState.turnInProgress = false; renderBattle(); }
    }

    // 1. Battle Logger Helper
    function addBattleLog(msg, type) {
        const container = document.getElementById('battle-log-feed');
        if (!container) return;
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerText = `> ${msg}`;
        container.prepend(entry);
    }

    // 2. Refined Render Logic
    function renderBattle() {
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId); 
        const bs = gameState.battleState;
        
        const pSize = getBattlerSize(pet, false, false);
        const eSize = getBattlerSize(bs.enemy, bs.isBoss, bs.isArena);
        
        const pVis = document.getElementById('battle-player-visual');
        pVis.style.filter = "none";    
        pVis.style.opacity = "1";      
        pVis.style.transform = "none"; 
        pVis.classList.remove('flipped-opponent');
        pVis.innerHTML = pet.image 
            ? `<img src="${pet.image}" class="battler-image ${pet.imageStyle}" style="width:${pSize}px; height:${pSize}px;">` 
            : `<div style="font-size:${pSize * 0.7}px;">${pet.emoji}</div>`;
      
        const eVis = document.getElementById('battle-enemy-visual'); 
        eVis.classList.add('flipped-opponent');
        eVis.innerHTML = bs.enemy.image 
            ? `<img src="${bs.enemy.image}" class="battler-image ${bs.enemy.imageStyle}" style="width:${eSize}px; height:${eSize}px;">` 
            : `<div class="emoji-wrapper" style="font-size:${eSize * 0.7}px;">${bs.enemy.emoji}</div>`;
      
        document.getElementById('player-battle-name').innerHTML = `${pet.name} ${gameState.burstMode ? "üî•" : ""} <span class="element-icon">${getElIcon(pet.element)}</span>`;
        document.getElementById('enemy-name').innerHTML = `${bs.enemy.name} <span class="element-icon">${getElIcon(bs.enemy.element)}</span>`;
        document.getElementById('enemy-hp-bar').style.width = (bs.enemyHP / bs.enemy.hp * 100) + "%";
        document.getElementById('player-hp-bar').style.width = (bs.playerHP / pet.maxHP * 100) + "%";
        document.getElementById('player-hp-text').innerText = `${Math.ceil(bs.playerHP)}/${pet.maxHP}`;

        const act = document.getElementById('battle-actions');
        
        if (!document.getElementById('battle-log-feed')) {
            const logHTML = `<div class="battle-log-container" id="battle-log-feed" style="display:none !important;"></div><div id="action-buttons-grid" class="battle-actions"></div>`;
            act.parentElement.innerHTML = logHTML;
            return renderBattle(); 
        }

        const btnGrid = document.getElementById('action-buttons-grid');

        if(bs.turnInProgress) {
            btnGrid.innerHTML = `<div style="color:white; font-weight:bold; width:100%; text-align:center; padding:10px;">Thinking...</div>`;
            return;
        }

        let buttons = pet.powers.map(pid => {
            const move = findShopItem(pid);
            const mult = getTypeMult(move.element, bs.enemy.element);
            let indicator = "";
            if (mult >= 2.0) indicator = `<span class="type-indicator eff-up">‚¨Ü</span>`;
            if (mult <= 0.5) indicator = `<span class="type-indicator eff-down">‚¨á</span>`;
            const burstClass = gameState.burstMode ? 'burst-ready' : '';
            const burstText = gameState.burstMode ? ' (CRIT)' : '';
            return `<button class="action-btn green ${burstClass}" style="display:flex; justify-content:space-between;" onclick="usePowerAsync('${pid}')"><span>${move.name}${burstText}</span> ${indicator}</button>`;
        }).join('');

        buttons += `<button class="action-btn blue" onclick="openSwapMenu()">üîÑ Squad</button><button class="action-btn red" onclick="flee()">üèÉ Run</button>`;
        btnGrid.innerHTML = buttons;
    }

    async function usePowerAsync(pid) {
        if (gameState.battleState.turnInProgress) return;
        if (gameState.battleState.playerHP <= 0) return showToast("Your pet has fainted!", "error");

        gameState.battleState.turnInProgress = true;
        renderBattle(); 

        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        const enemy = gameState.battleState.enemy;
        const move = findShopItem(pid);
        
        const pVis = document.getElementById('battle-player-visual');
        const eVis = document.getElementById('battle-enemy-visual');
        
        soundManager.playSFX('attack');
        pVis.style.animation = "attackLunge 0.3s";
        createProjectile(move.image || move.icon, pVis, eVis);
        await wait(500); 
        pVis.style.animation = "";

        let mult = getTypeMult(move.element, enemy.element);
        let isCrit = false;
        let critMult = 1.0;
        
        if (gameState.burstMode) {
            critMult = 2.0; isCrit = true; gameState.burstMode = false; showToast("üî• BRAIN BURST HIT! üî•", "success");
        } else if (Math.random() < 0.1) {
            critMult = 1.5; isCrit = true;
        }

        let rawDmg = (move.damage + (pet.level * 1.5));
        let dmg = Math.floor((rawDmg * mult * critMult) * (Math.random() * 0.2 + 0.9));
        
        gameState.battleState.enemyHP = Math.max(0, gameState.battleState.enemyHP - dmg);
        soundManager.playSFX('hit');
        eVis.style.animation = "damageShake 0.5s";
        
        let color = isCrit ? "crit" : (mult > 1 ? "super" : (mult < 1 ? "weak" : ""));
        showFloatingText(eVis.parentElement, `-${dmg}`, color);
        addBattleLog(`${pet.name} used ${move.name} for ${dmg} DMG!`, isCrit ? 'crit' : 'player');
        document.getElementById('enemy-hp-bar').style.width = (gameState.battleState.enemyHP / enemy.hp * 100) + "%";

        if (gameState.battleState.enemyHP <= 0) { await wait(1000); winBattle(); return; }
        await wait(800); await processEnemyTurnAsync();
        if (gameState.inBattle) { gameState.battleState.turnInProgress = false; renderBattle(); }
    }

    async function processEnemyTurnAsync() {
        if (!gameState.inBattle) return;
        const eVis = document.getElementById('battle-enemy-visual');
        const pVis = document.getElementById('battle-player-visual');
        const enemy = gameState.battleState.enemy;

        eVis.style.animation = "attackLunge 0.3s";
        await wait(300); eVis.style.animation = "";

        let dmg = Math.floor(enemy.damage * (Math.random() * 0.2 + 0.9));
        gameState.battleState.playerHP = Math.max(0, gameState.battleState.playerHP - dmg);
        soundManager.playSFX('hit');
        pVis.style.animation = "damageShake 0.5s";
        
        showFloatingText(pVis.parentElement, `-${dmg}`, "crit");
        addBattleLog(`${enemy.name} attacked for ${dmg} DMG!`, 'enemy');
        
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        pet.hp = gameState.battleState.playerHP; 

        document.getElementById('player-hp-bar').style.width = (gameState.battleState.playerHP / pet.maxHP * 100) + "%";
        document.getElementById('player-hp-text').innerText = `${Math.ceil(gameState.battleState.playerHP)}/${pet.maxHP}`;

        if (gameState.battleState.playerHP <= 0) { await wait(1000); handlePlayerFaint(); }
    }
    
    async function handlePlayerFaint() {
        if (!gameState.team) gameState.team = [gameState.currentPetId]; 
        const playerEl = document.getElementById('battle-player-visual');
        playerEl.style.transition = "filter 1s, opacity 1s, transform 1s";
        playerEl.style.filter = "grayscale(100%) brightness(0.5)";
        playerEl.style.opacity = "0.5";
        playerEl.style.transform = "scale(0.8)";
        
        soundManager.playSFX('wrong'); 
        showToast(`${document.getElementById('display-name').innerText}'s pet fainted!`, "error");
        await wait(1500); 

        const alivePets = gameState.pets.filter(p => 
            ((gameState.team && gameState.team.includes(p.id)) || (!gameState.team)) && 
            p.hp > 0 && p.isHatched
        );
        
        if(alivePets.length > 0) { openSwapMenu(true); } else { loseBattle(); }
    }

    function winBattle() { 
        soundManager.stopBGM(); 
        soundManager.playSFX('victory'); 
        
        const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); 
        const bs = gameState.battleState; 
        
        // 1. Update Stats (Health, BP, XP)
        p.hp = bs.playerHP; 
        const bp = bs.isBoss ? 100 : (bs.isArena ? 50 : 20); 
        addBP(bp); 
        p.xp += (bs.enemy.xp || 15); 
        
        // 2. Level Up Logic
        if(p.xp >= p.maxXp) { 
            p.level++; 
            p.xp = 0; 
            p.maxXp = p.level * 300 + 200; 
            p.maxHP = 50 + (p.level * 10); // Standard HP Formula
            p.hp = p.maxHP; 
            soundManager.playSFX('levelUp'); 
            showToast(`Level Up! ${p.name} is now Lvl ${p.level}`, "success");
        } 
        
        // 3. Random Egg Drop (Only in Wilds, NOT Quests/Arena)
        if (!bs.isBoss && !bs.isArena && !gameState.questBattleActive && Math.random() < 0.1) {
            const eggPool = [...PET_TYPES.common, ...PET_TYPES.uncommon]; 
            const basePet = eggPool[Math.floor(Math.random() * eggPool.length)];
            const newEgg = JSON.parse(JSON.stringify(basePet)); 
            newEgg.type = basePet.id; 
            newEgg.id = 'egg_' + Date.now(); 
            newEgg.isHatched = false; 
            newEgg.hatchProgress = 0; 
            newEgg.level = 1; 
            newEgg.xp = 0; 
            newEgg.maxXp = 100; 
            newEgg.powers = []; 
            newEgg.maxHP = basePet.baseHP; 
            newEgg.hp = basePet.baseHP;
            gameState.pets.push(newEgg); 
            setTimeout(() => { showToast("‚ú® Found a Mystery Egg! ‚ú®", "success"); }, 1500);
        }

        gameState.inBattle = false; 
        document.getElementById('battle-ui').style.display = 'none'; 
        
        // ===============================================
        // 4. QUEST BATTLE RETURN LOGIC (The New Part)
        // ===============================================
        if (gameState.questBattleActive) {
            gameState.questBattleActive = false; // Reset flag
            
            // A. Register Success Flag (Opens gates etc)
            if (gameState.questSuccessKey) {
                gameState.questProgress.flags.push(gameState.questSuccessKey);
            }

            // B. Handle Special Quest Reward
            if (gameState.pendingQuestRewardData) {
                const r = gameState.pendingQuestRewardData;
                
                // Register Evolutions if present
                if (r.evolutions && r.type) {
                    EVOLUTION_CHAINS[r.type] = r.evolutions;
                }

                const newPet = { 
                    ...r, 
                    id: 'quest_reward_' + Date.now(), 
                    isHatched: false, // Reward is an Egg
                    hatchProgress: 0, 
                    powers: [], 
                    level: 1, xp: 0, maxXp: 100 
                };
                
                gameState.pets.push(newPet);
                
                // --- TRIGGER THE CEREMONY ---
                // Show the adventure map background
                document.getElementById('adventure-list-view').style.display = 'none';
                document.getElementById('adventure-play-view').style.display = 'block';
                drawAdventureMap();

                // Determine Visual
                const visual = r.image 
                    ? `<img src="${r.image}" style="width:150px; height:150px; object-fit:contain;">` 
                    : r.emoji;

                triggerRewardCeremony(
                    "QUEST COMPLETE!", 
                    `You found a ${r.name} Egg!`, 
                    visual, 
                    () => { 
                        switchTab('adventure'); // Go back to map
                    }
                );
                
                gameState.pendingQuestRewardData = null; // Clear data
                saveGame();
                return; // Stop here, let the ceremony handle the rest
            } 
            else {
                // No Reward, just a victory (like beating a guard)
                alert("‚öîÔ∏è Enemy Defeated! The path is open!");
                
                switchTab('adventure'); 
                document.getElementById('adventure-list-view').style.display = 'none';
                document.getElementById('adventure-play-view').style.display = 'block';
                drawAdventureMap(); 
            }
        } 
        else {
            // ===============================================
            // 5. STANDARD WILD BATTLE RETURN
            // ===============================================
            showToast(`Victory! +${bp} BP`, "success"); 
            document.getElementById('rpg-wrapper').style.display = 'block'; 
            initRPG(); 
            soundManager.playBGM('wilds');
        }
        
        saveGame(); 
    }

    function loseBattle() { soundManager.stopBGM(); const p = gameState.pets.find(pet => pet.id === gameState.currentPetId); p.hp=0; showToast("Defeated...", "error"); gameState.inBattle=false; document.getElementById('battle-ui').style.display='none'; document.getElementById('wilds-menu').style.display='block'; saveGame(); setTimeout(() => soundManager.playBGM('hub'), 2000); }
    function flee() { 
    if(gameState.battleState.isArena) return showToast("No Running in Arena!", "error"); 
    
    gameState.inBattle = false; 
    document.getElementById('battle-ui').style.display = 'none'; 
    soundManager.stopBGM();

    // CHECK: Are we in an Adventure Quest?
    if (gameState.questBattleActive) {
        // Yes: Go back to Quest Map
        gameState.questBattleActive = false; 
        switchTab('adventure'); 
        document.getElementById('adventure-play-view').style.display = 'block'; 
        document.getElementById('adventure-list-view').style.display = 'none';
        drawAdventureMap(); 
        showToast("You ran away safely...", "info");
    } 
    else {
        // No: Go back to Wilds (Normal behavior)
        document.getElementById('rpg-wrapper').style.display = 'block'; 
        initRPG(); 
        soundManager.playBGM('wilds'); 
    }
}
    function switchTab(t) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); document.querySelector(`.tab[data-tab="${t}"]`).classList.add('active'); document.getElementById('screen-' + t).classList.add('active'); 
        if(t==='wilds') soundManager.playBGM('wilds'); else soundManager.playBGM('hub'); 
        if (t === 'hub') renderHub(); if (t === 'shop') renderShop(); 
        if (t !== 'wilds') { document.getElementById('rpg-wrapper').style.display = 'none'; document.getElementById('battle-ui').style.display = 'none'; document.getElementById('wilds-menu').style.display = 'block'; } 
    }
    function updateStatsDisplay() { document.getElementById('bp-display').innerText = gameState.brainPoints; document.getElementById('stamina-display').innerText = gameState.stamina; }
    function createProjectile(v, s, e) { const p = document.createElement('div'); p.className = 'projectile'; if (v && v.startsWith('http')) p.innerHTML = `<img src="${v}">`; else p.innerText = v; const sr = s.getBoundingClientRect(); const er = e.getBoundingClientRect(); p.style.left = (sr.left + sr.width/2 - 75) + 'px'; p.style.top = (sr.top + sr.height/2 - 75) + 'px'; document.body.appendChild(p); const a = p.animate([ { transform: 'translate(0,0) scale(0.5)', opacity: 1 }, { transform: `translate(${er.left+er.width/2 - (sr.left+sr.width/2)}px, ${er.top+er.height/2 - (sr.top+sr.height/2)}px) scale(1.2)`, opacity: 0 } ], { duration: 600 }); a.onfinish = () => p.remove(); }
    function showToast(m, t) { const d = document.createElement('div'); d.className = 'toast ' + t; d.innerText = m; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000); }
    function saveGame() { if(gameState.playerName) { localStorage.setItem('math_rpg_' + gameState.playerName, JSON.stringify(gameState)); saveProgressToFirebase(); } }
    function logout() { location.reload(); }
    function releasePet() { if(gameState.pets.length<=1) return; window.petToRelease = gameState.pets.find(p => p.id === gameState.currentPetId); const m = document.getElementById('release-modal'); m.classList.add('active'); }
    document.getElementById('release-confirm').addEventListener('click', () => { 
    const idToRemove = gameState.currentPetId;

    // 1. Remove from Inventory
    gameState.pets = gameState.pets.filter(p => p.id !== idToRemove); 
    
    // 2. Remove from Squad (The Missing Link!)
    if (gameState.team) {
        gameState.team = gameState.team.filter(id => id !== idToRemove);
    }

    // 3. Select a new pet
    if (gameState.pets.length > 0) {
        gameState.currentPetId = gameState.pets[0].id;
        // Ensure team isn't empty
        if (!gameState.team || gameState.team.length === 0) {
            gameState.team = [gameState.currentPetId];
        }
    } else {
        // Game Over safety (shouldn't happen if button is hidden for last pet)
        gameState.currentPetId = null;
    }

    gameState.brainPoints += 10; 
    saveGame(); 
    renderHub(); 
    document.getElementById('release-modal').classList.remove('active'); 
});

    // --- ADVENTURE MODE SYSTEM (RESTORATION) ---
    // ... (Your adventure functions remain here, skipping duplicate copy for brevity, they are assumed present as per instruction "Do not delete existing features") ... 
    // Re-adding adventure logic to ensure full functionality:
    let advCanvas, advCtx, advMap = [], advNpcs = [], currentAdvMapKey = "";
    let questX = 1, questY = 1;

    function renderAdventureList() {
        const list = document.getElementById('adventure-list-view');
        if(availableEvents.length === 0) { list.innerHTML = "No active quests."; return; }
        const today = new Date(); today.setHours(0,0,0,0); 
        list.innerHTML = availableEvents.map(ev => {
            let isLocked = false; let statusText = "Active"; let statusClass = "active";
            if (ev.unlockDate) { const unlock = new Date(ev.unlockDate); if (today < unlock) { isLocked = true; statusText = `Opens: ${ev.unlockDate}`; statusClass = "coming"; } } else if (ev.status !== 'active') { isLocked = true; statusText = "Coming Soon"; statusClass = "coming"; }
            const clickAction = isLocked ? `showToast('üîí This event opens on ${ev.unlockDate || "a later date"}!', 'error')` : `loadQuest('${ev.file}')`;
            return `<div class="adventure-card" onclick="${clickAction}" style="${isLocked ? 'opacity:0.6;filter:grayscale(1);' : ''}"><div class="adventure-header" style="${isLocked ? 'background:#718096;' : ''}">${ev.image ? `<img src="${ev.image}" width="24">` : 'üìú'} ${ev.title}</div><div class="adventure-body"><p class="adventure-desc">${ev.description}</p><span class="adventure-status status-${statusClass}">${statusText}</span></div></div>`;
        }).join('');
    }

// ==========================================
    // COMPLETE ADVENTURE ENGINE (FIXED)
    // ==========================================

    async function loadQuest(fileUrl) {
        let url = fileUrl;
        if (!url.startsWith('http')) url = getGhUrl(url);
        
        console.log("Loading quest:", url);

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const qData = await res.json();
            window.currentQuestData = qData;
            startAdventure(qData); // Now works because startAdventure is defined below
        } catch(e) { 
            console.error(e);
            showToast("Error loading quest: " + e.message, "error"); 
        }
    }

    function startAdventure(qData) { 
        if (!qData || !qData.maps) return showToast("Invalid Quest Data", "error");

        // 1. Switch to Adventure Screen
        document.getElementById('adventure-list-view').style.display = 'none'; 
        document.getElementById('adventure-play-view').style.display = 'block'; 
        
        if (qData.meta && qData.meta.title) {
            document.getElementById('quest-title-display').innerText = qData.meta.title;
        }

        // 2. Initialize Canvas
        advCanvas = document.getElementById('adventure-canvas'); 
        advCtx = advCanvas.getContext('2d'); 
        
        // --- FIX: LOAD PET IMAGE FOR QUEST ---
        const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        if (pet && pet.image && pet.image.length > 5) {
            playerImage.src = pet.image; 
        } else {
            playerImage.src = HUMAN_SPRITE_URL; // Fallback
        }

        // 3. Load First Map
        const startKey = qData.startMap || Object.keys(qData.maps)[0]; 
        loadAdventureMap(startKey); 

        // 4. Input Listener
        advCanvas.onclick = (e) => { 
            const rect = advCanvas.getBoundingClientRect(); 
            const clickX = (e.clientX - rect.left) * (advCanvas.width / rect.width); 
            const clickY = (e.clientY - rect.top) * (advCanvas.height / rect.height); 
            const tileX = Math.floor(clickX / TILE_SIZE); 
            const tileY = Math.floor(clickY / TILE_SIZE); 
            
            const npc = advNpcs.find(n => n.x === tileX && n.y === tileY); 
            if(npc && Math.abs(tileX - questX) + Math.abs(tileY - questY) <= 1) { 
                interactNPC(npc); 
            } 
        };
        
        // 5. KEYBOARD LISTENER (This was missing!)
        document.removeEventListener('keydown', handleKeyDown); 
        document.addEventListener('keydown', handleKeyDown);
    }

    function loadAdventureMap(mapKey) { 
        const mapData = window.currentQuestData.maps[mapKey]; 
        if(!mapData) return showToast("Map missing: " + mapKey, "error");

        currentAdvMapKey = mapKey; 
        advMap = mapData.layout; 
        advNpcs = mapData.npcs || []; 
        
        if(mapData.start) { 
            questX = mapData.start.x; 
            questY = mapData.start.y; 
        } 
        
        // Slight delay to ensure context is ready
        setTimeout(drawAdventureMap, 50); 
    }
    // Expert Feature: Check if NPC should be rendered/collided with
    function isNpcVisible(npc) {
        if (npc.hideOnFlag && gameState.questProgress.flags.includes(npc.hideOnFlag)) {
            return false; // Player has flag -> NPC disappears
        }
        if (npc.showOnFlag && !gameState.questProgress.flags.includes(npc.showOnFlag)) {
            return false; // Player missing flag -> NPC hidden
        }
        return true; // Visible
    }

    function drawAdventureMap() { 
    if (!advCtx || !advMap || advMap.length === 0) return; 
    
    advCtx.clearRect(0,0,advCanvas.width, advCanvas.height); 
    
    // Draw Tiles
    for(let r=0; r<advMap.length; r++) { 
        for(let c=0; c<advMap[0].length; c++) { 
            const tile = advMap[r][c]; 
            const x = c*TILE_SIZE; 
            const y = r*TILE_SIZE; 
            
            if (tile === 9) { // ROCK (Blocked)
                advCtx.fillStyle = '#4a5568'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '20px Arial'; advCtx.fillStyle = '#2d3748'; advCtx.fillText('ü™®', x+8, y+28); 
            } 
            else if (tile === 2) { // TREE (Blocked) - NEW!
                advCtx.fillStyle = '#2e7d32'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '24px Arial'; advCtx.fillStyle = '#1b5e20'; advCtx.fillText('üå≤', x+5, y+30); 
            }
            else if (tile === 8) { // PORTAL (Walkable) - NEW NUMBER!
                advCtx.fillStyle = '#9f7aea'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '20px Arial'; advCtx.fillStyle = 'white'; advCtx.fillText('üåÄ', x+8, y+28); 
            } 
            else if (tile === 5) { // SNOW
                advCtx.fillStyle = '#e2e8f0'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.font = '16px Arial'; advCtx.fillStyle = '#cbd5e0'; advCtx.fillText('‚ùÑÔ∏è', x+8, y+26); 
            }
            else if (tile === 3) { // WATER (Blocked)
                advCtx.fillStyle = '#4fc3f7'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
                advCtx.fillStyle = '#0288d1'; advCtx.fillText('~', x+10, y+25); 
            } 
            else if (tile === 4) { // SAND
                advCtx.fillStyle = '#f6e05e'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
            else if (tile === 1) { // VOID (Blocked)
                advCtx.fillStyle = '#1a202c'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
            else { // GRASS (0)
                advCtx.fillStyle = '#66bb6a'; advCtx.fillRect(x,y,TILE_SIZE,TILE_SIZE); 
            } 
        } 
    } 

    // Draw NPCs
    if (advNpcs && Array.isArray(advNpcs)) {
        advNpcs.forEach(n => { 
            // Check visibility
            if (n.hideOnFlag && gameState.questProgress.flags.includes(n.hideOnFlag)) return;
            if (n.showOnFlag && !gameState.questProgress.flags.includes(n.showOnFlag)) return;

            const nx = n.x * TILE_SIZE; 
            const ny = n.y * TILE_SIZE; 
            
            // Shadow
            advCtx.fillStyle = 'rgba(0,0,0,0.3)'; advCtx.beginPath(); 
            advCtx.ellipse(nx+20, ny+35, 10, 5, 0, 0, Math.PI*2); advCtx.fill(); 

            // Sprite
            if (n.sprite && n.sprite.startsWith('http')) { 
                const img = new Image(); img.src = n.sprite; 
                advCtx.drawImage(img, nx, ny, TILE_SIZE, TILE_SIZE); 
            } else { 
                advCtx.fillStyle = '#fff'; advCtx.font = '24px Arial'; 
                advCtx.fillText(n.sprite || 'üßô', nx+5, ny+30); 
            } 
            
            // Quest Marker
            if (Math.abs(n.x - questX) + Math.abs(n.y - questY) <= 1) {
                advCtx.font = '20px Arial'; advCtx.fillStyle = 'yellow'; advCtx.fillText('‚ùó', nx+10, ny);
            }
        }); 
    }

    // Draw Player
    const px = questX * TILE_SIZE; 
    const py = questY * TILE_SIZE; 
    
    // Player Shadow
    advCtx.fillStyle = 'rgba(0,0,0,0.3)'; advCtx.beginPath(); 
    advCtx.ellipse(px+20, py+35, 10, 5, 0, 0, Math.PI*2); advCtx.fill(); 
    
    // Player Image
    if(playerImage.complete && playerImage.naturalWidth > 0) { 
        advCtx.drawImage(playerImage, px, py, TILE_SIZE, TILE_SIZE); 
    } else { 
        advCtx.fillStyle = 'blue'; advCtx.beginPath(); advCtx.arc(px+20, py+20, 15, 0, Math.PI*2); advCtx.fill(); 
    } 
}
function checkAdventureRandomEncounter(tileType) {
        // 1. Define "Safe" tiles (e.g., portals shouldn't trigger battles)
        // Tiles: 0=Grass, 4=Sand, 5=Snow. These are "Wild" areas.
        if (![0, 4, 5].includes(tileType)) return;

        // 2. Chance Check (e.g., 8% chance per step)
        if (Math.random() < 0.08) {
            console.log("‚öîÔ∏è Random Adventure Encounter!");
            
            // --- FIX IS HERE: TELL THE GAME WE ARE IN A QUEST BATTLE ---
        gameState.questBattleActive = true; 
        // -----------------------------------------------------------

            
            // 3. Stop movement and Start Battle
            // We pass 'false' for boss/arena, and 'null' for specific enemy 
            // so the game picks a random one from your loaded lists.
            startBattle(tileType, false, false, null); 
        }
    }
    function handleQuestDPad(key) { 
    // 1. Safety Check: Ensure map data exists
    if(!window.currentQuestData || !advMap) return;

    // --- NEW: STAMINA CHECK ---
    if (gameState.stamina <= 0) {
        showToast("No Stamina! Study to get Energy.", "error");
        return;
    }

    let dx=0, dy=0; 
    if(key==='ArrowUp') dy=-1; 
    if(key==='ArrowDown') dy=1; 
    if(key==='ArrowLeft') dx=-1; 
    if(key==='ArrowRight') dx=1; 
    
    const nx = questX+dx; 
    const ny = questY+dy; 
    
    // Boundary Checks
    if(ny < 0 || ny >= advMap.length) return; 
    if(nx < 0 || nx >= advMap[ny].length) return; 

    // NPC Collision
    const npc = advNpcs.find(n => n.x === nx && n.y === ny && isNpcVisible(n));
    if (npc) {
        interactNPC(npc);
        return; 
    }

    // Blocked Tiles (Walls, Trees, Water)
    const tile = advMap[ny][nx]; 
    const blockedTiles = [1, 9, 2, 3]; 
    if(blockedTiles.includes(tile)) return; 
    
    // Portal Logic
    const mapData = window.currentQuestData.maps[currentAdvMapKey]; 
    if(mapData.portals) { 
        const portal = mapData.portals.find(p => p.x === nx && p.y === ny); 
        if(portal) { 
            loadAdventureMap(portal.toMap); 
            return; 
        } 
    } 
    
    // --- SUCCESSFUL MOVE ---
    questX = nx; 
    questY = ny; 
    
    // --- NEW: CONSUME STAMINA & UPDATE UI ---
    gameState.stamina = Math.max(0, gameState.stamina - 1);
    updateStatsDisplay();

    drawAdventureMap(); 
    
    // Random Encounter Check
    checkAdventureRandomEncounter(tile);
}

    // --- Helpers ---
    function interactNPC(npc) { 
        const dBox = document.getElementById('quest-dialog'); 
        document.getElementById('quest-npc-name').innerText = npc.name; 
        document.getElementById('quest-text').innerText = npc.dialogue[0]; 
        dBox.style.display = 'block'; 
        
        const btn = document.getElementById('quest-action-btn'); 
        btn.innerText = "Continue"; 
        btn.onclick = () => { 
            dBox.style.display = 'none'; 
            if(npc.action) triggerQuestAction(npc.action); 
        }; 
    }

    function triggerQuestAction(actionKey) { 
        const gate = window.currentQuestData.gates ? window.currentQuestData.gates[actionKey] : null; 
        if(!gate) return; 
        
        if(gate.type === 'academic_challenge') { 
            if(confirm(`üîí LOCKED! Answer ${gate.questionCount} questions to pass?`)) { 
                startAcademicGate(gate.questionCount, gate.onSuccess); 
            } 
        } 
        else if (gate.type === 'battle') { 
            // --- NEW: Monster Lookup Logic ---
            let targetMonster = null;
            if (gate.enemyId) {
                // Look for monster in your existing lists
                targetMonster = MONSTER_TYPES.find(m => m.name === gate.enemyId || m.id === gate.enemyId) ||
                                BOSS_TYPES.find(b => b.name === gate.enemyId || b.id === gate.enemyId);
            }
            // ---------------------------------

            const name = targetMonster ? targetMonster.name : "Monster";

            if(confirm(`‚ö†Ô∏è BATTLE: Fight ${name}?`)) { 
                gameState.questBattleActive = true; 
                gameState.questSuccessKey = gate.onSuccess; 
                
                if (gate.rewardData) gameState.pendingQuestRewardData = gate.rewardData;
                
                // Pass the specific monster to startBattle
                startBattle(7, true, false, targetMonster); 
            } 
        } 
        else if (gate.type === 'item') { 
        gameState.questProgress.flags.push(gate.onSuccess); 
        
        const rewardName = gate.itemName || 'Hidden Item';
        const rewardAmt = gate.reward || 0;
        
        triggerRewardCeremony(
            "TREASURE FOUND!",
            `You discovered: ${rewardName}`,
            "üíé", 
            () => {
                if(rewardAmt > 0) addBP(rewardAmt);
            }
        );
    }
    }

    function startAcademicGate(count, successKey) { 
        switchTab('study'); 
        let wins = 0; 
        const originalCheck = window.checkAnswer; 
        
        window.checkAnswer = (val) => { 
            let input = val || document.getElementById('answer-input').value; 
            // Simple check logic for gate
            if(input == gameState.currentQuestion.a) { 
                wins++; 
                soundManager.playSFX('correct'); 
                if(wins >= count) { 
                    alert("üéâ Gate Unlocked!"); 
                    window.checkAnswer = originalCheck; 
                    switchTab('adventure'); 
                    gameState.questProgress.flags.push(successKey); 
                } else { 
                    generateNextQuestion(); 
                } 
            } else { 
                alert("‚ùå Failed! Try again later."); 
                window.checkAnswer = originalCheck; 
                switchTab('adventure'); 
            } 
        }; 
        generateNextQuestion(); 
    }

    function exitAdventure() { 
        document.getElementById('adventure-list-view').style.display='grid'; 
        document.getElementById('adventure-play-view').style.display='none'; 
    }


    // --- TEACHER LOGIC ---
    let currentStudentData = null; 

    async function authenticateStudent(name, password) { try { const d = await window.fbase.getDoc(window.fbase.doc(window.db, "students", name)); if (d.exists() && (!d.data().password || d.data().password === password)) return { success: true, assignment: d.data().assignedGrade ? { grade: d.data().assignedGrade, topics: d.data().assignedTopics||[] } : null }; return { success: false, message: "Invalid Login" }; } catch (e) { return { success: false, message: "Error" }; } }
    // Function to show/hide the teacher login box
function toggleTeacherLogin() { 
    const panel = document.getElementById('teacher-login-panel');
    if (panel) {
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    } else {
        console.error("Error: Could not find element with id 'teacher-login-panel'");
    }
}
    async function checkTeacherPin() { 
    const inputPin = document.getElementById('teacher-pin').value;
    
    // 1. Calculate the Hash of what was typed
    const hashedInput = await sha256(inputPin);

    // 2. Compare against the known Hash of "1030"
    // Hash: 3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4
    const SECRET_HASH = "3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4";

    if (hashedInput === SECRET_HASH) { 
        document.getElementById('teacher-dashboard-screen').style.display = 'block'; 
        loadStudentList(); 
        document.getElementById('teacher-pin').value = ""; // Clear the field for safety
        showToast("Welcome, Teacher!", "success");
    } else { 
        showToast("Wrong PIN", "error"); 
    } 
}
    async function createStudentAccount() { 
    if (!currentLoggedTeacher) return showToast("Error: No teacher logged in", "error");

    const u = document.getElementById('new-student-user').value.trim(); 
    const p = document.getElementById('new-student-pass').value.trim(); 
    
    if(!u || !p) return showToast("Missing Info", "error"); 
    
    // Check if student exists globally (usernames must be unique)
    const check = await window.fbase.getDoc(window.fbase.doc(window.db, "students", u));
    if(check.exists()) return showToast("Username taken!", "error");

    await window.fbase.setDoc(window.fbase.doc(window.db,"students",u), {
        username: u,
        password: p,
        assignedGrade: document.getElementById('new-student-grade').value,
        assignedTopics: [],
        teacherId: currentLoggedTeacher, // <--- THIS LINKS THE STUDENT TO THE TEACHER
        createdAt: new Date()
    }); 
    
    showToast(`Created student: ${u}`, "success"); 
    loadStudentList(); // Refresh list
}
    function toggleAllStudents(c) { document.querySelectorAll('.student-select-checkbox').forEach(cb => cb.checked = c); updateBulkActionBar(); }
    function updateBulkActionBar() { const c = document.querySelectorAll('.student-select-checkbox:checked').length; const b = document.getElementById('bulk-action-bar'); document.getElementById('bulk-selected-count').innerText = `${c} Selected`; b.style.display = c > 0 ? 'flex' : 'none'; }
    
    async function loadStudentList() {
    if (!currentLoggedTeacher) return;

    const d = document.getElementById('student-list-container'); 
    d.innerHTML = '<div style="padding:20px;text-align:center;color:gray;">Loading class roster...</div>';
    
    // FETCH ALL STUDENTS
    // (Ideally, we would use a Firestore Query here, but client-side filtering is easier for now)
    const q = await window.fbase.getDocs(window.fbase.collection(window.db, "students")); 
    
    const grouped = {};
    let count = 0;

    q.forEach(doc => {
        const s = doc.data();
        
        // --- FILTER: ONLY SHOW MY STUDENTS ---
        if (s.teacherId !== currentLoggedTeacher) return; 
        
        count++;
        const g = s.assignedGrade || "Unassigned"; 
        const bp = (s.saveData && s.saveData.brainPoints) ? s.saveData.brainPoints : 0;
        
        if (!grouped[g]) grouped[g] = [];
        grouped[g].push(`<div class="student-list-item"><input type="checkbox" class="student-select-checkbox" data-username="${s.username}" onchange="updateBulkActionBar()"><div class="student-info" style="display:flex; flex-direction:column; align-items:flex-start;"><div style="font-size:16px; font-weight:bold;">${s.username}</div><div style="font-size:12px; background:#fef3c7; color:#92400e; padding:2px 8px; border-radius:10px; margin-top:2px;">üß† ${bp} BP</div></div><div style="display:flex; gap:5px;"><button class="action-btn green" style="width:auto; padding:5px 10px; font-size:12px;" onclick="giveStudentBP('${s.username}')">üéÅ +BP</button><button class="action-btn blue" style="width:auto; padding:5px 10px; font-size:12px;" onclick="openTopicManager('${s.username}')">Manage</button><button class="action-btn red" style="width:auto; padding:5px 10px; font-size:12px;" onclick="openDeleteModal('${s.username}')">üóëÔ∏è</button></div></div>`);
    });
    
    if (count === 0) { 
        d.innerHTML = '<div style="padding:20px;text-align:center;">No students found for your class.</div>'; 
        return; 
    }

    let finalHtml = ''; 
    const grades = Object.keys(grouped).sort(); 
    grades.forEach(grade => { 
        finalHtml += `<div class="grade-group"><div class="grade-summary" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'"><span>üìÇ Grade ${grade}</span><span>${grouped[grade].length} Students ‚ñº</span></div><div class="grade-student-list">${grouped[grade].join('')}</div></div>`; 
    }); 
    d.innerHTML = finalHtml; 
}

    let studentToDelete = null;
    function openDeleteModal(username) { studentToDelete = username; document.getElementById('delete-student-name-display').innerText = username; document.getElementById('teacher-delete-modal').classList.add('active'); }
    async function confirmDeleteStudent() { if(!studentToDelete) return; await window.fbase.deleteDoc(window.fbase.doc(window.db, "students", studentToDelete)); document.getElementById('teacher-delete-modal').classList.remove('active'); showToast("Student Deleted", "success"); loadStudentList(); }
    async function giveStudentBP(username) { const amount = prompt(`How many Brain Points (BP) for ${username}?`, "50"); if (!amount || isNaN(amount)) return; const val = parseInt(amount); if (val <= 0) return; const docRef = window.fbase.doc(window.db, "students", username); try { await window.fbase.updateDoc(docRef, { "saveData.brainPoints": window.fbase.increment(val) }); showToast(`‚úÖ Sent ${val} BP to ${username}!`, "success"); } catch (e) { try { await window.fbase.setDoc(docRef, { saveData: { brainPoints: val } }, { merge: true }); showToast(`‚úÖ Sent ${val} BP to ${username}!`, "success"); } catch (err) { showToast("Error giving points.", "error"); } } }
    
    async function openTopicManager(username) { 
        currentManagingStudent = username; document.getElementById('tm-student-name').innerText=username; document.getElementById('topic-manager-modal').style.display='flex';
        const docSnap = await window.fbase.getDoc(window.fbase.doc(window.db, "students", username));
        if (docSnap.exists()) { currentStudentData = docSnap.data(); document.getElementById('tm-grade-select').value = currentStudentData.assignedGrade || 'K'; renderCurrentAssignmentsList(); }
        refreshTopicManagerUI(); 
    }
    
    function renderCurrentAssignmentsList() {
        const listContainer = document.getElementById('tm-current-assignments');
        if (!currentStudentData.assignedTopics || currentStudentData.assignedTopics.length === 0) { listContainer.innerHTML = '<span style="color:#94a3b8; font-size:12px;">No lessons assigned yet.</span>'; return; }
        listContainer.innerHTML = currentStudentData.assignedTopics.map(t => { let cleanName = t; if (t.includes('/')) cleanName = t.split('/').pop(); cleanName = cleanName.replace('.json', '').replace(/%20/g, ' '); if (t.startsWith('INTERNAL:')) cleanName = t.replace('INTERNAL:', '') + " (Built-in)"; return `<span class="assigned-topic-badge">${cleanName}</span>`; }).join('');
    }

    async function refreshTopicManagerUI() { 
        const g=document.getElementById('tm-grade-select').value; const d=document.getElementById('tm-topic-list'); d.innerHTML='Loading...'; let files=[]; 
        if(GITHUB_CONFIG.enabled) files=await fetchGithubFolder(`questions/grade_${g}`); d.innerHTML=''; 
        const isChecked = (val) => { return (currentStudentData && currentStudentData.assignedTopics && currentStudentData.assignedTopics.includes(val)) ? 'checked' : ''; };
        if(files.length>0) { files.filter(f=>f.name.endsWith('.json')).forEach(f=> { d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="${f.download_url}" ${isChecked(f.download_url)}> ${f.name}</label>`; }); } else { Object.keys(QUESTION_REPOSITORY[g]||{}).forEach(t=> { const val = `INTERNAL:${t}`; d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="${val}" ${isChecked(val)}> ${t}</label>`; }); }
    }
    
    async function saveStudentTopics() { 
        const checkboxes = document.querySelectorAll('#tm-topic-list input'); let finalTopics = new Set(currentStudentData.assignedTopics || []);
        checkboxes.forEach(cb => { if (cb.checked) { finalTopics.add(cb.value); } else { finalTopics.delete(cb.value); } });
        const newGrade = document.getElementById('tm-grade-select').value;
        await window.fbase.updateDoc(window.fbase.doc(window.db,"students",currentManagingStudent), { assignedGrade: newGrade, assignedTopics: Array.from(finalTopics) }); 
        showToast("Saved!", "success"); document.getElementById('topic-manager-modal').style.display='none'; 
    }

    function openBulkTopicManager() { const selected = document.querySelectorAll('.student-select-checkbox:checked'); if(selected.length === 0) return showToast("No students selected", "error"); document.getElementById('bulk-student-count-display').innerText = `Applying to ${selected.length} students.`; document.getElementById('bulk-assign-modal').style.display = 'flex'; refreshBulkTopicUI(); }
    async function refreshBulkTopicUI() { const g = document.getElementById('bulk-grade-select').value; const d = document.getElementById('bulk-topic-list'); d.innerHTML='Loading...'; let files=[]; if(GITHUB_CONFIG.enabled) files=await fetchGithubFolder(`questions/grade_${g}`); d.innerHTML=''; if(files.length>0) files.filter(f=>f.name.endsWith('.json')).forEach(f=>d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="${f.download_url}"> ${f.name}</label>`); else Object.keys(QUESTION_REPOSITORY[g]||{}).forEach(t=>d.innerHTML+=`<label class="topic-checkbox-label" style="display:block; margin:5px 0;"><input type="checkbox" value="INTERNAL:${t}"> ${t}</label>`); }

    async function saveBulkStudentTopics() {
        const selectedStudents = Array.from(document.querySelectorAll('.student-select-checkbox:checked')).map(cb => cb.dataset.username); const topics = Array.from(document.querySelectorAll('#bulk-topic-list input:checked')).map(cb => cb.value); const grade = document.getElementById('bulk-grade-select').value;
        if (selectedStudents.length === 0) return showToast("No students selected", "error");
        const batch = window.fbase.writeBatch(window.db);
        selectedStudents.forEach(user => { const ref = window.fbase.doc(window.db, "students", user); const updateData = { assignedGrade: grade }; if (topics.length > 0) { updateData.assignedTopics = window.fbase.arrayUnion(...topics); } batch.update(ref, updateData); });
        await batch.commit(); showToast(`Added topics to ${selectedStudents.length} students!`, "success"); document.getElementById('bulk-assign-modal').style.display='none';
    }

    let currentRoomId=null, pvpUnsubscribe=null, isHost=false, localOpponentHP=0, localPlayerHP=0;
    function showMultiplayerMenu() { document.getElementById('wilds-menu').style.display='none'; document.getElementById('multiplayer-menu').style.display='block'; }
    
    async function createPvPRoom() { 
        if(gameState.brainPoints<100) return showToast("Need 100 BP", "error"); 
        const pet=gameState.pets.find(p=>p.id===gameState.currentPetId);
        if(pet.hp <= 0) return showToast("Your pet is too weak! Heal it first.", "error");
        gameState.brainPoints-=100; updateStatsDisplay(); 
        const code=Math.floor(1000+Math.random()*9000).toString(); 
        currentRoomId=code; isHost=true; localOpponentHP = 0; localPlayerHP = pet.hp;
        await window.fbase.setDoc(window.fbase.doc(window.db,"rooms",code),{ hostName:gameState.playerName, hostPet:pet, status:"waiting", turn:"host", hostHP:pet.hp, hostMaxHP:pet.maxHP, guestHP:0, guestMaxHP:0, logs:[`${gameState.playerName} created room.`] }); 
        document.getElementById('multiplayer-menu').style.display='none'; 
        document.getElementById('pvp-lobby-screen').style.display='block'; 
        document.getElementById('display-room-code').innerText=code; 
        subscribeToRoom(code); 
    }
    
    async function joinPvPRoom() { 
        const code=document.getElementById('room-code-input').value.trim(); const pet=gameState.pets.find(p=>p.id===gameState.currentPetId); 
        if(pet.hp <= 0) return showToast("Your pet is too weak! Heal it first.", "error");
        const r=await window.fbase.getDoc(window.fbase.doc(window.db,"rooms",code)); 
        if(r.exists() && r.data().status==="waiting") { 
            currentRoomId=code; isHost=false; localOpponentHP = r.data().hostHP; localPlayerHP = pet.hp;
            await window.fbase.updateDoc(window.fbase.doc(window.db,"rooms",code),{ guestName:gameState.playerName, guestPet:pet, guestHP:pet.hp, guestMaxHP:pet.maxHP, status:"connected", logs:window.fbase.arrayUnion(`${gameState.playerName} joined!`)}); 
            document.getElementById('multiplayer-menu').style.display='none'; document.getElementById('pvp-lobby-screen').style.display='block'; document.getElementById('display-room-code').innerText=code; subscribeToRoom(code); 
        } else { showToast("Room Error", "error"); }
    }
    
    function subscribeToRoom(code) { 
        pvpUnsubscribe = window.fbase.onSnapshot(window.fbase.doc(window.db,"rooms",code), (doc)=>{ 
            const d=doc.data(); if(!d) return; 
            document.getElementById('pvp-host-status').innerHTML=`Host: ${d.hostName}`; 
            document.getElementById('pvp-guest-status').innerHTML=`Guest: ${d.guestName||'...'}`; 
            if(d.status==='connected' && isHost) document.getElementById('pvp-start-btn').style.display='block'; 
            if(d.status==='battle') { 
                if(document.getElementById('pvp-lobby-screen').style.display!=='none') { 
                    document.getElementById('pvp-lobby-screen').style.display='none'; 
                    const availableBGs = [...Object.values(BATTLE_BACKGROUNDS), ...ARENA_IMGS];
                    const randomBG = availableBGs[Math.floor(Math.random() * availableBGs.length)];
                    document.getElementById('battle-ui').style.backgroundImage = `url('${randomBG}')`;
                    document.getElementById('battle-ui').style.display='flex'; 
                    soundManager.playBGM('boss'); 
                } 
                renderPvPBattle(d); 
            } 
        }); 
    }
    async function startPvPBattle() { await window.fbase.updateDoc(window.fbase.doc(window.db,"rooms",currentRoomId),{status:"battle",logs:window.fbase.arrayUnion("‚öîÔ∏è BATTLE START!")}); }
    
    function renderPvPBattle(d) {
        const myPet = isHost ? d.hostPet : d.guestPet; const oppPet = isHost ? d.guestPet : d.hostPet;
        const myHP = isHost ? d.hostHP : d.guestHP; const oppHP = isHost ? d.guestHP : d.hostHP;
        const myMax = isHost ? d.hostMaxHP : d.guestMaxHP; const oppMax = isHost ? d.guestMaxHP : d.hostMaxHP;

        const pVis = document.getElementById('battle-player-visual'); const eVis = document.getElementById('battle-enemy-visual');
        const mySize = getBattlerSize(myPet, false, false); const oppSize = getBattlerSize(oppPet, false, false);

        pVis.classList.remove('flipped-opponent');
        if(myPet.image) pVis.innerHTML = `<img src="${myPet.image}" class="battler-image ${myPet.imageStyle}" style="width:${mySize}px; height:${mySize}px;">`; else pVis.innerHTML = `<div style="font-size:${mySize*0.7}px;">${myPet.emoji}</div>`;
        eVis.classList.add('flipped-opponent');
        if(oppPet.image) eVis.innerHTML = `<img src="${oppPet.image}" class="battler-image ${oppPet.imageStyle}" style="width:${oppSize}px; height:${oppSize}px;">`; else eVis.innerHTML = `<div class="emoji-wrapper" style="font-size:${oppSize*0.7}px;">${oppPet.emoji}</div>`;

        if (localOpponentHP > oppHP) {
            const dmg = localOpponentHP - oppHP; pVis.style.animation = "attackLunge 0.4s"; eVis.style.animation = "damageShake 0.4s"; createProjectile(myPet.image || "‚öîÔ∏è", pVis, eVis); showFloatingText(eVis.parentElement, `-${dmg}`, "crit"); soundManager.playSFX('hit'); setTimeout(() => { pVis.style.animation = ""; eVis.style.animation = ""; }, 500);
        }
        if (localPlayerHP > myHP) {
            const dmg = localPlayerHP - myHP; eVis.style.animation = "attackLunge 0.4s"; pVis.style.animation = "damageShake 0.4s"; createProjectile(oppPet.image || "‚öîÔ∏è", eVis, pVis); showFloatingText(pVis.parentElement, `-${dmg}`, "crit"); soundManager.playSFX('hit'); setTimeout(() => { pVis.style.animation = ""; eVis.style.animation = ""; }, 500);
        }
        localOpponentHP = oppHP; localPlayerHP = myHP;
        
        document.getElementById('player-battle-name').innerHTML = `${isHost?d.hostName:d.guestName} <span class="element-icon">${getElIcon(myPet.element)}</span>`;
        document.getElementById('enemy-name').innerHTML = `${isHost?d.guestName:d.hostName} <span class="element-icon">${getElIcon(oppPet.element)}</span>`;
        document.getElementById('player-hp-bar').style.width = (myHP / myMax * 100) + "%";
        document.getElementById('player-hp-trail').style.width = (myHP / myMax * 100) + "%";
        document.getElementById('player-hp-text').innerText = `${myHP}/${myMax}`;
        document.getElementById('enemy-hp-bar').style.width = (oppHP / oppMax * 100) + "%";
        document.getElementById('enemy-hp-trail').style.width = (oppHP / oppMax * 100) + "%";

        const act = document.getElementById('battle-actions'); const turn = (d.turn === 'host' && isHost) || (d.turn === 'guest' && !isHost);
        if (myHP <= 0 || oppHP <= 0) { act.innerHTML = "<h2>GAME OVER</h2>"; setTimeout(leavePvPRoom, 3000); return; }
        
        // PvP uses simpler buttons than the advanced AI battle
        act.innerHTML = myPet.powers.map(pid => { const i = findShopItem(pid); return `<button class="action-btn green" onclick="usePvPAttack('${pid}')" ${!turn ? 'disabled style="opacity:0.5"' : ''}>${i.name}</button>`; }).join('');
    }

    async function usePvPAttack(pid) { const item=findShopItem(pid); const r=window.fbase.doc(window.db,"rooms",currentRoomId); soundManager.playSFX('attack'); await window.fbase.runTransaction(window.db, async(t)=>{ const d=(await t.get(r)).data(); const turn=(d.turn==='host'&&isHost)||(d.turn==='guest'&&!isHost); if(!turn) return; const dmg=(item.damage||10); t.update(r,{hostHP:isHost?d.hostHP:Math.max(0,d.hostHP-dmg), guestHP:isHost?Math.max(0,d.guestHP-dmg):d.guestHP, turn:isHost?'guest':'host', logs:window.fbase.arrayUnion(`${isHost?d.hostName:d.guestName} used ${item.name}!`) }); }); }
    function leavePvPRoom() { if(pvpUnsubscribe) pvpUnsubscribe(); currentRoomId=null; document.getElementById('pvp-lobby-screen').style.display='none'; document.getElementById('battle-ui').style.display='none'; document.getElementById('wilds-menu').style.display='block'; soundManager.playBGM('wilds'); }
    
    function readQuestionAloud() { if (gameState.currentQuestion) { const d=document.createElement('div'); d.innerHTML=gameState.currentQuestion.q; const t=d.textContent||d.innerText||""; if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.rate = 0.9; window.speechSynthesis.speak(u); } } }
    
    let touchStartX = 0; let touchStartY = 0;
    function initSwipe() { const zone = document.getElementById('rpg-canvas'); zone.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, {passive: false}); zone.addEventListener('touchend', function(e) { let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY); }, {passive: false}); }
    function handleSwipe(sx, sy, ex, ey) { if (gameState.inBattle) return; const diffX = ex - sx; const diffY = ey - sy; if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return; if (Math.abs(diffX) > Math.abs(diffY)) { handleDPad(diffX > 0 ? 'ArrowRight' : 'ArrowLeft'); } else { handleDPad(diffY > 0 ? 'ArrowDown' : 'ArrowUp'); } }

    // --- WORLD BOSS RAID SYSTEM (ADVANCED) ---

    let raidUnsub = null;
    let currentRaidData = null;

    // ===============================================
// FIXED TEACHER SUMMON (Complete Logic)
// ===============================================
async function teacherSummonRaid() {
    console.log("üëâ Teacher Summon Clicked");

    if (!currentLoggedTeacher) {
        return showToast("Error: You are not logged in.", "error");
    }

    try {
        // 1. Get Values from HTML
        const nameEl = document.getElementById('t-boss-name');
        const hpEl = document.getElementById('t-boss-hp');
        const atkEl = document.getElementById('t-boss-atk');
        const imgEl = document.getElementById('t-boss-img');
        const rewEl = document.getElementById('t-boss-reward-url');

        if (!nameEl || !hpEl) {
            alert("Error: Input boxes are missing from the HTML!");
            return;
        }

        const name = nameEl.value || "Class Boss";
        const hp = parseInt(hpEl.value) || 5000;
        const atk = parseInt(atkEl.value) || 15;
        const img = imgEl.value || "";
        const reward = rewEl.value || "";

        // 2. DEFINE THE DATA (This is what was missing before!)
        const bossData = {
            name: name,
            hp: hp,
            maxHP: hp,
            attack: atk,
            image: img,
            rewardUrl: reward,
            active: true,
            summonedBy: currentLoggedTeacher,
            damageDealers: {} 
        };

        // 3. Send to Firebase (To the Teacher's specific ID)
        await window.fbase.setDoc(window.fbase.doc(window.db, "world_boss", `teacher_${currentLoggedTeacher}`), bossData);
        
        alert("‚úÖ Class Boss Summoned Successfully!");

    } catch (e) {
        console.error("Teacher Summon Error:", e);
        alert("Summon Failed: " + e.message);
    }
}

async function checkClassBoss() {
    if (!gameState.playerName) return;
    
    let tid = gameState.teacherId;
    
    if (!tid) {
        try {
            const s = await window.fbase.getDoc(window.fbase.doc(window.db, "students", gameState.playerName));
            if (s.exists()) tid = s.data().teacherId;
            if (tid) gameState.teacherId = tid;
        } catch(e) {}
    }

    if (tid) {
        window.fbase.onSnapshot(window.fbase.doc(window.db, "world_boss", `teacher_${tid}`), (doc) => {
            const data = doc.data();
            
            // SAME LOGIC AS GLOBAL
            if (doc.exists() && data.active) {
                if (data.hp <= 0) {
                     if (currentRunDamage === 0) {
                        alert("Class Boss already defeated!");
                        finalizeExit();
                    } else {
                        handleRaidVictory();
                    }
                } else {
                    setupRaidData(data, `teacher_${tid}`);
                }
            } else {
                // NO BOSS AT ALL -> KICK OUT
                alert("No Active Raid found.");
                finalizeExit();
            }
        });
    } else {
        alert("No Global Raid and No Class Assigned.");
        finalizeExit();
    }
}

// Helper to update UI
function setupRaidData(data, docId) {
    currentRaidData = data;
    localRaidData = data; 
    
    document.getElementById('raid-boss-hp-text').innerText = `${Math.ceil(data.hp)} / ${data.maxHP}`;
    document.getElementById('raid-boss-bar').style.width = (data.hp / data.maxHP * 100) + "%";
    
    const vis = document.getElementById('raid-boss-visual');
    if (!vis.innerHTML.includes(data.image || 'üëπ')) {
         vis.innerHTML = data.image ? `<img src="${data.image}" style="width:200px; filter:drop-shadow(0 0 10px red);">` : 'üëπ';
    }
    
    renderLeaderboard(data.damageDealers);
    window.currentRaidDocPath = docId; 
}

    function renderLeaderboard(dealers) {
        if (!dealers) return;
        
        // Convert object to array and sort
        const sorted = Object.entries(dealers)
            .sort(([,a], [,b]) => b - a) // Sort desc
            .slice(0, 10); // Top 10

        const list = document.getElementById('raid-leaderboard-list');
        list.innerHTML = sorted.map(([name, dmg], index) => {
            const isMe = name === gameState.playerName;
            let medal = "";
            if (index === 0) medal = "ü•á";
            else if (index === 1) medal = "ü•à";
            else if (index === 2) medal = "ü•â";

            return `<div class="lb-row ${isMe ? 'me' : ''}">
                <span>${medal} ${index+1}. ${name}</span>
                <span>${dmg} dmg</span>
            </div>`;
        }).join('');
    }

    // 4. Attack Transaction (Prevent Race Conditions)
    let raidCooldown = false;
    async function attackRaidBoss() {
        if (raidCooldown) return;
        
        // Get Current Active Pet
        let pet = gameState.pets.find(p => p.id === gameState.currentPetId);
        
        // Auto-swap logic if current is dead
        if (pet.hp <= 0) {
            const nextLive = getSquad().find(p => p.hp > 0);
            if (nextLive) {
                gameState.currentPetId = nextLive.id;
                pet = nextLive;
                showToast(`Swapped to ${pet.name}!`, "info");
            } else {
                return showToast("Entire squad fainted! Revive them.", "error");
            }
        }

        raidCooldown = true;
        const btn = document.getElementById('raid-atk-btn');
        btn.style.opacity = 0.5;

        // Calc Damage
        const dmg = 20 + (pet.level * 2) + Math.floor(Math.random()*10);

        const ref = window.fbase.doc(window.db, "world_boss", "active");

        try {
            await window.fbase.runTransaction(window.db, async (transaction) => {
                const sfDoc = await transaction.get(ref);
                if (!sfDoc.exists()) throw "Boss missing!";
                
                const curHP = sfDoc.data().hp;
                if (curHP <= 0) throw "Boss dead";

                // Damage Boss
                const newHP = Math.max(0, curHP - dmg);
                
                // Record Player Damage (Atomic increment)
                const myDmgPath = `damageDealers.${gameState.playerName}`;
                const dealers = sfDoc.data().damageDealers || {};
                const currentMyDmg = dealers[gameState.playerName] || 0;

                transaction.update(ref, { 
                    hp: newHP,
                    active: newHP > 0, // Set inactive if dead
                    [myDmgPath]: currentMyDmg + dmg
                });
            });

            // Visuals
            const vis = document.getElementById('raid-boss-visual');
            vis.style.transform = "scale(0.9) rotate(5deg)";
            setTimeout(()=> vis.style.transform = "scale(1)", 100);
            showToast(`Dealt ${dmg} DMG!`, "success");

            // Boss Hits Back (Local Calc)
            if (Math.random() > 0.5) {
                pet.hp -= 10;
                if(pet.hp < 0) pet.hp = 0;
                saveGame();
                if(pet.hp === 0) showToast(`${pet.name} fainted!`, "error");
            }

        } catch (e) {
            console.log(e);
        }

        setTimeout(() => { raidCooldown = false; btn.style.opacity = 1; }, 800);
    }

    // 5. Victory & Rewards (Updated for Battle UI)
    let hasClaimedRaidReward = false; // Prevents double claiming glitches

    async function handleRaidVictory() {
        if (hasClaimedRaidReward) return; // Stop if already claimed
        hasClaimedRaidReward = true; 

        if (raidListenerUnsub) raidListenerUnsub(); // Stop listening
        
        soundManager.stopBGM();
        soundManager.playSFX('victory');

        // HIJACK THE BATTLE UI FOR VICTORY
        const battlePanel = document.getElementById('battle-ui');
        
        // Create a Victory Overlay inside the battle screen
        battlePanel.innerHTML = `
            <div style="
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
                align-items: center; justify-content: center; z-index: 100; color: white;
                animation: popIn 0.5s;
            ">
                <h1 style="color:#48bb78; font-size:50px; text-shadow:0 0 20px #fff; margin-bottom: 10px;">VICTORY!</h1>
                <p style="font-size: 20px; margin-bottom: 20px;">The Titan has fallen.</p>
                
                <div id="raid-reward-content" style="text-align:center; min-height: 150px;">
                    <div class="egg-shaking" style="font-size:60px;">üéÅ</div>
                    <p>Fetching Reward...</p>
                </div>

                <button class="action-btn red" style="width: 200px; margin-top: 20px;" onclick="location.reload()">Back to Hub</button>
            </div>
        `;

        // Fetch Reward Data
        if (currentRaidData && currentRaidData.rewardUrl) {
            try {
                let url = currentRaidData.rewardUrl;
                if(!url.startsWith('http')) url = `https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/${url}`;
                
                const res = await fetch(url);
                const petData = await res.json();
                
                // Register Evolutions if present
                if (petData.evolutions && petData.type) {
                    EVOLUTION_CHAINS[petData.type] = petData.evolutions;
                }
                
                // Add to Inventory
                const newPet = {
                    id: 'raid_reward_' + Date.now(),
                    ...petData, 
                    level: 5, // Bonus level for Raid reward
                    hp: petData.hp || 50,
                    maxHP: petData.hp || 50,
                    xp: 0, maxXp: 400,
                    isHatched: true
                };
                
                gameState.pets.push(newPet);
                addBP(500); // BP Bonus
                saveGame();

                // Show the Pet
                const rewardContainer = document.getElementById('raid-reward-content');
                if(rewardContainer) {
                    rewardContainer.innerHTML = `
                        <h3 style="color:#f6e05e; font-size: 24px;">${newPet.name}</h3>
                        ${newPet.image ? `<img src="${newPet.image}" style="width:150px; height:150px; object-fit:contain; filter:drop-shadow(0 0 10px white);">` : `<div style="font-size:80px">${newPet.emoji}</div>`}
                        <div style="color:#48bb78; font-weight:bold; margin-top:10px;">+500 Brain Points</div>
                    `;
                }

            } catch(e) {
                console.error("Reward Error", e);
                const rewardContainer = document.getElementById('raid-reward-content');
                if(rewardContainer) rewardContainer.innerHTML = "<p>Reward Error (Check Network)</p><p>+500 BP added.</p>";
                addBP(500);
            }
        } else {
            // No specific pet reward, just BP
            addBP(500);
            const rewardContainer = document.getElementById('raid-reward-content');
            if(rewardContainer) rewardContainer.innerHTML = "<h3 style='color:#f6e05e'>Reward: 500 BP</h3>";
        }
    }
// ===============================================
// FIXED JOIN RAID (Checks Global vs Class)
// ===============================================
// ===============================================
// FIXED JOIN RAID (Handles Multiple Boss Priority)
// ===============================================
async function joinRaid() {
    // 1. Check Entry Fee
    if (gameState.brainPoints < 1) return showToast("Need 1 BP to enter!", "error");
    
    // 2. Check Pet Health
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (!pet) return showToast("No pet selected!", "error");
    if (pet.hp <= 0) return showToast("Your current pet is fainted!", "error");

    showToast("Searching for Active Raid...", "info");

    let raidPath = null;

    try {
        // --- PRIORITY 1: GLOBAL BOSS (Admin) ---
        const globalRef = window.fbase.doc(window.db, "world_boss", "global");
        const globalSnap = await window.fbase.getDoc(globalRef);

        if (globalSnap.exists() && globalSnap.data().active && globalSnap.data().hp > 0) {
            console.log("Found Global Boss");
            raidPath = "global";
        } 
        else {
            // --- PRIORITY 2: TEACHER BOSS ---
            // Find Student's Teacher ID
            let tid = gameState.teacherId;
            if (!tid) {
                const s = await window.fbase.getDoc(window.fbase.doc(window.db, "students", gameState.playerName));
                if (s.exists()) {
                    tid = s.data().teacherId;
                    gameState.teacherId = tid; // Cache it
                }
            }

            if (tid) {
                const classRef = window.fbase.doc(window.db, "world_boss", `teacher_${tid}`);
                const classSnap = await window.fbase.getDoc(classRef);
                if (classSnap.exists() && classSnap.data().active && classSnap.data().hp > 0) {
                    console.log("Found Class Boss for teacher:", tid);
                    raidPath = `teacher_${tid}`;
                }
            }
        }
    } catch (e) {
        console.error("Raid Check Error:", e);
        return showToast("Network Error checking raids.", "error");
    }

    // If neither exists
    if (!raidPath) {
        return showToast("No Active Raid Found!", "error");
    }

    // 3. Deduct BP and Start
    gameState.brainPoints -= 1;
    updateStatsDisplay();
    saveGame();

    // 4. Switch UI
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-wilds').classList.add('active'); 
    
    document.getElementById('wilds-menu').style.display = 'none';
    document.getElementById('rpg-wrapper').style.display = 'none';
    document.getElementById('multiplayer-menu').style.display = 'none';
    document.getElementById('raid-arena').style.display = 'none'; 
    
    const ui = document.getElementById('battle-ui');
    ui.style.display = 'flex';
    // Default raid background
    ui.style.backgroundImage = `url('https://raw.githubusercontent.com/rye-ai/MathPetRPG/main/sprite/bg/undefined%20-%20Imgur%20(3).png')`; 

    // 5. CRITICAL: Start the engine with the SPECIFIC path found
    startRaidEngine(raidPath);
}

// --- GLOBAL RAID FUNCTIONS (Fixed & Un-nested) ---

window.prepareRaidAttack = function(moveId) {
    console.log("‚öîÔ∏è Attack button clicked for move:", moveId);

    // 1. Check/Reset Lock
    // We check if the variable exists globally. If not, we assume safe to proceed.
    if (typeof isRaidTurnProcessing !== 'undefined') {
        if(isRaidTurnProcessing === true) {
            console.log("‚è≥ Turn is processing... ignoring click.");
            return;
        }
    } else {
        // If variable is missing, define it globally to prevent errors
        window.isRaidTurnProcessing = false;
    }

    // 2. Determine Question Source (Assigned vs Random)
    let qData = null;

    try {
        if (window.gameState && window.gameState.activeQuestionPool && window.gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * window.gameState.activeQuestionPool.length);
            const sourceQ = window.gameState.activeQuestionPool[randIndex];
            
            if (sourceQ && typeof sourceQ === 'object') {
                qData = {
                    text: sourceQ.qVisualHTML || sourceQ.q || "Solve this problem:",
                    a: sourceQ.a,
                    options: sourceQ.options
                };
            }
        }
    } catch (err) {
        console.error("Error loading topic question:", err);
    }

    // Fallback
    if (!qData) {
        if (typeof MathEngine !== 'undefined') {
            qData = MathEngine.generate(window.gameState.grade || '1');
        } else {
            qData = { text: "5 + 5 = ?", a: 10, options: [5, 10, 15, 20] };
        }
    }

    const answer = qData.a;

    // 3. Create Overlay
    const battleUI = document.getElementById('battle-ui');
    if (!battleUI) return console.error("Battle UI not found!");

    const existing = document.getElementById('raid-math-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = "raid-math-overlay";
    overlay.style.cssText = `
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; animation: popIn 0.2s;
    `;

    overlay.innerHTML = `
        <div style="font-size: 20px; color: #a0aec0; margin-bottom: 10px;">‚ö†Ô∏è MATH CRIT CHANCE ‚ö†Ô∏è</div>
        <div style="font-size: 32px; font-weight: bold; margin-bottom: 30px; text-align:center; max-width:90%;">
            ${qData.text}
        </div>
        <div id="raid-math-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%;"></div>
        <button onclick="document.getElementById('raid-math-overlay').remove()" style="margin-top:20px; background:none; border:none; color:#aaa; cursor:pointer;">Cancel</button>
    `;

    battleUI.appendChild(overlay);

    // 4. Generate Options
    const optsContainer = overlay.querySelector('#raid-math-options');
    let finalOptions = [];

    if (qData.options && Array.isArray(qData.options) && qData.options.length > 0) {
        finalOptions = [...qData.options];
    } else {
        let optionsSet = new Set([answer]);
        const numericAns = parseFloat(answer);
        if (!isNaN(numericAns)) {
            while(optionsSet.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                if(offset !== 0) optionsSet.add(numericAns + offset);
            }
        } else {
            optionsSet.add("Yes");
            optionsSet.add("No");
        }
        finalOptions = Array.from(optionsSet);
    }

    finalOptions.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.fontSize = "20px";
        btn.style.minHeight = "60px";
        btn.innerHTML = opt; 
        btn.onclick = function() { resolveRaidMath(moveId, opt, answer); };
        optsContainer.appendChild(btn);
    });
};

window.resolveRaidMath = function(moveId, selected, correct) {
    const overlay = document.getElementById('raid-math-overlay');
    if(overlay) overlay.remove();

    if (selected == correct) {
        showFloatingText(document.body, "MATH CRIT! (2x)", "crit");
        soundManager.playSFX('correct');
        useRaidMove(moveId, 2.0, 1.0); 
    } else {
        showFloatingText(document.body, "WRONG! (Vuln Up)", "weak");
        soundManager.playSFX('wrong');
        useRaidMove(moveId, 0.5, 2.0);
    }
};

    // --- Raid Engine State ---
    let raidListenerUnsub = null;
    let localRaidData = { attack: 15 }; // <--- NEW: Defaults to 15

    // ===============================================
// FIXED RAID ENGINE (Listens to Correct Path)
// ===============================================
function startRaidEngine(path) {
    // Default to global if no path provided (fallback)
    const docPath = path || "global";
    window.currentRaidDocPath = docPath; // Save for score submission

    currentRunDamage = 0; 
    gameState.inBattle = true;
    document.getElementById('enemy-name').innerText = "Loading Titan...";
    
    // Connect to Firestore Live Data using the CORRECT PATH
    const docRef = window.fbase.doc(window.db, "world_boss", docPath);
    
    if (raidListenerUnsub) raidListenerUnsub(); // Clear old listeners

    raidListenerUnsub = window.fbase.onSnapshot(docRef, (doc) => {
        // --- CRITICAL FIX: PREVENT INSTANT WIN ON 404 ---
        if (!doc.exists() || !doc.data().active) {
            // Boss is gone or deleted.
            // Only trigger victory if we were ALREADY fighting and now it's gone.
            if (currentRunDamage > 0) {
                // We fought, so maybe we get a reward?
                // Actually, simpler to just exit safely.
                showToast("Raid ended.", "info");
                submitRaidRun("Raid Ended"); // Submit whatever we did
            } else {
                // We just got here and it's gone.
                showToast("Raid is no longer active.", "error");
                exitRaidBattle();
            }
            return;
        }

        const data = doc.data();
        
        // Check if dead
        if (data.hp <= 0) {
             handleRaidVictory();
             return;
        }

        // --- CAPTURE BOSS DATA ---
        localRaidData = data; 
        // -------------------------

        // Update Boss Visuals
        const enemyVis = document.getElementById('battle-enemy-visual');
        // Prevent flickering re-renders
        if (!enemyVis.innerHTML.includes(data.image) && data.image) {
            enemyVis.classList.add('flipped-opponent');
            enemyVis.innerHTML = `<img src="${data.image}" class="battler-image" style="width:300px; height:300px; filter:drop-shadow(0 0 15px red);">`;
        } else if (!data.image && enemyVis.innerText !== 'üëπ') {
             enemyVis.innerHTML = '<div style="font-size:100px;">üëπ</div>';
        }

        // Update Boss HP (Real-time)
        document.getElementById('enemy-name').innerHTML = `‚ò†Ô∏è ${data.name}`;
        document.getElementById('enemy-hp-bar').style.width = (data.hp / data.maxHP * 100) + "%";
        
        // Render Player Side
        renderRaidPlayerSide();
    });
}
    function renderRaidPlayerSide() {
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    
    // 1. Render Visuals
    const pVis = document.getElementById('battle-player-visual');
    pVis.classList.remove('flipped-opponent');
    pVis.innerHTML = pet.image 
        ? `<img src="${pet.image}" class="battler-image ${pet.imageStyle}" style="width:200px; height:200px;">` 
        : `<div style="font-size:100px;">${pet.emoji}</div>`;

    document.getElementById('player-battle-name').innerText = pet.name;
    document.getElementById('player-hp-bar').style.width = (pet.hp / pet.maxHP * 100) + "%";
    document.getElementById('player-hp-text').innerText = `${Math.ceil(pet.hp)}/${pet.maxHP}`;

    // 2. Render Buttons (Using FORCE logic)
    const btnGrid = document.getElementById('battle-actions');
    
    let buttons = pet.powers.map(pid => {
        const move = findShopItem(pid);
        // We use window.FORCE_RAID_ATTACK to bypass any scope issues
        return `<button class="action-btn green" style="border:2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="window.FORCE_RAID_ATTACK('${pid}')">${move.name}</button>`;
    }).join('');
    
    buttons += `<button class="action-btn blue" onclick="openSwapMenu()">üîÑ Squad</button>`;
    buttons += `<button class="action-btn red" onclick="exitRaidBattle()">üèÉ Escape</button>`;
    
    if(document.getElementById('action-buttons-grid')) {
        document.getElementById('action-buttons-grid').innerHTML = buttons;
    } else {
        btnGrid.innerHTML = `<div id="action-buttons-grid" class="battle-actions">${buttons}</div>`;
    }
}

    // --- The Connector (Animation + Database Transaction) ---
    // ===============================================
// RAID BATTLE ENGINE (40% Boss Attack Chance)
// ===============================================

// ===============================================
// "SURVIVAL RUN" RAID ENGINE (Saves Max Quota)
// ===============================================

let isRaidTurnProcessing = false;
let currentRunDamage = 0; // Accumulated damage for THIS fight only

// 1. THE ATTACK FUNCTION (100% Local - No Internet Usage)
window.useRaidMove = async function(moveId, playerMult = 1.0, bossMult = 1.0) {
    if (isRaidTurnProcessing) return;
    
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    if (pet.hp <= 0) return showToast("Pet fainted! Run ended.", "error");

    isRaidTurnProcessing = true;
    const move = findShopItem(moveId);

    // --- A. ANIMATIONS ---
    const pVis = document.getElementById('battle-player-visual');
    const eVis = document.getElementById('battle-enemy-visual');
    
    soundManager.playSFX('attack');
    pVis.style.animation = "attackLunge 0.3s";
    createProjectile(move.image || move.icon, pVis, eVis);
    
    await new Promise(r => setTimeout(r, 400)); 
    pVis.style.animation = "";
    eVis.style.animation = "damageShake 0.4s";
    soundManager.playSFX('hit');

    // --- B. LOCAL CALCULATION ONLY ---
    const baseDmg = 20 + (pet.level * 3);
    const random = Math.floor(Math.random() * 10);
    const finalDmg = Math.floor((baseDmg + random) * playerMult); 

    // Add to our local "Score"
    currentRunDamage += finalDmg;

    // Visuals
    const typeClass = playerMult > 1 ? "crit" : (playerMult < 1 ? "weak" : "super");
    showFloatingText(eVis.parentElement, `-${finalDmg}`, typeClass);
    
    // Fake update the Boss Bar (Visual Only)
    const bossBar = document.getElementById('raid-boss-bar');
    const hpText = document.getElementById('raid-boss-hp-text');
    if (localRaidData && bossBar) {
        // Show "Damage Done so far" in the UI somewhere if you want
        hpText.innerText = `Run Damage: ${currentRunDamage}`;
    }

    // --- C. BOSS COUNTER-ATTACK ---
    setTimeout(() => {
        // 40% Chance for boss to hit
        if (Math.random() > 0.4) {
            showFloatingText(pVis.parentElement, "DODGED!", "heal");
            isRaidTurnProcessing = false;
            return;
        }

        eVis.style.animation = "attackLunge 0.3s";
        soundManager.playSFX('hit');
        pVis.style.animation = "damageShake 0.4s";
        
        const baseAtk = (localRaidData && localRaidData.attack) ? localRaidData.attack : 15;
        const variance = Math.floor(baseAtk * 0.2); 
        const rawBossDmg = baseAtk + (Math.floor(Math.random() * variance * 2) - variance);
        const finalBossDmg = Math.floor(rawBossDmg * bossMult);

        pet.hp = Math.max(0, pet.hp - finalBossDmg);
        showFloatingText(pVis.parentElement, `-${finalBossDmg}`, bossMult > 1 ? "crit" : "weak");
        
        if (typeof renderRaidPlayerSide === 'function') renderRaidPlayerSide();
        saveGame(); 

        // CHECK FAINT (End the run automatically)
        if (pet.hp <= 0) {
             const squadIds = (gameState.team && gameState.team.length > 0) ? gameState.team : [gameState.currentPetId];
             const hasLivingPet = squadIds.some(id => {
                 const p = gameState.pets.find(x => x.id === id);
                 return p && p.hp > 0;
             });

             if (hasLivingPet) {
                 showToast(`${pet.name} Fainted! Swap!`, "error");
                 if (typeof openSwapMenu === 'function') openSwapMenu(true); 
             } else {
                 // ALL PETS DEAD -> SUBMIT SCORE
                 submitRaidRun("Defeated");
             }
        }
        
        isRaidTurnProcessing = false;

    }, 800); 
};
// ===============================================
// 1. MISSING CLEANUP FUNCTION (FIXES THE CRASH)
// ===============================================
function finalizeExit() {
    console.log("üö™ Exiting Raid...");

    // 1. Stop Firebase Listener
    if (raidListenerUnsub) {
        raidListenerUnsub();
        raidListenerUnsub = null;
    }

    // 2. Reset Battle Flags
    gameState.inBattle = false;
    window.currentRaidDocPath = null;
    currentRunDamage = 0; // Reset local damage counter

    // 3. UI Cleanup
    // Hide Battle UI
    document.getElementById('battle-ui').style.display = 'none';
    
    // Show Wilds Menu (The Hub)
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-wilds').classList.add('active');
    document.getElementById('wilds-menu').style.display = 'block';
    document.getElementById('rpg-wrapper').style.display = 'none';
    document.getElementById('multiplayer-menu').style.display = 'none';
    
    // 4. Audio
    soundManager.stopBGM();
    soundManager.playBGM('wilds');
}

// 2. SUBMIT SCORE (Runs only ONCE per session)
// ===============================================
// 2. FIXED SCORE SUBMISSION
// ===============================================
async function submitRaidRun(reason) {
    if (currentRunDamage <= 0) {
        // If we didn't do any damage, just leave immediately
        finalizeExit();
        return;
    }

    const dmgToSend = currentRunDamage;
    currentRunDamage = 0; // Prevent double submission
    
    // Show "Sending..." in the button area so user knows it's working
    const btnArea = document.getElementById('battle-actions');
    if(btnArea) btnArea.innerHTML = `<div style="color:white;text-align:center;font-weight:bold;padding:10px;">üì° Uploading Score...</div>`;

    const myUser = gameState.playerName;
    // Default to global if path somehow got lost
    const path = window.currentRaidDocPath || "global"; 
    const ref = window.fbase.doc(window.db, "world_boss", path);

    try {
        await window.fbase.runTransaction(window.db, async (t) => {
            const doc = await t.get(ref);
            if (!doc.exists()) return; // Boss might have been deleted
            
            const d = doc.data();
            const newHP = Math.max(0, d.hp - dmgToSend);
            
            // Get existing damage object or create new one
            const dealers = d.damageDealers || {};
            const myTotal = dealers[myUser] || 0;

            t.update(ref, { 
                hp: newHP,
                [`damageDealers.${myUser}`]: myTotal + dmgToSend
            });
        });
        
        // Show success alert
        alert(`‚öîÔ∏è RAID RUN COMPLETE!\n\nReason: ${reason}\nüî• Damage Dealt: ${dmgToSend}`);
        
    } catch(e) {
        console.error("Submit Error:", e);
        // Even if it fails, we must let the user exit
        alert("Network Error: Score might not have saved, but you survived.");
    }

    // NOW call the function that was missing before
    finalizeExit();
}

    // --- NEW RAID SUMMARY & EXIT LOGIC ---

function showRaidSummary() {
    // 1. Get Data from the local capture
    const dealers = localRaidData.damageDealers || {};
    
    // 2. Sort Players by Damage (Highest first)
    const sorted = Object.entries(dealers).sort(([,a], [,b]) => b - a);
    
    // 3. Find My Stats
    const myDmg = dealers[gameState.playerName] || 0;
    const myRank = sorted.findIndex(x => x[0] === gameState.playerName) + 1;

    // 4. Define Reward Logic
    const getReward = (rank) => {
        if (rank === 1) return 1000;
        if (rank === 2) return 800;
        if (rank === 3) return 600;
        if (rank <= 5) return 400;
        return 200; 
    };

    // 5. Build HTML List
    let listHtml = sorted.slice(0, 5).map((entry, i) => {
        const rank = i + 1;
        const isMe = entry[0] === gameState.playerName;
        const reward = getReward(rank);
        let medal = rank === 1 ? "ü•á" : (rank === 2 ? "ü•à" : (rank === 3 ? "ü•â" : `#${rank}`));

        return `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee; ${isMe ? 'background:#ebf8ff; color:#2b6cb0;' : ''}">
            <span style="font-weight:bold;">${medal} ${entry[0]}</span>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size:13px;">${entry[1]} dmg</div>
                <div style="color:#d69e2e; font-size:11px; font-weight:bold;">+${reward} BP</div>
            </div>
        </div>`;
    }).join('');

    // 6. Calculate My Reward
    const myPotentialBP = myRank > 0 ? getReward(myRank) : 0;

    // 7. Show Modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.style.zIndex = "3000";
    modal.innerHTML = `
        <div class="confirm-modal" style="max-width: 400px; padding: 20px;">
            <h2 style="color:#d69e2e; margin-bottom:5px;">üìä Battle Report</h2>
            <p style="font-size:12px; color:#718096; margin-bottom:15px;">Rewards distributed on Victory</p>
            
            <div style="background:white; border:2px solid #e2e8f0; border-radius:10px; margin-bottom:15px; max-height:220px; overflow-y:auto; text-align:left;">
                ${listHtml}
                ${sorted.length > 5 ? `<div style="text-align:center; padding:8px; color:gray; font-size:12px; border-top:1px dashed #ccc;">... and ${sorted.length - 5} others ...<br><span style="color:#d69e2e; font-weight:bold;">(The Rest: +200 BP)</span></div>` : ''}
            </div>

            <div style="background:#2d3748; color:white; padding:15px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-size:11px; color:#a0aec0;">YOUR RANK</div>
                    <div style="font-size:20px; font-weight:bold; color:#f6e05e;">#${myRank > 0 ? myRank : '-'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; color:#a0aec0;">ESTIMATED PAYOUT</div>
                    <div style="font-size:20px; font-weight:bold; color:#48bb78;">+${myPotentialBP} BP</div>
                </div>
            </div>

            <button class="confirm-btn no" style="width:100%;" onclick="this.parentElement.parentElement.remove(); finalizeExit();">
                Return to Camp
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// 3. FIXED EXIT BUTTON
// ===============================================
window.exitRaidBattle = function() {
    // If we have damage pending, submit it first.
    if (currentRunDamage > 0) {
        submitRaidRun("Escape");
    } else {
        // If no damage, just leave properly
        finalizeExit();
    }
}

// --- REWARD CEREMONY SYSTEM ---

function triggerRewardCeremony(title, message, visualHTML, callback) {
    soundManager.playSFX('victory');
    startConfetti();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.style.zIndex = "5000";
    modal.innerHTML = `
        <div class="reward-card-glow">
            <div class="reward-shine"></div>
            <h1 style="color:#d97706; font-size:36px; margin-bottom:10px; text-shadow:2px 2px 0 #fff;">${title}</h1>
            <p style="font-weight:bold; color:#744210; font-size:18px; margin-bottom:20px;">${message}</p>
            <div style="font-size:100px; margin:20px 0; filter:drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: subtleFloat 2s infinite;">
                ${visualHTML}
            </div>
            <button class="gacha-btn" style="margin-top:20px; font-size:24px;" id="claim-reward-btn">CLAIM REWARD!</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('claim-reward-btn').onclick = () => {
        modal.remove();
        if(callback) callback();
    };
}

function startConfetti() {
    const colors = ['#ff0', '#f00', '#0f0', '#00f', '#f0f', '#0ff'];
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    for (let i = 0; i < 100; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDuration = (Math.random() * 2 + 2) + 's';
        c.style.width = (Math.random() * 10 + 5) + 'px';
        c.style.height = c.style.width;
        container.appendChild(c);
    }

    setTimeout(() => container.remove(), 5000); // Cleanup after 5s
}
// --- FORCE FIX FOR RAID POPUP ---

// 1. Reset the lock globally so buttons are clickable
window.isRaidTurnProcessing = false; 

// 2. Define the new function attached to window
window.openRaidMathPopup = function(moveId) {
    console.log("üü¢ Raid Button Clicked:", moveId);

    // Safety Unlock: If the turn isn't actually animating, unlock it.
    // This fixes the "Button doesn't do anything" bug.
    const pVis = document.getElementById('battle-player-visual');
    if (pVis.style.animation === "") {
        window.isRaidTurnProcessing = false;
    }

    if (window.isRaidTurnProcessing) {
        console.log("‚è≥ Busy...");
        return; 
    }

    // A. GET QUESTION DATA
    let qData = null;
    
    // Check Assigned Topics
    try {
        if (window.gameState && window.gameState.activeQuestionPool && window.gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * window.gameState.activeQuestionPool.length);
            const sourceQ = window.gameState.activeQuestionPool[randIndex];
            if (sourceQ && typeof sourceQ === 'object') {
                qData = {
                    text: sourceQ.qVisualHTML || sourceQ.q || "Solve:",
                    a: sourceQ.a,
                    options: sourceQ.options
                };
            }
        }
    } catch(e) { console.error(e); }

    // Fallback to Grade Math
    if (!qData) {
        qData = MathEngine.generate(window.gameState.grade || '1');
    }

    const answer = qData.a;

    // B. SHOW POPUP (FORCE UI)
    const battleUI = document.getElementById('battle-ui');
    
    // Clean up old popups
    const old = document.getElementById('raid-math-overlay');
    if (old) old.remove();

    const overlay = document.createElement('div');
    overlay.id = "raid-math-overlay";
    overlay.style.cssText = `
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; animation: popIn 0.2s;
    `;

    overlay.innerHTML = `
        <div style="font-size: 20px; color: #f6e05e; margin-bottom: 10px;">‚ö° DOUBLE DAMAGE CHANCE ‚ö°</div>
        <div style="font-size: 32px; font-weight: bold; margin-bottom: 30px; text-align:center; max-width:90%;">
            ${qData.text}
        </div>
        <div id="raid-math-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 80%;"></div>
        <button onclick="document.getElementById('raid-math-overlay').remove()" style="margin-top:30px; padding:10px; background:#e53e3e; color:white; border:none; border-radius:5px;">Cancel</button>
    `;

    battleUI.appendChild(overlay);

    // C. GENERATE OPTIONS
    const optsContainer = overlay.querySelector('#raid-math-options');
    let finalOptions = [];

    if (qData.options && qData.options.length > 0) {
        finalOptions = [...qData.options];
    } else {
        // Number Generator
        let optionsSet = new Set([answer]);
        const numericAns = parseFloat(answer);
        if (!isNaN(numericAns)) {
            while(optionsSet.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                if(offset !== 0) optionsSet.add(numericAns + offset);
            }
        } else {
            optionsSet.add("Yes"); optionsSet.add("No");
        }
        finalOptions = Array.from(optionsSet);
    }

    finalOptions.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.fontSize = "22px";
        btn.style.minHeight = "60px";
        btn.innerHTML = opt; 
        btn.onclick = function() { 
            document.getElementById('raid-math-overlay').remove();
            
            if (opt == answer) {
                showFloatingText(document.body, "CRITICAL! (2x)", "crit");
                soundManager.playSFX('correct');
                useRaidMove(moveId, 2.0, 1.0); 
            } else {
                showFloatingText(document.body, "MISS! (Vuln Up)", "weak");
                soundManager.playSFX('wrong');
                useRaidMove(moveId, 0.5, 2.0);
            }
        };
        optsContainer.appendChild(btn);
    });
};

// ===============================================
// FORCE RAID POPUP (WITH BP REWARDS + 1s DELAY)
// ===============================================

window.FORCE_RAID_ATTACK = function(moveId) {
    console.log("üöÄ Force Attack Clicked:", moveId);

    // 1. DATA EXTRACTION
    let mainContent = "Solve:"; 
    let extraVisual = "";       
    let qAnswer = null;
    let qOptions = [];

    try {
        if (typeof gameState !== 'undefined' && gameState.activeQuestionPool && gameState.activeQuestionPool.length > 0) {
            const randIndex = Math.floor(Math.random() * gameState.activeQuestionPool.length);
            const sourceQ = gameState.activeQuestionPool[randIndex];
            
            if (sourceQ && typeof sourceQ === 'object') {
                if (sourceQ.q) mainContent = sourceQ.q;
                else if (sourceQ.text) mainContent = sourceQ.text;

                if (sourceQ.qVisualHTML) extraVisual = sourceQ.qVisualHTML;

                qAnswer = sourceQ.a;
                qOptions = sourceQ.options;
            }
        }
    } catch(e) { console.error("Topic Error:", e); }

    // Fallback
    if (!qAnswer) {
        const g = (typeof gameState !== 'undefined' && gameState.grade) ? gameState.grade : '1';
        const fallback = MathEngine.generate(g);
        mainContent = fallback.q;
        extraVisual = fallback.qVisualHTML || "";
        qAnswer = fallback.a;
        qOptions = fallback.options;
    }

    // 2. CREATE OVERLAY
    const existing = document.getElementById('force-raid-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'force-raid-overlay';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 10000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        backdrop-filter: blur(5px); animation: popIn 0.2s; padding: 15px;
    `;

    // 3. RENDER CONTENT
    overlay.innerHTML = `
        <div id="raid-question-container" style="width: 100%; max-width: 600px; display:flex; flex-direction:column; align-items:center;">
            <div style="font-size: 20px; color: #f6e05e; font-weight:bold; margin-bottom: 15px; text-shadow: 0 0 10px red;">
                ‚ö° DOUBLE DAMAGE CHANCE ‚ö°
            </div>
            
            <div style="
                background: white; color: #2d3748; border-radius: 20px; padding: 25px; 
                width: 100%; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
                display: flex; flex-direction: column; align-items: center; text-align: center;
            ">
                <div style="margin-bottom: 15px; width: 100%;">
                    ${extraVisual}
                </div>
                <div style="font-size: 32px; font-weight: bold; line-height: 1.3;">
                    ${mainContent}
                </div>
            </div>

            <div id="force-math-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%;"></div>
            
            <button onclick="document.getElementById('force-raid-overlay').remove()" 
                style="margin-top:25px; padding:10px 30px; background:#e53e3e; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">
                Cancel
            </button>
        </div>
    `;

    document.body.appendChild(overlay);

    // 4. GENERATE OPTIONS
    const optsContainer = document.getElementById('force-math-options');
    let finalOptions = [];

    if (qOptions && Array.isArray(qOptions) && qOptions.length > 0) {
        finalOptions = [...qOptions];
    } else {
        let optionsSet = new Set([qAnswer]);
        const numericAns = parseFloat(qAnswer);
        if (!isNaN(numericAns)) {
            while(optionsSet.size < 4) {
                let offset = Math.floor(Math.random() * 10) - 5;
                if(offset !== 0) optionsSet.add(numericAns + offset);
            }
        } else {
            optionsSet.add("Yes"); optionsSet.add("No");
        }
        finalOptions = Array.from(optionsSet);
    }

    finalOptions.sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('button');
        btn.className = "mcq-btn";
        btn.style.cssText = "font-size: 24px; min-height: 80px; width: 100%; cursor: pointer; border-radius: 15px; border: 4px solid #cbd5e0; background: white; color: #2d3748; box-shadow: 0 5px 0 #a0aec0;";
        btn.innerHTML = opt; 
        
        // --- CLICK HANDLER WITH BP REWARD ---
        btn.onclick = function() { 
            const isCorrect = (opt == qAnswer);
            
            // 1. BP LOGIC
            let bpMsg = "";
            if (isCorrect) {
                addBP(10); // Native function to add BP
                bpMsg = "+10 Brain Points!";
            } else {
                // Safe Deduction (Native logic)
                const deduction = Math.min(gameState.brainPoints, 5);
                gameState.brainPoints -= deduction;
                updateStatsDisplay();
                saveGame();
                bpMsg = `-${deduction} Brain Points`;
            }

            // 2. PLAY SOUND
            soundManager.playSFX(isCorrect ? 'correct' : 'wrong');

            // 3. SHOW FEEDBACK
            const container = document.getElementById('raid-question-container');
            if(container) {
                container.innerHTML = `
                    <div style="animation: popIn 0.3s; text-align:center;">
                        <div style="font-size: 80px; margin-bottom: 10px;">
                            ${isCorrect ? '‚úÖ' : '‚ùå'}
                        </div>
                        <h1 style="color: ${isCorrect ? '#48bb78' : '#f56565'}; font-size: 40px; font-weight:bold; text-shadow: 0 2px 5px black; margin:0;">
                            ${isCorrect ? 'CORRECT!' : 'INCORRECT!'}
                        </h1>
                        <p style="color: white; font-size: 20px; font-weight:bold; margin-top: 5px;">
                            ${isCorrect ? 'DOUBLE DAMAGE ACTIVATED!' : 'Damage Reduced...'}
                        </p>
                        <!-- BP MESSAGE -->
                        <p style="color: ${isCorrect ? '#f6e05e' : '#fc8181'}; font-size: 18px; font-weight:bold; margin-top: 5px;">
                            ${bpMsg}
                        </p>
                    </div>
                `;
            }

            // 4. WAIT 1 SECOND THEN ATTACK
            setTimeout(() => {
                document.getElementById('force-raid-overlay').remove();
                if (isCorrect) {
                    useRaidMove(moveId, 2.0, 1.0); 
                } else {
                    useRaidMove(moveId, 0.5, 2.0);
                }
            }, 1000); 
        };
        optsContainer.appendChild(btn);
    });
};

// ===============================================
// BULK ITEM USAGE SYSTEM (XP ONLY)
// ===============================================

let currentUsingItem = null;

window.openUseQuantityModal = function(itemId) {
    const count = gameState.inventory[itemId] || 0;
    if (count <= 0) return;

    currentUsingItem = findShopItem(itemId); 
    if (!currentUsingItem) return;

    const modal = document.getElementById('use-quantity-modal');
    const slider = document.getElementById('use-qty-slider');
    const title = document.getElementById('use-qty-title');
    const visual = document.getElementById('use-qty-visual');
    const desc = document.getElementById('use-qty-desc');
    const label = document.getElementById('use-qty-label');
    const maxText = document.getElementById('use-qty-max');
    const confirmBtn = document.getElementById('use-qty-confirm-btn');

    // Setup UI
    title.innerText = `Use ${currentUsingItem.name}`;
    visual.innerText = currentUsingItem.icon || 'üåü';
    desc.innerText = `You have: ${count}`;
    
    // Setup Slider
    slider.min = 1;
    slider.max = count;
    slider.value = 1;
    maxText.innerText = `Max: ${count}`;
    
    // Update Label function
    const updateLabel = () => {
        label.innerText = `Use: ${slider.value}`;
    };
    slider.oninput = updateLabel;
    updateLabel();

    // Confirm Action
    confirmBtn.onclick = () => {
        confirmBulkUse(itemId, parseInt(slider.value));
        modal.classList.remove('active');
    };

    modal.classList.add('active');
};

window.confirmBulkUse = function(itemId, quantity) {
    if (quantity <= 0) return;
    
    // 1. Remove items
    gameState.inventory[itemId] -= quantity;
    if (gameState.inventory[itemId] < 0) gameState.inventory[itemId] = 0;

    // 2. Apply Effects (XP Only)
    const pet = gameState.pets.find(p => p.id === gameState.currentPetId);
    let msg = "";

    if (itemId === 'xp_potion') {
        const totalXP = quantity * 100;
        pet.xp += totalXP;
        
        let levelsGained = 0;
        // Loop level up logic
        while (pet.xp >= pet.maxXp) {
            const maxLvl = LEVEL_CAPS[pet.rarity] || 100;
            if (pet.level >= maxLvl) {
                pet.xp = pet.maxXp; 
                break;
            }
            
            pet.level++;
            pet.xp -= pet.maxXp;
            pet.maxXp = pet.level * 300 + 200;
            pet.maxHP = 50 + (pet.level * 10);
            pet.hp = pet.maxHP; 
            levelsGained++;
        }
        
        soundManager.playSFX('levelUp');
        msg = levelsGained > 0 
            ? `Leveled up ${levelsGained} times!` 
            : `Added ${totalXP} XP!`;
    }

    saveGame();
    renderHub();
    updateStatsDisplay();
    showToast(msg, "success");
};
// ===============================================
// SECURITY HELPER: SHA-256 HASHING
// ===============================================
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}
// ===============================================
// MULTI-TEACHER SYSTEM
// ===============================================

// 1. REGISTER A NEW TEACHER
async function registerNewTeacher() {
    const user = document.getElementById('teacher-username').value.trim();
    const pass = document.getElementById('teacher-pass').value.trim();

    if (!user || !pass) return showToast("Enter Username & Password", "error");

    // Check if teacher already exists
    const docRef = window.fbase.doc(window.db, "teachers", user);
    const docSnap = await window.fbase.getDoc(docRef);

    if (docSnap.exists()) {
        return showToast("Teacher username already exists!", "error");
    }

    // Hash the password
    const hash = await sha256(pass);

    // Save to Firestore
    await window.fbase.setDoc(docRef, {
        username: user,
        passwordHash: hash,
        joinedAt: new Date().toISOString()
    });

    showToast(`Registered Teacher: ${user}`, "success");
}

// 2. LOGIN TEACHER (Updated to fix Split Screen)
async function loginTeacher() {
    const user = document.getElementById('teacher-username').value.trim();
    const pass = document.getElementById('teacher-pass').value.trim();

    if (!user || !pass) return showToast("Enter credentials", "error");

    // --- 1. CHECK IF ADMIN ---
    // User: "admin", Password: "1030"
    const ADMIN_HASH = "3691308f2a4c2f6983f2880d32e29c84e17067c9c043232c4cb72960e81726a4"; 
    const inputHash = await sha256(pass);

    if (user.toLowerCase() === "admin" && inputHash === ADMIN_HASH) {
        // Show Admin Dashboard
        document.getElementById('teacher-dashboard-screen').style.display = 'none'; // Hide teacher one
        document.getElementById('admin-dashboard-screen').style.display = 'block';
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-game-ui').style.display = 'none'; 
        
        loadAdminData(); // New function to load teacher list
        return showToast("Welcome, Headmaster.", "success");
    }

    // --- 2. CHECK IF REGULAR TEACHER ---
    const docRef = window.fbase.doc(window.db, "teachers", user);
    const docSnap = await window.fbase.getDoc(docRef);

    if (docSnap.exists() && inputHash === docSnap.data().passwordHash) {
        // Existing Teacher Logic
        currentLoggedTeacher = user;
        document.getElementById('teacher-dashboard-screen').style.display = 'block';
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-game-ui').style.display = 'none'; 
        
        document.getElementById('teacher-username').value = "";
        document.getElementById('teacher-pass').value = "";
        document.querySelector('#teacher-dashboard-screen h1').innerText = `üë®‚Äçüè´ Class: ${user}`;
        loadStudentList(); 
        showToast("Welcome back!", "success");
    } else {
        showToast("Invalid Credentials", "error");
    }
}
// ===============================================
// MIGRATION TOOL: CLAIM OLD STUDENTS
// ===============================================
async function claimLegacyStudents() {
    if (!currentLoggedTeacher) return showToast("Log in as a Teacher first!", "error");

    if (!confirm(`Are you sure you want to assign ALL old (unclaimed) students to "${currentLoggedTeacher}"?`)) {
        return;
    }

    const d = document.getElementById('student-list-container');
    d.innerHTML = '<div style="text-align:center;">Scanning database...</div>';

    // 1. Get ALL students
    const q = await window.fbase.getDocs(window.fbase.collection(window.db, "students"));
    const batch = window.fbase.writeBatch(window.db);
    let count = 0;

    q.forEach(doc => {
        const data = doc.data();
        
        // 2. Check if they are an "Orphan" (No teacherId)
        if (!data.teacherId) {
            // 3. Update them to belong to YOU
            batch.update(doc.ref, { teacherId: currentLoggedTeacher });
            count++;
        }
    });

    if (count > 0) {
        // 4. Save Changes
        await batch.commit();
        showToast(`Success! claimed ${count} students.`, "success");
        loadStudentList(); // Refresh the list to see them
    } else {
        showToast("No unclaimed students found.", "info");
        loadStudentList();
    }
}
// ===============================================
// ADMIN SYSTEM LOGIC
// ===============================================

// 1. Load Teachers List for Admin
async function loadAdminData() {
    const list = document.getElementById('admin-teacher-list');
    const select = document.getElementById('admin-boss-teacher-select');
    
    list.innerHTML = "Loading...";
    select.innerHTML = "";

    const q = await window.fbase.getDocs(window.fbase.collection(window.db, "teachers"));
    let html = "";
    
    q.forEach(doc => {
        const t = doc.data().username;
        html += `<div>üë§ ${t}</div>`;
        
        // Add to checkbox list for Boss Summoning
        select.innerHTML += `
            <label style="display:block; cursor:pointer;">
                <input type="checkbox" class="boss-target-teacher" value="${t}"> ${t}
            </label>
        `;
    });
    
    list.innerHTML = html || "No teachers yet.";
}

// 2. Admin Create Teacher
async function adminCreateTeacher() {
    const user = document.getElementById('admin-new-teacher-user').value.trim();
    const pass = document.getElementById('admin-new-teacher-pass').value.trim();

    if(!user || !pass) return showToast("Enter details", "error");

    const hash = await sha256(pass);
    await window.fbase.setDoc(window.fbase.doc(window.db, "teachers", user), {
        username: user, passwordHash: hash, joinedAt: new Date().toISOString()
    });

    showToast(`Teacher ${user} Created!`, "success");
    loadAdminData(); // Refresh lists
}

// 3. Admin Toggle UI
function toggleTeacherCheckboxes(show) {
    document.getElementById('admin-boss-teacher-select').style.display = show ? 'block' : 'none';
}

// 4. Admin Summon Boss
// 1. UPDATED ADMIN SUMMON (Reads Image Input Correctly)
// ===============================================
// FIXED ADMIN SUMMON (With Success Alert)
// ===============================================
// 4. Admin Summon Boss
// ===============================================
// ADMIN SUMMON (Writes to Correct Paths)
// ===============================================
async function adminSummonBoss() {
    console.log("üëâ Admin Summon Clicked");

    try {
        // 1. Get Values
        const name = document.getElementById('admin-boss-name').value || "Titan";
        const hp = parseInt(document.getElementById('admin-boss-hp').value) || 50000;
        const atk = parseInt(document.getElementById('admin-boss-atk').value) || 20;
        
        const imgInput = document.getElementById('admin-boss-img');
        const img = imgInput ? imgInput.value : '';

        const rewInput = document.getElementById('admin-boss-reward');
        const reward = rewInput ? rewInput.value : '';

        // 2. Check Target
        const radio = document.querySelector('input[name="boss-target"]:checked');
        const isGlobal = radio ? (radio.value === 'global') : true;

        // 3. DEFINE DATA
        const bossData = {
            name: name, 
            hp: hp, 
            maxHP: hp, 
            attack: atk,
            image: img, 
            active: true, // <--- MUST BE TRUE
            summonedBy: 'Admin',
            rewardUrl: reward, 
            damageDealers: {}
        };

        const batch = window.fbase.writeBatch(window.db);

        // 4. Queue Updates
        if (isGlobal) {
            // Write to GLOBAL path
            const ref = window.fbase.doc(window.db, "world_boss", "global");
            batch.set(ref, bossData);
        } else {
            const targets = document.querySelectorAll('.boss-target-teacher:checked');
            if(targets.length === 0) {
                alert("Please select at least one teacher checkbox!");
                return;
            }
            
            targets.forEach(cb => {
                // Write to CLASS path
                const ref = window.fbase.doc(window.db, "world_boss", `teacher_${cb.value}`);
                batch.set(ref, bossData);
            });
        }

        // 5. Commit
        await batch.commit();
        alert("‚úÖ BOSS SUMMONED!");

    } catch (e) {
        console.error("Admin Summon Error:", e);
        alert("‚ùå SUMMON FAILED:\n" + e.message);
    }
}

// 5. Admin End Raid
async function adminEndRaid() {
    if(!confirm("End the GLOBAL raid? (Students will stop fighting)")) return;
    
    // Set active: false
    await window.fbase.updateDoc(window.fbase.doc(window.db, "world_boss", "global"), {
        active: false,
        hp: 0 
    });
    
    showToast("üõë Global Raid Ended", "info");
}

// 6. Teacher End Raid
async function teacherEndRaid() {
    if (!currentLoggedTeacher) return;
    if(!confirm("End your class raid?")) return;

    await window.fbase.updateDoc(window.fbase.doc(window.db, "world_boss", `teacher_${currentLoggedTeacher}`), {
        active: false,
        hp: 0
    });
    
    showToast("üõë Class Raid Ended", "info");
}
// ===============================================
// SECURITY & LOGIN SYSTEM (REPAIRED)
// ===============================================

// 1. RE-ADD THE HASHING HELPER (Crucial for Admin Login)
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// 2. REPLACEMENT LOGIN FUNCTION (With Debugging)
// 2. LOGIN TEACHER (Bulletproof Version)
// 2. LOGIN TEACHER (Fixed Hash for "1030")
window.loginTeacher = async function() {
    console.log("üîë Login button clicked...");

    const userEl = document.getElementById('teacher-username');
    const passEl = document.getElementById('teacher-pass');

    if (!userEl || !passEl) {
        alert("Critical Error: Login text boxes are missing!");
        return;
    }

    const user = userEl.value.trim(); 
    const userLower = user.toLowerCase();
    const pass = passEl.value.trim();

    if (!user || !pass) return showToast("Enter credentials", "error");

    // --- ADMIN CONFIGURATION ---
    // User: "admin"
    // Password: "1030"
    // This hash matches the one in your error logs exactly:
    const ADMIN_HASH = "2f1987bf98c09d2f5d2a23a6ae29fa53b9aec8f07ed1330bd439122f5a1a2c2c"; 
    
    try {
        const inputHash = await sha256(pass);
        console.log("Input Hash:", inputHash);

        // 1. ADMIN CHECK
        if (userLower === "admin" && inputHash === ADMIN_HASH) {
            console.log("‚úÖ Admin Credentials Verified");
            
            // Switch to Admin Dashboard
            if(document.getElementById('teacher-dashboard-screen')) document.getElementById('teacher-dashboard-screen').style.display = 'none';
            if(document.getElementById('admin-dashboard-screen')) document.getElementById('admin-dashboard-screen').style.display = 'block';
            
            // Hide Login & Game
            document.getElementById('login-overlay').style.display = 'none';
            if(document.getElementById('main-game-ui')) document.getElementById('main-game-ui').style.display = 'none';
            
            // Clear inputs
            userEl.value = "";
            passEl.value = "";

            if(typeof loadAdminData === 'function') loadAdminData();
            
            return showToast("Welcome, Headmaster.", "success");
        }

        // 2. TEACHER CHECK (Only happens if Admin check fails)
        console.log("Checking Database for Teacher...");
        
        const docRef = window.fbase.doc(window.db, "teachers", user);
        const docSnap = await window.fbase.getDoc(docRef);

        if (docSnap.exists()) {
            const dbHash = docSnap.data().passwordHash;
            if (inputHash === dbHash) {
                // Teacher Success
                currentLoggedTeacher = user;
                document.getElementById('teacher-dashboard-screen').style.display = 'block';
                document.getElementById('login-overlay').style.display = 'none';
                if(document.getElementById('main-game-ui')) document.getElementById('main-game-ui').style.display = 'none';
                
                // Clear inputs
                userEl.value = "";
                passEl.value = "";
                
                const title = document.querySelector('#teacher-dashboard-screen h1');
                if(title) title.innerText = `üë®‚Äçüè´ Class: ${user}`;
                
                if(typeof loadStudentList === 'function') loadStudentList(); 
                showToast("Welcome back!", "success");
            } else {
                showToast("Wrong Password", "error");
            }
        } else {
            showToast("User not found", "error");
        }

    } catch (err) {
        console.error("Login Crash:", err);
        alert("Login Error: " + err.message);
    }
};
  </script>
</body>
</html>
